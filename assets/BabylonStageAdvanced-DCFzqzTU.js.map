{"version":3,"mappings":"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","names":["_BabylonEngineManager","__publicField","init","d","engine","scene","canvas","f","_a","_b","BabylonEngineManager","babylonEngineManager","EnergyBoxFeature","box","MeshBuilder","mat","StandardMaterial","Color3","glow","GlowLayer","obs","EffectsDrivenParticlesFeature","texData","ps","ParticleSystem","Texture","Vector3","Color4","burst","intensity","original","unsubLevel","effectsBus","level","unsubShock","severity","unsubStage","stage","unsubDrop","unsubAi","voltage","OutletFeature","base","pulse","unsubClick","DistortionShockFeature","pp","PostProcess","start","eff","t","DuelOpponentFeature","bar","unsub","players","list","maxScore","m","p","h","BabylonStageAdvanced","canvasRef","useRef","status","setStatus","useState","fps","setFps","lastFpsT","frameCounter","frameRef","useEffect","disposed","B","__vitePreload","webgpu","s","e","now","resize","jsxs","jsx"],"ignoreList":[],"sources":["../../src/babylon/BabylonEngineManager.ts","../../src/babylon/features/EnergyBoxFeature.ts","../../src/babylon/features/EffectsDrivenParticlesFeature.ts","../../src/babylon/features/OutletFeature.ts","../../src/babylon/features/DistortionShockFeature.ts","../../src/babylon/features/DuelOpponentFeature.ts","../../src/components/BabylonStageAdvanced.tsx"],"sourcesContent":["// Centralized Babylon.js engine & scene manager to allow modular feature registration\r\nimport type { Engine, Scene } from '@babylonjs/core';\r\n\r\nexport type BabylonFeatureInit = (ctx: { engine: Engine; scene: Scene; canvas: HTMLCanvasElement }) => void | (() => void);\r\n\r\nclass BabylonEngineManager {\r\n  private static _i: BabylonEngineManager;\r\n  static get instance() { return this._i || (this._i = new BabylonEngineManager()); }\r\n\r\n  engine: Engine | null = null;\r\n  scene: Scene | null = null;\r\n  private features: BabylonFeatureInit[] = [];\r\n  private disposers: (() => void)[] = [];\r\n  private ready = false;\r\n\r\n  registerFeature(init: BabylonFeatureInit) {\r\n    if (this.ready && this.engine && this.scene && this.canvas) {\r\n      const d = init({ engine: this.engine, scene: this.scene, canvas: this.canvas });\r\n      if (typeof d === 'function') this.disposers.push(d);\r\n    } else {\r\n      this.features.push(init);\r\n    }\r\n  }\r\n\r\n  canvas: HTMLCanvasElement | null = null;\r\n\r\n  init(engine: Engine, scene: Scene, canvas: HTMLCanvasElement) {\r\n    this.engine = engine; this.scene = scene; this.canvas = canvas; this.ready = true;\r\n    // flush queued features\r\n    for (const f of this.features) {\r\n      const d = f({ engine, scene, canvas });\r\n      if (typeof d === 'function') this.disposers.push(d);\r\n    }\r\n    this.features = [];\r\n  }\r\n\r\n  dispose() {\r\n    for (const d of this.disposers) { try { d(); } catch { /* ignore */ } }\r\n    this.disposers = [];\r\n    try { this.scene?.dispose(); } catch {}\r\n    try { this.engine?.dispose(); } catch {}\r\n    this.engine = null; this.scene = null; this.ready = false; this.canvas = null;\r\n  }\r\n}\r\n\r\nexport const babylonEngineManager = BabylonEngineManager.instance;\r\n","import { Color3, GlowLayer, MeshBuilder, StandardMaterial } from '@babylonjs/core';\r\nimport type { BabylonFeatureInit } from '../BabylonEngineManager';\r\n\r\n// Simple rotating emissive energy cube with glow\r\nexport const EnergyBoxFeature: BabylonFeatureInit = ({ scene }) => {\r\n  const box = MeshBuilder.CreateBox('energyBox', { size: 1.2 }, scene);\r\n  const mat = new StandardMaterial('energyMat', scene);\r\n  mat.emissiveColor = new Color3(1, 0.5, 0.15);\r\n  box.material = mat;\r\n  let glow: GlowLayer | null = null;\r\n  try { glow = new GlowLayer('glow', scene, { blurKernelSize: 32 }); glow.intensity = 0.6; glow.addIncludedOnlyMesh(box); } catch {}\r\n  const obs = scene.onBeforeRenderObservable.add(() => {\r\n    box.rotation.y += 0.01; box.rotation.x += 0.005;\r\n  });\r\n  return () => { scene.onBeforeRenderObservable.remove(obs); try { box.dispose(); } catch {}; try { glow?.dispose(); } catch {} };\r\n};\r\n","import { Color4, ParticleSystem, Texture, Vector3 } from '@babylonjs/core';\r\nimport type { BabylonFeatureInit } from '../BabylonEngineManager';\r\nimport { effectsBus } from '../../effects/effectsBus';\r\n\r\n// Creates a pooled particle system attached near origin and triggers bursts on effect events.\r\nexport const EffectsDrivenParticlesFeature: BabylonFeatureInit = ({ scene }) => {\r\n  const texData = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==';\r\n  const ps = new ParticleSystem('fxParticles', 4000, scene);\r\n  ps.particleTexture = new Texture(texData, scene, true, false, Texture.NEAREST_SAMPLINGMODE);\r\n  ps.emitter = new Vector3(0,0,0);\r\n  ps.minEmitPower = 0.3; ps.maxEmitPower = 2.2;\r\n  ps.minSize = 0.05; ps.maxSize = 0.35;\r\n  ps.minLifeTime = 0.3; ps.maxLifeTime = 1.2;\r\n  ps.emitRate = 0; // we'll trigger manual bursts\r\n  ps.color1 = new Color4(1,0.65,0.25,1);\r\n  ps.color2 = new Color4(1,0.35,0.1,1);\r\n  ps.colorDead = new Color4(0.2,0.1,0.05,0);\r\n  ps.updateSpeed = 0.012;\r\n  ps.start();\r\n\r\n  function burst(intensity: number) {\r\n    // Temporarily raise emitRate for a frame\r\n    const original = ps.emitRate;\r\n    ps.emitRate = intensity;\r\n    setTimeout(()=>{ ps.emitRate = original; }, 60);\r\n  }\r\n\r\n  const unsubLevel = effectsBus.on('levelUp', ({ level }) => burst(400 + level*40));\r\n  const unsubShock = effectsBus.on('shock', ({ severity }) => {\r\n    const mult = severity==='critical'? 600: severity==='severe'? 420: severity==='moderate'? 300: 180;\r\n    burst(mult);\r\n  });\r\n  const unsubStage = effectsBus.on('stageAdvance', ({ stage }) => burst(500 + stage*60));\r\n  const unsubDrop = effectsBus.on('itemDrop', ({ level }) => burst(260 + level*30));\r\n  const unsubAi = effectsBus.on('aiAttack', ({ voltage }) => burst(300 + Math.min(600, voltage)));\r\n\r\n  return () => {\r\n    unsubLevel(); unsubShock(); unsubStage(); unsubDrop(); unsubAi();\r\n    try { ps.dispose(); } catch {}\r\n  };\r\n};\r\n","import { Color3, MeshBuilder, StandardMaterial, Vector3 } from '@babylonjs/core';\r\nimport type { BabylonFeatureInit } from '../BabylonEngineManager';\r\nimport { effectsBus } from '../../effects/effectsBus';\r\n\r\nexport const OutletFeature: BabylonFeatureInit = ({ scene }) => {\r\n  const base = MeshBuilder.CreateBox('outletBase', { width: 2.2, height: 3.0, depth: 0.25 }, scene);\r\n  base.position = new Vector3(0,0,0);\r\n  const mat = new StandardMaterial('outletMat', scene);\r\n  mat.diffuseColor = new Color3(0.12,0.12,0.14);\r\n  mat.specularColor = new Color3(0.05,0.05,0.05);\r\n  base.material = mat;\r\n  const pulse = { t: 0 };\r\n  const obs = scene.onBeforeRenderObservable.add(() => {\r\n    if (pulse.t > 0) {\r\n      pulse.t -= scene.getEngine().getDeltaTime()*0.004;\r\n      const f = Math.max(0, pulse.t);\r\n      mat.emissiveColor = new Color3(0.8+0.2*f, 0.45+0.4*f, 0.15+0.2*f);\r\n    } else {\r\n      mat.emissiveColor = new Color3(0.8,0.45,0.15);\r\n    }\r\n  });\r\n  const unsubClick = effectsBus.on('outletClick', () => { pulse.t = 1; });\r\n  const unsubShock = effectsBus.on('shock', ({ severity }) => { pulse.t = severity==='critical'? 2.2 : severity==='severe'?1.6:1.1; });\r\n  return () => { unsubClick(); unsubShock(); scene.onBeforeRenderObservable.remove(obs); try { base.dispose(); } catch {}; };\r\n};\r\n","import { PostProcess } from '@babylonjs/core';\r\nimport type { BabylonFeatureInit } from '../BabylonEngineManager';\r\nimport { effectsBus } from '../../effects/effectsBus';\r\n\r\n// Simple fullscreen fragment that warps UVs based on a time-varying intensity.\r\nexport const DistortionShockFeature: BabylonFeatureInit = ({ scene }) => {\r\n  let intensity = 0;\r\n  const pp = new PostProcess('shockDistortion', `\r\n    precision highp float;\r\n    varying vec2 vUV;\r\n    uniform float iTime; uniform float iIntensity;\r\n    float hash(vec2 p){return fract(sin(dot(p,vec2(41.3,289.1)))*43758.5453);} \r\n    void main(){\r\n      vec2 uv=vUV; \r\n      float n = hash(floor(uv*vec2(64.0))+floor(iTime*10.0));\r\n      uv += (n-0.5)*0.02*iIntensity;\r\n      gl_FragColor = texture2D(textureSampler, uv);\r\n    }\r\n  `, ['iTime','iIntensity'], null, 1.0, null, undefined, scene.getEngine(), true);\r\n  let start = performance.now();\r\n  pp.onApply = (eff) => {\r\n    const t = (performance.now()-start)/1000;\r\n    intensity = Math.max(0, intensity - scene.getEngine().getDeltaTime()*0.0006);\r\n    eff.setFloat('iTime', t);\r\n    eff.setFloat('iIntensity', intensity);\r\n  };\r\n  const unsubShock = effectsBus.on('shock', ({ severity }) => {\r\n    intensity = severity==='critical'?1.6: severity==='severe'?1.2: severity==='moderate'?0.8:0.5;\r\n  });\r\n  return () => { unsubShock(); try { pp.dispose(); } catch {}; };\r\n};\r\n","import { MeshBuilder, StandardMaterial, Color3, Vector3 } from '@babylonjs/core';\r\nimport type { BabylonFeatureInit } from '../BabylonEngineManager';\r\nimport { effectsBus } from '../../effects/effectsBus';\r\n\r\nexport const DuelOpponentFeature: BabylonFeatureInit = ({ scene }) => {\r\n  const bar = MeshBuilder.CreateBox('opponentBar', { width: 0.3, height: 0.1, depth: 0.3 }, scene);\r\n  bar.position = new Vector3(1.6, 1.2, 0);\r\n  const mat = new StandardMaterial('opponentMat', scene); mat.emissiveColor = new Color3(0.2,0.5,1); bar.material = mat;\r\n  const unsub = effectsBus.on('duelState', ({ players }) => {\r\n    // Take first opponent (not local later we could filter) â€“ scale height by score fraction heuristic.\r\n    const list = Object.values(players);\r\n    if (!list.length) return;\r\n    const maxScore = list.reduce((m,p)=> p.score>m? p.score:m, 1);\r\n    const p = list[0];\r\n    const h = 0.3 + Math.min(2.5, (p.score / (maxScore||1)) * 1.5);\r\n    bar.scaling.y = h;\r\n    bar.position.y = 0.5 + h/2;\r\n    mat.emissiveColor = new Color3(0.2 + (p.streak*0.05)%0.5, 0.5, 1 - Math.min(0.7, p.volts/1000));\r\n  });\r\n  return () => { unsub(); try { bar.dispose(); } catch {}; };\r\n};\r\n","import React, { useEffect, useRef, useState } from 'react';\r\nimport { babylonEngineManager } from '../babylon/BabylonEngineManager';\r\nimport { EnergyBoxFeature } from '../babylon/features/EnergyBoxFeature';\r\nimport { EffectsDrivenParticlesFeature } from '../babylon/features/EffectsDrivenParticlesFeature';\r\nimport { OutletFeature } from '../babylon/features/OutletFeature';\r\nimport { DistortionShockFeature } from '../babylon/features/DistortionShockFeature';\r\nimport { DuelOpponentFeature } from '../babylon/features/DuelOpponentFeature';\r\n\r\ninterface AdvStatus { mode: 'loading'|'webgpu'|'webgl'|'error'; message: string; frames: number; }\r\n\r\n// More modular Babylon stage using BabylonEngineManager so we can add features (particles, power-ups, UI overlays) later\r\nexport const BabylonStageAdvanced: React.FC = () => {\r\n  const canvasRef = useRef<HTMLCanvasElement | null>(null);\r\n  const [status, setStatus] = useState<AdvStatus>({ mode: 'loading', message: 'Initializing...', frames: 0 });\r\n  const [fps, setFps] = useState(0);\r\n  const lastFpsT = useRef(performance.now());\r\n  const frameCounter = useRef(0);\r\n  const frameRef = useRef(0);\r\n\r\n  useEffect(() => {\r\n    let disposed = false;\r\n    (async () => {\r\n      if (!canvasRef.current) return;\r\n      try {\r\n        const B = await import('@babylonjs/core');\r\n        await import('@babylonjs/loaders');\r\n        const canvas = canvasRef.current;\r\n        let engine: any = null;\r\n        if ((navigator as any).gpu && B.WebGPUEngine) {\r\n          try { const webgpu = new B.WebGPUEngine(canvas, { adaptToDeviceRatio: true }); await webgpu.initAsync(); engine = webgpu; setStatus(s=>({ ...s, mode:'webgpu', message:'Babylon WebGPU'})); } catch (e) { console.warn('WebGPU init failed', e); }\r\n        }\r\n        if (!engine) { engine = new B.Engine(canvas, true); setStatus(s=>({ ...s, mode:'webgl', message:'Babylon WebGL'})); }\r\n        const scene = new B.Scene(engine);\r\n        const camera = new B.ArcRotateCamera('cam', Math.PI/4, Math.PI/3, 6, B.Vector3.Zero(), scene); camera.attachControl(canvas, true);\r\n        new B.HemisphericLight('hl', new B.Vector3(0,1,0), scene);\r\n        babylonEngineManager.init(engine, scene, canvas);\r\n        // Register core features\r\n        babylonEngineManager.registerFeature(EnergyBoxFeature);\r\n        babylonEngineManager.registerFeature(OutletFeature);\r\n        babylonEngineManager.registerFeature(EffectsDrivenParticlesFeature);\r\n        babylonEngineManager.registerFeature(DistortionShockFeature);\r\n  babylonEngineManager.registerFeature(DuelOpponentFeature);\r\n        engine.runRenderLoop(() => { \r\n          scene.render(); \r\n          frameRef.current++; frameCounter.current++;\r\n          const now = performance.now();\r\n          if (now - lastFpsT.current > 1000) {\r\n            setFps(Math.round(frameCounter.current * 1000 / (now - lastFpsT.current)));\r\n            frameCounter.current = 0; lastFpsT.current = now;\r\n          }\r\n          if (frameRef.current % 60 === 0) setStatus(s=>({ ...s, frames: frameRef.current }));\r\n        });\r\n        const resize = () => engine.resize(); window.addEventListener('resize', resize);\r\n        if (disposed) return;\r\n        return () => { disposed = true; window.removeEventListener('resize', resize); babylonEngineManager.dispose(); };\r\n      } catch (e:any) {\r\n        setStatus({ mode:'error', message: e?.message || 'Init error', frames: 0 });\r\n      }\r\n    })();\r\n  }, []);\r\n\r\n  return (\r\n    <div style={{border:'1px solid #334', padding:8, borderRadius:8, background:'#0d0f15', color:'#eaeaea'}}>\r\n  <div style={{fontSize:12, marginBottom:6}}>Mod Babylon: {status.message} frames:{status.frames} fps:{fps}</div>\r\n      <canvas ref={canvasRef} style={{width:'100%', height:300, display:'block', background:'#050608'}} />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default BabylonStageAdvanced;\r\n"],"file":"assets/BabylonStageAdvanced-DCFzqzTU.js"}