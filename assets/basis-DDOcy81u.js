import{c as b,w as y,T as U}from"./pointsCloudSystem-2vcS-S4d.js";function R(){const e={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFBC7:6,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFRGB565:14};let a=null;onmessage=t=>{if(t.data.action==="init"){if(t.data.url)try{importScripts(t.data.url)}catch(n){postMessage({action:"error",error:n})}a||(a=BASIS({wasmBinary:t.data.wasmBinary})),a!==null&&a.then(n=>{BASIS=n,n.initializeBasis(),postMessage({action:"init"})})}else if(t.data.action==="transcode"){const n=t.data.config,r=t.data.imageData,f=new BASIS.BasisFile(r),o=l(f);let d=t.data.ignoreSupportedFormats?null:s(t.data.config,o),T=!1;d===null&&(T=!0,d=o.hasAlpha?e.cTFBC3:e.cTFBC1);let u=!0;f.startTranscoding()||(u=!1);const m=[];for(let p=0;p<o.images.length&&u;p++){const h=o.images[p];if(n.loadSingleImage===void 0||n.loadSingleImage===p){let L=h.levels.length;n.loadMipmapLevels===!1&&(L=1);for(let C=0;C<L;C++){const _=h.levels[C],P=c(f,p,C,d,T);if(!P){u=!1;break}_.transcodedPixels=P,m.push(_.transcodedPixels.buffer)}}}f.close(),f.delete(),T&&(d=-1),u?postMessage({action:"transcode",success:u,id:t.data.id,fileInfo:o,format:d},m):postMessage({action:"transcode",success:u,id:t.data.id})}};function s(t,n){let r=null;return t.supportedCompressionFormats&&(t.supportedCompressionFormats.astc?r=e.cTFASTC_4x4:t.supportedCompressionFormats.bc7?r=e.cTFBC7:t.supportedCompressionFormats.s3tc?r=n.hasAlpha?e.cTFBC3:e.cTFBC1:t.supportedCompressionFormats.pvrtc?r=n.hasAlpha?e.cTFPVRTC1_4_RGBA:e.cTFPVRTC1_4_RGB:t.supportedCompressionFormats.etc2?r=e.cTFETC2:t.supportedCompressionFormats.etc1?r=e.cTFETC1:r=e.cTFRGB565),r}function l(t){const n=t.getHasAlpha(),r=t.getNumImages(),f=[];for(let d=0;d<r;d++){const T={levels:[]},u=t.getNumLevels(d);for(let m=0;m<u;m++){const p={width:t.getImageWidth(d,m),height:t.getImageHeight(d,m)};T.levels.push(p)}f.push(T)}return{hasAlpha:n,images:f}}function c(t,n,r,f,o){const d=t.getImageTranscodedSizeInBytes(n,r,f);let T=new Uint8Array(d);if(!t.transcodeImage(T,n,r,f,1,0))return null;if(o){const u=t.getImageWidth(n,r)+3&-4,m=t.getImageHeight(n,r)+3&-4;T=i(T,0,u,m)}return T}function i(t,n,r,f){const o=new Uint16Array(4),d=new Uint16Array(r*f),T=r/4,u=f/4;for(let m=0;m<u;m++)for(let p=0;p<T;p++){const h=n+8*(m*T+p);o[0]=t[h]|t[h+1]<<8,o[1]=t[h+2]|t[h+3]<<8,o[2]=(2*(o[0]&31)+1*(o[1]&31))/3|(2*(o[0]&2016)+1*(o[1]&2016))/3&2016|(2*(o[0]&63488)+1*(o[1]&63488))/3&63488,o[3]=(2*(o[1]&31)+1*(o[0]&31))/3|(2*(o[1]&2016)+1*(o[0]&2016))/3&2016|(2*(o[1]&63488)+1*(o[0]&63488))/3&63488;for(let L=0;L<4;L++){const C=t[h+4+L];let _=(m*4+L)*r+p*4;d[_++]=o[C&3],d[_++]=o[C>>2&3],d[_++]=o[C>>4&3],d[_++]=o[C>>6&3]}}return d}}function D(e,a,s){return new Promise((l,c)=>{const i=t=>{t.data.action==="init"?(e.removeEventListener("message",i),l(e)):t.data.action==="error"&&c(t.data.error||"error initializing worker")};e.addEventListener("message",i),e.postMessage({action:"init",url:s?b.GetBabylonScriptURL(s):void 0,wasmBinary:a},[a])})}class N{}class z{}var g;(function(e){e[e.cTFETC1=0]="cTFETC1",e[e.cTFETC2=1]="cTFETC2",e[e.cTFBC1=2]="cTFBC1",e[e.cTFBC3=3]="cTFBC3",e[e.cTFBC4=4]="cTFBC4",e[e.cTFBC5=5]="cTFBC5",e[e.cTFBC7=6]="cTFBC7",e[e.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",e[e.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",e[e.cTFASTC_4x4=10]="cTFASTC_4x4",e[e.cTFATC_RGB=11]="cTFATC_RGB",e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e.cTFRGBA32=13]="cTFRGBA32",e[e.cTFRGB565=14]="cTFRGB565",e[e.cTFBGR565=15]="cTFBGR565",e[e.cTFRGBA4444=16]="cTFRGBA4444",e[e.cTFFXT1_RGB=17]="cTFFXT1_RGB",e[e.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",e[e.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",e[e.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",e[e.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"})(g||(g={}));const w={JSModuleURL:`${b._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${b._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`},W=(e,a)=>{let s;switch(e){case g.cTFETC1:s=36196;break;case g.cTFBC1:s=33776;break;case g.cTFBC4:s=33779;break;case g.cTFASTC_4x4:s=37808;break;case g.cTFETC2:s=37496;break;case g.cTFBC7:s=36492;break}if(s===void 0)throw"The chosen Basis transcoder format is not currently supported";return s};let G=null,F=null,v=0;const k=!1,V=()=>(G||(G=new Promise((e,a)=>{F?e(F):b.LoadFileAsync(b.GetBabylonScriptURL(w.WasmModuleURL)).then(s=>{if(typeof URL!="function")return a("Basis transcoder requires an environment with a URL constructor");const l=URL.createObjectURL(new Blob([`(${R})()`],{type:"application/javascript"}));F=new Worker(l),D(F,s,w.JSModuleURL).then(e,a)}).catch(a)})),G),X=e=>{F=e},x=(e,a)=>{const s=e instanceof ArrayBuffer?new Uint8Array(e):e;return new Promise((l,c)=>{V().then(()=>{const i=v++,t=r=>{r.data.action==="transcode"&&r.data.id===i&&(F.removeEventListener("message",t),r.data.success?l(r.data):c("Transcode is not supported on this device"))};F.addEventListener("message",t);const n=new Uint8Array(s.byteLength);n.set(new Uint8Array(s.buffer,s.byteOffset,s.byteLength)),F.postMessage({action:"transcode",id:i,imageData:n,config:a,ignoreSupportedFormats:k},[n.buffer])},i=>{c(i)})})},E=(e,a)=>{var l,c;let s=(l=a._gl)==null?void 0:l.TEXTURE_2D;e.isCube&&(s=(c=a._gl)==null?void 0:c.TEXTURE_CUBE_MAP),a._bindTextureDirectly(s,e,!0)},H=(e,a)=>{const s=e.getEngine();for(let l=0;l<a.fileInfo.images.length;l++){const c=a.fileInfo.images[l].levels[0];if(e._invertVScale=e.invertY,a.format===-1||a.format===g.cTFRGB565)if(e.type=10,e.format=4,s._features.basisNeedsPOT&&(Math.log2(c.width)%1!==0||Math.log2(c.height)%1!==0)){const i=new y(s,2);e._invertVScale=e.invertY,i.type=10,i.format=4,i.width=c.width+3&-4,i.height=c.height+3&-4,E(i,s),s._uploadDataToTextureDirectly(i,new Uint16Array(c.transcodedPixels.buffer),l,0,4,!0),s._rescaleTexture(i,e,s.scenes[0],s._getInternalFormat(4),()=>{s._releaseTexture(i),E(e,s)})}else e._invertVScale=!e.invertY,e.width=c.width+3&-4,e.height=c.height+3&-4,e.samplingMode=2,E(e,s),s._uploadDataToTextureDirectly(e,new Uint16Array(c.transcodedPixels.buffer),l,0,4,!0);else{e.width=c.width,e.height=c.height,e.generateMipMaps=a.fileInfo.images[l].levels.length>1;const i=B.GetInternalFormatFromBasisFormat(a.format,s);e.format=i,E(e,s),a.fileInfo.images[l].levels.forEach((t,n)=>{s._uploadCompressedDataToTextureDirectly(e,i,t.width,t.height,t.transcodedPixels,l,n)}),s._features.basisNeedsPOT&&(Math.log2(e.width)%1!==0||Math.log2(e.height)%1!==0)&&(b.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),e._cachedWrapU=U.CLAMP_ADDRESSMODE,e._cachedWrapV=U.CLAMP_ADDRESSMODE)}}},B={JSModuleURL:w.JSModuleURL,WasmModuleURL:w.WasmModuleURL,GetInternalFormatFromBasisFormat:W,TranscodeAsync:x,LoadTextureFromTranscodeResult:H};Object.defineProperty(B,"JSModuleURL",{get:function(){return w.JSModuleURL},set:function(e){w.JSModuleURL=e}});Object.defineProperty(B,"WasmModuleURL",{get:function(){return w.WasmModuleURL},set:function(e){w.WasmModuleURL=e}});export{N as B,W as G,H as L,X as S,x as T,z as a,w as b,B as c};
//# sourceMappingURL=basis-DDOcy81u.js.map
