const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/animationGroup-CmNY7dur.js","assets/pointsCloudSystem-2vcS-S4d.js","assets/index-rhFFGTpy.js","assets/motion-3WHHzQTP.js","assets/vendor-CIP6LD3P.js","assets/index-DdXHf9oj.css"])))=>i.map(i=>d[i]);
import{c as D,O as le,L as P,aC as qt,fB as ss,g2 as nr,g1 as sr,cB as jt,M as se,af as rr,V as N,m as ge,T as q,N as De,B as rs,a as Ue,S as Ye,C as B,aa as _e,br as Me,y as os,d as un,A as O,Q as te,cs as as,cr as hn,ct as dn,cu as we,aY as nn,g as is,q as Ee,aH as ot,s as ht,p as S,a9 as or,ep as dt,ai as ar,h as pe,ag as ir,f as Kn,fj as lr,a8 as cr,g5 as ur,aI as hr,c$ as Z,fz as dr,fo as fr,aK as pr,el as _r,em as mr,en as gr,ab as ls,eo as Un,F as yr,aF as br,cc as Ar,K as Jt,cf as Tr,bS as xr,bY as Wn,e2 as wr,ev as Qt,ga as vr}from"./pointsCloudSystem-2vcS-S4d.js";import{k as lt,D as Qe,R as Er,W as Cr,A as Or,b as Ir,i as Nr}from"./dataReader-DPhJthB_.js";import{_ as sn}from"./index-rhFFGTpy.js";import"./motion-3WHHzQTP.js";import"./vendor-CIP6LD3P.js";function rn(r,e,t,n){const s={externalResourceFunction:n};return t&&(s.uri=e==="file:"?t:e+t),ArrayBuffer.isView(r)?GLTFValidator.validateBytes(r,s):GLTFValidator.validateString(r,s)}function Mr(){const r=[];onmessage=e=>{const t=e.data;switch(t.id){case"init":{importScripts(t.url);break}case"validate":{rn(t.data,t.rootUrl,t.fileName,n=>new Promise((s,o)=>{const a=r.length;r.push({resolve:s,reject:o}),postMessage({id:"getExternalResource",index:a,uri:n})})).then(n=>{postMessage({id:"validate.resolve",value:n})},n=>{postMessage({id:"validate.reject",reason:n})});break}case"getExternalResource.resolve":{r[t.index].resolve(t.value);break}case"getExternalResource.reject":{r[t.index].reject(t.reason);break}}}}class cs{static ValidateAsync(e,t,n,s){return typeof Worker=="function"?new Promise((o,a)=>{const i=`${rn}(${Mr})()`,l=URL.createObjectURL(new Blob([i],{type:"application/javascript"})),c=new Worker(l),u=d=>{c.removeEventListener("error",u),c.removeEventListener("message",h),a(d)},h=d=>{const f=d.data;switch(f.id){case"getExternalResource":{s(f.uri).then(p=>{c.postMessage({id:"getExternalResource.resolve",index:f.index,value:p},[p.buffer])},p=>{c.postMessage({id:"getExternalResource.reject",index:f.index,reason:p})});break}case"validate.resolve":{c.removeEventListener("error",u),c.removeEventListener("message",h),o(f.value),c.terminate();break}case"validate.reject":c.removeEventListener("error",u),c.removeEventListener("message",h),a(f.reason),c.terminate()}};if(c.addEventListener("error",u),c.addEventListener("message",h),c.postMessage({id:"init",url:D.GetBabylonScriptURL(this.Configuration.url)}),ArrayBuffer.isView(e)){const d=e.slice();c.postMessage({id:"validate",data:d,rootUrl:t,fileName:n},[d.buffer])}else c.postMessage({id:"validate",data:e,rootUrl:t,fileName:n})}):(this._LoadScriptPromise||(this._LoadScriptPromise=D.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>rn(e,t,n,s)))}}cs.Configuration={url:`${D._DefaultCdnUrl}/gltf_validator.js`};const Fe="Z2xURg",ct={name:"gltf",extensions:{".gltf":{isBinary:!1,mimeType:"model/gltf+json"},".glb":{isBinary:!0,mimeType:"model/gltf-binary"}},canDirectLoad(r){return r.indexOf("asset")!==-1&&r.indexOf("version")!==-1||r.startsWith("data:base64,"+Fe)||r.startsWith("data:;base64,"+Fe)||r.startsWith("data:application/octet-stream;base64,"+Fe)||r.startsWith("data:model/gltf-binary;base64,"+Fe)}};function qn(r,e,t){try{return Promise.resolve(new Uint8Array(r,e,t))}catch(n){return Promise.reject(n)}}function Sr(r,e,t){try{if(e<0||e>=r.byteLength)throw new RangeError("Offset is out of range.");if(e+t>r.byteLength)throw new RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(r.buffer,r.byteOffset+e,t))}catch(n){return Promise.reject(n)}}var tt;(function(r){r[r.AUTO=0]="AUTO",r[r.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(tt||(tt={}));var We;(function(r){r[r.NONE=0]="NONE",r[r.FIRST=1]="FIRST",r[r.ALL=2]="ALL"})(We||(We={}));var ue;(function(r){r[r.LOADING=0]="LOADING",r[r.READY=1]="READY",r[r.COMPLETE=2]="COMPLETE"})(ue||(ue={}));class Pr{constructor(){this.coordinateSystemMode=tt.AUTO,this.animationStartMode=We.FIRST,this.loadNodeAnimations=!0,this.loadSkins=!0,this.loadMorphTargets=!0,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.useGltfTextureNames=!1,this.preprocessUrlAsync=e=>Promise.resolve(e),this.extensionOptions={}}copyFrom(e){e&&(this.onParsed=e.onParsed,this.coordinateSystemMode=e.coordinateSystemMode??this.coordinateSystemMode,this.animationStartMode=e.animationStartMode??this.animationStartMode,this.loadNodeAnimations=e.loadNodeAnimations??this.loadNodeAnimations,this.loadSkins=e.loadSkins??this.loadSkins,this.loadMorphTargets=e.loadMorphTargets??this.loadMorphTargets,this.compileMaterials=e.compileMaterials??this.compileMaterials,this.useClipPlane=e.useClipPlane??this.useClipPlane,this.compileShadowGenerators=e.compileShadowGenerators??this.compileShadowGenerators,this.transparencyAsCoverage=e.transparencyAsCoverage??this.transparencyAsCoverage,this.useRangeRequests=e.useRangeRequests??this.useRangeRequests,this.createInstances=e.createInstances??this.createInstances,this.alwaysComputeBoundingBox=e.alwaysComputeBoundingBox??this.alwaysComputeBoundingBox,this.loadAllMaterials=e.loadAllMaterials??this.loadAllMaterials,this.loadOnlyMaterials=e.loadOnlyMaterials??this.loadOnlyMaterials,this.skipMaterials=e.skipMaterials??this.skipMaterials,this.useSRGBBuffers=e.useSRGBBuffers??this.useSRGBBuffers,this.targetFps=e.targetFps??this.targetFps,this.alwaysComputeSkeletonRootNode=e.alwaysComputeSkeletonRootNode??this.alwaysComputeSkeletonRootNode,this.useGltfTextureNames=e.useGltfTextureNames??this.useGltfTextureNames,this.preprocessUrlAsync=e.preprocessUrlAsync??this.preprocessUrlAsync,this.customRootNode=e.customRootNode,this.onMeshLoaded=e.onMeshLoaded,this.onSkinLoaded=e.onSkinLoaded,this.onTextureLoaded=e.onTextureLoaded,this.onMaterialLoaded=e.onMaterialLoaded,this.onCameraLoaded=e.onCameraLoaded,this.extensionOptions=e.extensionOptions??this.extensionOptions)}}class z extends Pr{constructor(e){super(),this.onParsedObservable=new le,this.onMeshLoadedObservable=new le,this.onSkinLoadedObservable=new le,this.onTextureLoadedObservable=new le,this.onMaterialLoadedObservable=new le,this.onCameraLoadedObservable=new le,this.onCompleteObservable=new le,this.onErrorObservable=new le,this.onDisposeObservable=new le,this.onExtensionLoadedObservable=new le,this.validate=!1,this.onValidatedObservable=new le,this._loader=null,this._state=null,this._requests=new Array,this.name=ct.name,this.extensions=ct.extensions,this.onLoaderStateChangedObservable=new le,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled,this.copyFrom(e)}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),e&&(this._onParsedObserver=this.onParsedObservable.add(e))}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),e&&(this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e))}set onSkinLoaded(e){this._onSkinLoadedObserver&&this.onSkinLoadedObservable.remove(this._onSkinLoadedObserver),e&&(this._onSkinLoadedObserver=this.onSkinLoadedObservable.add(t=>e(t.node,t.skinnedNode)))}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),e&&(this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e))}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),e&&(this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e))}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),e&&(this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e))}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,n,s,o,a,i,l){if(ArrayBuffer.isView(t))return this._loadBinary(e,t,n,s,i,l),null;this._progressCallback=o;const c=t.name||D.GetFilename(t);if(a){if(this.useRangeRequests){this.validate&&P.Warn("glTF validation is not supported when range requests are enabled");const u={abort:()=>{},onCompleteObservable:new le},h={readAsync:(d,f)=>new Promise((p,_)=>{this._loadFile(e,t,A=>{p(new Uint8Array(A))},!0,A=>{_(A)},A=>{A.setRequestHeader("Range",`bytes=${d}-${d+f-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new lt(h)).then(d=>{u.onCompleteObservable.notifyObservers(u),s(d)},i?d=>i(void 0,d):void 0),u}return this._loadFile(e,t,u=>{this._validate(e,new Uint8Array(u,0,u.byteLength),n,c),this._unpackBinaryAsync(new lt({readAsync:(h,d)=>qn(u,h,d),byteLength:u.byteLength})).then(h=>{s(h)},i?h=>i(void 0,h):void 0)},!0,i)}else return this._loadFile(e,t,u=>{try{this._validate(e,u,n,c),s({json:this._parseJson(u)})}catch{i&&i()}},!1,i)}_loadBinary(e,t,n,s,o,a){this._validate(e,new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n,a),this._unpackBinaryAsync(new lt({readAsync:(i,l)=>Sr(t,i,l),byteLength:t.byteLength})).then(i=>{s(i)},o?i=>o(void 0,i):void 0)}importMeshAsync(e,t,n,s,o,a){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(n),this.onParsedObservable.clear(),this._log(`Loading ${a||""}`),this._loader=this._getLoader(n),this._loader.importMeshAsync(e,t,null,n,s,o,a)))}loadAsync(e,t,n,s,o){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,n,s,o)))}loadAssetContainerAsync(e,t,n,s,o){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(t);const a=new qt(e),i=[];this.onMaterialLoadedObservable.add(h=>{i.push(h)});const l=[];this.onTextureLoadedObservable.add(h=>{l.push(h)});const c=[];this.onCameraLoadedObservable.add(h=>{c.push(h)});const u=[];return this.onMeshLoadedObservable.add(h=>{h.morphTargetManager&&u.push(h.morphTargetManager)}),this._loader.importMeshAsync(null,e,a,t,n,s,o).then(h=>(Array.prototype.push.apply(a.geometries,h.geometries),Array.prototype.push.apply(a.meshes,h.meshes),Array.prototype.push.apply(a.particleSystems,h.particleSystems),Array.prototype.push.apply(a.skeletons,h.skeletons),Array.prototype.push.apply(a.animationGroups,h.animationGroups),Array.prototype.push.apply(a.materials,i),Array.prototype.push.apply(a.textures,l),Array.prototype.push.apply(a.lights,h.lights),Array.prototype.push.apply(a.transformNodes,h.transformNodes),Array.prototype.push.apply(a.cameras,c),Array.prototype.push.apply(a.morphTargetManagers,u),a))})}canDirectLoad(e){return ct.canDirectLoad(e)}directLoad(e,t){if(t.startsWith("base64,"+Fe)||t.startsWith(";base64,"+Fe)||t.startsWith("application/octet-stream;base64,"+Fe)||t.startsWith("model/gltf-binary;base64,"+Fe)){const n=ss(t);return this._validate(e,new Uint8Array(n,0,n.byteLength)),this._unpackBinaryAsync(new lt({readAsync:(s,o)=>qn(n,s,o),byteLength:n.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(e){return new z(e[ct.name])}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((e,t)=>{this.onCompleteObservable.addOnce(()=>{e()}),this.onErrorObservable.addOnce(n=>{t(n)})})}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(ue[this._state]))}_loadFile(e,t,n,s,o,a){const i=e._loadFile(t,n,l=>{this._onProgress(l,i)},!0,s,o,a);return i.onCompleteObservable.add(()=>{i._lengthComputable=!0,i._total=i._loaded}),this._requests.push(i),i}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let n=!0,s=0,o=0;for(const a of this._requests){if(a._lengthComputable===void 0||a._loaded===void 0||a._total===void 0)return;n=n&&a._lengthComputable,s+=a._loaded,o+=a._total}this._progressCallback({lengthComputable:n,loaded:s,total:n?o:0})}_validate(e,t,n="",s=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),cs.ValidateAsync(t,n,s,o=>this.preprocessUrlAsync(n+o).then(a=>e._loadFileAsync(a,void 0,!0,!0).then(i=>new Uint8Array(i,0,i.byteLength)))).then(o=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(o),this.onValidatedObservable.clear()},o=>{this._endPerformanceCounter("Validate JSON"),D.Warn(`Failed to validate: ${o.message}`),this.onValidatedObservable.clear()}))}_getLoader(e){const t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);const n=z._parseVersion(t.version);if(!n)throw new Error("Invalid version: "+t.version);if(t.minVersion!==void 0){const a=z._parseVersion(t.minVersion);if(!a)throw new Error("Invalid minimum version: "+t.minVersion);if(z._compareVersion(a,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const o={1:z._CreateGLTF1Loader,2:z._CreateGLTF2Loader}[n.major];if(!o)throw new Error("Unsupported version: "+t.version);return o(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(()=>{const t={Magic:1179937895},n=e.readUint32();if(n!==t.Magic)throw new nr("Unexpected magic: "+n,sr.GLTFLoaderUnexpectedMagicError);const s=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${s}`);const o=e.readUint32();!this.useRangeRequests&&o!==e.buffer.byteLength&&P.Warn(`Length in header does not match actual data length: ${o} != ${e.buffer.byteLength}`);let a;switch(s){case 1:{a=this._unpackBinaryV1Async(e,o);break}case 2:{a=this._unpackBinaryV2Async(e,o);break}default:throw new Error("Unsupported version: "+s)}return this._endPerformanceCounter("Unpack Binary"),a})}_unpackBinaryV1Async(e,t){const n={JSON:0},s=e.readUint32(),o=e.readUint32();if(o!==n.JSON)throw new Error(`Unexpected content format: ${o}`);const a=t-e.byteOffset,i={json:this._parseJson(e.readString(s)),bin:null};if(a!==0){const l=e.byteOffset;i.bin={readAsync:(c,u)=>e.buffer.readAsync(l+c,u),byteLength:a}}return Promise.resolve(i)}_unpackBinaryV2Async(e,t){const n={JSON:1313821514,BIN:5130562},s=e.readUint32();if(e.readUint32()!==n.JSON)throw new Error("First chunk format is not JSON");return e.byteOffset+s===t?e.loadAsync(s).then(()=>({json:this._parseJson(e.readString(s)),bin:null})):e.loadAsync(s+8).then(()=>{const a={json:this._parseJson(e.readString(s)),bin:null},i=()=>{const l=e.readUint32();switch(e.readUint32()){case n.JSON:throw new Error("Unexpected JSON chunk");case n.BIN:{const u=e.byteOffset;a.bin={readAsync:(h,d)=>e.buffer.readAsync(u+h,d),byteLength:l},e.skipBytes(l);break}default:{e.skipBytes(l);break}}return e.byteOffset!==t?e.loadAsync(8).then(i):Promise.resolve(a)};return i()})}static _parseVersion(e){if(e==="1.0"||e==="1.0.1")return{major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const t=z._logSpaces.substring(0,this._logIndentLevel*2);P.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){D.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){D.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}z.IncrementalLoading=!0;z.HomogeneousCoordinates=!1;z._logSpaces="                                ";jt(new z);var Oe;(function(r){r[r.BYTE=5120]="BYTE",r[r.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",r[r.SHORT=5122]="SHORT",r[r.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",r[r.FLOAT=5126]="FLOAT"})(Oe||(Oe={}));var ft;(function(r){r[r.FRAGMENT=35632]="FRAGMENT",r[r.VERTEX=35633]="VERTEX"})(ft||(ft={}));var ce;(function(r){r[r.BYTE=5120]="BYTE",r[r.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",r[r.SHORT=5122]="SHORT",r[r.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",r[r.INT=5124]="INT",r[r.UNSIGNED_INT=5125]="UNSIGNED_INT",r[r.FLOAT=5126]="FLOAT",r[r.FLOAT_VEC2=35664]="FLOAT_VEC2",r[r.FLOAT_VEC3=35665]="FLOAT_VEC3",r[r.FLOAT_VEC4=35666]="FLOAT_VEC4",r[r.INT_VEC2=35667]="INT_VEC2",r[r.INT_VEC3=35668]="INT_VEC3",r[r.INT_VEC4=35669]="INT_VEC4",r[r.BOOL=35670]="BOOL",r[r.BOOL_VEC2=35671]="BOOL_VEC2",r[r.BOOL_VEC3=35672]="BOOL_VEC3",r[r.BOOL_VEC4=35673]="BOOL_VEC4",r[r.FLOAT_MAT2=35674]="FLOAT_MAT2",r[r.FLOAT_MAT3=35675]="FLOAT_MAT3",r[r.FLOAT_MAT4=35676]="FLOAT_MAT4",r[r.SAMPLER_2D=35678]="SAMPLER_2D"})(ce||(ce={}));var qe;(function(r){r[r.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",r[r.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",r[r.REPEAT=10497]="REPEAT"})(qe||(qe={}));var ye;(function(r){r[r.NEAREST=9728]="NEAREST",r[r.LINEAR=9728]="LINEAR",r[r.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",r[r.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",r[r.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",r[r.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(ye||(ye={}));var on;(function(r){r[r.ALPHA=6406]="ALPHA",r[r.RGB=6407]="RGB",r[r.RGBA=6408]="RGBA",r[r.LUMINANCE=6409]="LUMINANCE",r[r.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"})(on||(on={}));var pt;(function(r){r[r.FRONT=1028]="FRONT",r[r.BACK=1029]="BACK",r[r.FRONT_AND_BACK=1032]="FRONT_AND_BACK"})(pt||(pt={}));var j;(function(r){r[r.ZERO=0]="ZERO",r[r.ONE=1]="ONE",r[r.SRC_COLOR=768]="SRC_COLOR",r[r.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",r[r.DST_COLOR=774]="DST_COLOR",r[r.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",r[r.SRC_ALPHA=770]="SRC_ALPHA",r[r.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",r[r.DST_ALPHA=772]="DST_ALPHA",r[r.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",r[r.CONSTANT_COLOR=32769]="CONSTANT_COLOR",r[r.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",r[r.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",r[r.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",r[r.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"})(j||(j={}));class J{static SetMatrix(e,t,n,s,o){let a=null;if(n.semantic==="MODEL"?a=t.getWorldMatrix():n.semantic==="PROJECTION"?a=e.getProjectionMatrix():n.semantic==="VIEW"?a=e.getViewMatrix():n.semantic==="MODELVIEWINVERSETRANSPOSE"?a=se.Transpose(t.getWorldMatrix().multiply(e.getViewMatrix()).invert()):n.semantic==="MODELVIEW"?a=t.getWorldMatrix().multiply(e.getViewMatrix()):n.semantic==="MODELVIEWPROJECTION"?a=t.getWorldMatrix().multiply(e.getTransformMatrix()):n.semantic==="MODELINVERSE"?a=t.getWorldMatrix().invert():n.semantic==="VIEWINVERSE"?a=e.getViewMatrix().invert():n.semantic==="PROJECTIONINVERSE"?a=e.getProjectionMatrix().invert():n.semantic==="MODELVIEWINVERSE"?a=t.getWorldMatrix().multiply(e.getViewMatrix()).invert():n.semantic==="MODELVIEWPROJECTIONINVERSE"?a=t.getWorldMatrix().multiply(e.getTransformMatrix()).invert():n.semantic==="MODELINVERSETRANSPOSE"&&(a=se.Transpose(t.getWorldMatrix().invert())),a)switch(n.type){case ce.FLOAT_MAT2:o.setMatrix2x2(s,se.GetAsMatrix2x2(a));break;case ce.FLOAT_MAT3:o.setMatrix3x3(s,se.GetAsMatrix3x3(a));break;case ce.FLOAT_MAT4:o.setMatrix(s,a);break}}static SetUniform(e,t,n,s){switch(s){case ce.FLOAT:return e.setFloat(t,n),!0;case ce.FLOAT_VEC2:return e.setVector2(t,ge.FromArray(n)),!0;case ce.FLOAT_VEC3:return e.setVector3(t,N.FromArray(n)),!0;case ce.FLOAT_VEC4:return e.setVector4(t,rr.FromArray(n)),!0;default:return!1}}static GetWrapMode(e){switch(e){case qe.CLAMP_TO_EDGE:return q.CLAMP_ADDRESSMODE;case qe.MIRRORED_REPEAT:return q.MIRROR_ADDRESSMODE;case qe.REPEAT:return q.WRAP_ADDRESSMODE;default:return q.WRAP_ADDRESSMODE}}static GetByteStrideFromType(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(e){switch(e){case ye.LINEAR:case ye.LINEAR_MIPMAP_NEAREST:case ye.LINEAR_MIPMAP_LINEAR:return q.TRILINEAR_SAMPLINGMODE;case ye.NEAREST:case ye.NEAREST_MIPMAP_NEAREST:return q.NEAREST_SAMPLINGMODE;default:return q.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(e,t,n,s,o){n=t.byteOffset+n;const a=e.loadedBufferViews[t.buffer];if(n+s>a.byteLength)throw new Error("Buffer access is out of range");const i=a.buffer;switch(n+=a.byteOffset,o){case Oe.BYTE:return new Int8Array(i,n,s);case Oe.UNSIGNED_BYTE:return new Uint8Array(i,n,s);case Oe.SHORT:return new Int16Array(i,n,s);case Oe.UNSIGNED_SHORT:return new Uint16Array(i,n,s);default:return new Float32Array(i,n,s)}}static GetBufferFromAccessor(e,t){const n=e.bufferViews[t.bufferView],s=t.count*J.GetByteStrideFromType(t);return J.GetBufferFromBufferView(e,n,t.byteOffset,s,t.componentType)}static DecodeBufferToText(e){let t="";const n=e.byteLength;for(let s=0;s<n;++s)t+=String.fromCharCode(e[s]);return t}static GetDefaultMaterial(e){if(!J._DefaultMaterial){De.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),De.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);const t={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},n={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};J._DefaultMaterial=new rs("GLTFDefaultMaterial",e,t,n),J._DefaultMaterial.setColor4("u_emission",new Ue(.5,.5,.5,1))}return J._DefaultMaterial}}J._DefaultMaterial=null;var Le;(function(r){r[r.IDENTIFIER=1]="IDENTIFIER",r[r.UNKNOWN=2]="UNKNOWN",r[r.END_OF_INPUT=3]="END_OF_INPUT"})(Le||(Le={}));class jn{constructor(e){this._pos=0,this.currentToken=Le.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return Le.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=Le.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=Le.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}}const us=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],hs=["world","view","projection","worldView","worldViewProjection","mBones"],Fr=["translation","rotation","scale"],Lr=["position","rotationQuaternion","scaling"],kr=(r,e)=>{for(const t in r){const n=r[t];e.buffers[t]=n,e.buffersCount++}},Br=(r,e)=>{for(const t in r){const n=r[t];e.shaders[t]=n,e.shaderscount++}},ie=(r,e,t)=>{for(const n in r){const s=r[n];t[e][n]=s}},Rr=r=>{if(r)for(let e=0;e<r.length/2;e++)r[e*2+1]=1-r[e*2+1]},Yn=r=>{if(r.semantic==="NORMAL")return"normal";if(r.semantic==="POSITION")return"position";if(r.semantic==="JOINT")return"matricesIndices";if(r.semantic==="WEIGHT")return"matricesWeights";if(r.semantic==="COLOR")return"color";if(r.semantic&&r.semantic.indexOf("TEXCOORD_")!==-1){const e=Number(r.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},Gr=r=>{for(const e in r.animations){const t=r.animations[e];if(!t.channels||!t.samplers)continue;let n=null;for(let s=0;s<t.channels.length;s++){const o=t.channels[s],a=t.samplers[o.sampler];if(!a)continue;let i=null,l=null;t.parameters?(i=t.parameters[a.input],l=t.parameters[a.output]):(i=a.input,l=a.output);const c=J.GetBufferFromAccessor(r,r.accessors[i]),u=J.GetBufferFromAccessor(r,r.accessors[l]),h=o.target.id;let d=r.scene.getNodeById(h);if(d===null&&(d=r.scene.getNodeByName(h)),d===null){D.Warn("Creating animation named "+e+". But cannot find node named "+h+" to attach to");continue}const f=d instanceof ot;let p=o.target.path;const _=Fr.indexOf(p);_!==-1&&(p=Lr[_]);let A=O.ANIMATIONTYPE_MATRIX;f||(p==="rotationQuaternion"?(A=O.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new te):A=O.ANIMATIONTYPE_VECTOR3);let v=null;const F=[];let M=0,x=!1;f&&n&&n.getKeys().length===c.length&&(v=n,x=!0),x||(r.scene._blockEntityCollection=!!r.assetContainer,v=new O(e,f?"_matrix":p,1,A,O.ANIMATIONLOOPMODE_CYCLE),r.scene._blockEntityCollection=!1);for(let T=0;T<c.length;T++){let I=null;if(p==="rotationQuaternion"?(I=te.FromArray([u[M],u[M+1],u[M+2],u[M+3]]),M+=4):(I=N.FromArray([u[M],u[M+1],u[M+2]]),M+=3),f){const g=d;let E=N.Zero(),G=new te,V=N.Zero(),$=g.getBaseMatrix();x&&n&&($=n.getKeys()[T].value),$.decompose(V,G,E),p==="position"?E=I:p==="rotationQuaternion"?G=I:V=I,I=se.Compose(V,G,E)}x?n&&(n.getKeys()[T].value=I):F.push({frame:c[T],value:I})}!x&&v&&(v.setKeys(F),d.animations.push(v)),n=v,r.scene.stopAnimation(d),r.scene.beginAnimation(d,0,c[c.length-1],!0,1)}}},fn=r=>{let e=null;if(r.translation||r.rotation||r.scale){const t=N.FromArray(r.scale||[1,1,1]),n=te.FromArray(r.rotation||[0,0,0,1]),s=N.FromArray(r.translation||[0,0,0]);e=se.Compose(t,n,s)}else e=se.FromArray(r.matrix);return e},ds=(r,e,t,n)=>{for(let o=0;o<n.bones.length;o++)if(n.bones[o].name===t)return n.bones[o];const s=r.nodes;for(const o in s){const a=s[o];if(!a.jointName)continue;const i=a.children;for(let l=0;l<i.length;l++){const c=r.nodes[i[l]];if(c.jointName&&c.jointName===t){const u=fn(a),h=new ot(a.name||"",n,ds(r,e,a.jointName,n),u);return h.id=o,h}}}return null},Dr=(r,e)=>{for(let t=0;t<r.length;t++){const n=r[t];for(let s=0;s<n.node.children.length;s++)if(n.node.children[s]===e)return n.bone}return null},zt=(r,e)=>{const t=r.nodes;let n=t[e];if(n)return{node:n,id:e};for(const s in t)if(n=t[s],n.jointName===e)return{node:n,id:s};return null},Vr=(r,e)=>{for(let t=0;t<r.jointNames.length;t++)if(r.jointNames[t]===e)return!0;return!1},$r=(r,e,t,n)=>{for(const s in r.nodes){const o=r.nodes[s],a=s;if(!o.jointName||Vr(t,o.jointName))continue;const i=fn(o),l=new ot(o.name||"",e,null,i);l.id=a,n.push({bone:l,node:o,id:a})}for(let s=0;s<n.length;s++){const o=n[s],a=o.node.children;for(let i=0;i<a.length;i++){let l=null;for(let c=0;c<n.length;c++)if(n[c].id===a[i]){l=n[c];break}l&&(l.bone._parent=o.bone,o.bone.children.push(l.bone))}}},Hr=(r,e,t,n)=>{if(n||(n=new un(e.name||"","",r.scene)),!e.babylonSkeleton)return n;const s=[],o=[];$r(r,n,e,s),n.bones=[];for(let i=0;i<e.jointNames.length;i++){const l=zt(r,e.jointNames[i]);if(!l)continue;const c=l.node;if(!c){D.Warn("Joint named "+e.jointNames[i]+" does not exist");continue}const u=l.id,h=r.scene.getBoneById(u);if(h){n.bones.push(h);continue}let d=!1,f=null;for(let A=0;A<i;A++){const v=zt(r,e.jointNames[A]);if(!v)continue;const F=v.node;if(!F){D.Warn("Joint named "+e.jointNames[A]+" does not exist when looking for parent");continue}const M=F.children;if(M){d=!1;for(let x=0;x<M.length;x++)if(M[x]===u){f=ds(r,e,e.jointNames[A],n),d=!0;break}if(d)break}}const p=fn(c);!f&&s.length>0&&(f=Dr(s,u),f&&o.indexOf(f)===-1&&o.push(f));const _=new ot(c.jointName||"",n,f,p);_.id=u}const a=n.bones;n.bones=[];for(let i=0;i<e.jointNames.length;i++){const l=zt(r,e.jointNames[i]);if(l){for(let c=0;c<a.length;c++)if(a[c].id===l.id){n.bones.push(a[c]);break}}}n.prepare();for(let i=0;i<o.length;i++)n.bones.push(o[i]);return n},Zn=(r,e,t,n,s)=>{if(s||(r.scene._blockEntityCollection=!!r.assetContainer,s=new Ee(e.name||"",r.scene),s._parentContainer=r.assetContainer,r.scene._blockEntityCollection=!1,s.id=n),!e.babylonNode)return s;const o=[];let a=null;const i=[],l=[],c=[],u=[];for(let f=0;f<t.length;f++){const p=t[f],_=r.meshes[p];if(_)for(let A=0;A<_.primitives.length;A++){const v=new ht,F=_.primitives[A];F.mode;const M=F.attributes;let x=null,T=null;for(const g in M)if(x=r.accessors[M[g]],T=J.GetBufferFromAccessor(r,x),g==="NORMAL")v.normals=new Float32Array(T.length),v.normals.set(T);else if(g==="POSITION"){if(z.HomogeneousCoordinates){v.positions=new Float32Array(T.length-T.length/4);for(let E=0;E<T.length;E+=4)v.positions[E]=T[E],v.positions[E+1]=T[E+1],v.positions[E+2]=T[E+2]}else v.positions=new Float32Array(T.length),v.positions.set(T);l.push(v.positions.length)}else if(g.indexOf("TEXCOORD_")!==-1){const E=Number(g.split("_")[1]),G=S.UVKind+(E===0?"":E+1),V=new Float32Array(T.length);V.set(T),Rr(V),v.set(V,G)}else g==="JOINT"?(v.matricesIndices=new Float32Array(T.length),v.matricesIndices.set(T)):g==="WEIGHT"?(v.matricesWeights=new Float32Array(T.length),v.matricesWeights.set(T)):g==="COLOR"&&(v.colors=new Float32Array(T.length),v.colors.set(T));if(x=r.accessors[F.indices],x)T=J.GetBufferFromAccessor(r,x),v.indices=new Int32Array(T.length),v.indices.set(T),u.push(v.indices.length);else{const g=[];for(let E=0;E<v.positions.length/3;E++)g.push(E);v.indices=new Int32Array(g),u.push(v.indices.length)}a?a.merge(v):a=v;const I=r.scene.getMaterialById(F.material);o.push(I===null?J.GetDefaultMaterial(r.scene):I),i.push(i.length===0?0:i[i.length-1]+l[l.length-2]),c.push(c.length===0?0:c[c.length-1]+u[u.length-2])}}let h;r.scene._blockEntityCollection=!!r.assetContainer,o.length>1?(h=new or("multimat"+n,r.scene),h.subMaterials=o):h=new Ye("multimat"+n,r.scene),o.length===1&&(h=o[0]),h._parentContainer=r.assetContainer,s.material||(s.material=h),new dt(n,r.scene,a,!1,s),s.computeWorldMatrix(!0),r.scene._blockEntityCollection=!1,s.subMeshes=[];let d=0;for(let f=0;f<t.length;f++){const p=t[f],_=r.meshes[p];if(_)for(let A=0;A<_.primitives.length;A++)_.primitives[A].mode,ar.AddToMesh(d,i[d],l[d],c[d],u[d],s,s,!0),d++}return s},an=(r,e,t,n)=>{r.position&&(r.position=e),(r.rotationQuaternion||r.rotation)&&(r.rotationQuaternion=t),r.scaling&&(r.scaling=n)},Kr=(r,e)=>{if(e.matrix){const t=new N(0,0,0),n=new te,s=new N(0,0,0);se.FromArray(e.matrix).decompose(s,n,t),an(r,t,n,s)}else e.translation&&e.rotation&&e.scale&&an(r,N.FromArray(e.translation),te.FromArray(e.rotation),N.FromArray(e.scale));r.computeWorldMatrix(!0)},Ur=(r,e,t)=>{let n=null;if(r.importOnlyMeshes&&(e.skin||e.meshes)&&r.importMeshesNames&&r.importMeshesNames.length>0&&r.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){const s=r.skins[e.skin],o=Zn(r,e,e.meshes,t,e.babylonNode);o.skeleton=r.scene.getLastSkeletonById(e.skin),o.skeleton===null&&(o.skeleton=Hr(r,s,o,s.babylonSkeleton),s.babylonSkeleton||(s.babylonSkeleton=o.skeleton)),n=o}}else if(e.meshes)n=Zn(r,e,e.mesh?[e.mesh]:e.meshes,t,e.babylonNode);else if(e.light&&!e.babylonNode&&!r.importOnlyMeshes){const s=r.lights[e.light];if(s){if(s.type==="ambient"){const o=s[s.type],a=new as(e.light,N.Zero(),r.scene);a.name=e.name||"",o.color&&(a.diffuse=B.FromArray(o.color)),n=a}else if(s.type==="directional"){const o=s[s.type],a=new hn(e.light,N.Zero(),r.scene);a.name=e.name||"",o.color&&(a.diffuse=B.FromArray(o.color)),n=a}else if(s.type==="point"){const o=s[s.type],a=new dn(e.light,N.Zero(),r.scene);a.name=e.name||"",o.color&&(a.diffuse=B.FromArray(o.color)),n=a}else if(s.type==="spot"){const o=s[s.type],a=new we(e.light,N.Zero(),N.Zero(),0,0,r.scene);a.name=e.name||"",o.color&&(a.diffuse=B.FromArray(o.color)),o.fallOfAngle&&(a.angle=o.fallOfAngle),o.fallOffExponent&&(a.exponent=o.fallOffExponent),n=a}}}else if(e.camera&&!e.babylonNode&&!r.importOnlyMeshes){const s=r.cameras[e.camera];if(s){if(r.scene._blockEntityCollection=!!r.assetContainer,s.type==="orthographic"){const o=new nn(e.camera,N.Zero(),r.scene,!1);o.name=e.name||"",o.mode=is.ORTHOGRAPHIC_CAMERA,o.attachControl(),n=o,o._parentContainer=r.assetContainer}else if(s.type==="perspective"){const o=s[s.type],a=new nn(e.camera,N.Zero(),r.scene,!1);a.name=e.name||"",a.attachControl(),o.aspectRatio||(o.aspectRatio=r.scene.getEngine().getRenderWidth()/r.scene.getEngine().getRenderHeight()),o.znear&&o.zfar&&(a.maxZ=o.zfar,a.minZ=o.znear),n=a,a._parentContainer=r.assetContainer}r.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(n===null){r.scene._blockEntityCollection=!!r.assetContainer;const s=new Ee(e.name||"",r.scene);s._parentContainer=r.assetContainer,r.scene._blockEntityCollection=!1,e.babylonNode=s,n=s}}if(n!==null){if(e.matrix&&n instanceof Ee)Kr(n,e);else{const s=e.translation||[0,0,0],o=e.rotation||[0,0,0,1],a=e.scale||[1,1,1];an(n,N.FromArray(s),te.FromArray(o),N.FromArray(a))}n.updateCache(!0),e.babylonNode=n}return n},nt=(r,e,t,n=!1)=>{const s=r.nodes[e];let o=null;if(r.importOnlyMeshes&&!n&&r.importMeshesNames?r.importMeshesNames.indexOf(s.name||"")!==-1||r.importMeshesNames.length===0?n=!0:n=!1:n=!0,!s.jointName&&n&&(o=Ur(r,s,e),o!==null&&(o.id=e,o.parent=t)),s.children)for(let a=0;a<s.children.length;a++)nt(r,s.children[a],o,n)},Xn=r=>{let e=r.currentScene;if(e)for(let t=0;t<e.nodes.length;t++)nt(r,e.nodes[t],null);else for(const t in r.scenes){e=r.scenes[t];for(let n=0;n<e.nodes.length;n++)nt(r,e.nodes[n],null)}Gr(r);for(let t=0;t<r.scene.skeletons.length;t++){const n=r.scene.skeletons[t];r.scene.beginAnimation(n,0,Number.MAX_VALUE,!0,1)}},Wr=(r,e,t,n,s,o,a)=>{const i=o.values||s.parameters;for(const l in t){const c=t[l],u=c.type;if(u===ce.FLOAT_MAT2||u===ce.FLOAT_MAT3||u===ce.FLOAT_MAT4){if(c.semantic&&!c.source&&!c.node)J.SetMatrix(e.scene,r,c,l,n.getEffect());else if(c.semantic&&(c.source||c.node)){let h=e.scene.getNodeByName(c.source||c.node||"");if(h===null&&(h=e.scene.getNodeById(c.source||c.node||"")),h===null)continue;J.SetMatrix(e.scene,h,c,l,n.getEffect())}}else{const h=i[s.uniforms[l]];if(!h)continue;if(u===ce.SAMPLER_2D){const d=e.textures[o.values?h:c.value].babylonTexture;if(d==null)continue;n.getEffect().setTexture(l,d)}else J.SetUniform(n.getEffect(),l,h,u)}}a(n)},qr=(r,e,t,n,s)=>{const o=n.values||t.parameters,a=t.uniforms;for(const i in s){const l=s[i],c=l.type;let u=o[a[i]];if(u===void 0&&(u=l.value),!u)continue;const h=d=>f=>{l.value&&d&&(e.setTexture(d,f),delete s[d])};c===ce.SAMPLER_2D?Q.LoadTextureAsync(r,n.values?u:l.value,h(i),()=>h(null)):l.value&&J.SetUniform(e,i,n.values?u:l.value,c)&&delete s[i]}},jr=(r,e,t)=>(n,s)=>{e.dispose(!0),t("Cannot compile program named "+r.name+". Error: "+s+". Default material will be applied")},Yr=(r,e,t,n,s,o)=>a=>{qr(r,e,t,n,s),e.onBind=i=>{Wr(i,r,s,e,t,n,o)}},Jn=(r,e,t)=>{for(const n in e.uniforms){const s=e.uniforms[n],o=e.parameters[s];if(r.currentIdentifier===n&&o.semantic&&!o.source&&!o.node){const a=us.indexOf(o.semantic);if(a!==-1)return delete t[n],hs[a]}}return r.currentIdentifier},Qn=r=>{for(const e in r.materials)Q.LoadMaterialAsync(r,e,()=>{},()=>{})};class ve{static CreateRuntime(e,t,n){const s={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:n,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&ie(e.extensions,"extensions",s),e.extensionsUsed&&ie(e.extensionsUsed,"extensionsUsed",s),e.buffers&&kr(e.buffers,s),e.bufferViews&&ie(e.bufferViews,"bufferViews",s),e.accessors&&ie(e.accessors,"accessors",s),e.meshes&&ie(e.meshes,"meshes",s),e.lights&&ie(e.lights,"lights",s),e.cameras&&ie(e.cameras,"cameras",s),e.nodes&&ie(e.nodes,"nodes",s),e.images&&ie(e.images,"images",s),e.textures&&ie(e.textures,"textures",s),e.shaders&&Br(e.shaders,s),e.programs&&ie(e.programs,"programs",s),e.samplers&&ie(e.samplers,"samplers",s),e.techniques&&ie(e.techniques,"techniques",s),e.materials&&ie(e.materials,"materials",s),e.animations&&ie(e.animations,"animations",s),e.skins&&ie(e.skins,"skins",s),e.scenes&&(s.scenes=e.scenes),e.scene&&e.scenes&&(s.currentScene=e.scenes[e.scene]),s}static LoadBufferAsync(e,t,n,s,o){const a=e.buffers[t];D.IsBase64(a.uri)?setTimeout(()=>n(new Uint8Array(D.DecodeBase64(a.uri)))):D.LoadFile(e.rootUrl+a.uri,i=>n(new Uint8Array(i)),o,void 0,!0,i=>{i&&s(i.status+" "+i.statusText)})}static LoadTextureBufferAsync(e,t,n,s){const o=e.textures[t];if(!o||!o.source){s("");return}if(o.babylonTexture){n(null);return}const a=e.images[o.source];D.IsBase64(a.uri)?setTimeout(()=>n(new Uint8Array(D.DecodeBase64(a.uri)))):D.LoadFile(e.rootUrl+a.uri,i=>n(new Uint8Array(i)),void 0,void 0,!0,i=>{i&&s(i.status+" "+i.statusText)})}static CreateTextureAsync(e,t,n,s){const o=e.textures[t];if(o.babylonTexture){s(o.babylonTexture);return}const a=e.samplers[o.sampler],i=a.minFilter===ye.NEAREST_MIPMAP_NEAREST||a.minFilter===ye.NEAREST_MIPMAP_LINEAR||a.minFilter===ye.LINEAR_MIPMAP_NEAREST||a.minFilter===ye.LINEAR_MIPMAP_LINEAR,l=q.BILINEAR_SAMPLINGMODE,c=n==null?new Blob:new Blob([n]),u=URL.createObjectURL(c),h=()=>URL.revokeObjectURL(u),d=new q(u,e.scene,!i,!0,l,h,h);a.wrapS!==void 0&&(d.wrapU=J.GetWrapMode(a.wrapS)),a.wrapT!==void 0&&(d.wrapV=J.GetWrapMode(a.wrapT)),d.name=t,o.babylonTexture=d,s(d)}static LoadShaderStringAsync(e,t,n,s){const o=e.shaders[t];if(D.IsBase64(o.uri)){const a=atob(o.uri.split(",")[1]);n&&n(a)}else D.LoadFile(e.rootUrl+o.uri,n,void 0,void 0,!1,a=>{a&&s&&s(a.status+" "+a.statusText)})}static LoadMaterialAsync(e,t,n,s){const o=e.materials[t];if(!o.technique){s&&s("No technique found.");return}const a=e.techniques[o.technique];if(!a){e.scene._blockEntityCollection=!!e.assetContainer;const I=new Ye(t,e.scene);I._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,I.diffuseColor=new B(.5,.5,.5),I.sideOrientation=_e.CounterClockWiseSideOrientation,n(I);return}const i=e.programs[a.program],l=a.states,c=De.ShadersStore[i.vertexShader+"VertexShader"],u=De.ShadersStore[i.fragmentShader+"PixelShader"];let h="",d="";const f=new jn(c),p=new jn(u),_={},A=[],v=[],F=[];for(const I in a.uniforms){const g=a.uniforms[I],E=a.parameters[g];if(_[I]=E,E.semantic&&!E.node&&!E.source){const G=us.indexOf(E.semantic);G!==-1?(A.push(hs[G]),delete _[I]):A.push(I)}else E.type===ce.SAMPLER_2D?F.push(I):A.push(I)}for(const I in a.attributes){const g=a.attributes[I],E=a.parameters[g];if(E.semantic){const G=Yn(E);G&&v.push(G)}}for(;!f.isEnd()&&f.getNextToken();){if(f.currentToken!==Le.IDENTIFIER){h+=f.currentString;continue}let g=!1;for(const E in a.attributes){const G=a.attributes[E],V=a.parameters[G];if(f.currentIdentifier===E&&V.semantic){h+=Yn(V),g=!0;break}}g||(h+=Jn(f,a,_))}for(;!p.isEnd()&&p.getNextToken();){if(p.currentToken!==Le.IDENTIFIER){d+=p.currentString;continue}d+=Jn(p,a,_)}const M={vertex:i.vertexShader+t,fragment:i.fragmentShader+t},x={attributes:v,uniforms:A,samplers:F,needAlphaBlending:l&&l.enable&&l.enable.indexOf(3042)!==-1};De.ShadersStore[i.vertexShader+t+"VertexShader"]=h,De.ShadersStore[i.fragmentShader+t+"PixelShader"]=d;const T=new rs(t,e.scene,M,x);if(T.onError=jr(i,T,s),T.onCompiled=Yr(e,T,a,o,_,n),T.sideOrientation=_e.CounterClockWiseSideOrientation,l&&l.functions){const I=l.functions;I.cullFace&&I.cullFace[0]!==pt.BACK&&(T.backFaceCulling=!1);const g=I.blendFuncSeparate;g&&(g[0]===j.SRC_ALPHA&&g[1]===j.ONE_MINUS_SRC_ALPHA&&g[2]===j.ONE&&g[3]===j.ONE?T.alphaMode=Me.ALPHA_COMBINE:g[0]===j.ONE&&g[1]===j.ONE&&g[2]===j.ZERO&&g[3]===j.ONE?T.alphaMode=Me.ALPHA_ONEONE:g[0]===j.SRC_ALPHA&&g[1]===j.ONE&&g[2]===j.ZERO&&g[3]===j.ONE?T.alphaMode=Me.ALPHA_ADD:g[0]===j.ZERO&&g[1]===j.ONE_MINUS_SRC_COLOR&&g[2]===j.ONE&&g[3]===j.ONE?T.alphaMode=Me.ALPHA_SUBTRACT:g[0]===j.DST_COLOR&&g[1]===j.ZERO&&g[2]===j.ONE&&g[3]===j.ONE?T.alphaMode=Me.ALPHA_MULTIPLY:g[0]===j.SRC_ALPHA&&g[1]===j.ONE_MINUS_SRC_COLOR&&g[2]===j.ONE&&g[3]===j.ONE&&(T.alphaMode=Me.ALPHA_MAXIMIZED))}}}let $e=class ln{static RegisterExtension(e){if(ln.Extensions[e.name]){D.Error('Tool with the same name "'+e.name+'" already exists');return}ln.Extensions[e.name]=e}dispose(){}_importMeshAsync(e,t,n,s,o,a,i,l){return t.useRightHandedSystem=!0,Q.LoadRuntimeAsync(t,n,s,c=>{c.assetContainer=o,c.importOnlyMeshes=!0,e===""?c.importMeshesNames=[]:typeof e=="string"?c.importMeshesNames=[e]:e&&!(e instanceof Array)?c.importMeshesNames=[e]:(c.importMeshesNames=[],D.Warn("Argument meshesNames must be of type string or string[]")),this._createNodes(c);const u=[],h=[];for(const d in c.nodes){const f=c.nodes[d];f.babylonNode instanceof os&&u.push(f.babylonNode)}for(const d in c.skins){const f=c.skins[d];f.babylonSkeleton instanceof un&&h.push(f.babylonSkeleton)}this._loadBuffersAsync(c,()=>{this._loadShadersAsync(c,()=>{Qn(c),Xn(c),!z.IncrementalLoading&&a&&a(u,h)})}),z.IncrementalLoading&&a&&a(u,h)},l),!0}importMeshAsync(e,t,n,s,o,a){return new Promise((i,l)=>{this._importMeshAsync(e,t,s,o,n,(c,u)=>{i({meshes:c,particleSystems:[],skeletons:u,animationGroups:[],lights:[],transformNodes:[],geometries:[],spriteManagers:[]})},a,c=>{l(new Error(c))})})}_loadAsync(e,t,n,s,o,a){e.useRightHandedSystem=!0,Q.LoadRuntimeAsync(e,t,n,i=>{Q.LoadRuntimeExtensionsAsync(i,()=>{this._createNodes(i),this._loadBuffersAsync(i,()=>{this._loadShadersAsync(i,()=>{Qn(i),Xn(i),z.IncrementalLoading||s()})}),z.IncrementalLoading&&s()},a)},a)}loadAsync(e,t,n,s){return new Promise((o,a)=>{this._loadAsync(e,t,n,()=>{o()},s,i=>{a(new Error(i))})})}_loadShadersAsync(e,t){let n=!1;const s=(o,a)=>{Q.LoadShaderStringAsync(e,o,i=>{i instanceof ArrayBuffer||(e.loadedShaderCount++,i&&(De.ShadersStore[o+(a.type===ft.VERTEX?"VertexShader":"PixelShader")]=i),e.loadedShaderCount===e.shaderscount&&t())},()=>{D.Error("Error when loading shader program named "+o+" located at "+a.uri)})};for(const o in e.shaders){n=!0;const a=e.shaders[o];a?s.bind(this,o,a)():D.Error("No shader named: "+o)}n||t()}_loadBuffersAsync(e,t){let n=!1;const s=(o,a)=>{Q.LoadBufferAsync(e,o,i=>{e.loadedBufferCount++,i&&(i.byteLength!=e.buffers[o].byteLength&&D.Error("Buffer named "+o+" is length "+i.byteLength+". Expected: "+a.byteLength),e.loadedBufferViews[o]=i),e.loadedBufferCount===e.buffersCount&&t()},()=>{D.Error("Error when loading buffer named "+o+" located at "+a.uri)})};for(const o in e.buffers){n=!0;const a=e.buffers[o];a?s.bind(this,o,a)():D.Error("No buffer named: "+o)}n||t()}_createNodes(e){let t=e.currentScene;if(t)for(let n=0;n<t.nodes.length;n++)nt(e,t.nodes[n],null);else for(const n in e.scenes){t=e.scenes[n];for(let s=0;s<t.nodes.length;s++)nt(e,t.nodes[s],null)}}};$e.Extensions={};class Q{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,n,s,o){return!1}loadRuntimeExtensionsAsync(e,t,n){return!1}loadBufferAsync(e,t,n,s,o){return!1}loadTextureBufferAsync(e,t,n,s){return!1}createTextureAsync(e,t,n,s,o){return!1}loadShaderStringAsync(e,t,n,s){return!1}loadMaterialAsync(e,t,n,s){return!1}static LoadRuntimeAsync(e,t,n,s,o){Q._ApplyExtensions(a=>a.loadRuntimeAsync(e,t,n,s,o),()=>{setTimeout(()=>{s&&s(ve.CreateRuntime(t.json,e,n))})})}static LoadRuntimeExtensionsAsync(e,t,n){Q._ApplyExtensions(s=>s.loadRuntimeExtensionsAsync(e,t,n),()=>{setTimeout(()=>{t()})})}static LoadBufferAsync(e,t,n,s,o){Q._ApplyExtensions(a=>a.loadBufferAsync(e,t,n,s,o),()=>{ve.LoadBufferAsync(e,t,n,s,o)})}static LoadTextureAsync(e,t,n,s){Q._LoadTextureBufferAsync(e,t,o=>{o&&Q._CreateTextureAsync(e,t,o,n,s)},s)}static LoadShaderStringAsync(e,t,n,s){Q._ApplyExtensions(o=>o.loadShaderStringAsync(e,t,n,s),()=>{ve.LoadShaderStringAsync(e,t,n,s)})}static LoadMaterialAsync(e,t,n,s){Q._ApplyExtensions(o=>o.loadMaterialAsync(e,t,n,s),()=>{ve.LoadMaterialAsync(e,t,n,s)})}static _LoadTextureBufferAsync(e,t,n,s){Q._ApplyExtensions(o=>o.loadTextureBufferAsync(e,t,n,s),()=>{ve.LoadTextureBufferAsync(e,t,n,s)})}static _CreateTextureAsync(e,t,n,s,o){Q._ApplyExtensions(a=>a.createTextureAsync(e,t,n,s,o),()=>{ve.CreateTextureAsync(e,t,n,s)})}static _ApplyExtensions(e,t){for(const n in $e.Extensions){const s=$e.Extensions[n];if(e(s))return}t()}}z._CreateGLTF1Loader=()=>new $e;const Zr="binary_glTF";class fs extends Q{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,n,s){const o=t.json.extensionsUsed;return!o||o.indexOf(this.name)===-1||!t.bin?!1:(this._bin=t.bin,s(ve.CreateRuntime(t.json,e,n)),!0)}loadBufferAsync(e,t,n,s){return e.extensionsUsed.indexOf(this.name)===-1||t!==Zr?!1:(this._bin.readAsync(0,this._bin.byteLength).then(n,o=>s(o.message)),!0)}loadTextureBufferAsync(e,t,n){const s=e.textures[t],o=e.images[s.source];if(!o.extensions||!(this.name in o.extensions))return!1;const a=o.extensions[this.name],i=e.bufferViews[a.bufferView],l=J.GetBufferFromBufferView(e,i,0,i.byteLength,Oe.UNSIGNED_BYTE);return n(l),!0}loadShaderStringAsync(e,t,n){const s=e.shaders[t];if(!s.extensions||!(this.name in s.extensions))return!1;const o=s.extensions[this.name],a=e.bufferViews[o.bufferView],i=J.GetBufferFromBufferView(e,a,0,a.byteLength,Oe.UNSIGNED_BYTE);return setTimeout(()=>{const l=J.DecodeBufferToText(i);n(l)}),!0}}$e.RegisterExtension(new fs);class ps extends Q{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;const t=e.extensions[this.name];if(!t)return!1;const n=t.lights;if(n)for(const s in n){const o=n[s];switch(o.type){case"ambient":{const a=new as(o.name,new N(0,1,0),e.scene),i=o.ambient;i&&(a.diffuse=B.FromArray(i.color||[1,1,1]));break}case"point":{const a=new dn(o.name,new N(10,10,10),e.scene),i=o.point;i&&(a.diffuse=B.FromArray(i.color||[1,1,1]));break}case"directional":{const a=new hn(o.name,new N(0,-1,0),e.scene),i=o.directional;i&&(a.diffuse=B.FromArray(i.color||[1,1,1]));break}case"spot":{const a=o.spot;if(a){const i=new we(o.name,new N(0,10,0),new N(0,-1,0),a.fallOffAngle||Math.PI,a.fallOffExponent||0,e.scene);i.diffuse=B.FromArray(a.color||[1,1,1])}break}default:D.Warn('GLTF Material Common extension: light type "'+o.type+"” not supported");break}}return!1}loadMaterialAsync(e,t,n,s){const o=e.materials[t];if(!o||!o.extensions)return!1;const a=o.extensions[this.name];if(!a)return!1;const i=new Ye(t,e.scene);return i.sideOrientation=_e.CounterClockWiseSideOrientation,a.technique==="CONSTANT"&&(i.disableLighting=!0),i.backFaceCulling=a.doubleSided===void 0?!1:!a.doubleSided,i.alpha=a.values.transparency===void 0?1:a.values.transparency,i.specularPower=a.values.shininess===void 0?0:a.values.shininess,typeof a.values.ambient=="string"?this._loadTexture(e,a.values.ambient,i,"ambientTexture",s):i.ambientColor=B.FromArray(a.values.ambient||[0,0,0]),typeof a.values.diffuse=="string"?this._loadTexture(e,a.values.diffuse,i,"diffuseTexture",s):i.diffuseColor=B.FromArray(a.values.diffuse||[0,0,0]),typeof a.values.emission=="string"?this._loadTexture(e,a.values.emission,i,"emissiveTexture",s):i.emissiveColor=B.FromArray(a.values.emission||[0,0,0]),typeof a.values.specular=="string"?this._loadTexture(e,a.values.specular,i,"specularTexture",s):i.specularColor=B.FromArray(a.values.specular||[0,0,0]),!0}_loadTexture(e,t,n,s,o){ve.LoadTextureBufferAsync(e,t,a=>{ve.CreateTextureAsync(e,t,a,i=>n[s]=i)},o)}}$e.RegisterExtension(new ps);const fo=Object.freeze(Object.defineProperty({__proto__:null,get EBlendingFunction(){return j},get EComponentType(){return Oe},get ECullingType(){return pt},get EParameterType(){return ce},get EShaderType(){return ft},get ETextureFilterType(){return ye},get ETextureFormat(){return on},get ETextureWrapMode(){return qe},GLTFBinaryExtension:fs,GLTFLoader:$e,GLTFLoaderBase:ve,GLTFLoaderExtension:Q,GLTFMaterialsCommonExtension:ps,GLTFUtils:J},Symbol.toStringTag,{value:"Module"})),pn=new Map,_s=pn;function R(r,e,t){k(r)&&P.Warn(`Extension with the name '${r}' already exists`),pn.set(r,{isGLTFExtension:e,factory:t})}function k(r){return pn.delete(r)}class Xr{constructor(e,t){this._gltf=e,this._infoTree=t}convert(e){let t=this._gltf,n=this._infoTree,s;if(!e.startsWith("/"))throw new Error("Path must start with a /");const o=e.split("/");if(o.shift(),o[o.length-1].includes(".length")){const l=o[o.length-1].split(".");o.pop(),o.push(...l)}let a=!1;for(const i of o){const l=i==="length";if(l&&!n.__array__)throw new Error(`Path ${e} is invalid`);if(n.__ignoreObjectTree__&&(a=!0),n.__array__&&!l)n=n.__array__;else if(n=n[i],!n)throw new Error(`Path ${e} is invalid`);if(!a){if(t===void 0)throw new Error(`Path ${e} is invalid`);l||(t=t==null?void 0:t[i])}(n.__target__||l)&&(s=t)}return{object:s,info:n}}}const Jr={length:{type:"number",get:r=>r.length,getTarget:r=>r.map(e=>e._babylonTransformNode),getPropertyName:[()=>"length"]},__array__:{__target__:!0,translation:{type:"Vector3",get:r=>{var e;return(e=r._babylonTransformNode)==null?void 0:e.position},set:(r,e)=>{var t;return(t=e._babylonTransformNode)==null?void 0:t.position.copyFrom(r)},getTarget:r=>r._babylonTransformNode,getPropertyName:[()=>"position"]},rotation:{type:"Quaternion",get:r=>{var e;return(e=r._babylonTransformNode)==null?void 0:e.rotationQuaternion},set:(r,e)=>{var t,n;return(n=(t=e._babylonTransformNode)==null?void 0:t.rotationQuaternion)==null?void 0:n.copyFrom(r)},getTarget:r=>r._babylonTransformNode,getPropertyName:[()=>"rotationQuaternion"]},scale:{type:"Vector3",get:r=>{var e;return(e=r._babylonTransformNode)==null?void 0:e.scaling},set:(r,e)=>{var t;return(t=e._babylonTransformNode)==null?void 0:t.scaling.copyFrom(r)},getTarget:r=>r._babylonTransformNode,getPropertyName:[()=>"scaling"]},weights:{length:{type:"number",get:r=>r._numMorphTargets,getTarget:r=>r._babylonTransformNode,getPropertyName:[()=>"influence"]},__array__:{__target__:!0,type:"number",get:(r,e)=>{var t,n;return e!==void 0?(n=(t=r._primitiveBabylonMeshes)==null?void 0:t[0].morphTargetManager)==null?void 0:n.getTarget(e).influence:void 0},getTarget:r=>r._babylonTransformNode,getPropertyName:[()=>"influence"]},type:"number[]",get:(r,e)=>[0],getTarget:r=>r._babylonTransformNode,getPropertyName:[()=>"influence"]},matrix:{type:"Matrix",get:r=>{var e,t,n;return se.Compose((e=r._babylonTransformNode)==null?void 0:e.scaling,(t=r._babylonTransformNode)==null?void 0:t.rotationQuaternion,(n=r._babylonTransformNode)==null?void 0:n.position)},getTarget:r=>r._babylonTransformNode,isReadOnly:!0},globalMatrix:{type:"Matrix",get:r=>{var s,o,a,i,l,c,u;const e=se.Identity();let t=r.parent;for(;t&&t.parent;)t=t.parent;const n=((s=r._babylonTransformNode)==null?void 0:s.position._isDirty)||((a=(o=r._babylonTransformNode)==null?void 0:o.rotationQuaternion)==null?void 0:a._isDirty)||((i=r._babylonTransformNode)==null?void 0:i.scaling._isDirty);if(t){const h=(l=t._babylonTransformNode)==null?void 0:l.computeWorldMatrix(!0).invert();h&&((u=(c=r._babylonTransformNode)==null?void 0:c.computeWorldMatrix(n))==null||u.multiplyToRef(h,e))}else r._babylonTransformNode&&e.copyFrom(r._babylonTransformNode.computeWorldMatrix(n));return e},getTarget:r=>r._babylonTransformNode,isReadOnly:!0},extensions:{EXT_lights_ies:{multiplier:{type:"number",get:r=>{var e,t;return(t=(e=r._babylonTransformNode)==null?void 0:e.getChildren(n=>n instanceof we,!0)[0])==null?void 0:t.intensity},getTarget:r=>{var e;return(e=r._babylonTransformNode)==null?void 0:e.getChildren(t=>t instanceof we,!0)[0]},set:(r,e)=>{if(e._babylonTransformNode){const t=e._babylonTransformNode.getChildren(n=>n instanceof we,!0)[0];t&&(t.intensity=r)}}},color:{type:"Color3",get:r=>{var e,t;return(t=(e=r._babylonTransformNode)==null?void 0:e.getChildren(n=>n instanceof we,!0)[0])==null?void 0:t.diffuse},getTarget:r=>{var e;return(e=r._babylonTransformNode)==null?void 0:e.getChildren(t=>t instanceof we,!0)[0]},set:(r,e)=>{if(e._babylonTransformNode){const t=e._babylonTransformNode.getChildren(n=>n instanceof we,!0)[0];t&&(t.diffuse=r)}}}}}}},Qr={length:{type:"number",get:r=>r.length,getTarget:r=>r.map(e=>e._babylonAnimationGroup),getPropertyName:[()=>"length"]},__array__:{}},zr={length:{type:"number",get:r=>r.length,getTarget:r=>r.map(e=>{var t;return(t=e.primitives[0]._instanceData)==null?void 0:t.babylonSourceMesh}),getPropertyName:[()=>"length"]},__array__:{}},eo={__array__:{__target__:!0,orthographic:{xmag:{componentsCount:2,type:"Vector2",get:r=>{var e,t;return new ge(((e=r._babylonCamera)==null?void 0:e.orthoLeft)??0,((t=r._babylonCamera)==null?void 0:t.orthoRight)??0)},set:(r,e)=>{e._babylonCamera&&(e._babylonCamera.orthoLeft=r.x,e._babylonCamera.orthoRight=r.y)},getTarget:r=>r,getPropertyName:[()=>"orthoLeft",()=>"orthoRight"]},ymag:{componentsCount:2,type:"Vector2",get:r=>{var e,t;return new ge(((e=r._babylonCamera)==null?void 0:e.orthoBottom)??0,((t=r._babylonCamera)==null?void 0:t.orthoTop)??0)},set:(r,e)=>{e._babylonCamera&&(e._babylonCamera.orthoBottom=r.x,e._babylonCamera.orthoTop=r.y)},getTarget:r=>r,getPropertyName:[()=>"orthoBottom",()=>"orthoTop"]},zfar:{type:"number",get:r=>{var e;return(e=r._babylonCamera)==null?void 0:e.maxZ},set:(r,e)=>{e._babylonCamera&&(e._babylonCamera.maxZ=r)},getTarget:r=>r,getPropertyName:[()=>"maxZ"]},znear:{type:"number",get:r=>{var e;return(e=r._babylonCamera)==null?void 0:e.minZ},set:(r,e)=>{e._babylonCamera&&(e._babylonCamera.minZ=r)},getTarget:r=>r,getPropertyName:[()=>"minZ"]}},perspective:{aspectRatio:{type:"number",get:r=>{var e;return(e=r._babylonCamera)==null?void 0:e.getEngine().getAspectRatio(r._babylonCamera)},getTarget:r=>r,getPropertyName:[()=>"aspectRatio"],isReadOnly:!0},yfov:{type:"number",get:r=>{var e;return(e=r._babylonCamera)==null?void 0:e.fov},set:(r,e)=>{e._babylonCamera&&(e._babylonCamera.fov=r)},getTarget:r=>r,getPropertyName:[()=>"fov"]},zfar:{type:"number",get:r=>{var e;return(e=r._babylonCamera)==null?void 0:e.maxZ},set:(r,e)=>{e._babylonCamera&&(e._babylonCamera.maxZ=r)},getTarget:r=>r,getPropertyName:[()=>"maxZ"]},znear:{type:"number",get:r=>{var e;return(e=r._babylonCamera)==null?void 0:e.minZ},set:(r,e)=>{e._babylonCamera&&(e._babylonCamera.minZ=r)},getTarget:r=>r,getPropertyName:[()=>"minZ"]}}}},to={__array__:{__target__:!0,emissiveFactor:{type:"Color3",get:(r,e,t)=>y(r,e,t).emissiveColor,set:(r,e,t,n)=>y(e,t,n).emissiveColor.copyFrom(r),getTarget:(r,e,t)=>y(r,e,t),getPropertyName:[()=>"emissiveColor"]},emissiveTexture:{extensions:{KHR_texture_transform:ee("emissiveTexture")}},normalTexture:{scale:{type:"number",get:(r,e,t)=>{var n;return(n=Se(r,t,"bumpTexture"))==null?void 0:n.level},set:(r,e,t,n)=>{const s=Se(e,n,"bumpTexture");s&&(s.level=r)},getTarget:(r,e,t)=>y(r,e,t),getPropertyName:[()=>"level"]},extensions:{KHR_texture_transform:ee("bumpTexture")}},occlusionTexture:{strength:{type:"number",get:(r,e,t)=>y(r,e,t).ambientTextureStrength,set:(r,e,t,n)=>{const s=y(e,t,n);s&&(s.ambientTextureStrength=r)},getTarget:(r,e,t)=>y(r,e,t),getPropertyName:[()=>"ambientTextureStrength"]},extensions:{KHR_texture_transform:ee("ambientTexture")}},pbrMetallicRoughness:{baseColorFactor:{type:"Color4",get:(r,e,t)=>{const n=y(r,e,t);return Ue.FromColor3(n.albedoColor,n.alpha)},set:(r,e,t,n)=>{const s=y(e,t,n);s.albedoColor.set(r.r,r.g,r.b),s.alpha=r.a},getTarget:(r,e,t)=>y(r,e,t),getPropertyName:[()=>"albedoColor",()=>"alpha"]},baseColorTexture:{extensions:{KHR_texture_transform:ee("albedoTexture")}},metallicFactor:{type:"number",get:(r,e,t)=>y(r,e,t).metallic,set:(r,e,t,n)=>{const s=y(e,t,n);s&&(s.metallic=r)},getTarget:(r,e,t)=>y(r,e,t),getPropertyName:[()=>"metallic"]},roughnessFactor:{type:"number",get:(r,e,t)=>y(r,e,t).roughness,set:(r,e,t,n)=>{const s=y(e,t,n);s&&(s.roughness=r)},getTarget:(r,e,t)=>y(r,e,t),getPropertyName:[()=>"roughness"]},metallicRoughnessTexture:{extensions:{KHR_texture_transform:ee("metallicTexture")}}},extensions:{KHR_materials_anisotropy:{anisotropyStrength:{type:"number",get:(r,e,t)=>y(r,e,t).anisotropy.intensity,set:(r,e,t,n)=>{y(e,t,n).anisotropy.intensity=r},getTarget:(r,e,t)=>y(r,e,t),getPropertyName:[()=>"anisotropy.intensity"]},anisotropyRotation:{type:"number",get:(r,e,t)=>y(r,e,t).anisotropy.angle,set:(r,e,t,n)=>{y(e,t,n).anisotropy.angle=r},getTarget:(r,e,t)=>y(r,e,t),getPropertyName:[()=>"anisotropy.angle"]},anisotropyTexture:{extensions:{KHR_texture_transform:ee("anisotropy","texture")}}},KHR_materials_clearcoat:{clearcoatFactor:{type:"number",get:(r,e,t)=>y(r,e,t).clearCoat.intensity,set:(r,e,t,n)=>{y(e,t,n).clearCoat.intensity=r},getTarget:(r,e,t)=>y(r,e,t),getPropertyName:[()=>"clearCoat.intensity"]},clearcoatRoughnessFactor:{type:"number",get:(r,e,t)=>y(r,e,t).clearCoat.roughness,set:(r,e,t,n)=>{y(e,t,n).clearCoat.roughness=r},getTarget:(r,e,t)=>y(r,e,t),getPropertyName:[()=>"clearCoat.roughness"]},clearcoatTexture:{extensions:{KHR_texture_transform:ee("clearCoat","texture")}},clearcoatNormalTexture:{scale:{type:"number",get:(r,e,t)=>{var n;return(n=y(r,e,t).clearCoat.bumpTexture)==null?void 0:n.level},getTarget:y,set:(r,e,t,n)=>y(e,t,n).clearCoat.bumpTexture.level=r},extensions:{KHR_texture_transform:ee("clearCoat","bumpTexture")}},clearcoatRoughnessTexture:{extensions:{KHR_texture_transform:ee("clearCoat","textureRoughness")}}},KHR_materials_dispersion:{dispersion:{type:"number",get:(r,e,t)=>y(r,e,t).subSurface.dispersion,getTarget:y,set:(r,e,t,n)=>y(e,t,n).subSurface.dispersion=r}},KHR_materials_emissive_strength:{emissiveStrength:{type:"number",get:(r,e,t)=>y(r,e,t).emissiveIntensity,getTarget:y,set:(r,e,t,n)=>y(e,t,n).emissiveIntensity=r}},KHR_materials_ior:{ior:{type:"number",get:(r,e,t)=>y(r,e,t).indexOfRefraction,getTarget:y,set:(r,e,t,n)=>y(e,t,n).indexOfRefraction=r}},KHR_materials_iridescence:{iridescenceFactor:{type:"number",get:(r,e,t)=>y(r,e,t).iridescence.intensity,getTarget:y,set:(r,e,t,n)=>y(e,t,n).iridescence.intensity=r},iridescenceIor:{type:"number",get:(r,e,t)=>y(r,e,t).iridescence.indexOfRefraction,getTarget:y,set:(r,e,t,n)=>y(e,t,n).iridescence.indexOfRefraction=r},iridescenceTexture:{extensions:{KHR_texture_transform:ee("iridescence","texture")}},iridescenceThicknessMaximum:{type:"number",get:(r,e,t)=>y(r,e,t).iridescence.maximumThickness,getTarget:y,set:(r,e,t,n)=>y(e,t,n).iridescence.maximumThickness=r},iridescenceThicknessMinimum:{type:"number",get:(r,e,t)=>y(r,e,t).iridescence.minimumThickness,getTarget:y,set:(r,e,t,n)=>y(e,t,n).iridescence.minimumThickness=r},iridescenceThicknessTexture:{extensions:{KHR_texture_transform:ee("iridescence","thicknessTexture")}}},KHR_materials_sheen:{sheenColorFactor:{type:"Color3",get:(r,e,t)=>y(r,e,t).sheen.color,getTarget:y,set:(r,e,t,n)=>y(e,t,n).sheen.color.copyFrom(r)},sheenColorTexture:{extensions:{KHR_texture_transform:ee("sheen","texture")}},sheenRoughnessFactor:{type:"number",get:(r,e,t)=>y(r,e,t).sheen.intensity,getTarget:y,set:(r,e,t,n)=>y(e,t,n).sheen.intensity=r},sheenRoughnessTexture:{extensions:{KHR_texture_transform:ee("sheen","thicknessTexture")}}},KHR_materials_specular:{specularFactor:{type:"number",get:(r,e,t)=>y(r,e,t).metallicF0Factor,getTarget:y,set:(r,e,t,n)=>y(e,t,n).metallicF0Factor=r,getPropertyName:[()=>"metallicF0Factor"]},specularColorFactor:{type:"Color3",get:(r,e,t)=>y(r,e,t).metallicReflectanceColor,getTarget:y,set:(r,e,t,n)=>y(e,t,n).metallicReflectanceColor.copyFrom(r),getPropertyName:[()=>"metallicReflectanceColor"]},specularTexture:{extensions:{KHR_texture_transform:ee("metallicReflectanceTexture")}},specularColorTexture:{extensions:{KHR_texture_transform:ee("reflectanceTexture")}}},KHR_materials_transmission:{transmissionFactor:{type:"number",get:(r,e,t)=>y(r,e,t).subSurface.refractionIntensity,getTarget:y,set:(r,e,t,n)=>y(e,t,n).subSurface.refractionIntensity=r,getPropertyName:[()=>"subSurface.refractionIntensity"]},transmissionTexture:{extensions:{KHR_texture_transform:ee("subSurface","refractionIntensityTexture")}}},KHR_materials_diffuse_transmission:{diffuseTransmissionFactor:{type:"number",get:(r,e,t)=>y(r,e,t).subSurface.translucencyIntensity,getTarget:y,set:(r,e,t,n)=>y(e,t,n).subSurface.translucencyIntensity=r},diffuseTransmissionTexture:{extensions:{KHR_texture_transform:ee("subSurface","translucencyIntensityTexture")}},diffuseTransmissionColorFactor:{type:"Color3",get:(r,e,t)=>y(r,e,t).subSurface.translucencyColor,getTarget:y,set:(r,e,t,n)=>{var s;return r&&((s=y(e,t,n).subSurface.translucencyColor)==null?void 0:s.copyFrom(r))}},diffuseTransmissionColorTexture:{extensions:{KHR_texture_transform:ee("subSurface","translucencyColorTexture")}}},KHR_materials_volume:{attenuationColor:{type:"Color3",get:(r,e,t)=>y(r,e,t).subSurface.tintColor,getTarget:y,set:(r,e,t,n)=>y(e,t,n).subSurface.tintColor.copyFrom(r)},attenuationDistance:{type:"number",get:(r,e,t)=>y(r,e,t).subSurface.tintColorAtDistance,getTarget:y,set:(r,e,t,n)=>y(e,t,n).subSurface.tintColorAtDistance=r},thicknessFactor:{type:"number",get:(r,e,t)=>y(r,e,t).subSurface.maximumThickness,getTarget:y,set:(r,e,t,n)=>y(e,t,n).subSurface.maximumThickness=r},thicknessTexture:{extensions:{KHR_texture_transform:ee("subSurface","thicknessTexture")}}}}}},no={KHR_lights_punctual:{lights:{length:{type:"number",get:r=>r.length,getTarget:r=>r.map(e=>e._babylonLight),getPropertyName:[r=>"length"]},__array__:{__target__:!0,color:{type:"Color3",get:r=>{var e;return(e=r._babylonLight)==null?void 0:e.diffuse},set:(r,e)=>{var t;return(t=e._babylonLight)==null?void 0:t.diffuse.copyFrom(r)},getTarget:r=>r._babylonLight,getPropertyName:[r=>"diffuse"]},intensity:{type:"number",get:r=>{var e;return(e=r._babylonLight)==null?void 0:e.intensity},set:(r,e)=>e._babylonLight?e._babylonLight.intensity=r:void 0,getTarget:r=>r._babylonLight,getPropertyName:[r=>"intensity"]},range:{type:"number",get:r=>{var e;return(e=r._babylonLight)==null?void 0:e.range},set:(r,e)=>e._babylonLight?e._babylonLight.range=r:void 0,getTarget:r=>r._babylonLight,getPropertyName:[r=>"range"]},spot:{innerConeAngle:{type:"number",get:r=>{var e;return(e=r._babylonLight)==null?void 0:e.innerAngle},set:(r,e)=>e._babylonLight?e._babylonLight.innerAngle=r:void 0,getTarget:r=>r._babylonLight,getPropertyName:[r=>"innerConeAngle"]},outerConeAngle:{type:"number",get:r=>{var e;return(e=r._babylonLight)==null?void 0:e.angle},set:(r,e)=>e._babylonLight?e._babylonLight.angle=r:void 0,getTarget:r=>r._babylonLight,getPropertyName:[r=>"outerConeAngle"]}}}}},EXT_lights_ies:{lights:{length:{type:"number",get:r=>r.length,getTarget:r=>r.map(e=>e._babylonLight),getPropertyName:[r=>"length"]}}},EXT_lights_image_based:{lights:{length:{type:"number",get:r=>r.length,getTarget:r=>r.map(e=>e._babylonTexture),getPropertyName:[r=>"length"]},__array__:{__target__:!0,intensity:{type:"number",get:r=>{var e;return(e=r._babylonTexture)==null?void 0:e.level},set:(r,e)=>{e._babylonTexture&&(e._babylonTexture.level=r)},getTarget:r=>r._babylonTexture},rotation:{type:"Quaternion",get:r=>{var e;return r._babylonTexture&&te.FromRotationMatrix((e=r._babylonTexture)==null?void 0:e.getReflectionTextureMatrix())},set:(r,e)=>{var t;e._babylonTexture&&((t=e._babylonTexture.getScene())!=null&&t.useRightHandedSystem||(r=te.Inverse(r)),se.FromQuaternionToRef(r,e._babylonTexture.getReflectionTextureMatrix()))},getTarget:r=>r._babylonTexture}}}}};function Se(r,e,t,n){const s=y(r);return n?s[t][n]:s[t]}function y(r,e,t){var n,s;return(s=(n=r._data)==null?void 0:n[(t==null?void 0:t.fillMode)??Me.MATERIAL_TriangleFillMode])==null?void 0:s.babylonMaterial}function ee(r,e){return{offset:{componentsCount:2,type:"Vector2",get:(t,n,s)=>{const o=Se(t,s,r,e);return new ge(o==null?void 0:o.uOffset,o==null?void 0:o.vOffset)},getTarget:y,set:(t,n,s,o)=>{const a=Se(n,o,r,e);a.uOffset=t.x,a.vOffset=t.y},getPropertyName:[()=>`${r}${e?"."+e:""}.uOffset`,()=>`${r}${e?"."+e:""}.vOffset`]},rotation:{type:"number",get:(t,n,s)=>{var o;return(o=Se(t,s,r,e))==null?void 0:o.wAng},getTarget:y,set:(t,n,s,o)=>Se(n,o,r,e).wAng=t,getPropertyName:[()=>`${r}${e?"."+e:""}.wAng`]},scale:{componentsCount:2,type:"Vector2",get:(t,n,s)=>{const o=Se(t,s,r,e);return new ge(o==null?void 0:o.uScale,o==null?void 0:o.vScale)},getTarget:y,set:(t,n,s,o)=>{const a=Se(n,o,r,e);a.uScale=t.x,a.vScale=t.y},getPropertyName:[()=>`${r}${e?"."+e:""}.uScale`,()=>`${r}${e?"."+e:""}.vScale`]}}}const Yt={cameras:eo,nodes:Jr,materials:to,extensions:no,animations:Qr,meshes:zr};function _n(r){return new Xr(r,Yt)}function ze(r){const e=r.split("/").map(n=>n.replace(/{}/g,"__array__"));let t=Yt;for(const n of e)n&&(t=t[n]);if(t&&t.type&&t.get)return t}function m(r,e){const t=r.split("/").map(s=>s.replace(/{}/g,"__array__"));let n=Yt;for(const s of t)s&&(n=n[s]);n&&n.type&&n.get&&(n.interpolation=e)}function be(r,e){const t=r.split("/").map(s=>s.replace(/{}/g,"__array__"));let n=Yt;for(const s of t)if(s){if(!n[s]){if(s==="?"){n.__ignoreObjectTree__=!0;continue}n[s]={},s==="__array__"&&(n[s].__target__=!0)}n=n[s]}Object.assign(n,e)}class b{static Get(e,t,n){if(!t||n==null||!t[n])throw new Error(`${e}: Failed to find index (${n})`);return t[n]}static TryGet(e,t){return!e||t==null||!e[t]?null:e[t]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}function mn(r){if(r.min&&r.max){const e=r.min,t=r.max,n=pe.Vector3[0].copyFromFloats(e[0],e[1],e[2]),s=pe.Vector3[1].copyFromFloats(t[0],t[1],t[2]);if(r.normalized&&r.componentType!==5126){let o=1;switch(r.componentType){case 5120:o=127;break;case 5121:o=255;break;case 5122:o=32767;break;case 5123:o=65535;break}const a=1/o;n.scaleInPlace(a),s.scaleInPlace(a)}return new ir(n,s)}return null}class C{static RegisterExtension(e,t){R(e,!1,t)}static UnregisterExtension(e){return k(e)}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}get rootUrl(){return this._rootUrl}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=!1,this._skipStartAnimationStep=!1,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(e=>e.dispose&&e.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(e,t,n,s,o,a,i=""){return Promise.resolve().then(()=>{this._babylonScene=t,this._assetContainer=n,this._loadData(s);let l=null;if(e){const c={};if(this._gltf.nodes)for(const h of this._gltf.nodes)h.name&&(c[h.name]=h.index);l=(e instanceof Array?e:[e]).map(h=>{const d=c[h];if(d===void 0)throw new Error(`Failed to find node '${h}'`);return d})}return this._loadAsync(o,i,l,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries(),spriteManagers:[]}))})}loadAsync(e,t,n,s,o=""){return Promise.resolve().then(()=>(this._babylonScene=e,this._loadData(t),this._loadAsync(n,o,null,()=>{})))}_loadAsync(e,t,n,s){return Promise.resolve().then(async()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._allMaterialsDirtyRequired=!1,await this._loadExtensionsAsync();const o=`${ue[ue.LOADING]} => ${ue[ue.READY]}`,a=`${ue[ue.LOADING]} => ${ue[ue.COMPLETE]}`;this._parent._startPerformanceCounter(o),this._parent._startPerformanceCounter(a),this._parent._setState(ue.LOADING),this._extensionsOnLoading();const i=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(n)i.push(this.loadSceneAsync("/nodes",{nodes:n,index:-1}));else if(this._gltf.scene!=null||this._gltf.scenes&&this._gltf.scenes[0]){const u=b.Get("/scene",this._gltf.scenes,this._gltf.scene||0);i.push(this.loadSceneAsync(`/scenes/${u.index}`,u))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let u=0;u<this._gltf.materials.length;++u){const h=this._gltf.materials[u],d="/materials/"+u,f=_e.TriangleFillMode;i.push(this._loadMaterialAsync(d,h,null,f,()=>{}))}return this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=l:this._babylonScene._forceBlockMaterialDirtyMechanism(l),this._parent.compileMaterials&&i.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&i.push(this._compileShadowGeneratorsAsync()),Promise.all(i).then(()=>{this._rootBabylonMesh&&this._rootBabylonMesh!==this._parent.customRootNode&&this._rootBabylonMesh.setEnabled(!0);for(const u of this._babylonScene.materials){const h=u;h.maxSimultaneousLights!==void 0&&(h.maxSimultaneousLights=Math.max(h.maxSimultaneousLights,this._babylonScene.lights.length))}return this._extensionsOnReady(),this._parent._setState(ue.READY),this._skipStartAnimationStep||this._startAnimations(),s()}).then(u=>(this._parent._endPerformanceCounter(o),D.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(a),this._parent._setState(ue.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},h=>{this._parent.onErrorObservable.notifyObservers(h),this._parent.onErrorObservable.clear(),this.dispose()})}),u))}).catch(o=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(o),this._parent.onErrorObservable.clear(),this.dispose()),o})}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const n=t[0];(n.byteLength<e.bin.byteLength-3||n.byteLength>e.bin.byteLength)&&P.Warn(`Binary buffer length (${n.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else P.Warn("Unexpected BIN chunk")}}_setupData(){if(b.Assign(this._gltf.accessors),b.Assign(this._gltf.animations),b.Assign(this._gltf.buffers),b.Assign(this._gltf.bufferViews),b.Assign(this._gltf.cameras),b.Assign(this._gltf.images),b.Assign(this._gltf.materials),b.Assign(this._gltf.meshes),b.Assign(this._gltf.nodes),b.Assign(this._gltf.samplers),b.Assign(this._gltf.scenes),b.Assign(this._gltf.skins),b.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const n of this._gltf.nodes)if(n.children)for(const s of n.children)e[s]=n.index;const t=this._createRootNode();for(const n of this._gltf.nodes){const s=e[n.index];n.parent=s===void 0?t:this._gltf.nodes[s]}}}async _loadExtensionsAsync(){var t;const e=[];if(_s.forEach((n,s)=>{var o;((o=this.parent.extensionOptions[s])==null?void 0:o.enabled)===!1?n.isGLTFExtension&&this.isExtensionUsed(s)&&P.Warn(`Extension ${s} is used but has been explicitly disabled.`):(!n.isGLTFExtension||this.isExtensionUsed(s))&&e.push((async()=>{const a=await n.factory(this);return a.name!==s&&P.Warn(`The name of the glTF loader extension instance does not match the registered name: ${a.name} !== ${s}`),this._parent.onExtensionLoadedObservable.notifyObservers(a),a})())}),this._extensions.push(...await Promise.all(e)),this._extensions.sort((n,s)=>(n.order||Number.MAX_VALUE)-(s.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear(),this._gltf.extensionsRequired){for(const n of this._gltf.extensionsRequired)if(!this._extensions.some(o=>o.name===n&&o.enabled))throw((t=this.parent.extensionOptions[n])==null?void 0:t.enabled)===!1?new Error(`Required extension ${n} is disabled`):new Error(`Required extension ${n} is not available`)}}_createRootNode(){if(this._parent.customRootNode!==void 0)return this._rootBabylonMesh=this._parent.customRootNode,{_babylonTransformNode:this._rootBabylonMesh===null?void 0:this._rootBabylonMesh,index:-1};this._babylonScene._blockEntityCollection=!!this._assetContainer;const e=new Ee("__root__",this._babylonScene);this._rootBabylonMesh=e,this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const t={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case tt.AUTO:{this._babylonScene.useRightHandedSystem||(t.rotation=[0,1,0,0],t.scale=[1,1,-1],C._LoadTransform(t,this._rootBabylonMesh));break}case tt.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(e),t}loadSceneAsync(e,t){const n=this._extensionsLoadSceneAsync(e,t);if(n)return n;const s=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const o of t.nodes){const a=b.Get(`${e}/nodes/${o}`,this._gltf.nodes,o);s.push(this.loadNodeAsync(`/nodes/${a.index}`,a,i=>{i.parent=this._rootBabylonMesh}))}for(const o of this._postSceneLoadActions)o();return s.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(s).then(()=>{})}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const n of e._primitiveBabylonMeshes)t(n)}_getGeometries(){const e=[],t=this._gltf.nodes;if(t)for(const n of t)this._forEachPrimitive(n,s=>{const o=s.geometry;o&&e.indexOf(o)===-1&&e.push(o)});return e}_getMeshes(){const e=[];this._rootBabylonMesh instanceof os&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const n of t)this._forEachPrimitive(n,s=>{e.push(s)});return e}_getTransformNodes(){const e=[],t=this._gltf.nodes;if(t)for(const n of t)n._babylonTransformNode&&n._babylonTransformNode.getClassName()==="TransformNode"&&e.push(n._babylonTransformNode),n._babylonTransformNodeForSkin&&e.push(n._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=[],t=this._gltf.skins;if(t)for(const n of t)n._data&&e.push(n._data.babylonSkeleton);return e}_getAnimationGroups(){const e=[],t=this._gltf.animations;if(t)for(const n of t)n._babylonAnimationGroup&&e.push(n._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case We.NONE:break;case We.FIRST:{const e=this._getAnimationGroups();e.length!==0&&e[0].start(!0);break}case We.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(!0);break}default:{P.Error(`Invalid animation start mode (${this._parent.animationStartMode})`);return}}}loadNodeAsync(e,t,n=()=>{}){const s=this._extensionsLoadNodeAsync(e,t,n);if(s)return s;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const o=new Array;this.logOpen(`${e} ${t.name||""}`);const a=c=>{if(C.AddPointerMetadata(c,e),C._LoadTransform(t,c),t.camera!=null){const u=b.Get(`${e}/camera`,this._gltf.cameras,t.camera);o.push(this.loadCameraAsync(`/cameras/${u.index}`,u,h=>{h.parent=c}))}if(t.children)for(const u of t.children){const h=b.Get(`${e}/children/${u}`,this._gltf.nodes,u);o.push(this.loadNodeAsync(`/nodes/${h.index}`,h,d=>{d.parent=c}))}n(c)},i=t.mesh!=null,l=this._parent.loadSkins&&t.skin!=null;if(!i||l){const c=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const u=new Kn(c,this._babylonScene);u._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t.mesh==null?t._babylonTransformNode=u:t._babylonTransformNodeForSkin=u,a(u)}if(i)if(l){const c=b.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);o.push(this._loadMeshAsync(`/meshes/${c.index}`,t,c,u=>{const h=t._babylonTransformNodeForSkin;u.metadata=lr(h.metadata,u.metadata||{});const d=b.Get(`${e}/skin`,this._gltf.skins,t.skin);o.push(this._loadSkinAsync(`/skins/${d.index}`,t,d,f=>{this._forEachPrimitive(t,p=>{p.skeleton=f}),this._postSceneLoadActions.push(()=>{if(d.skeleton!=null){const p=b.Get(`/skins/${d.index}/skeleton`,this._gltf.nodes,d.skeleton).parent;t.index===p.index?u.parent=h.parent:u.parent=p._babylonTransformNode}else u.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:h,skinnedNode:u})})}))}))}else{const c=b.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);o.push(this._loadMeshAsync(`/meshes/${c.index}`,t,c,a))}return this.logClose(),Promise.all(o).then(()=>(this._forEachPrimitive(t,c=>{const u=c;!u.isAnInstance&&u.geometry&&u.geometry.useBoundingInfoFromGeometry?c._updateBoundingInfo():c.refreshBoundingInfo(!0,!0)}),t._babylonTransformNode))}_loadMeshAsync(e,t,n,s){const o=n.primitives;if(!o||!o.length)throw new Error(`${e}: Primitives are missing`);o[0].index==null&&b.Assign(o);const a=new Array;this.logOpen(`${e} ${n.name||""}`);const i=t.name||`node${t.index}`;if(o.length===1){const l=n.primitives[0];a.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,i,t,n,l,c=>{t._babylonTransformNode=c,t._primitiveBabylonMeshes=[c]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new Kn(i,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(const l of o)a.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,`${i}_primitive${l.index}`,t,n,l,c=>{c.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(c)}))}return s(t._babylonTransformNode),this.logClose(),Promise.all(a).then(()=>t._babylonTransformNode)}_loadMeshPrimitiveAsync(e,t,n,s,o,a){const i=this._extensionsLoadMeshPrimitiveAsync(e,t,n,s,o,a);if(i)return i;this.logOpen(`${e}`);const l=this._disableInstancedMesh===0&&this._parent.createInstances&&n.skin==null&&!s.primitives[0].targets;let c,u;if(l&&o._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,c=o._instanceData.babylonSourceMesh.createInstance(t),c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,u=o._instanceData.promise;else{const h=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const d=new Ee(t,this._babylonScene);d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,d.sideOrientation=this._babylonScene.useRightHandedSystem?_e.CounterClockWiseSideOrientation:_e.ClockWiseSideOrientation,this._createMorphTargets(e,n,s,o,d),h.push(this._loadVertexDataAsync(e,o,d).then(p=>this._loadMorphTargetsAsync(e,o,d,p).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,p.applyToMesh(d),p._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})));const f=C._GetDrawMode(e,o.mode);if(o.material==null){let p=this._defaultBabylonMaterialData[f];p||(p=this._createDefaultMaterial("__GLTFLoader._default",f),this._parent.onMaterialLoadedObservable.notifyObservers(p),this._defaultBabylonMaterialData[f]=p),d.material=p}else if(!this.parent.skipMaterials){const p=b.Get(`${e}/material`,this._gltf.materials,o.material);h.push(this._loadMaterialAsync(`/materials/${p.index}`,p,d,f,_=>{d.material=_}))}u=Promise.all(h),l&&(o._instanceData={babylonSourceMesh:d,promise:u}),c=d}return C.AddPointerMetadata(c,e),this._parent.onMeshLoadedObservable.notifyObservers(c),a(c),this.logClose(),u.then(()=>c)}_loadVertexDataAsync(e,t,n){const s=this._extensionsLoadVertexDataAsync(e,t,n);if(s)return s;const o=t.attributes;if(!o)throw new Error(`${e}: Attributes are missing`);const a=new Array,i=new dt(n.name,this._babylonScene);if(t.indices==null)n.isUnIndexed=!0;else{const c=b.Get(`${e}/indices`,this._gltf.accessors,t.indices);a.push(this._loadIndicesAccessorAsync(`/accessors/${c.index}`,c).then(u=>{i.setIndices(u)}))}const l=(c,u,h)=>{if(o[c]==null)return;n._delayInfo=n._delayInfo||[],n._delayInfo.indexOf(u)===-1&&n._delayInfo.push(u);const d=b.Get(`${e}/attributes/${c}`,this._gltf.accessors,o[c]);a.push(this._loadVertexAccessorAsync(`/accessors/${d.index}`,d,u).then(f=>{if(f.getKind()===S.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!n.skeleton){const p=mn(d);p&&(i._boundingInfo=p,i.useBoundingInfoFromGeometry=!0)}i.setVerticesBuffer(f,d.count)})),u==S.MatricesIndicesExtraKind&&(n.numBoneInfluencers=8),h&&h(d)};return l("POSITION",S.PositionKind),l("NORMAL",S.NormalKind),l("TANGENT",S.TangentKind),l("TEXCOORD_0",S.UVKind),l("TEXCOORD_1",S.UV2Kind),l("TEXCOORD_2",S.UV3Kind),l("TEXCOORD_3",S.UV4Kind),l("TEXCOORD_4",S.UV5Kind),l("TEXCOORD_5",S.UV6Kind),l("JOINTS_0",S.MatricesIndicesKind),l("WEIGHTS_0",S.MatricesWeightsKind),l("JOINTS_1",S.MatricesIndicesExtraKind),l("WEIGHTS_1",S.MatricesWeightsExtraKind),l("COLOR_0",S.ColorKind,c=>{c.type==="VEC4"&&(n.hasVertexAlpha=!0)}),Promise.all(a).then(()=>i)}_createMorphTargets(e,t,n,s,o){if(!s.targets||!this._parent.loadMorphTargets)return;if(t._numMorphTargets==null)t._numMorphTargets=s.targets.length;else if(s.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const a=n.extras?n.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,o.morphTargetManager=new cr(this._babylonScene),o.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,o.morphTargetManager.areUpdatesFrozen=!0;for(let i=0;i<s.targets.length;i++){const l=t.weights?t.weights[i]:n.weights?n.weights[i]:0,c=a?a[i]:`morphTarget${i}`;o.morphTargetManager.addTarget(new ur(c,l,o.getScene()))}}_loadMorphTargetsAsync(e,t,n,s){if(!t.targets||!this._parent.loadMorphTargets)return Promise.resolve();const o=new Array,a=n.morphTargetManager;for(let i=0;i<a.numTargets;i++){const l=a.getTarget(i);o.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${i}`,s,t.targets[i],l))}return Promise.all(o).then(()=>{a.areUpdatesFrozen=!1})}_loadMorphTargetVertexDataAsync(e,t,n,s){const o=new Array,a=(i,l,c)=>{if(n[i]==null)return;const u=t.getVertexBuffer(l);if(!u)return;const h=b.Get(`${e}/${i}`,this._gltf.accessors,n[i]);o.push(this._loadFloatAccessorAsync(`/accessors/${h.index}`,h).then(d=>{c(u,d)}))};return a("POSITION",S.PositionKind,(i,l)=>{const c=new Float32Array(l.length);i.forEach(l.length,(u,h)=>{c[h]=l[h]+u}),s.setPositions(c)}),a("NORMAL",S.NormalKind,(i,l)=>{const c=new Float32Array(l.length);i.forEach(c.length,(u,h)=>{c[h]=l[h]+u}),s.setNormals(c)}),a("TANGENT",S.TangentKind,(i,l)=>{const c=new Float32Array(l.length/3*4);let u=0;i.forEach(l.length/3*4,(h,d)=>{(d+1)%4!==0&&(c[u]=l[u]+h,u++)}),s.setTangents(c)}),a("TEXCOORD_0",S.UVKind,(i,l)=>{const c=new Float32Array(l.length);i.forEach(l.length,(u,h)=>{c[h]=l[h]+u}),s.setUVs(c)}),a("TEXCOORD_1",S.UV2Kind,(i,l)=>{const c=new Float32Array(l.length);i.forEach(l.length,(u,h)=>{c[h]=l[h]+u}),s.setUV2s(c)}),a("COLOR_0",S.ColorKind,(i,l)=>{let c=null;const u=i.getSize();if(u===3){c=new Float32Array(l.length/3*4),i.forEach(l.length,(h,d)=>{const f=Math.floor(d/3),p=d%3;c[4*f+p]=l[3*f+p]+h});for(let h=0;h<l.length/3;++h)c[4*h+3]=1}else if(u===4)c=new Float32Array(l.length),i.forEach(l.length,(h,d)=>{c[d]=l[d]+h});else throw new Error(`${e}: Invalid number of components (${u}) for COLOR_0 attribute`);s.setColors(c)}),Promise.all(o).then(()=>{})}static _LoadTransform(e,t){if(e.skin!=null)return;let n=N.Zero(),s=te.Identity(),o=N.One();e.matrix?se.FromArray(e.matrix).decompose(o,s,n):(e.translation&&(n=N.FromArray(e.translation)),e.rotation&&(s=te.FromArray(e.rotation)),e.scale&&(o=N.FromArray(e.scale))),t.position=n,t.rotationQuaternion=s,t.scaling=o}_loadSkinAsync(e,t,n,s){if(!this._parent.loadSkins)return Promise.resolve();const o=this._extensionsLoadSkinAsync(e,t,n);if(o)return o;if(n._data)return s(n._data.babylonSkeleton),n._data.promise;const a=`skeleton${n.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const i=new un(n.name||a,a,this._babylonScene);i._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,n,i);const l=this._loadSkinInverseBindMatricesDataAsync(e,n).then(c=>{this._updateBoneMatrices(i,c)});return n._data={babylonSkeleton:i,promise:l},s(i),l}_loadBones(e,t,n){if(t.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){const o=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(o)if(t.skeleton===void 0)t.skeleton=o.index;else{const a=(l,c)=>{for(;c.parent;c=c.parent)if(c.parent===l)return!0;return!1},i=b.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);i!==o&&!a(i,o)&&(P.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=o.index)}else P.Warn(`${e}: Failed to find common root`)}const s={};for(const o of t.joints){const a=b.Get(`${e}/joints/${o}`,this._gltf.nodes,o);this._loadBone(a,t,n,s)}}_findSkeletonRootNode(e,t){if(t.length===0)return null;const n={};for(const o of t){const a=[];let i=b.Get(`${e}/${o}`,this._gltf.nodes,o);for(;i.index!==-1;)a.unshift(i),i=i.parent;n[o]=a}let s=null;for(let o=0;;++o){let a=n[t[0]];if(o>=a.length)return s;const i=a[o];for(let l=1;l<t.length;++l)if(a=n[t[l]],o>=a.length||i!==a[o])return s;s=i}}_loadBone(e,t,n,s){e._isJoint=!0;let o=s[e.index];if(o)return o;let a=null;e.index!==t.skeleton&&(e.parent&&e.parent.index!==-1?a=this._loadBone(e.parent,t,n,s):t.skeleton!==void 0&&P.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const i=t.joints.indexOf(e.index);return o=new ot(e.name||`joint${e.index}`,n,a,this._getNodeMatrix(e),null,null,i),s[e.index]=o,this._postSceneLoadActions.push(()=>{o.linkTransformNode(e._babylonTransformNode)}),o}_loadSkinInverseBindMatricesDataAsync(e,t){if(t.inverseBindMatrices==null)return Promise.resolve(null);const n=b.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${n.index}`,n)}_updateBoneMatrices(e,t){for(const n of e.bones){const s=se.Identity(),o=n._index;t&&o!==-1&&(se.FromArrayToRef(t,o*16,s),s.invertToRef(s));const a=n.getParent();a&&s.multiplyToRef(a.getAbsoluteInverseBindMatrix(),s),n.updateMatrix(s,!1,!1),n._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(e){return e.matrix?se.FromArray(e.matrix):se.Compose(e.scale?N.FromArray(e.scale):N.One(),e.rotation?te.FromArray(e.rotation):te.Identity(),e.translation?N.FromArray(e.translation):N.Zero())}loadCameraAsync(e,t,n=()=>{}){const s=this._extensionsLoadCameraAsync(e,t,n);if(s)return s;const o=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new nn(t.name||`camera${t.index}`,N.Zero(),this._babylonScene,!1);switch(a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.ignoreParentScaling=!0,t._babylonCamera=a,a.rotation.set(0,Math.PI,0),t.type){case"perspective":{const i=t.perspective;if(!i)throw new Error(`${e}: Camera perspective properties are missing`);a.fov=i.yfov,a.minZ=i.znear,a.maxZ=i.zfar||0;break}case"orthographic":{if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);a.mode=is.ORTHOGRAPHIC_CAMERA,a.orthoLeft=-t.orthographic.xmag,a.orthoRight=t.orthographic.xmag,a.orthoBottom=-t.orthographic.ymag,a.orthoTop=t.orthographic.ymag,a.minZ=t.orthographic.znear,a.maxZ=t.orthographic.zfar;break}default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return C.AddPointerMetadata(a,e),this._parent.onCameraLoadedObservable.notifyObservers(a),n(a),this.logClose(),Promise.all(o).then(()=>a)}_loadAnimationsAsync(){const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let n=0;n<e.length;n++){const s=e[n];t.push(this.loadAnimationAsync(`/animations/${s.index}`,s).then(o=>{o.targetedAnimations.length===0&&o.dispose()}))}return Promise.all(t).then(()=>{})}loadAnimationAsync(e,t){const n=this._extensionsLoadAnimationAsync(e,t);return n||sn(async()=>{const{AnimationGroup:s}=await import("./animationGroup-CmNY7dur.js").then(o=>o.d);return{AnimationGroup:s}},__vite__mapDeps([0,1,2,3,4,5])).then(({AnimationGroup:s})=>{this._babylonScene._blockEntityCollection=!!this._assetContainer;const o=new s(t.name||`animation${t.index}`,this._babylonScene);o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=o;const a=new Array;b.Assign(t.channels),b.Assign(t.samplers);for(const i of t.channels)a.push(this._loadAnimationChannelAsync(`${e}/channels/${i.index}`,e,t,i,(l,c)=>{l.animations=l.animations||[],l.animations.push(c),o.addTargetedAnimation(c,l)}));return Promise.all(a).then(()=>(o.normalize(0),o))})}async _loadAnimationChannelAsync(e,t,n,s,o){var d,f,p,_;const a=this._extensionsLoadAnimationChannelAsync(e,t,n,s,o);if(a)return a;if(s.target.node==null)return Promise.resolve();const i=b.Get(`${e}/target/node`,this._gltf.nodes,s.target.node),l=s.target.path,c=l==="weights";if(c&&!i._numMorphTargets||!c&&!i._babylonTransformNode||!this._parent.loadNodeAnimations&&!c&&!i._isJoint)return Promise.resolve();await sn(()=>Promise.resolve().then(()=>so),void 0);let u;switch(l){case"translation":{u=(d=ze("/nodes/{}/translation"))==null?void 0:d.interpolation;break}case"rotation":{u=(f=ze("/nodes/{}/rotation"))==null?void 0:f.interpolation;break}case"scale":{u=(p=ze("/nodes/{}/scale"))==null?void 0:p.interpolation;break}case"weights":{u=(_=ze("/nodes/{}/weights"))==null?void 0:_.interpolation;break}default:throw new Error(`${e}/target/path: Invalid value (${s.target.path})`)}if(!u)throw new Error(`${e}/target/path: Could not find interpolation properties for target path (${s.target.path})`);const h={object:i,info:u};return this._loadAnimationChannelFromTargetInfoAsync(e,t,n,s,h,o)}_loadAnimationChannelFromTargetInfoAsync(e,t,n,s,o,a){const i=this.parent.targetFps,l=1/i,c=b.Get(`${e}/sampler`,n.samplers,s.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${s.sampler}`,c).then(u=>{let h=0;const d=o.object,f=o.info;for(const p of f){const _=p.getStride(d),A=u.input,v=u.output,F=new Array(A.length);let M=0;switch(u.interpolation){case"STEP":{for(let x=0;x<A.length;x++){const T=p.getValue(d,v,M,1);M+=_,F[x]={frame:A[x]*i,value:T,interpolation:1}}break}case"CUBICSPLINE":{for(let x=0;x<A.length;x++){const T=p.getValue(d,v,M,l);M+=_;const I=p.getValue(d,v,M,1);M+=_;const g=p.getValue(d,v,M,l);M+=_,F[x]={frame:A[x]*i,inTangent:T,value:I,outTangent:g}}break}case"LINEAR":{for(let x=0;x<A.length;x++){const T=p.getValue(d,v,M,1);M+=_,F[x]={frame:A[x]*i,value:T}}break}}if(M>0){const x=`${n.name||`animation${n.index}`}_channel${s.index}_${h}`,T=p.buildAnimations(d,x,i,F);for(const I of T)h++,a(I.babylonAnimatable,I.babylonAnimation)}}})}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const n=t.interpolation||"LINEAR";switch(n){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const s=b.Get(`${e}/input`,this._gltf.accessors,t.input),o=b.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${s.index}`,s),this._loadFloatAccessorAsync(`/accessors/${o.index}`,o)]).then(([a,i])=>({input:a,interpolation:n,output:i})),t._data}loadBufferAsync(e,t,n,s){const o=this._extensionsLoadBufferAsync(e,t,n,s);if(o)return o;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then(a=>{try{return new Uint8Array(a.buffer,a.byteOffset+n,s)}catch(i){throw new Error(`${e}: ${i.message}`)}})}loadBufferViewAsync(e,t){const n=this._extensionsLoadBufferViewAsync(e,t);if(n)return n;if(t._data)return t._data;const s=b.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${s.index}`,s,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,n){if(t._data)return t._data;const s=C._GetNumComponents(e,t.type),o=s*S.GetTypeByteLength(t.componentType),a=s*t.count;if(t.bufferView==null)t._data=Promise.resolve(new n(a));else{const i=b.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${i.index}`,i).then(l=>{if(t.componentType===5126&&!t.normalized&&(!i.byteStride||i.byteStride===o))return C._GetTypedArray(e,t.componentType,l,t.byteOffset,a);{const c=new n(a);return S.ForEach(l,t.byteOffset||0,i.byteStride||o,s,t.componentType,c.length,t.normalized||!1,(u,h)=>{c[h]=u}),c}})}if(t.sparse){const i=t.sparse;t._data=t._data.then(l=>{const c=l,u=b.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,i.indices.bufferView),h=b.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,i.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${u.index}`,u),this.loadBufferViewAsync(`/bufferViews/${h.index}`,h)]).then(([d,f])=>{const p=C._GetTypedArray(`${e}/sparse/indices`,i.indices.componentType,d,i.indices.byteOffset,i.count),_=s*i.count;let A;if(t.componentType===5126&&!t.normalized)A=C._GetTypedArray(`${e}/sparse/values`,t.componentType,f,i.values.byteOffset,_);else{const F=C._GetTypedArray(`${e}/sparse/values`,t.componentType,f,i.values.byteOffset,_);A=new n(_),S.ForEach(F,0,o,s,t.componentType,A.length,t.normalized||!1,(M,x)=>{A[x]=M})}let v=0;for(let F=0;F<p.length;F++){let M=p[F]*s;for(let x=0;x<s;x++)c[M++]=A[v++]}return c})})}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if(t.type!=="SCALAR")throw new Error(`${e}/type: Invalid value ${t.type}`);if(t.componentType!==5121&&t.componentType!==5123&&t.componentType!==5125)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const n=C._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,n)}else{const n=b.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${n.index}`,n).then(s=>C._GetTypedArray(e,t.componentType,s,t.byteOffset,t.count))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then(n=>new hr(t,n,!1)),e._babylonBuffer}_loadVertexAccessorAsync(e,t,n){var o;if((o=t._babylonVertexBuffer)!=null&&o[n])return t._babylonVertexBuffer[n];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const s=this._babylonScene.getEngine();if(t.sparse||t.bufferView==null)t._babylonVertexBuffer[n]=this._loadFloatAccessorAsync(e,t).then(a=>new S(s,a,n,!1));else{const a=b.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[n]=this._loadVertexBufferViewAsync(a).then(i=>{const l=C._GetNumComponents(e,t.type);return new S(s,i,n,!1,void 0,a.byteStride,void 0,t.byteOffset,l,t.componentType,t.normalized,!0,void 0,!0)})}return t._babylonVertexBuffer[n]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,n){if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);const s=new Array;return t&&(t.baseColorFactor?(n.albedoColor=B.FromArray(t.baseColorFactor),n.alpha=t.baseColorFactor[3]):n.albedoColor=B.White(),n.metallic=t.metallicFactor==null?1:t.metallicFactor,n.roughness=t.roughnessFactor==null?1:t.roughnessFactor,t.baseColorTexture&&s.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,o=>{o.name=`${n.name} (Base Color)`,n.albedoTexture=o})),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,o=>{o.name=`${n.name} (Metallic Roughness)`,n.metallicTexture=o})),n.useMetallnessFromMetallicTextureBlue=!0,n.useRoughnessFromMetallicTextureGreen=!0,n.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(s).then(()=>{})}_loadMaterialAsync(e,t,n,s,o=()=>{}){const a=this._extensionsLoadMaterialAsync(e,t,n,s,o);if(a)return a;t._data=t._data||{};let i=t._data[s];if(!i){this.logOpen(`${e} ${t.name||""}`);const l=this.createMaterial(e,t,s);i={babylonMaterial:l,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,l)},t._data[s]=i,C.AddPointerMetadata(l,e),this._parent.onMaterialLoadedObservable.notifyObservers(l),this.logClose()}return n&&(i.babylonMeshes.push(n),n.onDisposeObservable.addOnce(()=>{const l=i.babylonMeshes.indexOf(n);l!==-1&&i.babylonMeshes.splice(l,1)})),o(i.babylonMaterial),i.promise.then(()=>i.babylonMaterial)}_createDefaultMaterial(e,t){this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new Z(e,this._babylonScene);return n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n.fillMode=t,n.enableSpecularAntiAliasing=!0,n.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,n.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,n.transparencyMode=Z.PBRMATERIAL_OPAQUE,n.metallic=1,n.roughness=1,n}createMaterial(e,t,n){const s=this._extensionsCreateMaterial(e,t,n);if(s)return s;const o=t.name||`material${t.index}`;return this._createDefaultMaterial(o,n)}loadMaterialPropertiesAsync(e,t,n){const s=this._extensionsLoadMaterialPropertiesAsync(e,t,n);if(s)return s;const o=new Array;return o.push(this.loadMaterialBasePropertiesAsync(e,t,n)),t.pbrMetallicRoughness&&o.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,n)),this.loadMaterialAlphaProperties(e,t,n),Promise.all(o).then(()=>{})}loadMaterialBasePropertiesAsync(e,t,n){if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);const s=new Array;return n.emissiveColor=t.emissiveFactor?B.FromArray(t.emissiveFactor):new B(0,0,0),t.doubleSided&&(n.backFaceCulling=!1,n.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,o=>{o.name=`${n.name} (Normal)`,n.bumpTexture=o})),n.invertNormalMapX=!this._babylonScene.useRightHandedSystem,n.invertNormalMapY=this._babylonScene.useRightHandedSystem,t.normalTexture.scale!=null&&n.bumpTexture&&(n.bumpTexture.level=t.normalTexture.scale),n.forceIrradianceInFragment=!0),t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,o=>{o.name=`${n.name} (Occlusion)`,n.ambientTexture=o})),n.useAmbientInGrayScale=!0,t.occlusionTexture.strength!=null&&(n.ambientTextureStrength=t.occlusionTexture.strength)),t.emissiveTexture&&s.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,o=>{o.name=`${n.name} (Emissive)`,n.emissiveTexture=o})),Promise.all(s).then(()=>{})}loadMaterialAlphaProperties(e,t,n){if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);switch(t.alphaMode||"OPAQUE"){case"OPAQUE":{n.transparencyMode=Z.PBRMATERIAL_OPAQUE,n.alpha=1;break}case"MASK":{n.transparencyMode=Z.PBRMATERIAL_ALPHATEST,n.alphaCutOff=t.alphaCutoff==null?.5:t.alphaCutoff,n.albedoTexture&&(n.albedoTexture.hasAlpha=!0);break}case"BLEND":{n.transparencyMode=Z.PBRMATERIAL_ALPHABLEND,n.albedoTexture&&(n.albedoTexture.hasAlpha=!0,n.useAlphaFromAlbedoTexture=!0);break}default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,n=()=>{}){const s=this._extensionsLoadTextureInfoAsync(e,t,n);if(s)return s;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const o=b.Get(`${e}/index`,this._gltf.textures,t.index);o._textureInfo=t;const a=this._loadTextureAsync(`/textures/${t.index}`,o,i=>{i.coordinatesIndex=t.texCoord||0,C.AddPointerMetadata(i,e),this._parent.onTextureLoadedObservable.notifyObservers(i),n(i)});return this.logClose(),a}_loadTextureAsync(e,t,n=()=>{}){const s=this._extensionsLoadTextureAsync(e,t,n);if(s)return s;this.logOpen(`${e} ${t.name||""}`);const o=t.sampler==null?C.DefaultSampler:b.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),a=b.Get(`${e}/source`,this._gltf.images,t.source),i=this._createTextureAsync(e,o,a,n,void 0,!t._textureInfo.nonColorData);return this.logClose(),i}_createTextureAsync(e,t,n,s=()=>{},o,a){const i=this._loadSampler(`/samplers/${t.index}`,t),l=new Array,c=new Qe;this._babylonScene._blockEntityCollection=!!this._assetContainer;const u={noMipmap:i.noMipMaps,invertY:!1,samplingMode:i.samplingMode,onLoad:()=>{this._disposed||c.resolve()},onError:(d,f)=>{this._disposed||c.reject(new Error(`${e}: ${f&&f.message?f.message:d||"Failed to load texture"}`))},mimeType:n.mimeType,loaderOptions:o,useSRGBBuffer:!!a&&this._parent.useSRGBBuffers},h=new q(null,this._babylonScene,u);return h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.push(c.promise),l.push(this.loadImageAsync(`/images/${n.index}`,n).then(d=>{const f=n.uri||`${this._fileName}#image${n.index}`,p=`data:${this._uniqueRootUrl}${f}`;h.updateURL(p,d);const _=h.getInternalTexture();_&&(_.label=n.name)})),h.wrapU=i.wrapU,h.wrapV=i.wrapV,s(h),this._parent.useGltfTextureNames&&(h.name=n.name||n.uri||`image${n.index}`),Promise.all(l).then(()=>h)}_loadSampler(e,t){return t._data||(t._data={noMipMaps:t.minFilter===9728||t.minFilter===9729,samplingMode:C._GetTextureSamplingMode(e,t),wrapU:C._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:C._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{const n=b.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${n.index}`,n)}this.logClose()}return t._data}loadUriAsync(e,t,n){const s=this._extensionsLoadUriAsync(e,t,n);if(s)return s;if(!C._ValidateUri(n))throw new Error(`${e}: '${n}' is invalid`);if(dr(n)){const o=new Uint8Array(ss(n));return this.log(`${e}: Decoded ${n.substring(0,64)}... (${o.length} bytes)`),Promise.resolve(o)}return this.log(`${e}: Loading ${n}`),this._parent.preprocessUrlAsync(this._rootUrl+n).then(o=>new Promise((a,i)=>{this._parent._loadFile(this._babylonScene,o,l=>{this._disposed||(this.log(`${e}: Loaded ${n} (${l.byteLength} bytes)`),a(new Uint8Array(l)))},!0,l=>{i(new fr(`${e}: Failed to load '${n}'${l?": "+l.status+" "+l.statusText:""}`,l))})}))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};const n=e._internalMetadata=e._internalMetadata||{},s=n.gltf=n.gltf||{};(s.pointers=s.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=t??10497,t){case 33071:return q.CLAMP_ADDRESSMODE;case 33648:return q.MIRROR_ADDRESSMODE;case 10497:return q.WRAP_ADDRESSMODE;default:return P.Warn(`${e}: Invalid value (${t})`),q.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const n=t.magFilter==null?9729:t.magFilter,s=t.minFilter==null?9987:t.minFilter;if(n===9729)switch(s){case 9728:return q.LINEAR_NEAREST;case 9729:return q.LINEAR_LINEAR;case 9984:return q.LINEAR_NEAREST_MIPNEAREST;case 9985:return q.LINEAR_LINEAR_MIPNEAREST;case 9986:return q.LINEAR_NEAREST_MIPLINEAR;case 9987:return q.LINEAR_LINEAR_MIPLINEAR;default:return P.Warn(`${e}/minFilter: Invalid value (${s})`),q.LINEAR_LINEAR_MIPLINEAR}else switch(n!==9728&&P.Warn(`${e}/magFilter: Invalid value (${n})`),s){case 9728:return q.NEAREST_NEAREST;case 9729:return q.NEAREST_LINEAR;case 9984:return q.NEAREST_NEAREST_MIPNEAREST;case 9985:return q.NEAREST_LINEAR_MIPNEAREST;case 9986:return q.NEAREST_NEAREST_MIPLINEAR;case 9987:return q.NEAREST_LINEAR_MIPLINEAR;default:return P.Warn(`${e}/minFilter: Invalid value (${s})`),q.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){try{return pr(t)}catch(n){throw new Error(`${e}: ${n.message}`)}}static _GetTypedArray(e,t,n,s,o){const a=n.buffer;s=n.byteOffset+(s||0);const i=C._GetTypedArrayConstructor(`${e}/componentType`,t),l=S.GetTypeByteLength(t);return s%l!==0?(P.Warn(`${e}: Copying buffer as byte offset (${s}) is not a multiple of component type byte length (${l})`),new i(a.slice(s,s+o*l),0)):new i(a,s,o)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return D.IsBase64(e)||e.indexOf("..")===-1}static _GetDrawMode(e,t){switch(t==null&&(t=4),t){case 0:return _e.PointListDrawMode;case 1:return _e.LineListDrawMode;case 2:return _e.LineLoopDrawMode;case 3:return _e.LineStripDrawMode;case 4:return _e.TriangleFillMode;case 5:return _e.TriangleStripDrawMode;case 6:return _e.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials){for(const t of this._gltf.materials)if(t._data)for(const n in t._data){const s=t._data[n];for(const o of s.babylonMeshes){o.computeWorldMatrix(!0);const a=s.babylonMaterial;e.push(a.forceCompilationAsync(o)),e.push(a.forceCompilationAsync(o,{useInstances:!0})),this._parent.useClipPlane&&(e.push(a.forceCompilationAsync(o,{clipPlane:!0})),e.push(a.forceCompilationAsync(o,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const n of t){const s=n.getShadowGenerator();s&&e.push(s.forceCompilationAsync())}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,n){for(const s of this._extensions)if(s.enabled){const o=`${s.name}.${t}`,a=e;a._activeLoaderExtensionFunctions=a._activeLoaderExtensionFunctions||{};const i=a._activeLoaderExtensionFunctions;if(!i[o]){i[o]=!0;try{const l=n(s);if(l)return l}finally{delete i[o]}}}return null}_extensionsOnLoading(){this._forEachExtensions(e=>e.onLoading&&e.onLoading())}_extensionsOnReady(){this._forEachExtensions(e=>e.onReady&&e.onReady())}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",n=>n.loadSceneAsync&&n.loadSceneAsync(e,t))}_extensionsLoadNodeAsync(e,t,n){return this._applyExtensions(t,"loadNode",s=>s.loadNodeAsync&&s.loadNodeAsync(e,t,n))}_extensionsLoadCameraAsync(e,t,n){return this._applyExtensions(t,"loadCamera",s=>s.loadCameraAsync&&s.loadCameraAsync(e,t,n))}_extensionsLoadVertexDataAsync(e,t,n){return this._applyExtensions(t,"loadVertexData",s=>s._loadVertexDataAsync&&s._loadVertexDataAsync(e,t,n))}_extensionsLoadMeshPrimitiveAsync(e,t,n,s,o,a){return this._applyExtensions(o,"loadMeshPrimitive",i=>i._loadMeshPrimitiveAsync&&i._loadMeshPrimitiveAsync(e,t,n,s,o,a))}_extensionsLoadMaterialAsync(e,t,n,s,o){return this._applyExtensions(t,"loadMaterial",a=>a._loadMaterialAsync&&a._loadMaterialAsync(e,t,n,s,o))}_extensionsCreateMaterial(e,t,n){return this._applyExtensions(t,"createMaterial",s=>s.createMaterial&&s.createMaterial(e,t,n))}_extensionsLoadMaterialPropertiesAsync(e,t,n){return this._applyExtensions(t,"loadMaterialProperties",s=>s.loadMaterialPropertiesAsync&&s.loadMaterialPropertiesAsync(e,t,n))}_extensionsLoadTextureInfoAsync(e,t,n){return this._applyExtensions(t,"loadTextureInfo",s=>s.loadTextureInfoAsync&&s.loadTextureInfoAsync(e,t,n))}_extensionsLoadTextureAsync(e,t,n){return this._applyExtensions(t,"loadTexture",s=>s._loadTextureAsync&&s._loadTextureAsync(e,t,n))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",n=>n.loadAnimationAsync&&n.loadAnimationAsync(e,t))}_extensionsLoadAnimationChannelAsync(e,t,n,s,o){return this._applyExtensions(n,"loadAnimationChannel",a=>a._loadAnimationChannelAsync&&a._loadAnimationChannelAsync(e,t,n,s,o))}_extensionsLoadSkinAsync(e,t,n){return this._applyExtensions(n,"loadSkin",s=>s._loadSkinAsync&&s._loadSkinAsync(e,t,n))}_extensionsLoadUriAsync(e,t,n){return this._applyExtensions(t,"loadUri",s=>s._loadUriAsync&&s._loadUriAsync(e,t,n))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",n=>n.loadBufferViewAsync&&n.loadBufferViewAsync(e,t))}_extensionsLoadBufferAsync(e,t,n,s){return this._applyExtensions(t,"loadBuffer",o=>o.loadBufferAsync&&o.loadBufferAsync(e,t,n,s))}static LoadExtensionAsync(e,t,n,s){if(!t.extensions)return null;const a=t.extensions[n];return a?s(`${e}/extensions/${n}`,a):null}static LoadExtraAsync(e,t,n,s){if(!t.extras)return null;const a=t.extras[n];return a?s(`${e}/extras/${n}`,a):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(e)!==-1}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}C.DefaultSampler={index:-1};z._CreateGLTF2Loader=r=>new C(r);function Zt(r,e,t,n){return N.FromArray(e,t).scaleInPlace(n)}function gn(r,e,t,n){return te.FromArray(e,t).scaleInPlace(n)}function yn(r,e,t,n){const s=new Array(r._numMorphTargets);for(let o=0;o<s.length;o++)s[o]=e[t++]*n;return s}class He{constructor(e,t,n,s){this.type=e,this.name=t,this.getValue=n,this.getStride=s}_buildAnimation(e,t,n){const s=new O(e,this.name,t,this.type);return s.setKeys(n),s}}class at extends He{buildAnimations(e,t,n,s){const o=[];return o.push({babylonAnimatable:e._babylonTransformNode,babylonAnimation:this._buildAnimation(t,n,s)}),o}}class bn extends He{buildAnimations(e,t,n,s){const o=[];if(e._numMorphTargets)for(let a=0;a<e._numMorphTargets;a++){const i=new O(`${t}_${a}`,this.name,n,this.type);if(i.setKeys(s.map(l=>({frame:l.frame,inTangent:l.inTangent?l.inTangent[a]:void 0,value:l.value[a],outTangent:l.outTangent?l.outTangent[a]:void 0,interpolation:l.interpolation}))),e._primitiveBabylonMeshes){for(const l of e._primitiveBabylonMeshes)if(l.morphTargetManager){const c=l.morphTargetManager.getTarget(a),u=i.clone();c.animations.push(u),o.push({babylonAnimatable:c,babylonAnimation:u})}}}return o}}m("/nodes/{}/translation",[new at(O.ANIMATIONTYPE_VECTOR3,"position",Zt,()=>3)]);m("/nodes/{}/rotation",[new at(O.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",gn,()=>4)]);m("/nodes/{}/scale",[new at(O.ANIMATIONTYPE_VECTOR3,"scaling",Zt,()=>3)]);m("/nodes/{}/weights",[new bn(O.ANIMATIONTYPE_FLOAT,"influence",yn,r=>r._numMorphTargets)]);const so=Object.freeze(Object.defineProperty({__proto__:null,AnimationPropertyInfo:He,TransformNodeAnimationPropertyInfo:at,WeightAnimationPropertyInfo:bn,getQuaternion:gn,getVector3:Zt,getWeights:yn},Symbol.toStringTag,{value:"Module"})),_t="EXT_lights_image_based";class ms{constructor(e){this.name=_t,this._loader=e,this.enabled=this._loader.isExtensionUsed(_t)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return C.LoadExtensionAsync(e,t,this.name,(n,s)=>{this._loader._allMaterialsDirtyRequired=!0;const o=new Array;o.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${n}`);const a=b.Get(`${n}/light`,this._lights,s.light);return o.push(this._loadLightAsync(`/extensions/${this.name}/lights/${s.light}`,a).then(i=>{this._loader.babylonScene.environmentTexture=i})),this._loader.logClose(),Promise.all(o).then(()=>{})})}_loadLightAsync(e,t){if(!t._loaded){const n=new Array;this._loader.logOpen(`${e}`);const s=new Array(t.specularImages.length);for(let o=0;o<t.specularImages.length;o++){const a=t.specularImages[o];s[o]=new Array(a.length);for(let i=0;i<a.length;i++){const l=`${e}/specularImages/${o}/${i}`;this._loader.logOpen(`${l}`);const c=a[i],u=b.Get(l,this._loader.gltf.images,c);n.push(this._loader.loadImageAsync(`/images/${c}`,u).then(h=>{s[o][i]=h})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(n).then(()=>{const o=new Er(this._loader.babylonScene,null,t.specularImageSize);if(o.name=t.name||"environment",t._babylonTexture=o,t.intensity!=null&&(o.level=t.intensity),t.rotation){let c=te.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(c=te.Inverse(c)),se.FromQuaternionToRef(c,o.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const a=_r.FromArray(t.irradianceCoefficients);a.scaleInPlace(t.intensity),a.convertIrradianceToLambertianRadiance();const i=mr.FromHarmonics(a),l=(s.length-1)/Math.log2(t.specularImageSize);return o.updateRGBDAsync(s,i,l)})}return t._loaded.then(()=>t._babylonTexture)}}k(_t);R(_t,!0,r=>new ms(r));const mt="EXT_mesh_gpu_instancing";class gs{constructor(e){this.name=mt,this._loader=e,this.enabled=this._loader.isExtensionUsed(mt)}dispose(){this._loader=null}loadNodeAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{this._loader._disableInstancedMesh++;const a=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,n);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return a;const i=new Array;let l=0;const c=u=>{if(o.attributes[u]==null){i.push(Promise.resolve(null));return}const h=b.Get(`${s}/attributes/${u}`,this._loader.gltf.accessors,o.attributes[u]);if(i.push(this._loader._loadFloatAccessorAsync(`/accessors/${h.bufferView}`,h)),l===0)l=h.count;else if(l!==h.count)throw new Error(`${s}/attributes: Instance buffer accessors do not have the same count.`)};return c("TRANSLATION"),c("ROTATION"),c("SCALE"),a.then(u=>Promise.all(i).then(([h,d,f])=>{const p=new Float32Array(l*16);pe.Vector3[0].copyFromFloats(0,0,0),pe.Quaternion[0].copyFromFloats(0,0,0,1),pe.Vector3[1].copyFromFloats(1,1,1);for(let _=0;_<l;++_)h&&N.FromArrayToRef(h,_*3,pe.Vector3[0]),d&&te.FromArrayToRef(d,_*4,pe.Quaternion[0]),f&&N.FromArrayToRef(f,_*3,pe.Vector3[1]),se.ComposeToRef(pe.Vector3[1],pe.Quaternion[0],pe.Vector3[0],pe.Matrix[0]),pe.Matrix[0].copyToArray(p,_*16);for(const _ of t._primitiveBabylonMeshes)_.thinInstanceSetBuffer("matrix",p,16,!0);return u}))})}}k(mt);R(mt,!0,r=>new gs(r));const gt="EXT_meshopt_compression";class ys{constructor(e){this.name=gt,this.enabled=e.isExtensionUsed(gt),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return C.LoadExtensionAsync(e,t,this.name,(n,s)=>{const o=t;if(o._meshOptData)return o._meshOptData;const a=b.Get(`${e}/buffer`,this._loader.gltf.buffers,s.buffer);return o._meshOptData=this._loader.loadBufferAsync(`/buffers/${a.index}`,a,s.byteOffset||0,s.byteLength).then(i=>gr.Default.decodeGltfBufferAsync(i,s.count,s.byteStride,s.mode,s.filter)),o._meshOptData})}}k(gt);R(gt,!0,r=>new ys(r));const yt="EXT_texture_webp";class bs{constructor(e){this.name=yt,this._loader=e,this.enabled=e.isExtensionUsed(yt)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{const a=t.sampler==null?C.DefaultSampler:b.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),i=b.Get(`${s}/source`,this._loader.gltf.images,o.source);return this._loader._createTextureAsync(e,a,i,l=>{n(l)},void 0,!t._textureInfo.nonColorData)})}}k(yt);R(yt,!0,r=>new bs(r));const bt="EXT_texture_avif";class As{constructor(e){this.name=bt,this._loader=e,this.enabled=e.isExtensionUsed(bt)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{const a=t.sampler==null?C.DefaultSampler:b.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),i=b.Get(`${s}/source`,this._loader.gltf.images,o.source);return this._loader._createTextureAsync(e,a,i,l=>{n(l)},void 0,!t._textureInfo.nonColorData)})}}k(bt);R(bt,!0,r=>new As(r));const At="EXT_lights_ies";class Ts{constructor(e){this.name=At,this._loader=e,this.enabled=this._loader.isExtensionUsed(At)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,b.Assign(this._lights)}}loadNodeAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,async(s,o)=>{this._loader._allMaterialsDirtyRequired=!0;let a,i;const l=await this._loader.loadNodeAsync(e,t,u=>{i=b.Get(s,this._lights,o.light);const h=i.name||u.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,a=new we(h,N.Zero(),N.Backward(),0,1,this._loader.babylonScene),a.angle=Math.PI/2,a.innerAngle=0,a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,i._babylonLight=a,a.falloffType=ls.FALLOFF_GLTF,a.diffuse=o.color?B.FromArray(o.color):B.White(),a.intensity=o.multiplier||1,a.range=Number.MAX_VALUE,a.parent=u,this._loader._babylonLights.push(a),C.AddPointerMetadata(a,s),n(u)});let c;if(i.uri)c=await this._loader.loadUriAsync(e,i,i.uri);else{const u=b.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,i.bufferView);c=await this._loader.loadBufferViewAsync(`/bufferViews/${u.index}`,u)}return a.iesProfileTexture=new q(name+"_iesProfile",this._loader.babylonScene,!0,!1,void 0,null,null,c,!0,void 0,void 0,void 0,void 0,".ies"),l})}}k(At);R(At,!0,r=>new Ts(r));const Tt="KHR_draco_mesh_compression";class xs{constructor(e){this.name=Tt,this.useNormalizedFlagFromAccessor=!0,this._loader=e,this.enabled=Un.DefaultAvailable&&this._loader.isExtensionUsed(Tt)}dispose(){delete this.dracoDecoder,this._loader=null}_loadVertexDataAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{if(t.mode!=null&&t.mode!==4&&t.mode!==5)throw new Error(`${e}: Unsupported mode ${t.mode}`);const a={},i={},l=(u,h)=>{const d=o.attributes[u];if(d!=null&&(n._delayInfo=n._delayInfo||[],n._delayInfo.indexOf(h)===-1&&n._delayInfo.push(h),a[h]=d,this.useNormalizedFlagFromAccessor)){const f=b.TryGet(this._loader.gltf.accessors,t.attributes[u]);f&&(i[h]=f.normalized||!1)}};l("POSITION",S.PositionKind),l("NORMAL",S.NormalKind),l("TANGENT",S.TangentKind),l("TEXCOORD_0",S.UVKind),l("TEXCOORD_1",S.UV2Kind),l("TEXCOORD_2",S.UV3Kind),l("TEXCOORD_3",S.UV4Kind),l("TEXCOORD_4",S.UV5Kind),l("TEXCOORD_5",S.UV6Kind),l("JOINTS_0",S.MatricesIndicesKind),l("WEIGHTS_0",S.MatricesWeightsKind),l("COLOR_0",S.ColorKind);const c=b.Get(s,this._loader.gltf.bufferViews,o.bufferView);return c._dracoBabylonGeometry||(c._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${c.index}`,c).then(u=>{const h=this.dracoDecoder||Un.Default,d=b.TryGet(this._loader.gltf.accessors,t.attributes.POSITION),f=!this._loader.parent.alwaysComputeBoundingBox&&!n.skeleton&&d?mn(d):null;return h._decodeMeshToGeometryForGltfAsync(n.name,this._loader.babylonScene,u,a,i,f).catch(p=>{throw new Error(`${e}: ${p.message}`)})})),c._dracoBabylonGeometry})}}k(Tt);R(Tt,!0,r=>new xs(r));const xt="KHR_lights_punctual";class ws{constructor(e){this.name=xt,this._loader=e,this.enabled=this._loader.isExtensionUsed(xt)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,b.Assign(this._lights)}}loadNodeAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>(this._loader._allMaterialsDirtyRequired=!0,this._loader.loadNodeAsync(e,t,a=>{let i;const l=b.Get(s,this._lights,o.light),c=l.name||a.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l.type){case"directional":{const u=new hn(c,N.Backward(),this._loader.babylonScene);u.position.setAll(0),i=u;break}case"point":{i=new dn(c,N.Zero(),this._loader.babylonScene);break}case"spot":{const u=new we(c,N.Zero(),N.Backward(),0,1,this._loader.babylonScene);u.angle=(l.spot&&l.spot.outerConeAngle||Math.PI/4)*2,u.innerAngle=(l.spot&&l.spot.innerConeAngle||0)*2,i=u;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${s}: Invalid light type (${l.type})`)}i._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=i,i.falloffType=ls.FALLOFF_GLTF,i.diffuse=l.color?B.FromArray(l.color):B.White(),i.intensity=l.intensity==null?1:l.intensity,i.range=l.range==null?Number.MAX_VALUE:l.range,i.parent=a,this._loader._babylonLights.push(i),C.AddPointerMetadata(i,s),n(a)})))}}k(xt);R(xt,!0,r=>new ws(r));const wt="KHR_materials_pbrSpecularGlossiness";class vs{constructor(e){this.name=wt,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(wt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{const a=new Array;return a.push(this._loader.loadMaterialBasePropertiesAsync(e,t,n)),a.push(this._loadSpecularGlossinessPropertiesAsync(s,o,n)),this._loader.loadMaterialAlphaProperties(e,t,n),Promise.all(a).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,t,n){if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);const s=new Array;return n.metallic=null,n.roughness=null,t.diffuseFactor?(n.albedoColor=B.FromArray(t.diffuseFactor),n.alpha=t.diffuseFactor[3]):n.albedoColor=B.White(),n.reflectivityColor=t.specularFactor?B.FromArray(t.specularFactor):B.White(),n.microSurface=t.glossinessFactor==null?1:t.glossinessFactor,t.diffuseTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,t.diffuseTexture,o=>{o.name=`${n.name} (Diffuse)`,n.albedoTexture=o})),t.specularGlossinessTexture&&(s.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,t.specularGlossinessTexture,o=>{o.name=`${n.name} (Specular Glossiness)`,n.reflectivityTexture=o,n.reflectivityTexture.hasAlpha=!0})),n.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(s).then(()=>{})}}k(wt);R(wt,!0,r=>new vs(r));const vt="KHR_materials_unlit";class Es{constructor(e){this.name=vt,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(vt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,()=>this._loadUnlitPropertiesAsync(e,t,n))}_loadUnlitPropertiesAsync(e,t,n){if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);const s=new Array;n.unlit=!0;const o=t.pbrMetallicRoughness;return o&&(o.baseColorFactor?(n.albedoColor=B.FromArray(o.baseColorFactor),n.alpha=o.baseColorFactor[3]):n.albedoColor=B.White(),o.baseColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,o.baseColorTexture,a=>{a.name=`${n.name} (Base Color)`,n.albedoTexture=a}))),t.doubleSided&&(n.backFaceCulling=!1,n.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,n),Promise.all(s).then(()=>{})}}k(vt);R(vt,!0,r=>new Es(r));const Et="KHR_materials_clearcoat";class Cs{constructor(e){this.name=Et,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Et)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadClearCoatPropertiesAsync(s,o,n)),Promise.all(a).then(()=>{})})}_loadClearCoatPropertiesAsync(e,t,n){if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);const s=new Array;return n.clearCoat.isEnabled=!0,n.clearCoat.useRoughnessFromMainTexture=!1,n.clearCoat.remapF0OnInterfaceChange=!1,t.clearcoatFactor!=null?n.clearCoat.intensity=t.clearcoatFactor:n.clearCoat.intensity=0,t.clearcoatTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,o=>{o.name=`${n.name} (ClearCoat)`,n.clearCoat.texture=o})),t.clearcoatRoughnessFactor!=null?n.clearCoat.roughness=t.clearcoatRoughnessFactor:n.clearCoat.roughness=0,t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,o=>{o.name=`${n.name} (ClearCoat Roughness)`,n.clearCoat.textureRoughness=o}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,o=>{o.name=`${n.name} (ClearCoat Normal)`,n.clearCoat.bumpTexture=o})),n.invertNormalMapX=!n.getScene().useRightHandedSystem,n.invertNormalMapY=n.getScene().useRightHandedSystem,t.clearcoatNormalTexture.scale!=null&&(n.clearCoat.bumpTexture.level=t.clearcoatNormalTexture.scale)),Promise.all(s).then(()=>{})}}k(Et);R(Et,!0,r=>new Cs(r));const Ct="KHR_materials_iridescence";class Os{constructor(e){this.name=Ct,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ct)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadIridescencePropertiesAsync(s,o,n)),Promise.all(a).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,n){if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);const s=new Array;return n.iridescence.isEnabled=!0,n.iridescence.intensity=t.iridescenceFactor??0,n.iridescence.indexOfRefraction=t.iridescenceIor??t.iridescenceIOR??1.3,n.iridescence.minimumThickness=t.iridescenceThicknessMinimum??100,n.iridescence.maximumThickness=t.iridescenceThicknessMaximum??400,t.iridescenceTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,o=>{o.name=`${n.name} (Iridescence)`,n.iridescence.texture=o})),t.iridescenceThicknessTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,o=>{o.name=`${n.name} (Iridescence Thickness)`,n.iridescence.thicknessTexture=o})),Promise.all(s).then(()=>{})}}k(Ct);R(Ct,!0,r=>new Os(r));const Ot="KHR_materials_anisotropy";class Is{constructor(e){this.name=Ot,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ot)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadIridescencePropertiesAsync(s,o,n)),Promise.all(a).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,n){if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);const s=new Array;return n.anisotropy.isEnabled=!0,n.anisotropy.intensity=t.anisotropyStrength??0,n.anisotropy.angle=t.anisotropyRotation??0,t.anisotropyTexture&&(t.anisotropyTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/anisotropyTexture`,t.anisotropyTexture,o=>{o.name=`${n.name} (Anisotropy Intensity)`,n.anisotropy.texture=o}))),Promise.all(s).then(()=>{})}}k(Ot);R(Ot,!0,r=>new Is(r));const It="KHR_materials_emissive_strength";class Ns{constructor(e){this.name=It,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(It)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>this._loader.loadMaterialPropertiesAsync(e,t,n).then(()=>{this._loadEmissiveProperties(s,o,n)}))}_loadEmissiveProperties(e,t,n){if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);t.emissiveStrength!==void 0&&(n.emissiveIntensity=t.emissiveStrength)}}k(It);R(It,!0,r=>new Ns(r));const Nt="KHR_materials_sheen";class Ms{constructor(e){this.name=Nt,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Nt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadSheenPropertiesAsync(s,o,n)),Promise.all(a).then(()=>{})})}_loadSheenPropertiesAsync(e,t,n){if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);const s=new Array;return n.sheen.isEnabled=!0,n.sheen.intensity=1,t.sheenColorFactor!=null?n.sheen.color=B.FromArray(t.sheenColorFactor):n.sheen.color=B.Black(),t.sheenColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,o=>{o.name=`${n.name} (Sheen Color)`,n.sheen.texture=o})),t.sheenRoughnessFactor!==void 0?n.sheen.roughness=t.sheenRoughnessFactor:n.sheen.roughness=0,t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,o=>{o.name=`${n.name} (Sheen Roughness)`,n.sheen.textureRoughness=o}))),n.sheen.albedoScaling=!0,n.sheen.useRoughnessFromMainTexture=!1,Promise.all(s).then(()=>{})}}k(Nt);R(Nt,!0,r=>new Ms(r));const Mt="KHR_materials_specular";class Ss{constructor(e){this.name=Mt,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Mt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadSpecularPropertiesAsync(s,o,n)),Promise.all(a).then(()=>{})})}_loadSpecularPropertiesAsync(e,t,n){if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);const s=new Array;return t.specularFactor!==void 0&&(n.metallicF0Factor=t.specularFactor),t.specularColorFactor!==void 0&&(n.metallicReflectanceColor=B.FromArray(t.specularColorFactor)),t.specularTexture&&(t.specularTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,o=>{o.name=`${n.name} (Specular)`,n.metallicReflectanceTexture=o,n.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),t.specularColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,o=>{o.name=`${n.name} (Specular Color)`,n.reflectanceTexture=o})),Promise.all(s).then(()=>{})}}k(Mt);R(Mt,!0,r=>new Ss(r));const St="KHR_materials_ior";class it{constructor(e){this.name=St,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(St)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadIorPropertiesAsync(s,o,n)),Promise.all(a).then(()=>{})})}_loadIorPropertiesAsync(e,t,n){if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);return t.ior!==void 0?n.indexOfRefraction=t.ior:n.indexOfRefraction=it._DEFAULT_IOR,Promise.resolve()}}it._DEFAULT_IOR=1.5;k(St);R(St,!0,r=>new it(r));const ae="KHR_materials_variants";class he{constructor(e){this.name=ae,this._loader=e,this.enabled=this._loader.isExtensionUsed(ae)}dispose(){this._loader=null}static GetAvailableVariants(e){const t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return he.GetAvailableVariants(e)}static SelectVariant(e,t){const n=this._GetExtensionMetadata(e);if(!n)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${ae} extension`);const s=o=>{const a=n.variants[o];if(a)for(const i of a)i.mesh.material=i.material};if(t instanceof Array)for(const o of t)s(o);else s(t);n.lastSelected=t}selectVariant(e,t){he.SelectVariant(e,t)}static Reset(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot reset on a glTF mesh that does not have the ${ae} extension`);for(const n of t.original)n.mesh.material=n.material;t.lastSelected=null}reset(e){he.Reset(e)}static GetLastSelectedVariant(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${ae} extension`);return t.lastSelected}getLastSelectedVariant(e){return he.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){var t,n;return((n=(t=e==null?void 0:e._internalMetadata)==null?void 0:t.gltf)==null?void 0:n[ae])||null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._variants=t.variants}}onReady(){var t;const e=this._loader.rootBabylonMesh;if(e){const n=this._loader.parent.extensionOptions[ae];n!=null&&n.defaultVariant&&he.SelectVariant(e,n.defaultVariant),(t=n==null?void 0:n.onLoaded)==null||t.call(n,{get variants(){return he.GetAvailableVariants(e)},get selectedVariant(){const s=he.GetLastSelectedVariant(e);return s?Array.isArray(s)?s[0]:s:he.GetAvailableVariants(e)[0]},set selectedVariant(s){he.SelectVariant(e,s)}})}}_loadMeshPrimitiveAsync(e,t,n,s,o,a){return C.LoadExtensionAsync(e,o,this.name,(i,l)=>{const c=new Array;return c.push(this._loader._loadMeshPrimitiveAsync(e,t,n,s,o,u=>{if(a(u),u instanceof Ee){const h=C._GetDrawMode(e,o.mode),d=this._loader.rootBabylonMesh,f=d?d._internalMetadata=d._internalMetadata||{}:{},p=f.gltf=f.gltf||{},_=p[ae]=p[ae]||{lastSelected:null,original:[],variants:{}};_.original.push({mesh:u,material:u.material});for(let A=0;A<l.mappings.length;++A){const v=l.mappings[A],F=b.Get(`${i}/mappings/${A}/material`,this._loader.gltf.materials,v.material);c.push(this._loader._loadMaterialAsync(`#/materials/${v.material}`,F,u,h,M=>{for(let x=0;x<v.variants.length;++x){const T=v.variants[x],I=b.Get(`/extensions/${ae}/variants/${T}`,this._variants,T);_.variants[I.name]=_.variants[I.name]||[],_.variants[I.name].push({mesh:u,material:M}),u.onClonedObservable.add(g=>{const E=g;let G=null,V=E;do{if(V=V.parent,!V)return;G=he._GetExtensionMetadata(V)}while(G===null);if(d&&G===he._GetExtensionMetadata(d)){V._internalMetadata={};for(const $ in d._internalMetadata)V._internalMetadata[$]=d._internalMetadata[$];V._internalMetadata.gltf=[];for(const $ in d._internalMetadata.gltf)V._internalMetadata.gltf[$]=d._internalMetadata.gltf[$];V._internalMetadata.gltf[ae]={lastSelected:null,original:[],variants:{}};for(const $ of G.original)V._internalMetadata.gltf[ae].original.push({mesh:$.mesh,material:$.material});for(const $ in G.variants)if(Object.prototype.hasOwnProperty.call(G.variants,$)){V._internalMetadata.gltf[ae].variants[$]=[];for(const Te of G.variants[$])V._internalMetadata.gltf[ae].variants[$].push({mesh:Te.mesh,material:Te.material})}G=V._internalMetadata.gltf[ae]}for(const $ of G.original)$.mesh===u&&($.mesh=E);for(const $ of G.variants[I.name])$.mesh===u&&($.mesh=E)})}}))}}})),Promise.all(c).then(([u])=>u)})}}k(ae);R(ae,!0,r=>new he(r));class An{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:Me.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...An._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new le,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(o=>this._options[o]!==e[o]).length)return;const n={...this._options,...e},s=this._options;this._options=n,n.renderSize!==s.renderSize||n.renderTargetTextureType!==s.renderTargetTextureType||n.generateMipmaps!==s.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=n.samples,this._opaqueRenderTarget.lodGenerationScale=n.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=n.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return e?!!(e instanceof Z&&e.subSurface.isRefractionEnabled):!1}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),D.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.indexOf(e)===-1&&this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.indexOf(e)===-1&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);t!==-1&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),t!==-1&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const t=this._transparentMeshesCache.indexOf(e),n=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof Z&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),n!==-1?(this._opaqueMeshesCache.splice(n,1),this._transparentMeshesCache.push(e)):t===-1&&this._transparentMeshesCache.push(e)):t!==-1?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):n===-1&&this._opaqueMeshesCache.push(e)}_isRenderTargetValid(){var e;return((e=this._opaqueRenderTarget)==null?void 0:e.getInternalTexture())!==null}_setupRenderTargets(){var t;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new yr("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=((t=this._options.clearColor)==null?void 0:t.clone())??this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.renderSprites=!0,this._opaqueRenderTarget.renderParticles=!0,this._opaqueRenderTarget.renderInLinearSpace=!0;let e;this._opaqueRenderTarget.onBeforeBindObservable.add(n=>{e=this._scene.environmentIntensity,this._scene.environmentIntensity=1,this._options.clearColor?n.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(n.clearColor,this._scene.getEngine().useExactSrgbConversions)}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=e}),this._transparentMeshesCache.forEach(n=>{this._shouldRenderAsTransmission(n.material)&&(n.material.refractionTexture=this._opaqueRenderTarget)})}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const Pt="KHR_materials_transmission";class Ps{constructor(e){this.name=Pt,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(Pt),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadTransparentPropertiesAsync(s,t,n,o)),Promise.all(a).then(()=>{})})}_loadTransparentPropertiesAsync(e,t,n,s){var a,i;if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);const o=n;if(o.subSurface.isRefractionEnabled=!0,o.subSurface.volumeIndexOfRefraction=1,o.subSurface.useAlbedoToTintRefraction=!0,s.transmissionFactor!==void 0){o.subSurface.refractionIntensity=s.transmissionFactor;const l=o.getScene();o.subSurface.refractionIntensity&&!l._transmissionHelper?new An({},o.getScene()):o.subSurface.refractionIntensity&&!((a=l._transmissionHelper)!=null&&a._isRenderTargetValid())&&((i=l._transmissionHelper)==null||i._setupRenderTargets())}else return o.subSurface.refractionIntensity=0,o.subSurface.isRefractionEnabled=!1,Promise.resolve();return o.subSurface.minimumThickness=0,o.subSurface.maximumThickness=0,s.transmissionTexture?(s.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,s.transmissionTexture,void 0).then(l=>{l.name=`${n.name} (Transmission)`,o.subSurface.refractionIntensityTexture=l,o.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}k(Pt);R(Pt,!0,r=>new Ps(r));const Ft="KHR_materials_diffuse_transmission";class Fs{constructor(e){this.name=Ft,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ft),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadTranslucentPropertiesAsync(s,t,n,o)),Promise.all(a).then(()=>{})})}_loadTranslucentPropertiesAsync(e,t,n,s){if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);const o=n;if(o.subSurface.isTranslucencyEnabled=!0,o.subSurface.volumeIndexOfRefraction=1,o.subSurface.minimumThickness=0,o.subSurface.maximumThickness=0,o.subSurface.useAlbedoToTintTranslucency=!1,s.diffuseTransmissionFactor!==void 0)o.subSurface.translucencyIntensity=s.diffuseTransmissionFactor;else return o.subSurface.translucencyIntensity=0,o.subSurface.isTranslucencyEnabled=!1,Promise.resolve();const a=new Array;return o.subSurface.useGltfStyleTextures=!0,s.diffuseTransmissionTexture&&(s.diffuseTransmissionTexture.nonColorData=!0,a.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionTexture`,s.diffuseTransmissionTexture).then(i=>{i.name=`${n.name} (Diffuse Transmission)`,o.subSurface.translucencyIntensityTexture=i}))),s.diffuseTransmissionColorFactor!==void 0?o.subSurface.translucencyColor=B.FromArray(s.diffuseTransmissionColorFactor):o.subSurface.translucencyColor=B.White(),s.diffuseTransmissionColorTexture&&a.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionColorTexture`,s.diffuseTransmissionColorTexture).then(i=>{i.name=`${n.name} (Diffuse Transmission Color)`,o.subSurface.translucencyColorTexture=i})),Promise.all(a).then(()=>{})}}k(Ft);R(Ft,!0,r=>new Fs(r));const Lt="KHR_materials_volume";class Ls{constructor(e){this.name=Lt,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(Lt),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadVolumePropertiesAsync(s,t,n,o)),Promise.all(a).then(()=>{})})}_loadVolumePropertiesAsync(e,t,n,s){if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);if(!n.subSurface.isRefractionEnabled&&!n.subSurface.isTranslucencyEnabled||!s.thicknessFactor)return Promise.resolve();n.subSurface.volumeIndexOfRefraction=n.indexOfRefraction;const o=s.attenuationDistance!==void 0?s.attenuationDistance:Number.MAX_VALUE;return n.subSurface.tintColorAtDistance=o,s.attenuationColor!==void 0&&s.attenuationColor.length==3&&n.subSurface.tintColor.copyFromFloats(s.attenuationColor[0],s.attenuationColor[1],s.attenuationColor[2]),n.subSurface.minimumThickness=0,n.subSurface.maximumThickness=s.thicknessFactor,n.subSurface.useThicknessAsDepth=!0,s.thicknessTexture?(s.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,s.thicknessTexture).then(a=>{a.name=`${n.name} (Thickness)`,n.subSurface.thicknessTexture=a,n.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}k(Lt);R(Lt,!0,r=>new Ls(r));const kt="KHR_materials_dispersion";class ks{constructor(e){this.name=kt,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(kt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadDispersionPropertiesAsync(s,t,n,o)),Promise.all(a).then(()=>{})})}_loadDispersionPropertiesAsync(e,t,n,s){if(!(n instanceof Z))throw new Error(`${e}: Material type not supported`);return!n.subSurface.isRefractionEnabled||!s.dispersion||(n.subSurface.isDispersionEnabled=!0,n.subSurface.dispersion=s.dispersion),Promise.resolve()}}k(kt);R(kt,!0,r=>new ks(r));const Bt="KHR_mesh_quantization";class Bs{constructor(e){this.name=Bt,this.enabled=e.isExtensionUsed(Bt)}dispose(){}}k(Bt);R(Bt,!0,r=>new Bs(r));const Rt="KHR_texture_basisu";class Rs{constructor(e){this.name=Rt,this._loader=e,this.enabled=e.isExtensionUsed(Rt)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{const a=t.sampler==null?C.DefaultSampler:b.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),i=b.Get(`${s}/source`,this._loader.gltf.images,o.source);return this._loader._createTextureAsync(e,a,i,l=>{n(l)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)})}}k(Rt);R(Rt,!0,r=>new Rs(r));const Gt="KHR_texture_transform";class Gs{constructor(e){this.name=Gt,this._loader=e,this.enabled=this._loader.isExtensionUsed(Gt)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>this._loader.loadTextureInfoAsync(e,t,a=>{if(!(a instanceof q))throw new Error(`${s}: Texture type not supported`);o.offset&&(a.uOffset=o.offset[0],a.vOffset=o.offset[1]),a.uRotationCenter=0,a.vRotationCenter=0,o.rotation&&(a.wAng=-o.rotation),o.scale&&(a.uScale=o.scale[0],a.vScale=o.scale[1]),o.texCoord!=null&&(a.coordinatesIndex=o.texCoord),n(a)}))}}k(Gt);R(Gt,!0,r=>new Gs(r));const Dt="KHR_xmp_json_ld";class Ds{constructor(e){this.name=Dt,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(Dt)}dispose(){this._loader=null}onLoading(){var n,s,o;if(this._loader.rootBabylonMesh===null)return;const e=(n=this._loader.gltf.extensions)==null?void 0:n.KHR_xmp_json_ld,t=(o=(s=this._loader.gltf.asset)==null?void 0:s.extensions)==null?void 0:o.KHR_xmp_json_ld;if(e&&t){const a=+t.packet;e.packets&&a<e.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=e.packets[a])}}}k(Dt);R(Dt,!0,r=>new Ds(r));function ke(r,e,t,n){return B.FromArray(e,t).scale(n)}function ro(r,e,t,n){return e[t+3]*n}function U(r,e,t,n){return e[t]*n}function Tn(r,e,t,n){return-e[t]*n}function Vt(r,e,t,n){return e[t+1]*n}function Vs(r,e,t,n){return e[t]*n*2}function ne(r){return{scale:[new K(O.ANIMATIONTYPE_FLOAT,`${r}.uScale`,U,()=>2),new K(O.ANIMATIONTYPE_FLOAT,`${r}.vScale`,Vt,()=>2)],offset:[new K(O.ANIMATIONTYPE_FLOAT,`${r}.uOffset`,U,()=>2),new K(O.ANIMATIONTYPE_FLOAT,`${r}.vOffset`,Vt,()=>2)],rotation:[new K(O.ANIMATIONTYPE_FLOAT,`${r}.wAng`,Tn,()=>1)]}}class Ie extends He{buildAnimations(e,t,n,s){return[{babylonAnimatable:e._babylonCamera,babylonAnimation:this._buildAnimation(t,n,s)}]}}class K extends He{buildAnimations(e,t,n,s){const o=[];for(const a in e._data)o.push({babylonAnimatable:e._data[a].babylonMaterial,babylonAnimation:this._buildAnimation(t,n,s)});return o}}class Ke extends He{buildAnimations(e,t,n,s){return[{babylonAnimatable:e._babylonLight,babylonAnimation:this._buildAnimation(t,n,s)}]}}m("/cameras/{}/orthographic/xmag",[new Ie(O.ANIMATIONTYPE_FLOAT,"orthoLeft",Tn,()=>1),new Ie(O.ANIMATIONTYPE_FLOAT,"orthoRight",Vt,()=>1)]);m("/cameras/{}/orthographic/ymag",[new Ie(O.ANIMATIONTYPE_FLOAT,"orthoBottom",Tn,()=>1),new Ie(O.ANIMATIONTYPE_FLOAT,"orthoTop",Vt,()=>1)]);m("/cameras/{}/orthographic/zfar",[new Ie(O.ANIMATIONTYPE_FLOAT,"maxZ",U,()=>1)]);m("/cameras/{}/orthographic/znear",[new Ie(O.ANIMATIONTYPE_FLOAT,"minZ",U,()=>1)]);m("/cameras/{}/perspective/yfov",[new Ie(O.ANIMATIONTYPE_FLOAT,"fov",U,()=>1)]);m("/cameras/{}/perspective/zfar",[new Ie(O.ANIMATIONTYPE_FLOAT,"maxZ",U,()=>1)]);m("/cameras/{}/perspective/znear",[new Ie(O.ANIMATIONTYPE_FLOAT,"minZ",U,()=>1)]);m("/materials/{}/pbrMetallicRoughness/baseColorFactor",[new K(O.ANIMATIONTYPE_COLOR3,"albedoColor",ke,()=>4),new K(O.ANIMATIONTYPE_FLOAT,"alpha",ro,()=>4)]);m("/materials/{}/pbrMetallicRoughness/metallicFactor",[new K(O.ANIMATIONTYPE_FLOAT,"metallic",U,()=>1)]);m("/materials/{}/pbrMetallicRoughness/metallicFactor",[new K(O.ANIMATIONTYPE_FLOAT,"roughness",U,()=>1)]);const xn=ne("albedoTexture");m("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/scale",xn.scale);m("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/offset",xn.offset);m("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/rotation",xn.rotation);const wn=ne("metallicTexture");m("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/scale",wn.scale);m("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/offset",wn.offset);m("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/rotation",wn.rotation);m("/materials/{}/emissiveFactor",[new K(O.ANIMATIONTYPE_COLOR3,"emissiveColor",ke,()=>3)]);const vn=ne("bumpTexture");m("/materials/{}/normalTexture/scale",[new K(O.ANIMATIONTYPE_FLOAT,"bumpTexture.level",U,()=>1)]);m("/materials/{}/normalTexture/extensions/KHR_texture_transform/scale",vn.scale);m("/materials/{}/normalTexture/extensions/KHR_texture_transform/offset",vn.offset);m("/materials/{}/normalTexture/extensions/KHR_texture_transform/rotation",vn.rotation);m("/materials/{}/occlusionTexture/strength",[new K(O.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",U,()=>1)]);const En=ne("ambientTexture");m("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/scale",En.scale);m("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/offset",En.offset);m("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/rotation",En.rotation);const Cn=ne("emissiveTexture");m("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/scale",Cn.scale);m("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/offset",Cn.offset);m("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/rotation",Cn.rotation);m("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyStrength",[new K(O.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",U,()=>1)]);m("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyRotation",[new K(O.ANIMATIONTYPE_FLOAT,"anisotropy.angle",U,()=>1)]);const On=ne("anisotropy.texture");m("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/scale",On.scale);m("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/offset",On.offset);m("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/rotation",On.rotation);m("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatFactor",[new K(O.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",U,()=>1)]);m("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessFactor",[new K(O.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",U,()=>1)]);const In=ne("clearCoat.texture");m("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/scale",In.scale);m("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/offset",In.offset);m("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/rotation",In.rotation);const Nn=ne("clearCoat.bumpTexture");m("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/scale",[new K(O.ANIMATIONTYPE_FLOAT,"clearCoat.bumpTexture.level",U,()=>1)]);m("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/scale",Nn.scale);m("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/offset",Nn.offset);m("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/rotation",Nn.rotation);const Mn=ne("clearCoat.textureRoughness");m("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/scale",Mn.scale);m("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/offset",Mn.offset);m("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/rotation",Mn.rotation);m("/materials/{}/extensions/KHR_materials_dispersion/dispersionFactor",[new K(O.ANIMATIONTYPE_FLOAT,"subSurface.dispersion",U,()=>1)]);m("/materials/{}/extensions/KHR_materials_emissive_strength/emissiveStrength",[new K(O.ANIMATIONTYPE_FLOAT,"emissiveIntensity",U,()=>1)]);m("/materials/{}/extensions/KHR_materials_ior/ior",[new K(O.ANIMATIONTYPE_FLOAT,"indexOfRefraction",U,()=>1)]);m("/materials/{}/extensions/KHR_materials_iridescence/iridescenceFactor",[new K(O.ANIMATIONTYPE_FLOAT,"iridescence.intensity",U,()=>1)]);m("/materials/{}/extensions/KHR_materials_iridescence/iridescenceIor",[new K(O.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",U,()=>1)]);m("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMinimum",[new K(O.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",U,()=>1)]);m("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMaximum",[new K(O.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",U,()=>1)]);const Sn=ne("iridescence.texture");m("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/scale",Sn.scale);m("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/offset",Sn.offset);m("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/rotation",Sn.rotation);const Pn=ne("iridescence.thicknessTexture");m("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/scale",Pn.scale);m("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/offset",Pn.offset);m("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/rotation",Pn.rotation);m("/materials/{}/extensions/KHR_materials_sheen/sheenColorFactor",[new K(O.ANIMATIONTYPE_COLOR3,"sheen.color",ke,()=>3)]);m("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessFactor",[new K(O.ANIMATIONTYPE_FLOAT,"sheen.roughness",U,()=>1)]);const Fn=ne("sheen.texture");m("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/scale",Fn.scale);m("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/offset",Fn.offset);m("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/rotation",Fn.rotation);const Ln=ne("sheen.textureRoughness");m("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/scale",Ln.scale);m("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/offset",Ln.offset);m("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/rotation",Ln.rotation);m("/materials/{}/extensions/KHR_materials_specular/specularFactor",[new K(O.ANIMATIONTYPE_FLOAT,"metallicF0Factor",U,()=>1)]);m("/materials/{}/extensions/KHR_materials_specular/specularColorFactor",[new K(O.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",ke,()=>3)]);const kn=ne("metallicReflectanceTexture");m("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/scale",kn.scale);m("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/offset",kn.offset);m("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/rotation",kn.rotation);const Bn=ne("reflectanceTexture");m("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/scale",Bn.scale);m("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/offset",Bn.offset);m("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/rotation",Bn.rotation);m("/materials/{}/extensions/KHR_materials_transmission/transmissionFactor",[new K(O.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",U,()=>1)]);const Rn=ne("subSurface.refractionIntensityTexture");m("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/scale",Rn.scale);m("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/offset",Rn.offset);m("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/rotation",Rn.rotation);m("/materials/{}/extensions/KHR_materials_volume/attenuationColor",[new K(O.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",ke,()=>3)]);m("/materials/{}/extensions/KHR_materials_volume/attenuationDistance",[new K(O.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",U,()=>1)]);m("/materials/{}/extensions/KHR_materials_volume/thicknessFactor",[new K(O.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",U,()=>1)]);const Gn=ne("subSurface.thicknessTexture");m("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/scale",Gn.scale);m("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/offset",Gn.offset);m("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/rotation",Gn.rotation);m("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionFactor",[new K(O.ANIMATIONTYPE_FLOAT,"subSurface.translucencyIntensity",U,()=>1)]);const Dn=ne("subSurface.translucencyIntensityTexture");m("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/scale",Dn.scale);m("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/offset",Dn.offset);m("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/rotation",Dn.rotation);m("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorFactor",[new K(O.ANIMATIONTYPE_COLOR3,"subSurface.translucencyColor",ke,()=>3)]);const Vn=ne("subSurface.translucencyColorTexture");m("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/scale",Vn.scale);m("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/offset",Vn.offset);m("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/rotation",Vn.rotation);m("/extensions/KHR_lights_punctual/lights/{}/color",[new Ke(O.ANIMATIONTYPE_COLOR3,"diffuse",ke,()=>3)]);m("/extensions/KHR_lights_punctual/lights/{}/intensity",[new Ke(O.ANIMATIONTYPE_FLOAT,"intensity",U,()=>1)]);m("/extensions/KHR_lights_punctual/lights/{}/range",[new Ke(O.ANIMATIONTYPE_FLOAT,"range",U,()=>1)]);m("/extensions/KHR_lights_punctual/lights/{}/spot/innerConeAngle",[new Ke(O.ANIMATIONTYPE_FLOAT,"innerAngle",Vs,()=>1)]);m("/extensions/KHR_lights_punctual/lights/{}/spot/outerConeAngle",[new Ke(O.ANIMATIONTYPE_FLOAT,"angle",Vs,()=>1)]);m("/nodes/{}/extensions/EXT_lights_ies/color",[new Ke(O.ANIMATIONTYPE_COLOR3,"diffuse",ke,()=>3)]);m("/nodes/{}/extensions/EXT_lights_ies/multiplier",[new Ke(O.ANIMATIONTYPE_FLOAT,"intensity",U,()=>1)]);const $t="KHR_animation_pointer";class $s{constructor(e){this.name=$t,this._loader=e,this._pathToObjectConverter=_n(this._loader.gltf)}get enabled(){return this._loader.isExtensionUsed($t)}dispose(){this._loader=null,delete this._pathToObjectConverter}_loadAnimationChannelAsync(e,t,n,s,o){var c;const a=(c=s.target.extensions)==null?void 0:c.KHR_animation_pointer;if(!a||!this._pathToObjectConverter)return null;s.target.path!=="pointer"&&P.Warn(`${e}/target/path: Value (${s.target.path}) must be (pointer) when using the ${this.name} extension`),s.target.node!=null&&P.Warn(`${e}/target/node: Value (${s.target.node}) must not be present when using the ${this.name} extension`);const i=`${e}/extensions/${this.name}`,l=a.pointer;if(!l)throw new Error(`${i}: Pointer is missing`);try{const u=this._pathToObjectConverter.convert(l);if(!u.info.interpolation)throw new Error(`${i}/pointer: Interpolation is missing`);return this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,n,s,{object:u.object,info:u.info.interpolation},o)}catch{return P.Warn(`${i}/pointer: Invalid pointer (${l}) skipped`),null}}}k($t);R($t,!0,r=>new $s(r));const Ht="MSFT_audio_emitter";class Hs{constructor(e){this.name=Ht,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ht)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,b.Assign(this._clips),b.Assign(this._emitters)}}loadSceneAsync(e,t){return C.LoadExtensionAsync(e,t,this.name,(n,s)=>{const o=new Array;o.push(this._loader.loadSceneAsync(e,t));for(const a of s.emitters){const i=b.Get(`${n}/emitters`,this._emitters,a);if(i.refDistance!=null||i.maxDistance!=null||i.rolloffFactor!=null||i.distanceModel!=null||i.innerAngle!=null||i.outerAngle!=null)throw new Error(`${n}: Direction or Distance properties are not allowed on emitters attached to a scene`);o.push(this._loadEmitterAsync(`${n}/emitters/${i.index}`,i))}return Promise.all(o).then(()=>{})})}loadNodeAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{const a=new Array;return this._loader.loadNodeAsync(s,t,i=>{for(const l of o.emitters){const c=b.Get(`${s}/emitters`,this._emitters,l);a.push(this._loadEmitterAsync(`${s}/emitters/${c.index}`,c).then(()=>{for(const u of c._babylonSounds)u.attachToMesh(i),(c.innerAngle!=null||c.outerAngle!=null)&&(u.setLocalDirectionToMesh(N.Forward()),u.setDirectionalCone(2*D.ToDegrees(c.innerAngle==null?Math.PI:c.innerAngle),2*D.ToDegrees(c.outerAngle==null?Math.PI:c.outerAngle),0))}))}n(i)}).then(i=>Promise.all(a).then(()=>i))})}loadAnimationAsync(e,t){return C.LoadExtensionAsync(e,t,this.name,(n,s)=>this._loader.loadAnimationAsync(e,t).then(o=>{const a=new Array;b.Assign(s.events);for(const i of s.events)a.push(this._loadAnimationEventAsync(`${n}/events/${i.index}`,e,t,i,o));return Promise.all(a).then(()=>o)}))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let n;if(t.uri)n=this._loader.loadUriAsync(e,t,t.uri);else{const s=b.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);n=this._loader.loadBufferViewAsync(`/bufferViews/${s.index}`,s)}return t._objectURL=n.then(s=>URL.createObjectURL(new Blob([s],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const n=new Array,s=t.name||`emitter${t.index}`,o={loop:!1,autoplay:!1,volume:t.volume==null?1:t.volume};for(let i=0;i<t.clips.length;i++){const l=`/extensions/${this.name}/clips`,c=b.Get(l,this._clips,t.clips[i].clip);n.push(this._loadClipAsync(`${l}/${t.clips[i].clip}`,c).then(u=>{const h=t._babylonSounds[i]=new br(s,u,this._loader.babylonScene,null,o);h.refDistance=t.refDistance||1,h.maxDistance=t.maxDistance||256,h.rolloffFactor=t.rolloffFactor||1,h.distanceModel=t.distanceModel||"exponential"}))}const a=Promise.all(n).then(()=>{const i=t.clips.map(c=>c.weight||1),l=new Cr(t.loop||!1,t._babylonSounds,i);t.innerAngle&&(l.directionalConeInnerAngle=2*D.ToDegrees(t.innerAngle)),t.outerAngle&&(l.directionalConeOuterAngle=2*D.ToDegrees(t.outerAngle)),t.volume&&(l.volume=t.volume),t._babylonData.sound=l});t._babylonData={loaded:a}}return t._babylonData.loaded}_getEventAction(e,t,n,s,o){switch(n){case"play":return a=>{const i=(o||0)+(a-s);t.play(i)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${n}`)}}_loadAnimationEventAsync(e,t,n,s,o){if(o.targetedAnimations.length==0)return Promise.resolve();const a=o.targetedAnimations[0],i=s.emitter,l=b.Get(`/extensions/${this.name}/emitters`,this._emitters,i);return this._loadEmitterAsync(e,l).then(()=>{const c=l._babylonData.sound;if(c){const u=new Or(s.time,this._getEventAction(e,c,s.action,s.time,s.startOffset));a.animation.addEvent(u),o.onAnimationGroupEndObservable.add(()=>{c.stop()}),o.onAnimationGroupPauseObservable.add(()=>{c.pause()})}})}}k(Ht);R(Ht,!0,r=>new Hs(r));const et="MSFT_lod";class Ks{constructor(e){var t;this.name=et,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new le,this.onMaterialLODsLoadedObservable=new le,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.maxLODsToLoad=((t=this._loader.parent.extensionOptions[et])==null?void 0:t.maxLODsToLoad)??this.maxLODsToLoad,this.enabled=this._loader.isExtensionUsed(et)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const t=Promise.all(this._nodePromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){const t=Promise.all(this._materialPromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){const n=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),n}loadNodeAsync(e,t,n){return C.LoadExtensionAsync(e,t,this.name,(s,o)=>{let a;const i=this._getLODs(s,t,this._loader.gltf.nodes,o.ids);this._loader.logOpen(`${s}`);for(let l=0;l<i.length;l++){const c=i[l];l!==0&&(this._nodeIndexLOD=l,this._nodeSignalLODs[l]=this._nodeSignalLODs[l]||new Qe);const u=d=>{n(d),d.setEnabled(!1)},h=this._loader.loadNodeAsync(`/nodes/${c.index}`,c,u).then(d=>{if(l!==0){const f=i[l-1];f._babylonTransformNode&&(this._disposeTransformNode(f._babylonTransformNode),delete f._babylonTransformNode)}return d.setEnabled(!0),d});this._nodePromiseLODs[l]=this._nodePromiseLODs[l]||[],l===0?a=h:(this._nodeIndexLOD=null,this._nodePromiseLODs[l].push(h))}return this._loader.logClose(),a})}_loadMaterialAsync(e,t,n,s,o){return this._nodeIndexLOD?null:C.LoadExtensionAsync(e,t,this.name,(a,i)=>{let l;const c=this._getLODs(a,t,this._loader.gltf.materials,i.ids);this._loader.logOpen(`${a}`);for(let u=0;u<c.length;u++){const h=c[u];u!==0&&(this._materialIndexLOD=u);const d=this._loader._loadMaterialAsync(`/materials/${h.index}`,h,n,s,f=>{u===0&&o(f)}).then(f=>{if(u!==0){o(f);const p=c[u-1]._data;p[s]&&(this._disposeMaterials([p[s].babylonMaterial]),delete p[s])}return f});this._materialPromiseLODs[u]=this._materialPromiseLODs[u]||[],u===0?l=d:(this._materialIndexLOD=null,this._materialPromiseLODs[u].push(d))}return this._loader.logClose(),l})}_loadUriAsync(e,t,n){if(this._nodeIndexLOD!==null){this._loader.log("deferred");const s=this._nodeIndexLOD-1;return this._nodeSignalLODs[s]=this._nodeSignalLODs[s]||new Qe,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(()=>this._loader.loadUriAsync(e,t,n))}else if(this._materialIndexLOD!==null){this._loader.log("deferred");const s=this._materialIndexLOD-1;return this._materialSignalLODs[s]=this._materialSignalLODs[s]||new Qe,this._materialSignalLODs[s].promise.then(()=>this._loader.loadUriAsync(e,t,n))}return null}loadBufferAsync(e,t,n,s){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const o=(a,i)=>{const l=n,c=l+s-1;let u=a[i];return u?(u.start=Math.min(u.start,l),u.end=Math.max(u.end,c)):(u={start:l,end:c,loaded:new Qe},a[i]=u),u.loaded.promise.then(h=>new Uint8Array(h.buffer,h.byteOffset+n-u.start,s))};return this._loader.log("deferred"),this._nodeIndexLOD!==null?o(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?o(this._materialBufferLODs,this._materialIndexLOD):o(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){const n=e[t];n&&(this._loader.log(`Loading buffer range [${n.start}-${n.end}]`),this._loader.bin.readAsync(n.start,n.end-n.start+1).then(s=>{n.loaded.resolve(s)},s=>{n.loaded.reject(s)}))}_getLODs(e,t,n,s){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const o=[];for(let a=s.length-1;a>=0;a--)if(o.push(b.Get(`${e}/ids/${s[a]}`,n,s[a])),o.length===this.maxLODsToLoad)return o;return o.push(t),o}_disposeTransformNode(e){const t=[],n=e.material;n&&t.push(n);for(const o of e.getChildMeshes())o.material&&t.push(o.material);e.dispose();const s=t.filter(o=>this._loader.babylonScene.meshes.every(a=>a.material!=o));this._disposeMaterials(s)}_disposeMaterials(e){const t={};for(const n of e){for(const s of n.getActiveTextures())t[s.uniqueId]=s;n.dispose()}for(const n in t)for(const s of this._loader.babylonScene.materials)s.hasTexture(t[n])&&delete t[n];for(const n in t)t[n].dispose()}}k(et);R(et,!0,r=>new Ks(r));const Kt="MSFT_minecraftMesh";class Us{constructor(e){this.name=Kt,this._loader=e,this.enabled=this._loader.isExtensionUsed(Kt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return C.LoadExtraAsync(e,t,this.name,(s,o)=>{if(o){if(!(n instanceof Z))throw new Error(`${s}: Material type not supported`);const a=this._loader.loadMaterialPropertiesAsync(e,t,n);return n.needAlphaBlending()&&(n.forceDepthWrite=!0,n.separateCullingPass=!0),n.backFaceCulling=n.forceDepthWrite,n.twoSidedLighting=!0,a}return null})}}k(Kt);R(Kt,!0,r=>new Us(r));const Ut="MSFT_sRGBFactors";class Ws{constructor(e){this.name=Ut,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ut)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return C.LoadExtraAsync(e,t,this.name,(s,o)=>{if(o){if(!(n instanceof Z))throw new Error(`${s}: Material type not supported`);const a=this._loader.loadMaterialPropertiesAsync(e,t,n),i=n.getScene().getEngine().useExactSrgbConversions;return n.albedoTexture||n.albedoColor.toLinearSpaceToRef(n.albedoColor,i),n.reflectivityTexture||n.reflectivityColor.toLinearSpaceToRef(n.reflectivityColor,i),a}return null})}}k(Ut);R(Ut,!0,r=>new Ws(r));function cn(r){const[e,t]=r.split(":");return $n({op:e,extension:t})}function $n(r,e=!0){var n;const t=r.extension?(n=ut[r.extension])==null?void 0:n[r.op]:qs[r.op];if(!t&&(P.Warn(`No mapping found for operation ${r.op} and extension ${r.extension||"KHR_interactivity"}`),e)){const s={},o={flows:{}};if(r.inputValueSockets){s.values={};for(const a in r.inputValueSockets)s.values[a]={name:a}}return r.outputValueSockets&&(o.values={},Object.keys(r.outputValueSockets).forEach(a=>{o.values[a]={name:a}})),{blocks:[],inputs:s,outputs:o}}return t}function Xt(r,e,t){ut[e]||(ut[e]={}),ut[e][r]=t}const ut={BABYLON:{"flow/log":{blocks:["FlowGraphConsoleLogBlock"],inputs:{values:{message:{name:"message"}}}}}},qs={"event/onStart":{blocks:["FlowGraphSceneReadyEventBlock"],outputs:{flows:{out:{name:"done"}}}},"event/onTick":{blocks:["FlowGraphSceneTickEventBlock"],inputs:{},outputs:{values:{timeSinceLastTick:{name:"deltaTime",gltfType:"number"}},flows:{out:{name:"done"}}}},"event/send":{blocks:["FlowGraphSendCustomEventBlock"],outputs:{flows:{out:{name:"done"}}},extraProcessor(r,e,t,n,s){if(e.op!=="event/send"||!r.configuration||Object.keys(r.configuration).length!==1)throw new Error("Receive event should have a single configuration object, the event itself");const a=r.configuration.event.value[0];if(typeof a!="number")throw new Error("Event id should be a number");const i=n.arrays.events[a],l=s[0];return l.config||(l.config={}),l.config.eventId=i.eventId,l.config.eventData=i.eventData,s}},"event/receive":{blocks:["FlowGraphReceiveCustomEventBlock"],outputs:{flows:{out:{name:"done"}}},validation(r,e){var o;if(!r.configuration)return P.Error("Receive event should have a configuration object"),!1;const t=r.configuration.event;if(!t)return P.Error("Receive event should have a single configuration object, the event itself"),!1;const n=t.value[0];return typeof n!="number"?(P.Error("Event id should be a number"),!1):((o=e.events)==null?void 0:o[n])?!0:(P.Error(`Event with id ${n} not found`),!1)},extraProcessor(r,e,t,n,s){if(e.op!=="event/receive"||!r.configuration||Object.keys(r.configuration).length!==1)throw new Error("Receive event should have a single configuration object, the event itself");const a=r.configuration.event.value[0];if(typeof a!="number")throw new Error("Event id should be a number");const i=n.arrays.events[a],l=s[0];return l.config||(l.config={}),l.config.eventId=i.eventId,l.config.eventData=i.eventData,s}},"math/e":w("FlowGraphEBlock"),"math/pi":w("FlowGraphPIBlock"),"math/inf":w("FlowGraphInfBlock"),"math/nan":w("FlowGraphNaNBlock"),"math/abs":w("FlowGraphAbsBlock"),"math/sign":w("FlowGraphSignBlock"),"math/trunc":w("FlowGraphTruncBlock"),"math/floor":w("FlowGraphFloorBlock"),"math/ceil":w("FlowGraphCeilBlock"),"math/round":{blocks:["FlowGraphRoundBlock"],configuration:{},inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(r,e,t,n,s){return s[0].config=s[0].config||{},s[0].config.roundHalfAwayFromZero=!0,s}},"math/fract":w("FlowGraphFractBlock"),"math/neg":w("FlowGraphNegationBlock"),"math/add":w("FlowGraphAddBlock",["a","b"],!0),"math/sub":w("FlowGraphSubtractBlock",["a","b"],!0),"math/mul":{blocks:["FlowGraphMultiplyBlock"],extraProcessor(r,e,t,n,s){s[0].config=s[0].config||{},s[0].config.useMatrixPerComponent=!0;let o=-1;return Object.keys(r.values||{}).find(a=>{var i;return((i=r.values)==null?void 0:i[a].type)!==void 0?(o=r.values[a].type,!0):!1}),o!==-1&&(s[0].config.type=n.arrays.types[o].flowGraphType),s}},"math/div":w("FlowGraphDivideBlock",["a","b"],!0),"math/rem":w("FlowGraphModuloBlock",["a","b"]),"math/min":w("FlowGraphMinBlock",["a","b"]),"math/max":w("FlowGraphMaxBlock",["a","b"]),"math/clamp":w("FlowGraphClampBlock",["a","b","c"]),"math/saturate":w("FlowGraphSaturateBlock"),"math/mix":w("FlowGraphMathInterpolationBlock",["a","b","c"]),"math/eq":w("FlowGraphEqualityBlock",["a","b"]),"math/lt":w("FlowGraphLessThanBlock",["a","b"]),"math/le":w("FlowGraphLessThanOrEqualBlock",["a","b"]),"math/gt":w("FlowGraphGreaterThanBlock",["a","b"]),"math/ge":w("FlowGraphGreaterThanOrEqualBlock",["a","b"]),"math/isnan":w("FlowGraphIsNaNBlock"),"math/isinf":w("FlowGraphIsInfBlock"),"math/select":{blocks:["FlowGraphConditionalBlock"],inputs:{values:{condition:{name:"condition"},a:{name:"onTrue"},b:{name:"onFalse"}}},outputs:{values:{value:{name:"output"}}}},"math/random":{blocks:["FlowGraphRandomBlock"],outputs:{values:{value:{name:"value"}}}},"math/sin":w("FlowGraphSinBlock"),"math/cos":w("FlowGraphCosBlock"),"math/tan":w("FlowGraphTanBlock"),"math/asin":w("FlowGraphASinBlock"),"math/acos":w("FlowGraphACosBlock"),"math/atan":w("FlowGraphATanBlock"),"math/atan2":w("FlowGraphATan2Block",["a","b"]),"math/sinh":w("FlowGraphSinhBlock"),"math/cosh":w("FlowGraphCoshBlock"),"math/tanh":w("FlowGraphTanhBlock"),"math/asinh":w("FlowGraphASinhBlock"),"math/acosh":w("FlowGraphACoshBlock"),"math/atanh":w("FlowGraphATanhBlock"),"math/exp":w("FlowGraphExponentialBlock"),"math/log":w("FlowGraphLogBlock"),"math/log2":w("FlowGraphLog2Block"),"math/log10":w("FlowGraphLog10Block"),"math/sqrt":w("FlowGraphSquareRootBlock"),"math/cbrt":w("FlowGraphCubeRootBlock"),"math/pow":w("FlowGraphPowerBlock",["a","b"]),"math/length":w("FlowGraphLengthBlock"),"math/normalize":w("FlowGraphNormalizeBlock"),"math/dot":w("FlowGraphDotBlock",["a","b"]),"math/cross":w("FlowGraphCrossBlock",["a","b"]),"math/rotate2d":w("FlowGraphRotate2DBlock",["a","b"]),"math/rotate3d":w("FlowGraphRotate3DBlock",["a","b","c"]),"math/transform":{blocks:["FlowGraphTransformVectorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/combine2":{blocks:["FlowGraphCombineVector2Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine3":{blocks:["FlowGraphCombineVector3Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine4":{blocks:["FlowGraphCombineVector4Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/extract2":{blocks:["FlowGraphExtractVector2Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"}}}},"math/extract3":{blocks:["FlowGraphExtractVector3Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"}}}},"math/extract4":{blocks:["FlowGraphExtractVector4Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/transpose":w("FlowGraphTransposeBlock"),"math/determinant":w("FlowGraphDeterminantBlock"),"math/inverse":w("FlowGraphInvertMatrixBlock"),"math/matmul":w("FlowGraphMatrixMultiplicationBlock",["a","b"]),"math/matCompose":{blocks:["FlowGraphMatrixCompose"],inputs:{values:{translation:{name:"position",gltfType:"float3"},rotation:{name:"rotationQuaternion",gltfType:"float4"},scale:{name:"scaling",gltfType:"float3"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(r,e,t,n,s,o){const a=s[0].dataInputs.find(i=>i.name==="rotationQuaternion");if(!a)throw new Error("Rotation quaternion input not found");return o._connectionValues[a.uniqueId]&&(o._connectionValues[a.uniqueId].type="Quaternion"),s}},"math/matDecompose":{blocks:["FlowGraphMatrixDecompose"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{translation:{name:"position"},rotation:{name:"rotationQuaternion"},scale:{name:"scaling"}}}},"math/combine2x2":{blocks:["FlowGraphCombineMatrix2DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(r,e,t,n,s){return s[0].config=s[0].config||{},s[0].config.inputIsColumnMajor=!0,s}},"math/extract2x2":{blocks:["FlowGraphExtractMatrix2DBlock"],inputs:{values:{a:{name:"input",gltfType:"float2x2"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/combine3x3":{blocks:["FlowGraphCombineMatrix3DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(r,e,t,n,s){return s[0].config=s[0].config||{},s[0].config.inputIsColumnMajor=!0,s}},"math/extract3x3":{blocks:["FlowGraphExtractMatrix3DBlock"],inputs:{values:{a:{name:"input",gltfType:"float3x3"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"}}}},"math/combine4x4":{blocks:["FlowGraphCombineMatrixBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"},j:{name:"input_9",gltfType:"number"},k:{name:"input_10",gltfType:"number"},l:{name:"input_11",gltfType:"number"},m:{name:"input_12",gltfType:"number"},n:{name:"input_13",gltfType:"number"},o:{name:"input_14",gltfType:"number"},p:{name:"input_15",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(r,e,t,n,s){return s[0].config=s[0].config||{},s[0].config.inputIsColumnMajor=!0,s}},"math/extract4x4":{blocks:["FlowGraphExtractMatrixBlock"],configuration:{},inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"},9:{name:"output_9"},10:{name:"output_10"},11:{name:"output_11"},12:{name:"output_12"},13:{name:"output_13"},14:{name:"output_14"},15:{name:"output_15"}}}},"math/compose":{blocks:["FlowGraphMatrixCompose"],configuration:{},inputs:{values:{translation:{name:"position",gltfType:"float3"},rotation:{name:"rotationQuaternion",gltfType:"float4"},scale:{name:"scaling",gltfType:"float3"}}},outputs:{values:{value:{name:"output"}}}},"math/decompose":{blocks:["FlowGraphMatrixDecompose"],configuration:{},inputs:{values:{a:{name:"input"}}},outputs:{values:{translation:{name:"position"},rotation:{name:"rotationQuaternion"},scale:{name:"scaling"}}}},"math/not":{blocks:["FlowGraphBitwiseNotBlock"],inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(r,e,t,n,s,o){var i;s[0].config=s[0].config||{};const a=s[0].dataInputs[0];return s[0].config.valueType=((i=o._connectionValues[a.uniqueId])==null?void 0:i.type)??"FlowGraphInteger",s}},"math/and":{blocks:["FlowGraphBitwiseAndBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(r,e,t,n,s,o){var l,c;s[0].config=s[0].config||{};const a=s[0].dataInputs[0],i=s[0].dataInputs[1];return s[0].config.valueType=((l=o._connectionValues[a.uniqueId])==null?void 0:l.type)??((c=o._connectionValues[i.uniqueId])==null?void 0:c.type)??"FlowGraphInteger",s}},"math/or":{blocks:["FlowGraphBitwiseOrBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(r,e,t,n,s,o){var l,c;s[0].config=s[0].config||{};const a=s[0].dataInputs[0],i=s[0].dataInputs[1];return s[0].config.valueType=((l=o._connectionValues[a.uniqueId])==null?void 0:l.type)??((c=o._connectionValues[i.uniqueId])==null?void 0:c.type)??"FlowGraphInteger",s}},"math/xor":{blocks:["FlowGraphBitwiseXorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(r,e,t,n,s,o){var l,c;s[0].config=s[0].config||{};const a=s[0].dataInputs[0],i=s[0].dataInputs[1];return s[0].config.valueType=((l=o._connectionValues[a.uniqueId])==null?void 0:l.type)??((c=o._connectionValues[i.uniqueId])==null?void 0:c.type)??"FlowGraphInteger",s}},"math/asr":w("FlowGraphBitwiseRightShiftBlock",["a","b"]),"math/lsl":w("FlowGraphBitwiseLeftShiftBlock",["a","b"]),"math/clz":w("FlowGraphLeadingZerosBlock"),"math/ctz":w("FlowGraphTrailingZerosBlock"),"math/popcnt":w("FlowGraphOneBitsCounterBlock"),"math/rad":w("FlowGraphDegToRadBlock"),"math/deg":w("FlowGraphRadToDegBlock"),"type/boolToInt":w("FlowGraphBooleanToInt"),"type/boolToFloat":w("FlowGraphBooleanToFloat"),"type/intToBool":w("FlowGraphIntToBoolean"),"type/intToFloat":w("FlowGraphIntToFloat"),"type/floatToInt":w("FlowGraphFloatToInt"),"type/floatToBool":w("FlowGraphFloatToBoolean"),"flow/sequence":{blocks:["FlowGraphSequenceBlock"],extraProcessor(r,e,t,n,s){const o=s[0];return o.config||(o.config={}),o.config.outputSignalCount=Object.keys(r.flows||[]).length,o.signalOutputs.forEach((a,i)=>{a.name="out_"+i}),s}},"flow/branch":{blocks:["FlowGraphBranchBlock"],outputs:{flows:{true:{name:"onTrue"},false:{name:"onFalse"}}}},"flow/switch":{blocks:["FlowGraphSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"}}},validation(r){if(r.configuration&&r.configuration.cases){const e=r.configuration.cases.value;if(!e.every(s=>typeof s=="number"&&/^\d+$/.test(s.toString())))return r.configuration.cases.value=[],!0;const n=new Set(e);r.configuration.cases.value=Array.from(n)}return!0},extraProcessor(r,e,t,n,s){if(e.op!=="flow/switch"||!r.flows||Object.keys(r.flows).length===0)throw new Error("Switch should have a single configuration object, the cases array");return s[0].signalOutputs.forEach(a=>{a.name!=="default"&&(a.name="out_"+a.name)}),s}},"flow/while":{blocks:["FlowGraphWhileLoopBlock"],outputs:{flows:{loopBody:{name:"executionFlow"}}}},"flow/for":{blocks:["FlowGraphForLoopBlock"],configuration:{initialIndex:{name:"initialIndex",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{values:{startIndex:{name:"startIndex",gltfType:"number"},endIndex:{name:"endIndex",gltfType:"number"}}},outputs:{values:{index:{name:"index"}},flows:{loopBody:{name:"executionFlow"}}}},"flow/doN":{blocks:["FlowGraphDoNBlock"],configuration:{},inputs:{values:{n:{name:"maxExecutions",gltfType:"number"}}},outputs:{values:{currentCount:{name:"executionCount"}}}},"flow/multiGate":{blocks:["FlowGraphMultiGateBlock"],configuration:{isRandom:{name:"isRandom",gltfType:"boolean",inOptions:!0,defaultValue:!1},isLoop:{name:"isLoop",gltfType:"boolean",inOptions:!0,defaultValue:!1}},extraProcessor(r,e,t,n,s){if(e.op!=="flow/multiGate"||!r.flows||Object.keys(r.flows).length===0)throw new Error("MultiGate should have a single configuration object, the number of output flows");const o=s[0];return o.config||(o.config={}),o.config.outputSignalCount=Object.keys(r.flows).length,o.signalOutputs.forEach((a,i)=>{a.name="out_"+i}),s}},"flow/waitAll":{blocks:["FlowGraphWaitAllBlock"],configuration:{inputFlows:{name:"inputSignalCount",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{flows:{"[segment]":{name:"in_$1"}}},validation(r){var e,t;return typeof((t=(e=r.configuration)==null?void 0:e.inputFlows)==null?void 0:t.value[0])!="number"&&(r.configuration=r.configuration||{inputFlows:{value:[0]}},r.configuration.inputFlows.value=[0]),!0}},"flow/throttle":{blocks:["FlowGraphThrottleBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/setDelay":{blocks:["FlowGraphSetDelayBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/cancelDelay":{blocks:["FlowGraphCancelDelayBlock"]},"variable/get":{blocks:["FlowGraphGetVariableBlock"],validation(r){var e,t;return(t=(e=r.configuration)==null?void 0:e.variable)!=null&&t.value?!0:(P.Error("Variable get block should have a variable configuration"),!1)},configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer(r,e){return[e.getVariableName(r[0])]}}}},"variable/set":{blocks:["FlowGraphSetVariableBlock"],configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer(r,e){return[e.getVariableName(r[0])]}}}},"variable/setMultiple":{blocks:["FlowGraphSetVariableBlock"],configuration:{variables:{name:"variables",gltfType:"number",flowGraphType:"string",inOptions:!0,dataTransformer(r,e){return[r[0].map(t=>e.getVariableName(t))]}}},extraProcessor(r,e,t,n,s){return s[0].dataInputs.forEach(a=>{a.name=n.getVariableName(+a.name)}),s}},"variable/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphContextBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing","FlowGraphGetVariableBlock"],configuration:{variable:{name:"propertyName",inOptions:!0,isVariable:!0,dataTransformer(r,e){return[e.getVariableName(r[0])]}},useSlerp:{name:"animationType",inOptions:!0,defaultValue:!1,dataTransformer:r=>r[0]===!0?["Quaternion"]:[void 0]}},inputs:{values:{value:{name:"value_1"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"userVariables",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:4,isVariable:!0}],extraProcessor(r,e,t,n,s){var h;var o,a;const i=s[0],l=(h=r.configuration)==null?void 0:h.variable.value[0];if(typeof l!="number")throw P.Error("Variable index is not defined for variable interpolation block"),new Error("Variable index is not defined for variable interpolation block");const c=n.arrays.staticVariables[l];typeof i.config.animationType.value>"u"&&(n.arrays.staticVariables,i.config.animationType.value=Ar(c.type));const u=s[4];return u.config||(u.config={}),(o=u.config).variable||(o.variable={}),u.config.variable.value=n.getVariableName(l),(a=s[3]).config||(a.config={}),s}},"pointer/get":{blocks:["FlowGraphGetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customGetFunction",output:"getFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(r,e,t,n,s){return s.forEach(o=>{o.className==="FlowGraphJsonPointerParserBlock"&&(o.config||(o.config={}),o.config.outputValue=!0)}),s}},"pointer/set":{blocks:["FlowGraphSetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customSetFunction",output:"setFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(r,e,t,n,s){return s.forEach(o=>{o.className==="FlowGraphJsonPointerParserBlock"&&(o.config||(o.config={}),o.config.outputValue=!0)}),s}},"pointer/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphJsonPointerParserBlock","FlowGraphPlayAnimationBlock","FlowGraphEasingBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value_1"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphEasingBlock"},p2:{name:"controlPoint2",toBlock:"FlowGraphEasingBlock"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customBuildAnimation",output:"generateAnimationsFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(r,e,t,n,s){return s.forEach(o=>{o.className==="FlowGraphJsonPointerParserBlock"?(o.config||(o.config={}),o.config.outputValue=!0):o.className==="FlowGraphInterpolationBlock"&&(o.config||(o.config={}),Object.keys(r.values||[]).forEach(a=>{var l;const i=(l=r.values)==null?void 0:l[a];if(a==="value"&&i){const c=i.type;c!==void 0&&(o.config.animationType=n.arrays.types[c].flowGraphType)}}))}),s}},"animation/start":{blocks:["FlowGraphPlayAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},speed:{name:"speed",gltfType:"number"},startTime:{name:"from",gltfType:"number",dataTransformer:(r,e)=>[r[0]*e._loader.parent.targetFps]},endTime:{name:"to",gltfType:"number",dataTransformer:(r,e)=>[r[0]*e._loader.parent.targetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(r,e,t,n,s,o,a){const i=s[s.length-1];return i.config||(i.config={}),i.config.glTF=a,s}},"animation/stop":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(r,e,t,n,s,o,a){const i=s[s.length-1];return i.config||(i.config={}),i.config.glTF=a,s}},"animation/stopAt":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{},inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},stopTime:{name:"stopAtFrame",gltfType:"number",dataTransformer:(r,e)=>[r[0]*e._loader.parent.targetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(r,e,t,n,s,o,a){const i=s[s.length-1];return i.config||(i.config={}),i.config.glTF=a,s}},"math/switch":{blocks:["FlowGraphDataSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"}}},validation(r){if(r.configuration&&r.configuration.cases){const e=r.configuration.cases.value;if(!e.every(s=>typeof s=="number"&&/^\d+$/.test(s.toString())))return r.configuration.cases.value=[],!0;const n=new Set(e);r.configuration.cases.value=Array.from(n)}return!0},extraProcessor(r,e,t,n,s){return s[0].dataInputs.forEach(a=>{a.name!=="default"&&a.name!=="case"&&(a.name="in_"+a.name)}),s}},"debug/log":{blocks:["FlowGraphConsoleLogBlock"],configuration:{message:{name:"messageTemplate",inOptions:!0}}}};function w(r,e=["a"],t){return{blocks:[r],inputs:{values:e.reduce((n,s)=>(n[s]={name:s},n),{})},outputs:{values:{value:{name:"value"}}},extraProcessor(n,s,o,a,i){if(t){i[0].config=i[0].config||{};let l=-1;Object.keys(n.values||{}).find(c=>{var u;return((u=n.values)==null?void 0:u[c].type)!==void 0?(l=n.values[c].type,!0):!1}),l!==-1&&(i[0].config.type=a.arrays.types[l].flowGraphType)}return i}}}function oo(){return Object.keys(qs)}const js={float:{length:1,flowGraphType:"number",elementType:"number"},bool:{length:1,flowGraphType:"boolean",elementType:"boolean"},float2:{length:2,flowGraphType:"Vector2",elementType:"number"},float3:{length:3,flowGraphType:"Vector3",elementType:"number"},float4:{length:4,flowGraphType:"Vector4",elementType:"number"},float4x4:{length:16,flowGraphType:"Matrix",elementType:"number"},float2x2:{length:4,flowGraphType:"Matrix2D",elementType:"number"},float3x3:{length:9,flowGraphType:"Matrix3D",elementType:"number"},int:{length:1,flowGraphType:"FlowGraphInteger",elementType:"number"}};class Ys{constructor(e,t,n){this._interactivityGraph=e,this._gltf=t,this._loader=n,this._types=[],this._mappings=[],this._staticVariables=[],this._events=[],this._internalEventsCounter=0,this._nodes=[],this._parseTypes(),this._parseDeclarations(),this._parseVariables(),this._parseEvents(),this._parseNodes()}get arrays(){return{types:this._types,mappings:this._mappings,staticVariables:this._staticVariables,events:this._events,nodes:this._nodes}}_parseTypes(){if(this._interactivityGraph.types)for(const e of this._interactivityGraph.types)this._types.push(js[e.signature])}_parseDeclarations(){if(this._interactivityGraph.declarations)for(const e of this._interactivityGraph.declarations){const t=$n(e);if(!t)throw P.Error(["No mapping found for declaration",e]),new Error("Error parsing declarations");this._mappings.push({flowGraphMapping:t,fullOperationName:e.extension?e.op+":"+e.extension:e.op})}}_parseVariables(){if(this._interactivityGraph.variables)for(const e of this._interactivityGraph.variables){const t=this._parseVariable(e);this._staticVariables.push(t)}}_parseVariable(e,t){const n=this._types[e.type];if(!n)throw P.Error(["No type found for variable",e]),new Error("Error parsing variables");if(e.value&&e.value.length!==n.length)throw P.Error(["Invalid value length for variable",e,n]),new Error("Error parsing variables");const s=e.value||[];if(!s.length)switch(n.flowGraphType){case"boolean":s.push(!1);break;case"FlowGraphInteger":s.push(0);break;case"number":s.push(NaN);break;case"Vector2":s.push(NaN,NaN);break;case"Vector3":s.push(NaN,NaN,NaN);break;case"Vector4":case"Matrix2D":case"Quaternion":s.fill(NaN,0,4);break;case"Matrix":s.fill(NaN,0,16);break;case"Matrix3D":s.fill(NaN,0,9);break}return{type:n.flowGraphType,value:t?t(s,this):s}}_parseEvents(){if(this._interactivityGraph.events)for(const e of this._interactivityGraph.events){const t={eventId:e.id||"internalEvent_"+this._internalEventsCounter++};e.values&&(t.eventData=Object.keys(e.values).map(n=>{var i;const s=(i=e.values)==null?void 0:i[n];if(!s)throw P.Error(["No value found for event key",n]),new Error("Error parsing events");const o=this._types[s.type];if(!o)throw P.Error(["No type found for event value",s]),new Error("Error parsing events");const a=typeof s.value<"u"?this._parseVariable(s):void 0;return{id:n,type:o.flowGraphType,eventData:!0,value:a}})),this._events.push(t)}}_parseNodes(){if(this._interactivityGraph.nodes)for(const e of this._interactivityGraph.nodes){if(typeof e.declaration!="number")throw P.Error(["No declaration found for node",e]),new Error("Error parsing nodes");const t=this._mappings[e.declaration];if(!t)throw P.Error(["No mapping found for node",e]),new Error("Error parsing nodes");if(t.flowGraphMapping.validation&&!t.flowGraphMapping.validation(e,this._interactivityGraph,this._gltf))throw new Error(`Error validating interactivity node ${e}`);const n=[];for(const s of t.flowGraphMapping.blocks){const o=this._getEmptyBlock(s,t.fullOperationName);this._parseNodeConfiguration(e,o,t.flowGraphMapping,s),n.push(o)}this._nodes.push({blocks:n,fullOperationName:t.fullOperationName})}}_getEmptyBlock(e,t){return{uniqueId:Jt(),className:e,dataInputs:[],dataOutputs:[],signalInputs:[],signalOutputs:[],config:{},type:t,metadata:{}}}_parseNodeConfiguration(e,t,n,s){const o=t.config;e.configuration&&Object.keys(e.configuration).forEach(a=>{var u,h;const i=(u=e.configuration)==null?void 0:u[a];if(!i)throw P.Error(["No value found for node configuration",a]),new Error("Error parsing node configuration");const l=(h=n.configuration)==null?void 0:h[a];if(l&&l.toBlock?l.toBlock===s:n.blocks.indexOf(s)===0){const d=(l==null?void 0:l.name)||a;(!i||typeof i.value>"u")&&typeof(l==null?void 0:l.defaultValue)<"u"?o[d]={value:l.defaultValue}:i.value.length>=1?o[d]={value:i.value.length===1?i.value[0]:i.value}:P.Warn(["Invalid value for node configuration",i]),l&&l.dataTransformer&&(o[d].value=l.dataTransformer([o[d].value],this)[0])}})}_parseNodeConnections(e){var t,n,s,o,a,i,l,c,u,h,d,f,p,_,A,v,F,M,x;for(let T=0;T<this._nodes.length;T++){const I=(t=this._interactivityGraph.nodes)==null?void 0:t[T];if(!I)throw P.Error(["No node found for interactivity node",this._nodes[T]]),new Error("Error parsing node connections");const g=this._nodes[T],E=this._mappings[I.declaration];if(!E)throw P.Error(["No mapping found for node",I]),new Error("Error parsing node connections");const G=I.flows||{},V=Object.keys(G).sort();for(const Y of V){const W=G[Y],H=(s=(n=E.flowGraphMapping.outputs)==null?void 0:n.flows)==null?void 0:s[Y],re=(H==null?void 0:H.name)||Y,Ce=this._createNewSocketConnection(re,!0);(H&&H.toBlock&&g.blocks.find(me=>me.className===H.toBlock)||g.blocks[0]).signalOutputs.push(Ce);const Ze=W.node,oe=this._nodes[Ze];if(!oe)throw P.Error(["No node found for input node id",Ze]),new Error("Error parsing node connections");const xe=cn(oe.fullOperationName);if(!xe)throw P.Error(["No mapping found for input node",oe]),new Error("Error parsing node connections");let de=(a=(o=xe.inputs)==null?void 0:o.flows)==null?void 0:a[W.socket||"in"],Re=!1;if(!de)for(const me in(i=xe.inputs)==null?void 0:i.flows)me.startsWith("[")&&me.endsWith("]")&&(Re=!0,de=(c=(l=xe.inputs)==null?void 0:l.flows)==null?void 0:c[me]);const fe=de?Re?de.name.replace("$1",W.socket||""):de.name:W.socket||"in",Xe=de&&de.toBlock&&oe.blocks.find(me=>me.className===de.toBlock)||oe.blocks[0];let Ne=Xe.signalInputs.find(me=>me.name===fe);Ne||(Ne=this._createNewSocketConnection(fe),Xe.signalInputs.push(Ne)),Ne.connectedPointIds.push(Ce.uniqueId),Ce.connectedPointIds.push(Ne.uniqueId)}const $=I.values||{},Te=Object.keys($);for(const Y of Te){const W=$[Y];let H=(h=(u=E.flowGraphMapping.inputs)==null?void 0:u.values)==null?void 0:h[Y],re=!1;if(!H)for(const oe in(d=E.flowGraphMapping.inputs)==null?void 0:d.values)oe.startsWith("[")&&oe.endsWith("]")&&(re=!0,H=(p=(f=E.flowGraphMapping.inputs)==null?void 0:f.values)==null?void 0:p[oe]);const Ce=H?re?H.name.replace("$1",Y):H.name:Y,Be=this._createNewSocketConnection(Ce);if((H&&H.toBlock&&g.blocks.find(oe=>oe.className===H.toBlock)||g.blocks[0]).dataInputs.push(Be),W.value!==void 0){const oe=this._parseVariable(W,H&&H.dataTransformer);e._connectionValues[Be.uniqueId]=oe}else if(typeof W.node<"u"){const oe=W.node,xe=W.socket||"value",de=this._nodes[oe];if(!de)throw P.Error(["No node found for output socket reference",W]),new Error("Error parsing node connections");const Re=cn(de.fullOperationName);if(!Re)throw P.Error(["No mapping found for output socket reference",W]),new Error("Error parsing node connections");let fe=(A=(_=Re.outputs)==null?void 0:_.values)==null?void 0:A[xe],Xe=!1;if(!fe)for(const Ge in(v=Re.outputs)==null?void 0:v.values)Ge.startsWith("[")&&Ge.endsWith("]")&&(Xe=!0,fe=(M=(F=Re.outputs)==null?void 0:F.values)==null?void 0:M[Ge]);const Ne=fe?Xe?fe.name.replace("$1",xe):fe==null?void 0:fe.name:xe,me=fe&&fe.toBlock&&de.blocks.find(Ge=>Ge.className===fe.toBlock)||de.blocks[0];let Je=me.dataOutputs.find(Ge=>Ge.name===Ne);Je||(Je=this._createNewSocketConnection(Ne,!0),me.dataOutputs.push(Je)),Be.connectedPointIds.push(Je.uniqueId),Je.connectedPointIds.push(Be.uniqueId)}else throw P.Error(["Invalid value for value connection",W]),new Error("Error parsing node connections")}if(E.flowGraphMapping.interBlockConnectors)for(const Y of E.flowGraphMapping.interBlockConnectors){const W=Y.input,H=Y.output,re=Y.isVariable;this._connectFlowGraphNodes(W,H,g.blocks[Y.inputBlockIndex],g.blocks[Y.outputBlockIndex],re)}if(E.flowGraphMapping.extraProcessor){const Y=(x=this._interactivityGraph.declarations)==null?void 0:x[I.declaration];if(!Y)throw P.Error(["No declaration found for extra processor",I]),new Error("Error parsing node connections");g.blocks=E.flowGraphMapping.extraProcessor(I,Y,E.flowGraphMapping,this,g.blocks,e,this._gltf)}}}_createNewSocketConnection(e,t){return{uniqueId:Jt(),name:e,_connectionType:t?1:0,connectedPointIds:[]}}_connectFlowGraphNodes(e,t,n,s,o){const a=o?n.dataInputs:n.signalInputs,i=o?s.dataOutputs:s.signalOutputs,l=a.find(u=>u.name===e)||this._createNewSocketConnection(e),c=i.find(u=>u.name===t)||this._createNewSocketConnection(t,!0);a.find(u=>u.name===e)||a.push(l),i.find(u=>u.name===t)||i.push(c),l.connectedPointIds.push(c.uniqueId),c.connectedPointIds.push(l.uniqueId)}getVariableName(e){return"staticVariable_"+e}serializeToFlowGraph(){const e={uniqueId:Jt(),_userVariables:{},_connectionValues:{}};this._parseNodeConnections(e);for(let n=0;n<this._staticVariables.length;n++){const s=this._staticVariables[n];e._userVariables[this.getVariableName(n)]=s}return{rightHanded:!0,allBlocks:this._nodes.reduce((n,s)=>n.concat(s.blocks),[]),executionContexts:[e]}}}const st="KHR_interactivity";class Zs{constructor(e){this._loader=e,this.name=st,this.enabled=this._loader.isExtensionUsed(st),this._pathConverter=_n(this._loader.gltf),e._skipStartAnimationStep=!0;const t=e.babylonScene;t&&Xs(t)}dispose(){this._loader=null,delete this._pathConverter}async onReady(){var o;if(!this._loader.babylonScene||!this._pathConverter)return;const e=this._loader.babylonScene,t=(o=this._loader.gltf.extensions)==null?void 0:o.KHR_interactivity;if(!t)return;const n=new Tr({scene:e}),s=t.graphs.map(a=>new Ys(a,this._loader.gltf,this._loader).serializeToFlowGraph());await Promise.all(s.map(a=>Ir(a,{coordinator:n,pathConverter:this._pathConverter}))),n.start()}}function Xs(r){be("/extensions/KHR_interactivity/?/activeCamera/rotation",{get:()=>r.activeCamera?te.FromRotationMatrix(r.activeCamera.getWorldMatrix()).normalize():new te(NaN,NaN,NaN,NaN),type:"Quaternion",getTarget:()=>r.activeCamera}),be("/extensions/KHR_interactivity/?/activeCamera/position",{get:()=>r.activeCamera?r.activeCamera.position:new N(NaN,NaN,NaN),type:"Vector3",getTarget:()=>r.activeCamera}),be("/animations/{}/extensions/KHR_interactivity/isPlaying",{get:e=>{var t;return((t=e._babylonAnimationGroup)==null?void 0:t.isPlaying)??!1},type:"boolean",getTarget:e=>e._babylonAnimationGroup}),be("/animations/{}/extensions/KHR_interactivity/minTime",{get:e=>{var t;return(((t=e._babylonAnimationGroup)==null?void 0:t.from)??0)/60},type:"number",getTarget:e=>e._babylonAnimationGroup}),be("/animations/{}/extensions/KHR_interactivity/maxTime",{get:e=>{var t;return(((t=e._babylonAnimationGroup)==null?void 0:t.to)??0)/60},type:"number",getTarget:e=>e._babylonAnimationGroup}),be("/animations/{}/extensions/KHR_interactivity/playhead",{get:e=>{var t;return(((t=e._babylonAnimationGroup)==null?void 0:t.getCurrentFrame())??0)/60},type:"number",getTarget:e=>e._babylonAnimationGroup}),be("/animations/{}/extensions/KHR_interactivity/virtualPlayhead",{get:e=>{var t;return(((t=e._babylonAnimationGroup)==null?void 0:t.getCurrentFrame())??0)/60},type:"number",getTarget:e=>e._babylonAnimationGroup})}Nr(st,"FlowGraphGLTFDataProvider",async()=>(await sn(async()=>{const{FlowGraphGLTFDataProvider:r}=await Promise.resolve().then(()=>ao);return{FlowGraphGLTFDataProvider:r}},void 0)).FlowGraphGLTFDataProvider);k(st);R(st,!0,r=>new Zs(r));const Wt="KHR_node_visibility";be("/nodes/{}/extensions/KHR_node_visibility/visible",{get:r=>{const e=r._babylonTransformNode;return e&&e.isVisible!==void 0?e.isVisible:!0},set:(r,e)=>{var t,n;(t=e._primitiveBabylonMeshes)==null||t.forEach(s=>{s.inheritVisibility=!0}),e._babylonTransformNode&&(e._babylonTransformNode.isVisible=r),(n=e._primitiveBabylonMeshes)==null||n.forEach(s=>{s.isVisible=r})},getTarget:r=>r._babylonTransformNode,getPropertyName:[()=>"isVisible"],type:"boolean"});class Js{constructor(e){this.name=Wt,this._loader=e,this.enabled=e.isExtensionUsed(Wt)}async onReady(){var e;(e=this._loader.gltf.nodes)==null||e.forEach(t=>{var n,s,o,a;(n=t._primitiveBabylonMeshes)==null||n.forEach(i=>{i.inheritVisibility=!0}),(s=t.extensions)!=null&&s.KHR_node_visibility&&((o=t.extensions)==null?void 0:o.KHR_node_visibility.visible)===!1&&(t._babylonTransformNode&&(t._babylonTransformNode.isVisible=!1),(a=t._primitiveBabylonMeshes)==null||a.forEach(i=>{i.isVisible=!1}))})}dispose(){this._loader=null}}k(Wt);R(Wt,!0,r=>new Js(r));const rt="KHR_node_selectability";Xt("event/onSelect",rt,{blocks:["FlowGraphMeshPickEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(r){return["pickedMesh_"+r[0]]}}},outputs:{values:{selectedNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"},selectionPoint:{name:"pickedPoint"},selectionRayOrigin:{name:"pickOrigin"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"asset",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"pickedMesh",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(r,e,t,n,s,o,a){var u,h,d,f,p,_;const i=s[s.length-1];i.config=i.config||{},i.config.glTF=a;const l=(h=(u=r.configuration)==null?void 0:u.nodeIndex)==null?void 0:h.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");const c="pickedMesh_"+l;return s[1].config.variable=c,o._userVariables[c]={className:"Mesh",id:(f=(d=a==null?void 0:a.nodes)==null?void 0:d[l]._babylonTransformNode)==null?void 0:f.id,uniqueId:(_=(p=a==null?void 0:a.nodes)==null?void 0:p[l]._babylonTransformNode)==null?void 0:_.uniqueId},s}});be("/nodes/{}/extensions/KHR_node_selectability/selectable",{get:r=>{const e=r._babylonTransformNode;return e&&e.isPickable!==void 0?e.isPickable:!0},set:(r,e)=>{var t;(t=e._primitiveBabylonMeshes)==null||t.forEach(n=>{n.isPickable=r})},getTarget:r=>r._babylonTransformNode,getPropertyName:[()=>"isPickable"],type:"boolean"});class Qs{constructor(e){this.name=rt,this._loader=e,this.enabled=e.isExtensionUsed(rt)}async onReady(){var e;(e=this._loader.gltf.nodes)==null||e.forEach(t=>{var n,s,o;(n=t.extensions)!=null&&n.KHR_node_selectability&&((s=t.extensions)==null?void 0:s.KHR_node_selectability.selectable)===!1&&((o=t._babylonTransformNode)==null||o.getChildMeshes().forEach(a=>{a.isPickable=!1}))})}dispose(){this._loader=null}}k(rt);R(rt,!0,r=>new Qs(r));const je="KHR_node_hoverability",zn="targetMeshPointerOver_";Xt("event/onHoverIn",je,{blocks:["FlowGraphPointerOverEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(r){return[zn+r[0]]}}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshUnderPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(r,e,t,n,s,o,a){var u,h,d,f,p,_;const i=s[s.length-1];i.config=i.config||{},i.config.glTF=a;const l=(h=(u=r.configuration)==null?void 0:u.nodeIndex)==null?void 0:h.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");const c=zn+l;return s[1].config.variable=c,o._userVariables[c]={className:"Mesh",id:(f=(d=a==null?void 0:a.nodes)==null?void 0:d[l]._babylonTransformNode)==null?void 0:f.id,uniqueId:(_=(p=a==null?void 0:a.nodes)==null?void 0:p[l]._babylonTransformNode)==null?void 0:_.uniqueId},s}});const es="targetMeshPointerOut_";Xt("event/onHoverOut",je,{blocks:["FlowGraphPointerOutEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(r){return[es+r[0]]}}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshOutOfPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(r,e,t,n,s,o,a){var u,h,d,f,p,_;const i=s[s.length-1];i.config=i.config||{},i.config.glTF=a;const l=(h=(u=r.configuration)==null?void 0:u.nodeIndex)==null?void 0:h.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");const c=es+l;return s[1].config.variable=c,o._userVariables[c]={className:"Mesh",id:(f=(d=a==null?void 0:a.nodes)==null?void 0:d[l]._babylonTransformNode)==null?void 0:f.id,uniqueId:(_=(p=a==null?void 0:a.nodes)==null?void 0:p[l]._babylonTransformNode)==null?void 0:_.uniqueId},s}});be("/nodes/{}/extensions/KHR_node_hoverability/hoverable",{get:r=>{const e=r._babylonTransformNode;return e&&e.pointerOverDisableMeshTesting!==void 0?e.pointerOverDisableMeshTesting:!0},set:(r,e)=>{var t;(t=e._primitiveBabylonMeshes)==null||t.forEach(n=>{n.pointerOverDisableMeshTesting=!r})},getTarget:r=>r._babylonTransformNode,getPropertyName:[()=>"pointerOverDisableMeshTesting"],type:"boolean"});class zs{constructor(e){this.name=je,this._loader=e,this.enabled=e.isExtensionUsed(je)}async onReady(){var e;(e=this._loader.gltf.nodes)==null||e.forEach(t=>{var n,s,o;(n=t.extensions)!=null&&n.KHR_node_hoverability&&((s=t.extensions)==null?void 0:s.KHR_node_hoverability.hoverable)===!1&&((o=t._babylonTransformNode)==null||o.getChildMeshes().forEach(a=>{a.pointerOverDisableMeshTesting=!0}))})}dispose(){this._loader=null}}k(je);R(je,!0,r=>new zs(r));const Hn="ExtrasAsMetadata";class er{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){const n=e.metadata=e.metadata||{},s=n.gltf=n.gltf||{};s.extras=t.extras}}constructor(e){this.name=Hn,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,n){return this._loader.loadNodeAsync(e,t,s=>{this._assignExtras(s,t),n(s)})}loadCameraAsync(e,t,n){return this._loader.loadCameraAsync(e,t,s=>{this._assignExtras(s,t),n(s)})}createMaterial(e,t,n){const s=this._loader.createMaterial(e,t,n);return this._assignExtras(s,t),s}}k(Hn);R(Hn,!1,r=>new er(r));class tr extends xr{constructor(e){var o,a;super();const t=e.glTF,n=((o=t.animations)==null?void 0:o.map(i=>i._babylonAnimationGroup))||[];this.animationGroups=this.registerDataOutput("animationGroups",Wn,n);const s=((a=t.nodes)==null?void 0:a.map(i=>i._babylonTransformNode))||[];this.nodes=this.registerDataOutput("nodes",Wn,s)}getClassName(){return"FlowGraphGLTFDataProvider"}}const ao=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphGLTFDataProvider:tr},Symbol.toStringTag,{value:"Module"})),po=Object.freeze(Object.defineProperty({__proto__:null,AddObjectAccessorToKey:be,AnimationPropertyInfo:He,ArrayItem:b,EXT_lights_ies:Ts,EXT_lights_image_based:ms,EXT_mesh_gpu_instancing:gs,EXT_meshopt_compression:ys,EXT_texture_avif:As,EXT_texture_webp:bs,ExtrasAsMetadata:er,FlowGraphGLTFDataProvider:tr,GLTFFileLoader:z,GLTFLoader:C,GetMappingForKey:ze,GetPathToObjectConverter:_n,InteractivityGraphToFlowGraphParser:Ys,KHR_animation_pointer:$s,KHR_draco_mesh_compression:xs,KHR_interactivity:Zs,KHR_lights:ws,KHR_materials_anisotropy:Is,KHR_materials_clearcoat:Cs,KHR_materials_diffuse_transmission:Fs,KHR_materials_dispersion:ks,KHR_materials_emissive_strength:Ns,KHR_materials_ior:it,KHR_materials_iridescence:Os,KHR_materials_pbrSpecularGlossiness:vs,KHR_materials_sheen:Ms,KHR_materials_specular:Ss,KHR_materials_transmission:Ps,KHR_materials_unlit:Es,KHR_materials_variants:he,KHR_materials_volume:Ls,KHR_mesh_quantization:Bs,KHR_node_hoverability:zs,KHR_node_selectability:Qs,KHR_node_visibility:Js,KHR_texture_basisu:Rs,KHR_texture_transform:Gs,KHR_xmp_json_ld:Ds,LoadBoundingInfoFromPositionAccessor:mn,MSFT_audio_emitter:Hs,MSFT_lod:Ks,MSFT_minecraftMesh:Us,MSFT_sRGBFactors:Ws,SetInterpolationForKey:m,TransformNodeAnimationPropertyInfo:at,WeightAnimationPropertyInfo:bn,_AddInteractivityObjectModel:Xs,addNewInteractivityFlowGraphMapping:Xt,getAllSupportedNativeNodeTypes:oo,getMappingForDeclaration:$n,getMappingForFullOperationName:cn,getQuaternion:gn,getVector3:Zt,getWeights:yn,gltfTypeToBabylonType:js,registerGLTFExtension:R,registeredGLTFExtensions:_s,unregisterGLTFExtension:k},Symbol.toStringTag,{value:"Module"}));class Ae{constructor(){this.materials=[]}parseMTL(e,t,n,s){if(t instanceof ArrayBuffer)return;const o=t.split(`
`),a=/\s+/;let i,l=null;for(let c=0;c<o.length;c++){const u=o[c].trim();if(u.length===0||u.charAt(0)==="#")continue;const h=u.indexOf(" ");let d=h>=0?u.substring(0,h):u;d=d.toLowerCase();const f=h>=0?u.substring(h+1).trim():"";if(d==="newmtl")l&&this.materials.push(l),e._blockEntityCollection=!!s,l=new Ye(f,e),l._parentContainer=s,e._blockEntityCollection=!1;else if(d==="kd"&&l)i=f.split(a,3).map(parseFloat),l.diffuseColor=B.FromArray(i);else if(d==="ka"&&l)i=f.split(a,3).map(parseFloat),l.ambientColor=B.FromArray(i);else if(d==="ks"&&l)i=f.split(a,3).map(parseFloat),l.specularColor=B.FromArray(i);else if(d==="ke"&&l)i=f.split(a,3).map(parseFloat),l.emissiveColor=B.FromArray(i);else if(d==="ns"&&l)l.specularPower=parseFloat(f);else if(d==="d"&&l)l.alpha=parseFloat(f);else if(d==="map_ka"&&l)l.ambientTexture=Ae._GetTexture(n,f,e);else if(d==="map_kd"&&l)l.diffuseTexture=Ae._GetTexture(n,f,e);else if(d==="map_ks"&&l)l.specularTexture=Ae._GetTexture(n,f,e);else if(d!=="map_ns")if(d==="map_bump"&&l){const p=f.split(a),_=p.indexOf("-bm");let A=null;_>=0&&(A=p[_+1],p.splice(_,2)),l.bumpTexture=Ae._GetTexture(n,p.join(" "),e),l.bumpTexture&&A!==null&&(l.bumpTexture.level=parseFloat(A))}else d==="map_d"&&l&&(l.opacityTexture=Ae._GetTexture(n,f,e))}l&&this.materials.push(l)}static _GetTexture(e,t,n){if(!t)return null;let s=e;if(e==="file:"){let o=t.lastIndexOf("\\");o===-1&&(o=t.lastIndexOf("/")),o>-1?s+=t.substring(o+1):s+=t}else s+=t;return new q(s,n,!1,Ae.INVERT_TEXTURE_Y)}}Ae.INVERT_TEXTURE_Y=!0;class L{constructor(e,t,n){this._positions=[],this._normals=[],this._uvs=[],this._colors=[],this._extColors=[],this._meshesFromObj=[],this._indicesForBabylon=[],this._wrappedPositionForBabylon=[],this._wrappedUvsForBabylon=[],this._wrappedColorsForBabylon=[],this._wrappedNormalsForBabylon=[],this._tuplePosNorm=[],this._curPositionInIndices=0,this._hasMeshes=!1,this._unwrappedPositionsForBabylon=[],this._unwrappedColorsForBabylon=[],this._unwrappedNormalsForBabylon=[],this._unwrappedUVForBabylon=[],this._triangles=[],this._materialNameFromObj="",this._objMeshName="",this._increment=1,this._isFirstMaterial=!0,this._grayColor=new Ue(.5,.5,.5,1),this._hasLineData=!1,this._materialToUse=e,this._babylonMeshesArray=t,this._loadingOptions=n}_isInArray(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[]});const n=e[t[0]].normals.indexOf(t[1]);return n===-1?-1:e[t[0]].idx[n]}_isInArrayUV(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[],uv:[]});const n=e[t[0]].normals.indexOf(t[1]);return n!=1&&t[2]===e[t[0]].uv[n]?e[t[0]].idx[n]:-1}_setData(e,t,n,s,o,a,i){let l;this._loadingOptions.optimizeWithUV?l=this._isInArrayUV(this._tuplePosNorm,[e,n,t]):l=this._isInArray(this._tuplePosNorm,[e,n]),l===-1?(this._indicesForBabylon.push(this._wrappedPositionForBabylon.length),this._wrappedPositionForBabylon.push(s),o=o??new ge(0,0),this._wrappedUvsForBabylon.push(o),this._wrappedNormalsForBabylon.push(a),i!==void 0&&this._wrappedColorsForBabylon.push(i),this._tuplePosNorm[e].normals.push(n),this._tuplePosNorm[e].idx.push(this._curPositionInIndices++),this._loadingOptions.optimizeWithUV&&this._tuplePosNorm[e].uv.push(t)):this._indicesForBabylon.push(l)}_unwrapData(){try{for(let e=0;e<this._wrappedPositionForBabylon.length;e++)this._unwrappedPositionsForBabylon.push(this._wrappedPositionForBabylon[e].x*this._handednessSign,this._wrappedPositionForBabylon[e].y,this._wrappedPositionForBabylon[e].z),this._unwrappedNormalsForBabylon.push(this._wrappedNormalsForBabylon[e].x*this._handednessSign,this._wrappedNormalsForBabylon[e].y,this._wrappedNormalsForBabylon[e].z),this._unwrappedUVForBabylon.push(this._wrappedUvsForBabylon[e].x,this._wrappedUvsForBabylon[e].y),this._loadingOptions.importVertexColors&&this._unwrappedColorsForBabylon.push(this._wrappedColorsForBabylon[e].r,this._wrappedColorsForBabylon[e].g,this._wrappedColorsForBabylon[e].b,this._wrappedColorsForBabylon[e].a);this._wrappedPositionForBabylon.length=0,this._wrappedNormalsForBabylon.length=0,this._wrappedUvsForBabylon.length=0,this._wrappedColorsForBabylon.length=0,this._tuplePosNorm.length=0,this._curPositionInIndices=0}catch{throw new Error("Unable to unwrap data while parsing OBJ data.")}}_getTriangles(e,t){for(let n=t;n<e.length-1;n++)this._pushTriangle(e,n)}_getColor(e){if(this._loadingOptions.importVertexColors)return this._extColors[e]??this._colors[e]}_setDataForCurrentFaceWithPattern1(e,t){this._getTriangles(e,t);for(let n=0;n<this._triangles.length;n++){const s=parseInt(this._triangles[n])-1;this._setData(s,0,0,this._positions[s],ge.Zero(),N.Up(),this._getColor(s))}this._triangles.length=0}_setDataForCurrentFaceWithPattern2(e,t){this._getTriangles(e,t);for(let n=0;n<this._triangles.length;n++){const s=this._triangles[n].split("/"),o=parseInt(s[0])-1,a=parseInt(s[1])-1;this._setData(o,a,0,this._positions[o],this._uvs[a]??ge.Zero(),N.Up(),this._getColor(o))}this._triangles.length=0}_setDataForCurrentFaceWithPattern3(e,t){this._getTriangles(e,t);for(let n=0;n<this._triangles.length;n++){const s=this._triangles[n].split("/"),o=parseInt(s[0])-1,a=parseInt(s[1])-1,i=parseInt(s[2])-1;this._setData(o,a,i,this._positions[o],this._uvs[a]??ge.Zero(),this._normals[i]??N.Up())}this._triangles.length=0}_setDataForCurrentFaceWithPattern4(e,t){this._getTriangles(e,t);for(let n=0;n<this._triangles.length;n++){const s=this._triangles[n].split("//"),o=parseInt(s[0])-1,a=parseInt(s[1])-1;this._setData(o,1,a,this._positions[o],ge.Zero(),this._normals[a],this._getColor(o))}this._triangles.length=0}_setDataForCurrentFaceWithPattern5(e,t){this._getTriangles(e,t);for(let n=0;n<this._triangles.length;n++){const s=this._triangles[n].split("/"),o=this._positions.length+parseInt(s[0]),a=this._uvs.length+parseInt(s[1]),i=this._normals.length+parseInt(s[2]);this._setData(o,a,i,this._positions[o],this._uvs[a],this._normals[i],this._getColor(o))}this._triangles.length=0}_addPreviousObjMesh(){this._meshesFromObj.length>0&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._unwrapData(),this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._handledMesh.indices=this._indicesForBabylon.slice(),this._handledMesh.positions=this._unwrappedPositionsForBabylon.slice(),this._handledMesh.normals=this._unwrappedNormalsForBabylon.slice(),this._handledMesh.uvs=this._unwrappedUVForBabylon.slice(),this._handledMesh.hasLines=this._hasLineData,this._loadingOptions.importVertexColors&&(this._handledMesh.colors=this._unwrappedColorsForBabylon.slice()),this._indicesForBabylon.length=0,this._unwrappedPositionsForBabylon.length=0,this._unwrappedColorsForBabylon.length=0,this._unwrappedNormalsForBabylon.length=0,this._unwrappedUVForBabylon.length=0,this._hasLineData=!1)}_optimizeNormals(e){const t=e.getVerticesData(S.PositionKind),n=e.getVerticesData(S.NormalKind),s={};if(!t||!n)return;for(let a=0;a<t.length/3;a++){const i=t[a*3+0],l=t[a*3+1],c=t[a*3+2],u=i+"_"+l+"_"+c;let h=s[u];h||(h=[],s[u]=h),h.push(a)}const o=new N;for(const a in s){const i=s[a];if(i.length<2)continue;const l=i[0];for(let c=1;c<i.length;++c){const u=i[c];n[l*3+0]+=n[u*3+0],n[l*3+1]+=n[u*3+1],n[l*3+2]+=n[u*3+2]}o.copyFromFloats(n[l*3+0],n[l*3+1],n[l*3+2]),o.normalize();for(let c=0;c<i.length;++c){const u=i[c];n[u*3+0]=o.x,n[u*3+1]=o.y,n[u*3+2]=o.z}}e.setVerticesData(S.NormalKind,n)}static _IsLineElement(e){return e.startsWith("l")}static _IsObjectElement(e){return e.startsWith("o")}static _IsGroupElement(e){return e.startsWith("g")}static _GetZbrushMRGB(e,t){if(!e.startsWith("mrgb"))return null;if(e=e.replace("mrgb","").trim(),t)return[];const n=/[a-z0-9]/g,s=e.match(n);if(!s||s.length%8!==0)return[];const o=[];for(let a=0;a<s.length/8;a++){const i=s[a*8+2]+s[a*8+3],l=s[a*8+4]+s[a*8+5],c=s[a*8+6]+s[a*8+7];o.push(new Ue(parseInt(i,16)/255,parseInt(l,16)/255,parseInt(c,16)/255,1))}return o}parse(e,t,n,s,o){var u;t=t.replace(/#MRGB/g,"mrgb"),t=t.replace(/#.*$/gm,"").trim(),this._loadingOptions.useLegacyBehavior?(this._pushTriangle=(h,d)=>this._triangles.push(h[0],h[d],h[d+1]),this._handednessSign=1):n.useRightHandedSystem?(this._pushTriangle=(h,d)=>this._triangles.push(h[0],h[d+1],h[d]),this._handednessSign=1):(this._pushTriangle=(h,d)=>this._triangles.push(h[0],h[d],h[d+1]),this._handednessSign=-1);const a=t.split(`
`),i=[];let l=[];i.push(l);for(let h=0;h<a.length;h++){const d=a[h].trim().replace(/\s\s/g," ");if(!(d.length===0||d.charAt(0)==="#"))if((L._IsGroupElement(d)||L._IsObjectElement(d))&&(l=[],i.push(l)),L._IsLineElement(d)){const f=d.split(" ");for(let p=1;p<f.length-1;p++)l.push(`l ${f[p]} ${f[p+1]}`)}else l.push(d)}const c=i.flat();for(let h=0;h<c.length;h++){const d=c[h].trim().replace(/\s\s/g," ");let f;if(!(d.length===0||d.charAt(0)==="#"))if(L.VertexPattern.test(d)){if(f=d.match(/[^ ]+/g),this._positions.push(new N(parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3]))),this._loadingOptions.importVertexColors)if(f.length>=7){const p=parseFloat(f[4]),_=parseFloat(f[5]),A=parseFloat(f[6]);this._colors.push(new Ue(p>1?p/255:p,_>1?_/255:_,A>1?A/255:A,f.length===7||f[7]===void 0?1:parseFloat(f[7])))}else this._colors.push(this._grayColor)}else if((f=L.NormalPattern.exec(d))!==null)this._normals.push(new N(parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3])));else if((f=L.UVPattern.exec(d))!==null)this._uvs.push(new ge(parseFloat(f[1])*this._loadingOptions.UVScaling.x,parseFloat(f[2])*this._loadingOptions.UVScaling.y));else if((f=L.FacePattern3.exec(d))!==null)this._setDataForCurrentFaceWithPattern3(f[1].trim().split(" "),1);else if((f=L.FacePattern4.exec(d))!==null)this._setDataForCurrentFaceWithPattern4(f[1].trim().split(" "),1);else if((f=L.FacePattern5.exec(d))!==null)this._setDataForCurrentFaceWithPattern5(f[1].trim().split(" "),1);else if((f=L.FacePattern2.exec(d))!==null)this._setDataForCurrentFaceWithPattern2(f[1].trim().split(" "),1);else if((f=L.FacePattern1.exec(d))!==null)this._setDataForCurrentFaceWithPattern1(f[1].trim().split(" "),1);else if((f=L.LinePattern1.exec(d))!==null)this._setDataForCurrentFaceWithPattern1(f[1].trim().split(" "),0),this._hasLineData=!0;else if((f=L.LinePattern2.exec(d))!==null)this._setDataForCurrentFaceWithPattern2(f[1].trim().split(" "),0),this._hasLineData=!0;else if(f=L._GetZbrushMRGB(d,!this._loadingOptions.importVertexColors))f.forEach(p=>{this._extColors.push(p)});else if((f=L.LinePattern3.exec(d))!==null)this._setDataForCurrentFaceWithPattern3(f[1].trim().split(" "),0),this._hasLineData=!0;else if(L.GroupDescriptor.test(d)||L.ObjectDescriptor.test(d)){const p={name:d.substring(2).trim(),indices:null,positions:null,normals:null,uvs:null,colors:null,materialName:this._materialNameFromObj,isObject:L.ObjectDescriptor.test(d)};this._addPreviousObjMesh(),this._meshesFromObj.push(p),this._hasMeshes=!0,this._isFirstMaterial=!0,this._increment=1}else if(L.UseMtlDescriptor.test(d)){if(this._materialNameFromObj=d.substring(7).trim(),!this._isFirstMaterial||!this._hasMeshes){this._addPreviousObjMesh();const p={name:(this._objMeshName||"mesh")+"_mm"+this._increment.toString(),indices:null,positions:null,normals:null,uvs:null,colors:null,materialName:this._materialNameFromObj,isObject:!1};this._increment++,this._meshesFromObj.push(p),this._hasMeshes=!0}this._hasMeshes&&this._isFirstMaterial&&(this._meshesFromObj[this._meshesFromObj.length-1].materialName=this._materialNameFromObj,this._isFirstMaterial=!1)}else L.MtlLibGroupDescriptor.test(d)?o(d.substring(7).trim()):L.SmoothDescriptor.test(d)||P.Log("Unhandled expression at line : "+d)}if(this._hasMeshes&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._unwrapData(),this._handledMesh.indices=this._indicesForBabylon,this._handledMesh.positions=this._unwrappedPositionsForBabylon,this._handledMesh.normals=this._unwrappedNormalsForBabylon,this._handledMesh.uvs=this._unwrappedUVForBabylon,this._handledMesh.hasLines=this._hasLineData,this._loadingOptions.importVertexColors&&(this._handledMesh.colors=this._unwrappedColorsForBabylon)),!this._hasMeshes){let h=null;if(this._indicesForBabylon.length)this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._unwrapData();else{for(const d of this._positions)this._unwrappedPositionsForBabylon.push(d.x,d.y,d.z);if(this._normals.length)for(const d of this._normals)this._unwrappedNormalsForBabylon.push(d.x,d.y,d.z);if(this._uvs.length)for(const d of this._uvs)this._unwrappedUVForBabylon.push(d.x,d.y);if(this._extColors.length)for(const d of this._extColors)this._unwrappedColorsForBabylon.push(d.r,d.g,d.b,d.a);else if(this._colors.length)for(const d of this._colors)this._unwrappedColorsForBabylon.push(d.r,d.g,d.b,d.a);this._materialNameFromObj||(h=new Ye(dt.RandomId(),n),h.pointsCloud=!0,this._materialNameFromObj=h.name,this._normals.length||(h.disableLighting=!0,h.emissiveColor=B.White()))}this._meshesFromObj.push({name:dt.RandomId(),indices:this._indicesForBabylon,positions:this._unwrappedPositionsForBabylon,colors:this._unwrappedColorsForBabylon,normals:this._unwrappedNormalsForBabylon,uvs:this._unwrappedUVForBabylon,materialName:this._materialNameFromObj,directMaterial:h,isObject:!0,hasLines:this._hasLineData})}for(let h=0;h<this._meshesFromObj.length;h++){if(e&&this._meshesFromObj[h].name){if(e instanceof Array){if(e.indexOf(this._meshesFromObj[h].name)===-1)continue}else if(this._meshesFromObj[h].name!==e)continue}this._handledMesh=this._meshesFromObj[h],n._blockEntityCollection=!!s;const d=new Ee(this._meshesFromObj[h].name,n);if(d._parentContainer=s,n._blockEntityCollection=!1,this._handledMesh._babylonMesh=d,!this._handledMesh.isObject){for(let p=h-1;p>=0;--p)if(this._meshesFromObj[p].isObject&&this._meshesFromObj[p]._babylonMesh){d.parent=this._meshesFromObj[p]._babylonMesh;break}}if(this._materialToUse.push(this._meshesFromObj[h].materialName),this._handledMesh.hasLines&&(d._internalMetadata??(d._internalMetadata={}),d._internalMetadata._isLine=!0),((u=this._handledMesh.positions)==null?void 0:u.length)===0){this._babylonMeshesArray.push(d);continue}const f=new ht;if(f.uvs=this._handledMesh.uvs,f.indices=this._handledMesh.indices,f.positions=this._handledMesh.positions,this._loadingOptions.computeNormals){const p=new Array;ht.ComputeNormals(this._handledMesh.positions,this._handledMesh.indices,p),f.normals=p}else f.normals=this._handledMesh.normals;this._loadingOptions.importVertexColors&&(f.colors=this._handledMesh.colors),f.applyToMesh(d),this._loadingOptions.invertY&&(d.scaling.y*=-1),this._loadingOptions.optimizeNormals&&this._optimizeNormals(d),this._babylonMeshesArray.push(d),this._handledMesh.directMaterial&&(d.material=this._handledMesh.directMaterial)}}}L.ObjectDescriptor=/^o/;L.GroupDescriptor=/^g/;L.MtlLibGroupDescriptor=/^mtllib /;L.UseMtlDescriptor=/^usemtl /;L.SmoothDescriptor=/^s /;L.VertexPattern=/^v(\s+[\d|.|+|\-|e|E]+){3,7}/;L.NormalPattern=/^vn(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/;L.UVPattern=/^vt(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/;L.FacePattern1=/^f\s+(([\d]{1,}[\s]?){3,})+/;L.FacePattern2=/^f\s+((([\d]{1,}\/[\d]{1,}[\s]?){3,})+)/;L.FacePattern3=/^f\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){3,})+)/;L.FacePattern4=/^f\s+((([\d]{1,}\/\/[\d]{1,}[\s]?){3,})+)/;L.FacePattern5=/^f\s+(((-[\d]{1,}\/-[\d]{1,}\/-[\d]{1,}[\s]?){3,})+)/;L.LinePattern1=/^l\s+(([\d]{1,}[\s]?){2,})+/;L.LinePattern2=/^l\s+((([\d]{1,}\/[\d]{1,}[\s]?){2,})+)/;L.LinePattern3=/^l\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){2,})+)/;const en={name:"obj",extensions:".obj"};class X{static get INVERT_TEXTURE_Y(){return Ae.INVERT_TEXTURE_Y}static set INVERT_TEXTURE_Y(e){Ae.INVERT_TEXTURE_Y=e}constructor(e){this.name=en.name,this.extensions=en.extensions,this._assetContainer=null,this._loadingOptions={...X._DefaultLoadingOptions,...e??{}}}static get _DefaultLoadingOptions(){return{computeNormals:X.COMPUTE_NORMALS,optimizeNormals:X.OPTIMIZE_NORMALS,importVertexColors:X.IMPORT_VERTEX_COLORS,invertY:X.INVERT_Y,invertTextureY:X.INVERT_TEXTURE_Y,UVScaling:X.UV_SCALING,materialLoadingFailsSilently:X.MATERIAL_LOADING_FAILS_SILENTLY,optimizeWithUV:X.OPTIMIZE_WITH_UV,skipMaterials:X.SKIP_MATERIALS,useLegacyBehavior:X.USE_LEGACY_BEHAVIOR}}_loadMTL(e,t,n,s){const o=t+e;D.LoadFile(o,n,void 0,void 0,!1,(a,i)=>{s(o,i)})}createPlugin(e){return new X(e[en.name])}canDirectLoad(){return!1}importMeshAsync(e,t,n,s){return this._parseSolid(e,t,n,s).then(o=>({meshes:o,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]}))}loadAsync(e,t,n){return this.importMeshAsync(null,e,t,n).then(()=>{})}loadAssetContainerAsync(e,t,n){const s=new qt(e);return this._assetContainer=s,this.importMeshAsync(null,e,t,n).then(o=>(o.meshes.forEach(a=>s.meshes.push(a)),o.meshes.forEach(a=>{const i=a.material;i&&s.materials.indexOf(i)==-1&&(s.materials.push(i),i.getActiveTextures().forEach(c=>{s.textures.indexOf(c)==-1&&s.textures.push(c)}))}),this._assetContainer=null,s)).catch(o=>{throw this._assetContainer=null,o})}_parseSolid(e,t,n,s){let o="";const a=new Ae,i=[],l=[];n=n.replace(/#.*$/gm,"").trim(),new L(i,l,this._loadingOptions).parse(e,n,t,this._assetContainer,h=>{o=h});const u=[];return o!==""&&!this._loadingOptions.skipMaterials&&u.push(new Promise((h,d)=>{this._loadMTL(o,s,f=>{try{a.parseMTL(t,f,s,this._assetContainer);for(let p=0;p<a.materials.length;p++){let _=0;const A=[];let v;for(;(v=i.indexOf(a.materials[p].name,_))>-1;)A.push(v),_=v+1;if(v===-1&&A.length===0)a.materials[p].dispose();else for(let F=0;F<A.length;F++){const M=l[A[F]],x=a.materials[p];M.material=x,M.getTotalIndices()||(x.pointsCloud=!0)}}h()}catch(p){D.Warn(`Error processing MTL file: '${o}'`),this._loadingOptions.materialLoadingFailsSilently?h():d(p)}},(f,p)=>{D.Warn(`Error downloading MTL file: '${o}'`),this._loadingOptions.materialLoadingFailsSilently?h():d(p)})})),Promise.all(u).then(()=>{const h=d=>{var f;return!!(((f=d._internalMetadata)==null?void 0:f._isLine)??!1)};return l.forEach(d=>{if(h(d)){let f=d.material??new Ye(d.name+"_line",t);f.getBindedMeshes().filter(_=>!h(_)).length>0&&(f=f.clone(f.name+"_line")??f),f.wireframe=!0,d.material=f,d._internalMetadata&&(d._internalMetadata._isLine=void 0)}}),l})}}X.OPTIMIZE_WITH_UV=!0;X.INVERT_Y=!1;X.IMPORT_VERTEX_COLORS=!1;X.COMPUTE_NORMALS=!1;X.OPTIMIZE_NORMALS=!1;X.UV_SCALING=new ge(1,1);X.SKIP_MATERIALS=!1;X.MATERIAL_LOADING_FAILS_SILENTLY=!0;X.USE_LEGACY_BEHAVIOR=!1;jt(new X);const ts={name:"stl",extensions:{".stl":{isBinary:!0}}};class Ve{constructor(){this.solidPattern=/solid (\S*)([\S\s]*?)endsolid[ ]*(\S*)/g,this.facetsPattern=/facet([\s\S]*?)endfacet/g,this.normalPattern=/normal[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.vertexPattern=/vertex[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.name=ts.name,this.extensions=ts.extensions}importMesh(e,t,n,s,o){let a;if(typeof n!="string"){if(this._isBinary(n)){const i=new Ee("stlmesh",t);return this._parseBinary(i,n),o&&o.push(i),!0}n=new TextDecoder().decode(new Uint8Array(n))}for(;a=this.solidPattern.exec(n);){let i=a[1];const l=a[3];if(l&&i!=l)return D.Error("Error in STL, solid name != endsolid name"),!1;if(e&&i){if(e instanceof Array){if(!e.indexOf(i))continue}else if(i!==e)continue}i=i||"stlmesh";const c=new Ee(i,t);this._parseASCII(c,a[2]),o&&o.push(c)}return!0}load(e,t,n){return this.importMesh(null,e,t,n,null)}loadAssetContainer(e,t,n){const s=new qt(e);return e._blockEntityCollection=!0,this.importMesh(null,e,t,n,s.meshes),e._blockEntityCollection=!1,s}_isBinary(e){const t=new DataView(e);if(t.byteLength<=80)return!1;const n=32/8*3+32/8*3*3+16/8,s=t.getUint32(80,!0);if(80+32/8+s*n===t.byteLength)return!0;const o=[115,111,108,105,100];for(let a=0;a<5;a++)if(t.getUint8(a)!==o[a])return!0;return!1}_parseBinary(e,t){const n=new DataView(t),s=n.getUint32(80,!0),o=84,a=12*4+2;let i=0;const l=new Float32Array(s*3*3),c=new Float32Array(s*3*3),u=new Uint32Array(s*3);let h=0;for(let d=0;d<s;d++){const f=o+d*a,p=n.getFloat32(f,!0),_=n.getFloat32(f+4,!0),A=n.getFloat32(f+8,!0);for(let v=1;v<=3;v++){const F=f+v*12;l[i]=n.getFloat32(F,!0),c[i]=p,Ve.DO_NOT_ALTER_FILE_COORDINATES?(l[i+1]=n.getFloat32(F+4,!0),l[i+2]=n.getFloat32(F+8,!0),c[i+1]=_,c[i+2]=A):(l[i+2]=n.getFloat32(F+4,!0),l[i+1]=n.getFloat32(F+8,!0),c[i+2]=_,c[i+1]=A),i+=3}Ve.DO_NOT_ALTER_FILE_COORDINATES?(u[h]=h,u[h+1]=h+2,u[h+2]=h+1,h+=3):(u[h]=h++,u[h]=h++,u[h]=h++)}e.setVerticesData(S.PositionKind,l),e.setVerticesData(S.NormalKind,c),e.setIndices(u),e.computeWorldMatrix(!0)}_parseASCII(e,t){const n=[],s=[],o=[];let a=0,i;for(;i=this.facetsPattern.exec(t);){const l=i[1],c=this.normalPattern.exec(l);if(this.normalPattern.lastIndex=0,!c)continue;const u=[Number(c[1]),Number(c[5]),Number(c[3])];let h;for(;h=this.vertexPattern.exec(l);)Ve.DO_NOT_ALTER_FILE_COORDINATES?(n.push(Number(h[1]),Number(h[3]),Number(h[5])),s.push(u[0],u[2],u[1])):(n.push(Number(h[1]),Number(h[5]),Number(h[3])),s.push(u[0],u[1],u[2]));Ve.DO_NOT_ALTER_FILE_COORDINATES?(o.push(a,a+2,a+1),a+=3):o.push(a++,a++,a++),this.vertexPattern.lastIndex=0}this.facetsPattern.lastIndex=0,e.setVerticesData(S.PositionKind,n),e.setVerticesData(S.NormalKind,s),e.setIndices(o),e.computeWorldMatrix(!0)}}Ve.DO_NOT_ALTER_FILE_COORDINATES=!1;jt(new Ve);const tn={name:"splat",extensions:{".splat":{isBinary:!0},".ply":{isBinary:!0},".spz":{isBinary:!0}}};var ns;(function(r){r[r.Splat=0]="Splat",r[r.PointCloud=1]="PointCloud",r[r.Mesh=2]="Mesh",r[r.Reject=3]="Reject"})(ns||(ns={}));class Pe{constructor(e=Pe._DefaultLoadingOptions){this.name=tn.name,this._assetContainer=null,this.extensions=tn.extensions,this._loadingOptions=e}createPlugin(e){return new Pe(e[tn.name])}async importMeshAsync(e,t,n,s,o,a){return this._parse(e,t,n,s).then(i=>({meshes:i,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]}))}static _BuildPointCloud(e,t){if(!t.byteLength)return!1;const n=new Uint8Array(t),s=new Float32Array(t),o=3*4+3*4+4+4,a=n.length/o,i=function(l,c){const u=s[8*c+0],h=s[8*c+1],d=s[8*c+2];l.position=new N(u,h,d);const f=n[o*c+24+0]/255,p=n[o*c+24+1]/255,_=n[o*c+24+2]/255;l.color=new Ue(f,p,_,1)};return e.addPoints(a,i),!0}static _BuildMesh(e,t){const n=new Ee("PLYMesh",e),s=new Uint8Array(t.data),o=new Float32Array(t.data),a=3*4+3*4+4+4,i=s.length/a,l=[],c=new ht;for(let u=0;u<i;u++){const h=o[8*u+0],d=o[8*u+1],f=o[8*u+2];l.push(h,d,f)}if(t.hasVertexColors){const u=new Float32Array(i*4);for(let h=0;h<i;h++){const d=s[a*h+24+0]/255,f=s[a*h+24+1]/255,p=s[a*h+24+2]/255;u[h*4+0]=d,u[h*4+1]=f,u[h*4+2]=p,u[h*4+3]=1}c.colors=u}return c.positions=l,c.indices=t.faces,c.applyToMesh(n),n}_parseSPZ(e,t){const n=new Uint8Array(e),s=new Uint32Array(e),o=s[2],a=n[12],i=n[13];if(n[15]||s[0]!=1347635022||s[1]!=2)return new Promise(g=>{g({mode:3,data:u,hasVertexColors:!1})});const c=3*4+3*4+4+4,u=new ArrayBuffer(c*o),h=1/(1<<i),d=new Int32Array(1),f=new Uint8Array(d.buffer),p=function(g,E){return f[0]=g[E+0],f[1]=g[E+1],f[2]=g[E+2],f[3]=g[E+2]&128?255:0,d[0]*h};let _=16;const A=new Float32Array(u),v=new Float32Array(u),F=new Uint8ClampedArray(u),M=new Uint8ClampedArray(u);let x=1,T=0;this._loadingOptions.flipY||(x=-1,T=255);for(let g=0;g<o;g++)A[g*8+0]=p(n,_+0),A[g*8+1]=x*p(n,_+3),A[g*8+2]=x*p(n,_+6),_+=9;const I=.282;for(let g=0;g<o;g++){for(let E=0;E<3;E++){const V=(n[_+o+g*3+E]-127.5)/(.15*255);F[g*32+24+E]=wr.Clamp((.5+I*V)*255,0,255)}F[g*32+24+3]=n[_+g]}_+=o*4;for(let g=0;g<o;g++)v[g*8+3+0]=Math.exp(n[_+0]/16-10),v[g*8+3+1]=Math.exp(n[_+1]/16-10),v[g*8+3+2]=Math.exp(n[_+2]/16-10),_+=3;for(let g=0;g<o;g++){const E=n[_+0],G=n[_+1]*x+T,V=n[_+2]*x+T,$=E/127.5-1,Te=G/127.5-1,Y=V/127.5-1;M[g*32+28+1]=E,M[g*32+28+2]=G,M[g*32+28+3]=V;const W=1-($*$+Te*Te+Y*Y);M[g*32+28+0]=127.5+Math.sqrt(W<0?0:W)*127.5,_+=3}if(a){const E=((a+1)*(a+1)-1)*3,G=Math.ceil(E/16);let V=_;const $=[],Y=t.getEngine().getCaps().maxTextureSize,W=Math.ceil(o/Y);for(let H=0;H<G;H++){const re=new Uint8Array(W*Y*4*4);$.push(re)}for(let H=0;H<o;H++)for(let re=0;re<E;re++){const Ce=n[V++],Be=Math.floor(re/16),Ze=$[Be],oe=re%16,xe=H*16;Ze[oe+xe]=Ce}return new Promise(H=>{H({mode:0,data:u,hasVertexColors:!1,sh:$})})}return new Promise(g=>{g({mode:0,data:u,hasVertexColors:!1})})}_parse(e,t,n,s){const o=[],a=new ReadableStream({start(c){c.enqueue(new Uint8Array(n)),c.close()}}),i=new DecompressionStream("gzip"),l=a.pipeThrough(i);return new Promise(c=>{new Response(l).arrayBuffer().then(u=>{this._parseSPZ(u,t).then(h=>{t._blockEntityCollection=!!this._assetContainer;const d=new Qt("GaussianSplatting",null,t,this._loadingOptions.keepInRam);d._parentContainer=this._assetContainer,o.push(d),d.updateData(h.data,h.sh),t._blockEntityCollection=!1,c(o)})}).catch(()=>{Pe._ConvertPLYToSplat(n).then(async u=>{switch(t._blockEntityCollection=!!this._assetContainer,u.mode){case 0:{const h=new Qt("GaussianSplatting",null,t,this._loadingOptions.keepInRam);h._parentContainer=this._assetContainer,o.push(h),h.updateData(u.data)}break;case 1:{const h=new vr("PointCloud",1,t);Pe._BuildPointCloud(h,u.data)?await h.buildMeshAsync().then(d=>{o.push(d)}):h.dispose()}break;case 2:if(u.faces)o.push(Pe._BuildMesh(t,u));else throw new Error("PLY mesh doesn't contain face informations.");break;default:throw new Error("Unsupported Splat mode")}t._blockEntityCollection=!1,c(o)})})})}loadAssetContainerAsync(e,t,n){const s=new qt(e);return this._assetContainer=s,this.importMeshAsync(null,e,t,n).then(o=>(o.meshes.forEach(a=>s.meshes.push(a)),this._assetContainer=null,s)).catch(o=>{throw this._assetContainer=null,o})}loadAsync(e,t,n){return this.importMeshAsync(null,e,t,n).then(()=>{})}static _ConvertPLYToSplat(e){const t=new Uint8Array(e),n=new TextDecoder().decode(t.slice(0,1024*10)),s=`end_header
`,o=n.indexOf(s);if(o<0||!n)return new Promise(x=>{x({mode:0,data:e})});const a=parseInt(/element vertex (\d+)\n/.exec(n)[1]),i=/element face (\d+)\n/.exec(n);let l=0;i&&(l=parseInt(i[1]));const c=/element chunk (\d+)\n/.exec(n);let u=0;c&&(u=parseInt(c[1]));let h=0,d=0;const f={double:8,int:4,uint:4,float:4,short:2,ushort:2,uchar:1,list:0};let p;(function(x){x[x.Vertex=0]="Vertex",x[x.Chunk=1]="Chunk"})(p||(p={}));let _=1;const A=[],v=n.slice(0,o).split(`
`);for(const x of v)if(x.startsWith("property ")){const[,T,I]=x.split(" ");_==1?d+=f[T]:_==0&&(A.push({name:I,type:T,offset:h}),h+=f[T]),f[T]||P.Warn(`Unsupported property type: ${T}.`)}else if(x.startsWith("element ")){const[,T]=x.split(" ");T=="chunk"?_=1:T=="vertex"&&(_=0)}const F=h,M=d;return Qt.ConvertPLYWithSHToSplatAsync(e).then(x=>{const T=new DataView(e,o+s.length);let I=M*u+F*a;const g=[];if(l)for(let W=0;W<l;W++){const H=T.getUint8(I);if(H==3){I+=1;for(let re=0;re<H;re++){const Ce=T.getUint32(I+(2-re)*4,!0);g.push(Ce)}I+=12}}if(u)return new Promise(W=>{W({mode:0,data:x.buffer,sh:x.sh,faces:g,hasVertexColors:!1})});let E=0,G=0;const V=["x","y","z","scale_0","scale_1","scale_2","opacity","rot_0","rot_1","rot_2","rot_3"],$=["red","green","blue","f_dc_0","f_dc_1","f_dc_2"];for(let W=0;W<A.length;W++){const H=A[W];V.includes(H.name)&&E++,$.includes(H.name)&&G++}const Te=E==V.length&&G==3,Y=l?2:Te?0:1;return new Promise(W=>{W({mode:Y,data:x.buffer,sh:x.sh,faces:g,hasVertexColors:!!G})})})}}Pe._DefaultLoadingOptions={keepInRam:!1,flipY:!1};jt(new Pe);export{fo as GLTF1,po as GLTF2,z as GLTFFileLoader,We as GLTFLoaderAnimationStartMode,tt as GLTFLoaderCoordinateSystemMode,ue as GLTFLoaderState,cs as GLTFValidation,Ae as MTLFileLoader,X as OBJFileLoader,Pe as SPLATFileLoader,Ve as STLFileLoader,L as SolidParser};
//# sourceMappingURL=index-KdCQAYTE.js.map
