const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/BabylonStage-DTqXF1d6.js","assets/motion-3WHHzQTP.js","assets/vendor-CIP6LD3P.js","assets/BabylonStageAdvanced-DCFzqzTU.js","assets/pointsCloudSystem-2vcS-S4d.js","assets/nativeXRFrame-DgHx7Vcb.js","assets/bumpVertex-CO1be_N_.js","assets/vertexColorMixing-CmRbdHdF.js","assets/helperFunctions-Dt8Ez0m5.js","assets/default.fragment-B-kdUbSd.js","assets/defaultUboDeclaration-C5WGJzzr.js","assets/oitFragment-COwarqmx.js","assets/mainUVVaryingDeclaration-kAMx1wwy.js","assets/easing-CYNgw8CS.js","assets/animationGroup-CmNY7dur.js","assets/dds-C64e2J1b.js","assets/khronosTextureContainer2-DKf4UHYP.js","assets/flowGraphSetDelayBlock-BBfSTBoS.js","assets/oitFragment-C1qnXpVq.js","assets/default.fragment-CtvPXGlm.js","assets/defaultUboDeclaration-mfzMqo_r.js","assets/mainUVVaryingDeclaration-BftUusui.js","assets/pbr.fragment-CxtSokwZ.js","assets/harmonicsFunctions-BiMv5FUV.js","assets/pbr.fragment-jox_Wzt1.js","assets/harmonicsFunctions-C2rlzhtf.js","assets/hdr-6elhj4O4.js","assets/tga-BWmadVoa.js","assets/default.vertex-kA04vKVP.js","assets/postprocess.vertex-DIr9NoBj.js","assets/flowGraphConsoleLogBlock-5lumJm4F.js","assets/flowGraphBranchBlock-peq7SHeE.js","assets/flowGraphDoNBlock-Cw0MCZY_.js","assets/flowGraphForLoopBlock-DFb4jPHE.js","assets/flowGraphThrottleBlock-DSWZx77Z.js","assets/flowGraphMultiGateBlock-CFHMOiDs.js","assets/flowGraphSwitchBlock-C1_GlPCW.js","assets/flowGraphWaitAllBlock-DaOfx9s5.js","assets/flowGraphCounterBlock-C3E0kQJV.js","assets/flowGraphWhileLoopBlock-CrKmMf0V.js","assets/flowGraphDebounceBlock-BD27J6wA.js","assets/flowGraphFlipFlopBlock-BeUAb8kC.js","assets/flowGraphSequenceBlock-CAUFTA3B.js","assets/flowGraphCancelDelayBlock-BDMNcw84.js","assets/flowGraphPlayAnimationBlock-Bn5vAf3k.js","assets/flowGraphStopAnimationBlock-BFnaBB8T.js","assets/flowGraphPauseAnimationBlock-CGPBCzif.js","assets/flowGraphInterpolationBlock-DCCdvI-3.js","assets/flowGraphEasingBlock-Cg0myAZj.js","assets/flowGraphBezierCurveEasingBlock-D8e5lRJR.js","assets/flowGraphConditionalDataBlock-CXbcBt68.js","assets/flowGraphGetVariableBlock-DhlcrG-o.js","assets/flowGraphSetVariableBlock-B1MhHVxv.js","assets/flowGraphTransformCoordinatesSystemBlock-DNGdu7-D.js","assets/flowGraphGetPropertyBlock-TnE7q6og.js","assets/flowGraphCachedOperationBlock-ByGHbGUe.js","assets/flowGraphSetPropertyBlock-DXJsQY2Q.js","assets/flowGraphConstantBlock-DysdAuT5.js","assets/flowGraphGetAssetBlock-BLmhj2X4.js","assets/flowGraphDataSwitchBlock-DvJwFjXa.js","assets/flowGraphMathBlocks-C4x3is-T.js","assets/flowGraphBinaryOperationBlock-DZCn6KPT.js","assets/flowGraphUnaryOperationBlock-BvbmF_Vi.js","assets/flowGraphTernaryOperationBlock-Cd2lmfhN.js","assets/flowGraphMathCombineExtractBlocks-BlJzkMI0.js","assets/flowGraphMatrixMathBlocks-dFiznv_Q.js","assets/flowGraphVectorMathBlocks-VcTsQTKK.js","assets/flowGraphJsonPointerParserBlock-CAnLRrmw.js","assets/flowGraphTypeToTypeBlocks-B2Nx7lWr.js","assets/flowGraphContextBlock-CSQiKo5X.js","assets/flowGraphArrayIndexBlock-GiVbpSS7.js","assets/flowGraphIndexOfBlock-CUZxmyHg.js","assets/flowGraphFunctionReferenceBlock-Dmuyl_SX.js","assets/flowGraphMeshPickEventBlock-DsWTRMRq.js","assets/flowGraphSceneReadyEventBlock-D0WxwWod.js","assets/flowGraphReceiveCustomEventBlock-pMlatOPN.js","assets/flowGraphSendCustomEventBlock-5_bDlDSf.js","assets/flowGraphSceneTickEventBlock-LT0lNSWj.js","assets/flowGraphPointerOutEventBlock-Crq0OLtx.js","assets/flowGraphPointerOverEventBlock-BjEu_EeF.js","assets/pbr.vertex-C6clv1jW.js","assets/pbr.vertex-C_PHP_eE.js","assets/basis-DDOcy81u.js","assets/exrLoader.configuration-BDKsI_eb.js","assets/default.vertex-Ao6IQZKy.js","assets/lodCube.fragment-D_gIz9a5.js","assets/lod.fragment-CVDCt30G.js","assets/lodCube.fragment-Ds6X7yQ8.js","assets/lod.fragment-C6sl9DjL.js","assets/rgbdDecode.fragment-Dd8vf-n0.js","assets/rgbdEncode.fragment-C5jKXevo.js","assets/rgbdDecode.fragment-B9rvcZQ2.js","assets/rgbdEncode.fragment-CC1-xNHs.js","assets/pass.fragment-D7l-dmRx.js","assets/passCube.fragment-sEcb3B-6.js","assets/pass.fragment-B8b0gssu.js","assets/passCube.fragment-_Y3ijnqO.js"])))=>i.map(i=>d[i]);
var kt=Object.defineProperty;var St=(i,t,e)=>t in i?kt(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var B=(i,t,e)=>St(i,typeof t!="symbol"?t+"":t,e);import{j as r,m as x,A as V}from"./motion-3WHHzQTP.js";import{a as Et,r as h,g as _t,R as he}from"./vendor-CIP6LD3P.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=e(n);fetch(n.href,a)}})();var je={},$e=Et;je.createRoot=$e.createRoot,je.hydrateRoot=$e.hydrateRoot;const Tt="modulepreload",Mt=function(i){return"/tigerrosette/"+i},Ue={},st=function(t,e,s){let n=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),l=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));n=Promise.allSettled(e.map(c=>{if(c=Mt(c),c in Ue)return;Ue[c]=!0;const d=c.endsWith(".css"),m=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${m}`))return;const p=document.createElement("link");if(p.rel=d?"stylesheet":Tt,d||(p.as="script"),p.crossOrigin="",p.href=c,l&&p.setAttribute("nonce",l),document.head.appendChild(p),d)return new Promise((u,g)=>{p.addEventListener("load",u),p.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${c}`)))})}))}function a(o){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=o,window.dispatchEvent(l),!l.defaultPrevented)throw o}return n.then(o=>{for(const l of o||[])l.status==="rejected"&&a(l.reason);return t().catch(a)})},At={},qe=i=>{let t;const e=new Set,s=(m,p)=>{const u=typeof m=="function"?m(t):m;if(!Object.is(u,t)){const g=t;t=p??(typeof u!="object"||u===null)?u:Object.assign({},t,u),e.forEach(f=>f(t,g))}},n=()=>t,c={setState:s,getState:n,getInitialState:()=>d,subscribe:m=>(e.add(m),()=>e.delete(m)),destroy:()=>{(At?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),e.clear()}},d=t=i(s,n,c);return c},Ct=i=>i?qe(i):qe;var rt={exports:{}},it={},nt={exports:{}},at={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ee=h;function Rt(i,t){return i===t&&(i!==0||1/i===1/t)||i!==i&&t!==t}var It=typeof Object.is=="function"?Object.is:Rt,Pt=ee.useState,Dt=ee.useEffect,Lt=ee.useLayoutEffect,Ot=ee.useDebugValue;function Bt(i,t){var e=t(),s=Pt({inst:{value:e,getSnapshot:t}}),n=s[0].inst,a=s[1];return Lt(function(){n.value=e,n.getSnapshot=t,ge(n)&&a({inst:n})},[i,e,t]),Dt(function(){return ge(n)&&a({inst:n}),i(function(){ge(n)&&a({inst:n})})},[i]),Ot(e),e}function ge(i){var t=i.getSnapshot;i=i.value;try{var e=t();return!It(i,e)}catch{return!0}}function Ft(i,t){return t()}var $t=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?Ft:Bt;at.useSyncExternalStore=ee.useSyncExternalStore!==void 0?ee.useSyncExternalStore:$t;nt.exports=at;var Ut=nt.exports;/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var me=h,qt=Ut;function Vt(i,t){return i===t&&(i!==0||1/i===1/t)||i!==i&&t!==t}var Ht=typeof Object.is=="function"?Object.is:Vt,Wt=qt.useSyncExternalStore,zt=me.useRef,Gt=me.useEffect,Kt=me.useMemo,Yt=me.useDebugValue;it.useSyncExternalStoreWithSelector=function(i,t,e,s,n){var a=zt(null);if(a.current===null){var o={hasValue:!1,value:null};a.current=o}else o=a.current;a=Kt(function(){function c(g){if(!d){if(d=!0,m=g,g=s(g),n!==void 0&&o.hasValue){var f=o.value;if(n(f,g))return p=f}return p=g}if(f=p,Ht(m,g))return f;var N=s(g);return n!==void 0&&n(f,N)?(m=g,f):(m=g,p=N)}var d=!1,m,p,u=e===void 0?null:e;return[function(){return c(t())},u===null?void 0:function(){return c(u())}]},[t,e,s,n]);var l=Wt(i,a[0],a[1]);return Gt(function(){o.hasValue=!0,o.value=l},[l]),Yt(l),l};rt.exports=it;var Jt=rt.exports;const Xt=_t(Jt),ot={},{useDebugValue:Qt}=he,{useSyncExternalStoreWithSelector:Zt}=Xt;let Ve=!1;const es=i=>i;function ts(i,t=es,e){(ot?"production":void 0)!=="production"&&e&&!Ve&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),Ve=!0);const s=Zt(i.subscribe,i.getState,i.getServerState||i.getInitialState,t,e);return Qt(s),s}const He=i=>{(ot?"production":void 0)!=="production"&&typeof i!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const t=typeof i=="function"?Ct(i):i,e=(s,n)=>ts(t,s,n);return Object.assign(e,t),e},ss=i=>i?He(i):He,J=[{level:1,requiredExperience:0,voltsReward:0,title:"Новичок",description:"Первые шаги с электричеством"},{level:2,requiredExperience:5e3,voltsReward:50,title:"Ученик",description:"Осваиваете основы"},{level:3,requiredExperience:15e3,voltsReward:75,title:"Практикант",description:"⚠️ Опасно! Теперь удар током отнимает очки"},{level:4,requiredExperience:35e3,voltsReward:100,title:"Любитель",description:"🔥 Критично! Напряжение отнимается от очков"},{level:5,requiredExperience:7e4,voltsReward:150,title:"Энтузиаст",description:"Проявляете смелость в опасной игре"},{level:6,requiredExperience:125e3,voltsReward:200,title:"Смельчак",description:"Не боитесь рисковать"},{level:7,requiredExperience:2e5,voltsReward:250,title:"Храбрец",description:"Идете на оправданный риск"},{level:8,requiredExperience:3e5,voltsReward:300,title:"Отважный",description:"Покоряете сложности"},{level:9,requiredExperience:45e4,voltsReward:400,title:"Безрассудный",description:"Играете с опасностью"},{level:10,requiredExperience:65e4,voltsReward:500,title:"Профессионал",description:"Мастерски владеете риском"},{level:11,requiredExperience:9e5,voltsReward:600,title:"Эксперт",description:"Знаете все тонкости"},{level:12,requiredExperience:12e5,voltsReward:750,title:"Мастер",description:"Превосходите ожидания"},{level:13,requiredExperience:16e5,voltsReward:900,title:"Виртуоз",description:"Играете как художник"},{level:14,requiredExperience:21e5,voltsReward:1100,title:"Гуру",description:"Достигли просветления"},{level:15,requiredExperience:27e5,voltsReward:1300,title:"Сенсей",description:"Учите других"},{level:16,requiredExperience:35e5,voltsReward:1500,title:"Легенда",description:"О вас слагают легенды"},{level:17,requiredExperience:45e5,voltsReward:1750,title:"Миф",description:"Недостижимый идеал"},{level:18,requiredExperience:58e5,voltsReward:2e3,title:"Титан",description:"Сверхчеловеческие способности"},{level:19,requiredExperience:75e5,voltsReward:2300,title:"Бог Электричества",description:"Повелеваете молниями"},{level:20,requiredExperience:1e7,voltsReward:2500,title:"Зевс",description:"Абсолютная власть над током"}];function Z(i){let t=J[0];for(let e=J.length-1;e>=0;e--)if(i>=J[e].requiredExperience){t=J[e];break}return t}function lt(i){const t=Z(i),e=J.findIndex(n=>n.level===t.level)+1;if(e>=J.length)return{current:i,required:i,remaining:0,nextLevel:null};const s=J[e];return{current:i-t.requiredExperience,required:s.requiredExperience-t.requiredExperience,remaining:s.requiredExperience-i,nextLevel:s}}function rs(i){const{current:t,required:e}=lt(i);return e===0?100:Math.min(100,t/e*100)}const K={SAFE_CLICK:3,RISKY_CLICK:8,EXTREME_CLICK:15,STREAK_5:25,STREAK_10:60,STREAK_25:150,STREAK_50:300,SHOCK_SURVIVAL:5};function X(i){const t="/tigerrosette/";return i<=3?`${t}Media/Pictures/tigrrozetka_1.png`:i<=7?`${t}Media/Pictures/tigrrozetka_2.png`:i<=12?`${t}Media/Pictures/tigrrozetka_3.png`:`${t}Media/Pictures/tigrrozetka_4.png`}const We="http://localhost:3001/api";class is{constructor(){B(this,"token",null);this.token=localStorage.getItem("auth_token"),this.initializeTelegramAuth()}initializeTelegramAuth(){var t,e;if(typeof window<"u"&&((t=window.Telegram)!=null&&t.WebApp)){const s=window.Telegram.WebApp;(e=s.initDataUnsafe)!=null&&e.user&&this.authenticateWithTelegram(s.initData)}}async authenticateWithTelegram(t){try{const s=await(await fetch(`${We}/auth/telegram`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({initData:t})})).json();s.token&&(this.token=s.token,localStorage.setItem("auth_token",s.token))}catch(e){console.error("Telegram authentication failed:",e)}}async makeRequest(t,e={}){try{const s={"Content-Type":"application/json",...e.headers};this.token&&(s.Authorization=`Bearer ${this.token}`);const n=await fetch(`${We}${t}`,{...e,headers:s}),a=await n.json();return n.ok?{success:!0,data:a}:{error:a.error||`HTTP ${n.status}`}}catch(s){return console.error("API request failed:",s),{error:s instanceof Error?s.message:"Network error"}}}async submitScore(t){return this.makeRequest("/game/score",{method:"POST",body:JSON.stringify(t)})}async getUserStats(){return this.makeRequest("/game/stats")}async getLeaderboard(t="level",e=10){return this.makeRequest(`/game/leaderboard?type=${t}&limit=${e}`)}async refillEnergy(){return this.makeRequest("/game/refill-energy",{method:"POST"})}isAuthenticated(){return!!this.token}setToken(t){this.token=t,localStorage.setItem("auth_token",t)}clearToken(){this.token=null,localStorage.removeItem("auth_token")}}const q=new is;class ns{constructor(){B(this,"listeners",{})}on(t,e){var s;return((s=this.listeners)[t]||(s[t]=new Set)).add(e),()=>this.off(t,e)}off(t,e){var s;(s=this.listeners[t])==null||s.delete(e)}emit(t,e){var s;(s=this.listeners[t])==null||s.forEach(n=>{try{n(e)}catch{}})}}const F=new ns,ze={mode:"menu",isPlaying:!1,isPaused:!1,gameTime:0,score:0},as={id:"player1",name:"Смельчак",volts:0,level:1,experience:0,streak:0,totalClicks:0,successfulClicks:0,shockedClicks:0,luckCoefficient:50,luckIndicatorHidden:!1,luckHiddenUntil:0,survivalTime:0,protection:{gloves:{level:0,protection:0,durability:0,maxDurability:0},boots:{level:0,protection:0,durability:0,maxDurability:0},suit:{level:0,protection:0,durability:0,maxDurability:0},helmet:{level:0,protection:0,durability:0,maxDurability:0}}},Ge={difficulty:"easy",aiPattern:"regular",currentRisk:"low",streakCount:0,timeInSafeZone:0,lastClickTime:0,dangerLevel:0,warningSignsActive:!1,stage:1,aiElectricianActive:!1,nextDischargeTime:0,dischargeWarningTime:0,isDischarging:!1,dischargeDuration:5e3},os={volume:.7,enabled:!0,backgroundMusicEnabled:!0},ls=[{id:"first_click",title:"Первое прикосновение",description:"Нажми на розетку впервые",icon:"⚡",requirement:1,progress:0,completed:!1,reward:50,category:"special"},{id:"survivor_5",title:"Живчик",description:"Серия из 5 успешных нажатий",icon:"🏃",requirement:5,progress:0,completed:!1,reward:100,category:"streak"},{id:"survivor_25",title:"Неубиваемый",description:"Серия из 25 успешных нажатий",icon:"🛡️",requirement:25,progress:0,completed:!1,reward:500,category:"streak"},{id:"risk_taker",title:"Безрассудный",description:"50 нажатий в режиме High Risk",icon:"🔥",requirement:50,progress:0,completed:!1,reward:500,category:"risk"},{id:"time_survivor",title:"Выживальщик",description:"Выживи 5 минут без поражения",icon:"⏰",requirement:300,progress:0,completed:!1,reward:1e3,category:"survival"}],L=ss((i,t)=>({gameState:ze,player:as,singleMode:Ge,achievements:ls,sounds:os,showElectricSparks:!1,sparksIntensity:"medium",showScreenShake:!1,aiElectrician:{name:"Иван Электрик",energy:100,maxEnergy:100,voltage:0,maxVoltage:500,voltageChargeRate:2,lastAttackTime:0,equipment:{battery:100,capacitor:100,wires:100,generator:100},mood:"confident",experience:50,isActive:!1,lastMessage:"Готов к работе!",messageTime:0,failuresCount:0,successfulDischarges:0,playerAttacksReceived:0,workingEfficiency:100,canWork:!0,fatigueLevel:0,points:0,maxPoints:0},levelUpNotification:{isVisible:!1,level:null,voltsReward:0},startSingleMode:e=>{console.log("startSingleMode: Starting with difficulty:",e),t().fixPlayerLevel();const s=t().compensateExperience();s>0&&console.log(`Compensated ${s} experience points based on current score`),i({gameState:{...t().gameState,mode:"single",isPlaying:!0,gameTime:0,score:0},singleMode:{...Ge,difficulty:e}}),i(n=>({aiElectrician:{...n.aiElectrician,points:t().getAIMaxPointsForStage(t().singleMode.stage||1),maxPoints:t().getAIMaxPointsForStage(t().singleMode.stage||1)}})),setTimeout(()=>{console.log("startSingleMode: Starting AI Electrician after 3s delay"),t().startAIElectrician()},3e3)},startMultiplayerMode:e=>{let s="multiplayer";e==="duel"&&(s="duel-invite"),i({gameState:{...t().gameState,mode:s,isPlaying:!1,gameTime:0,score:0}}),console.log(`Starting multiplayer mode: ${e}`)},startRealDuel:()=>{i({gameState:{...t().gameState,mode:"duel",isPlaying:!0,gameTime:0,score:0}}),console.log("Starting real duel with another player")},goToMenu:()=>{i({gameState:{...ze,mode:"menu"}})},clickOutlet:()=>{const e=t(),s=Date.now(),n=s-e.singleMode.lastClickTime;let a="low";n<1e3?a="extreme":n<2e3?a="high":n<3e3&&(a="medium");const o=Math.min(100,e.singleMode.streakCount*2+(a==="extreme"?40:a==="high"?25:a==="medium"?15:5)+(e.player.luckCoefficient<30?20:0)),l=o>60;i({player:{...e.player,totalClicks:e.player.totalClicks+1},singleMode:{...e.singleMode,lastClickTime:s,currentRisk:a,dangerLevel:o,warningSignsActive:l}}),t().updateLuckCoefficient(),F.emit("outletClick",{time:s})},updateScore:e=>{const s=t(),n=s.gameState.score+e.totalPoints,a=s.player.volts+e.totalPoints,o=e.reason!=="Поражение током"&&e.reason!=="Клик во время разряда!"&&e.totalPoints>0,l=o?s.player.streak+1:0,c=o?s.singleMode.streakCount+1:0;let d=0;if(o){d=K.SAFE_CLICK,e.riskMultiplier>=2&&(d=K.RISKY_CLICK),e.riskMultiplier>=3&&(d=K.EXTREME_CLICK),l===5&&(d+=K.STREAK_5),l===10&&(d+=K.STREAK_10),l===25&&(d+=K.STREAK_25),l===50&&(d+=K.STREAK_50);const b=Math.floor(Math.max(0,e.totalPoints)/10);d+=b}else d=K.SHOCK_SURVIVAL;const m=o?s.player.successfulClicks+1:s.player.successfulClicks,p=o?s.player.shockedClicks:s.player.shockedClicks+1,u=m+p,g=u>0?Math.round(m/u*100):50;if(i({gameState:{...s.gameState,score:n},player:{...s.player,volts:a,streak:l,successfulClicks:m,shockedClicks:p,luckCoefficient:g},singleMode:{...s.singleMode,streakCount:c}}),o&&e.totalPoints>0){const b=t().aiElectrician,j=Math.max(1,Math.floor(e.totalPoints/2));i({aiElectrician:{...b,points:Math.max(0,b.points-j)}}),t().onAIPointsChanged()}const{addExperience:f}=t();f(d);const{unlockAchievement:N}=t();s.player.totalClicks===0&&N("first_click"),l===5&&N("survivor_5"),l===10&&N("survivor_10"),l===25&&N("survivor_25")},calculateShockImpact:e=>{let s,n,a,o;e<50?(s=Math.floor(e*.1)+1,n="mild",a=1e3,o=2e3):e<150?(s=Math.floor(e*.15)+5,n="moderate",a=1500,o=3e3):e<300?(s=Math.floor(e*.2)+10,n="severe",a=2e3,o=5e3):(s=Math.floor(e*.25)+20,n="critical",a=3e3,o=8e3);const l=Math.floor(e*.7);return{damage:s,voltsDrained:l,duration:a,severity:n,luckHideDuration:o}},triggerShock:()=>{const e=t();if(!e.gameState.isPlaying)return;const s=e.calculateShockImpact(e.player.volts),a=(100-e.getTotalProtection())/100,o=Math.floor(s.damage*a);e.damageProtection(s.damage),i({player:{...e.player,volts:Math.max(0,e.player.volts-s.voltsDrained),shockedClicks:e.player.shockedClicks+1,totalClicks:e.player.totalClicks+1,streak:0,luckIndicatorHidden:!0,luckHiddenUntil:Date.now()+s.luckHideDuration},showElectricSparks:!0,sparksIntensity:s.severity==="critical"?"extreme":s.severity==="severe"?"high":s.severity==="moderate"?"medium":"low",showScreenShake:!0,gameState:{...e.gameState,score:Math.max(0,e.gameState.score-o)},singleMode:{...e.singleMode,streakCount:0}}),i(l=>({aiElectrician:{...l.aiElectrician,points:Math.min(l.aiElectrician.maxPoints,l.aiElectrician.points+Math.max(1,Math.floor(o/2)))}})),t().onAIPointsChanged(),setTimeout(()=>{i({showElectricSparks:!1,showScreenShake:!1})},s.duration),F.emit("shock",{severity:s.severity}),t().updateLuckCoefficient()},endGame:()=>{t().stopAIElectrician(),i({gameState:{...t().gameState,mode:"menu",isPlaying:!1}})},unlockAchievement:e=>{const s=t(),n=s.achievements.find(a=>a.id===e);n&&!n.completed&&i({achievements:s.achievements.map(a=>a.id===e?{...a,completed:!0,progress:a.requirement}:a),player:{...s.player,volts:s.player.volts+n.reward}})},updatePlayerStats:e=>{const s=t();i({player:{...s.player,...e}})},addExperience:e=>{const s=t(),n=s.player.experience+e,a=Z(s.player.experience),o=Z(n);if(console.log("addExperience:",{amount:e,oldExperience:s.player.experience,newExperience:n,oldLevel:a.level,newLevel:o.level,playerLevel:s.player.level}),o.level>a.level){console.log("LEVEL UP!",{from:a.level,to:o.level,voltsReward:o.voltsReward});const l=s.player.volts+o.voltsReward;i({player:{...s.player,experience:n,level:o.level,volts:l}});const{showLevelUpNotification:c}=t();c(o,o.voltsReward),F.emit("levelUp",{level:o.level,voltsReward:o.voltsReward})}else i({player:{...s.player,experience:n,level:o.level}})},getCurrentLevelInfo:()=>{const e=t();return{currentLevel:Z(e.player.experience),progressInfo:lt(e.player.experience)}},fixPlayerLevel:()=>{const e=t(),s=Z(e.player.experience);console.log("fixPlayerLevel:",{currentStoredLevel:e.player.level,correctLevel:s.level,experience:e.player.experience}),e.player.level!==s.level&&(console.log("Fixing player level from",e.player.level,"to",s.level),i({player:{...e.player,level:s.level}}))},compensateExperience:()=>{const e=t(),s=e.gameState.score,n=e.player.experience,a=Math.floor(s/5),o=Math.max(0,a-n);return console.log("compensateExperience:",{currentScore:s,currentExperience:n,expectedExperience:a,missingExperience:o}),o>0?(console.log(`Compensating ${o} experience points`),t().addExperience(o),o):0},showLevelUpNotification:(e,s)=>{i({levelUpNotification:{isVisible:!0,level:e,voltsReward:s}})},getAIMaxPointsForStage(e){const s=t().singleMode.difficulty,n=s==="extreme"?250:s==="hard"?200:s==="medium"?150:120;return n+Math.floor((e-1)*n*.25)},hideLevelUpNotification:()=>{i({levelUpNotification:{isVisible:!1,level:null,voltsReward:0}})},updateLuckCoefficient:()=>{const e=t(),s=e.player.totalClicks,n=e.player.successfulClicks,a=s>0?Math.round(n/s*100):50,o=e.player.luckIndicatorHidden&&Date.now()>=e.player.luckHiddenUntil;i({player:{...e.player,luckCoefficient:a,luckIndicatorHidden:o?!1:e.player.luckIndicatorHidden}})},startAIElectrician:()=>{const e=t();if(!e.gameState.isPlaying){console.log("startAIElectrician: Game not playing, aborting");return}console.log("startAIElectrician: Starting AI Electrician"),i({singleMode:{...e.singleMode,aiElectricianActive:!0},aiElectrician:{...e.aiElectrician,isActive:!0,lastMessage:t().getAIElectricianMessage(),messageTime:Date.now()}});const s=setInterval(()=>{const n=t();if(!n.singleMode.aiElectricianActive||!n.gameState.isPlaying){console.log("startAIElectrician: Clearing AI update interval"),clearInterval(s);return}t().updateAIElectrician(),Math.random()<.3&&i({aiElectrician:{...t().aiElectrician,lastMessage:t().getAIElectricianMessage(),messageTime:Date.now()}})},2e3);console.log("startAIElectrician: Scheduling first discharge"),t().scheduleNextDischarge()},onAIPointsChanged:()=>{const e=t(),s=e.aiElectrician;if(e.gameState.isPlaying){if(s.points<=0){const n=e.singleMode.stage+1,a=t().getAIMaxPointsForStage(n),o=50+n*10;i({player:{...e.player,volts:e.player.volts+o},singleMode:{...e.singleMode,stage:n},aiElectrician:{...s,points:a,maxPoints:a,lastMessage:"Этап пройден! Я выдохся...",messageTime:Date.now()}}),F.emit("stageAdvance",{stage:n}),Math.random()<.5&&setTimeout(()=>t().dropElectricianItem(),400);return}if(s.points>=s.maxPoints){t().aiElectricianAttackPlayer();const n=Math.floor(s.maxPoints*.6);i({aiElectrician:{...s,points:n}})}}},advanceStage:()=>{const e=t(),s=e.singleMode.stage+1,n=t().getAIMaxPointsForStage(s);i({singleMode:{...e.singleMode,stage:s},aiElectrician:{...e.aiElectrician,points:n,maxPoints:n}})},dropElectricianItem:()=>{const e=t(),s=Math.floor(e.aiElectrician.fatigueLevel),a=(j=>j>=8?[{type:"suit",level:3,chance:.2,message:"🥽 ИИ электрик от усталости снял профессиональный костюм!"},{type:"gloves",level:3,chance:.3,message:"🧤 ИИ электрик уронил диэлектрические перчатки!"},{type:"boots",level:2,chance:.3,message:"👢 ИИ электрик оставил диэлектрические сапоги!"},{type:"helmet",level:2,chance:.2,message:"⛑️ ИИ электрик забыл диэлектрическую каску!"}]:j>=5?[{type:"gloves",level:2,chance:.4,message:"🧤 ИИ электрик потерял усиленные перчатки!"},{type:"boots",level:2,chance:.3,message:"👢 ИИ электрик оставил диэлектрические сапоги!"},{type:"suit",level:1,chance:.2,message:"🥽 ИИ электрик снял изолирующий костюм!"},{type:"helmet",level:1,chance:.1,message:"⛑️ ИИ электрик забыл каску!"}]:j>=2?[{type:"gloves",level:1,chance:.5,message:"🧤 ИИ электрик уронил резиновые перчатки!"},{type:"boots",level:1,chance:.3,message:"👢 ИИ электрик оставил резиновые сапоги!"},{type:"helmet",level:1,chance:.2,message:"⛑️ ИИ электрик забыл защитную каску!"}]:[{type:"gloves",level:1,chance:.7,message:"� ИИ электрик уронил рабочие перчатки!"},{type:"boots",level:1,chance:.3,message:"👢 ИИ электрик потерял сапог!"}])(s),o=Math.random();let l=0,c=null;for(const j of a)if(l+=j.chance,o<=l){c=j;break}if(!c)return;const{type:d,level:m,message:p}=c,u=d;if(e.player.protection[u].level>=m){console.log("Player already has better protection item:",d,m);const j=m*25;i({player:{...e.player,volts:e.player.volts+j},aiElectrician:{...e.aiElectrician,lastMessage:`💰 ИИ электрик дал ${j} вольт вместо ненужного предмета!`,messageTime:Date.now()}});return}const N=e.getShopItems().find(j=>j.type===u&&j.level===m);if(!N){console.error("Item stats not found for:",d,m);return}i({player:{...e.player,protection:{...e.player.protection,[u]:{level:N.level,protection:N.protection,durability:N.durability,maxDurability:N.durability}}},aiElectrician:{...e.aiElectrician,lastMessage:p,messageTime:Date.now()}}),F.emit("itemDrop",{type:u,level:m}),console.log(`Dropped item: ${N.name} (${N.protection}% protection) at fatigue level ${s}`);const b=25*m;t().addExperience(b)},restartAIElectrician:()=>{const e=t();if(!e.gameState.isPlaying){console.log("restartAIElectrician: Game not playing");return}if(e.aiElectrician.isActive){console.log("restartAIElectrician: AI already active");return}console.log("restartAIElectrician: Restarting AI Electrician"),i({aiElectrician:{...e.aiElectrician,energy:Math.max(50,e.aiElectrician.energy),equipment:{battery:Math.max(50,e.aiElectrician.equipment.battery),capacitor:Math.max(50,e.aiElectrician.equipment.capacitor),wires:Math.max(50,e.aiElectrician.equipment.wires),generator:Math.max(50,e.aiElectrician.equipment.generator)},lastMessage:"Отдохнул, снова готов к работе!",messageTime:Date.now()}}),t().startAIElectrician()},stopAIElectrician:()=>{i(e=>({singleMode:{...e.singleMode,aiElectricianActive:!1,nextDischargeTime:0,dischargeWarningTime:0,isDischarging:!1},aiElectrician:{...e.aiElectrician,isActive:!1,lastMessage:"Смена закончена, иду домой!",messageTime:Date.now()}}))},scheduleNextDischarge:()=>{const e=t();if(console.log("scheduleNextDischarge: Starting, AI active:",e.singleMode.aiElectricianActive),!e.singleMode.aiElectricianActive)return;const s=Date.now(),a=(()=>{const c={easy:{min:3e3,max:8e3},medium:{min:2500,max:6e3},hard:{min:2e3,max:4e3},extreme:{min:1500,max:3e3}}[e.singleMode.difficulty];let d=1;if(e.singleMode.aiPattern==="burst")d=.7;else if(e.singleMode.aiPattern==="random")d=Math.random()*.8+.6;else if(e.singleMode.aiPattern==="adaptive"){const u=e.player.luckCoefficient;d=u>70?.8:u<30?1.3:1}const m=c.min*d,p=c.max*d;return Math.random()*(p-m)+m})(),o=s+a,l=o-3e3;console.log("scheduleNextDischarge: Scheduled discharge",{interval:a/1e3+"s",nextDischargeTime:o,dischargeWarningTime:l,timeFromNow:(o-s)/1e3+"s"}),i({singleMode:{...e.singleMode,nextDischargeTime:o,dischargeWarningTime:l}}),setTimeout(()=>{console.log("scheduleNextDischarge: Timer triggered, checking discharge"),t().checkForDischarge()},a)},checkForDischarge:()=>{const e=t();if(!e.singleMode.aiElectricianActive||!e.gameState.isPlaying){console.log("checkForDischarge: AI inactive or game not playing",{aiActive:e.singleMode.aiElectricianActive,isPlaying:e.gameState.isPlaying});return}const s=Date.now();console.log("checkForDischarge: Checking discharge timing",{now:s,nextDischargeTime:e.singleMode.nextDischargeTime,timeUntilDischarge:e.singleMode.nextDischargeTime-s,isDischarging:e.singleMode.isDischarging,warningSignsActive:e.singleMode.warningSignsActive,dischargeWarningTime:e.singleMode.dischargeWarningTime}),!e.singleMode.warningSignsActive&&s>=e.singleMode.dischargeWarningTime&&(console.log("checkForDischarge: Activating warning signs"),i({singleMode:{...e.singleMode,warningSignsActive:!0,dangerLevel:85}})),s>=e.singleMode.nextDischargeTime&&!e.singleMode.isDischarging&&(console.log("checkForDischarge: STARTING DISCHARGE!"),i({singleMode:{...e.singleMode,isDischarging:!0},showElectricSparks:!0,sparksIntensity:"high"}),i({aiElectrician:{...e.aiElectrician,successfulDischarges:e.aiElectrician.successfulDischarges+1,lastMessage:"Отличный разряд! Все по плану!",messageTime:s}}),Math.random()<.3&&t().damageAIElectrician("equipment",Math.random()*5+2),setTimeout(()=>{console.log("checkForDischarge: ENDING DISCHARGE after",e.singleMode.dischargeDuration,"ms");const n=t();i({singleMode:{...n.singleMode,isDischarging:!1,warningSignsActive:!1,dangerLevel:0},showElectricSparks:!1}),t().updateAIElectrician(),t().aiElectrician.canWork?(console.log("checkForDischarge: Scheduling next discharge after ending current one"),t().scheduleNextDischarge()):(console.log("checkForDischarge: AI electrician is tired/broken, scheduling with delay"),i({aiElectrician:{...t().aiElectrician,lastMessage:t().getAIElectricianMessage(),messageTime:Date.now()}}),setTimeout(()=>{t().singleMode.aiElectricianActive&&t().gameState.isPlaying&&(console.log("checkForDischarge: Tired AI attempting to work again"),t().scheduleNextDischarge())},3e4))},e.singleMode.dischargeDuration))},updateAIElectrician:()=>{const e=t();if(!e.aiElectrician.isActive){console.log("updateAIElectrician: AI not active, skipping");return}const s=e.aiElectrician,n=Date.now();console.log("updateAIElectrician: Current state",{energy:s.energy.toFixed(1),voltage:s.voltage.toFixed(1),efficiency:s.workingEfficiency.toFixed(1),mood:s.mood,canWork:s.canWork});const a=s.workingEfficiency>80?.1:.2;let o=Math.max(0,s.energy-a),l=s.fatigueLevel;const c=s.energy>10,d=o<=10;d&&c&&(l=Math.min(10,s.fatigueLevel+.1)),d?(o=Math.min(s.maxEnergy,o+.5),console.log("updateAIElectrician: AI resting, energy recovery:",o.toFixed(1)),Math.floor(l)>Math.floor(s.fatigueLevel)&&Math.random()<.5&&(console.log(`AI fatigue level increased to ${Math.floor(l)}, dropping item`),t().dropElectricianItem())):o>50&&(l=Math.max(0,s.fatigueLevel-.05));const m=s.voltageChargeRate*(s.workingEfficiency/100),p=Math.min(s.maxVoltage,s.voltage+m),u=Math.random()*.05,g={battery:Math.max(0,s.equipment.battery-u),capacitor:Math.max(0,s.equipment.capacitor-u*.5),wires:Math.max(0,s.equipment.wires-u*.3),generator:Math.max(0,s.equipment.generator-u*.7)},f=(g.battery+g.capacitor+g.wires+g.generator)/4;f<30&&(g.battery=Math.min(100,g.battery+.1),g.capacitor=Math.min(100,g.capacitor+.1),g.wires=Math.min(100,g.wires+.1),g.generator=Math.min(100,g.generator+.1),console.log("updateAIElectrician: Equipment self-repair activated"));const N=Math.min(100,o*.7+f*.3);let b=s.mood;N<20?b="broken":N<40?b="tired":s.failuresCount>s.successfulDischarges?b="frustrated":s.playerAttacksReceived>3?b="angry":N>80&&(b="confident");const j=o>10&&f>15;p>=100&&(s.playerAttacksReceived>2||b==="angry"||Math.random()<.05)&&n-s.lastAttackTime>3e4&&setTimeout(()=>{t().aiElectricianAttackPlayer()},Math.random()*5e3),i({aiElectrician:{...s,energy:o,voltage:p,equipment:g,workingEfficiency:N,mood:b,canWork:j,fatigueLevel:l}})},damageAIElectrician:(e,s=10,n=!1)=>{const o=t().aiElectrician;if(e==="energy"){const l=Math.max(0,o.energy-s);let c;if(n){const d=["Ой! Да ты что, обалдел?! 😱","Эй, это больно! Мы же команда! 😭","Предательство! А я думал мы друзья... 💔","Ауууу! За что меня?! 😵","Ну и зачем ты меня шарахнул?! ⚡","Больно же! Я ведь стараюсь для тебя! 😢","Мама дорогая! Меня ударило током! 🤕","Это что, месть за разряды?! 😤","Ладно-ладно, я понял намек... 😅","Ай-ай-ай! Теперь у меня всё болит! 🤒","Обидно! Я же честно работаю! 😭","Ты серьезно?! Я же электрик, а не мишень! 🎯","Больше так не делай, договорились? 🥺","Кто научил тебя так драться?! 😰","Ну вот, теперь у меня мигрень... 🤕","Так, теперь я разозлился! Готовься к ответке! 😠","Больно! Но ничего, я тебе это припомню... 😈"];c=d[Math.floor(Math.random()*d.length)]}else c=l<=0?"Энергия кончилась! Нужен отдых...":"Ауч! Меня ударило током!";i({aiElectrician:{...o,energy:l,failuresCount:o.failuresCount+1,playerAttacksReceived:n?o.playerAttacksReceived+1:o.playerAttacksReceived,lastMessage:c,messageTime:Date.now()}})}else{const l=["battery","capacitor","wires","generator"],c=l[Math.floor(Math.random()*l.length)],d={...o.equipment,[c]:Math.max(0,o.equipment[c]-s)};let m;if(n){const p=[`Ты сломал мой ${c==="battery"?"аккумулятор":c==="capacitor"?"конденсатор":c==="wires"?"провода":"генератор"}! Теперь что делать?! 😱`,`Поломка! Мой ${c==="battery"?"аккумулятор":c==="capacitor"?"конденсатор":c==="wires"?"провода":"генератор"} дымится! 💨`,`О нет! Без ${c==="battery"?"аккумулятора":c==="capacitor"?"конденсатора":c==="wires"?"проводов":"генератора"} я не смогу работать! 😭`,`Ты же понимаешь, что ${c==="battery"?"аккумулятор":c==="capacitor"?"конденсатор":c==="wires"?"провода":"генератор"} стоит денег?! 💸`,"Вот это ты меня достал! Теперь ремонтировать придется... 🔧"];m=p[Math.floor(Math.random()*p.length)]}else m=`Сломался ${c==="battery"?"аккумулятор":c==="capacitor"?"конденсатор":c==="wires"?"провода":"генератор"}!`;i({aiElectrician:{...o,equipment:d,failuresCount:o.failuresCount+1,lastMessage:m,messageTime:Date.now()}})}t().updateAIElectrician()},repairAIElectrician:e=>{const n=t().aiElectrician;if(e==="energy"){const a=Math.min(n.maxEnergy,n.energy+25),o=["Спасибо! Чувствую прилив сил!","Отлично! Теперь я могу работать дольше!","Энергия восстановлена! Готов к работе!","Вау! Как будто заново родился!"];i({aiElectrician:{...n,energy:a,lastMessage:o[Math.floor(Math.random()*o.length)],messageTime:Date.now()}})}else{const a={battery:Math.min(100,n.equipment.battery+20),capacitor:Math.min(100,n.equipment.capacitor+20),wires:Math.min(100,n.equipment.wires+20),generator:Math.min(100,n.equipment.generator+20)},o=["Отремонтировал оборудование, теперь работает лучше!","Техника как новая! Спасибо за помощь!","Все детали заменены, можно продолжать!","Оборудование восстановлено! Теперь все будет работать!"];i({aiElectrician:{...n,equipment:a,lastMessage:o[Math.floor(Math.random()*o.length)],messageTime:Date.now()}})}t().updateAIElectrician()},aiElectricianAttackPlayer:()=>{const e=t(),s=e.aiElectrician;if(!s.isActive||s.voltage<100)return;console.log("AI Electrician attacking player!",{aiVoltage:s.voltage,playerVolts:e.player.volts});const n=20,a=Math.floor(s.voltage/20),o=n+a,l=[`Получай! ${s.voltage} вольт прямо в тебя! ⚡😈`,`А вот и ответка за твои выходки! ${s.voltage}В! 💀`,`Думал я не отвечу? Вот тебе ${s.voltage} вольт! ⚡😤`,`Месть электрика! ${s.voltage} вольт возмездия! ⚡👿`,`Получи разряд в ${s.voltage}В! Это тебе урок! 😠⚡`,`Вот что бывает с теми, кто нападает на электрика! ${s.voltage}В! 💥`,`Ответный удар! ${s.voltage} вольт прямо в цель! ⚡🎯`,`Хватит меня трогать! Держи ${s.voltage} вольт! 😡⚡`];i({singleMode:{...e.singleMode,isDischarging:!0,warningSignsActive:!0,dangerLevel:100}}),i({aiElectrician:{...s,voltage:0,lastAttackTime:Date.now(),lastMessage:l[Math.floor(Math.random()*l.length)],messageTime:Date.now(),playerAttacksReceived:Math.max(0,s.playerAttacksReceived-1)}});const c=Math.max(0,e.player.volts-o);i({player:{...e.player,volts:c}}),i({showElectricSparks:!0,sparksIntensity:"extreme"}),setTimeout(()=>{i({showElectricSparks:!1,singleMode:{...t().singleMode,isDischarging:!1,warningSignsActive:!1,dangerLevel:0}}),t().singleMode.aiElectricianActive&&t().gameState.isPlaying&&(console.log("AI attack complete, restarting discharge scheduling"),t().scheduleNextDischarge())},3e3),F.emit("aiAttack",{voltage:s.voltage})},getAIElectricianMessage:()=>{const s=t().aiElectrician,n={confident:["Я лучший электрик в городе!","Эта работа мне по плечу!","Никто не справится лучше меня!","У меня золотые руки!","Электричество - моя стихия!","Я знаю все о токе и напряжении!","Розетки трепещут от моего мастерства!"],frustrated:["Что-то сегодня не мой день...","Техника подводит, как всегда...","Может быть, стоит сменить профессию?","Опять что-то пошло не так!","Почему ничего не работает как надо?","Кто вообще проектировал эту схему?!","Каждый день одни проблемы..."],tired:["Устал я уже...","Нужен перерыв на кофе","Сил больше нет работать","Хочется домой...","Рабочий день слишком длинный","Глаза уже слипаются","Может, хватит на сегодня?"],broken:["Все сломалось! Ничего не работает!","Это конец! Я больше не могу!","Вызывайте другого электрика...","Техника в хлам, а я без сил!","Аварийное отключение! Все пропало!","Системный сбой! Помогите!","Я сломался как старая лампочка!"],angry:["Да что ж такое?! Опять сбой!","Кто проектировал эту схему?!","Руки бы поотрывать создателям!","Нервы уже на пределе!","Сколько можно терпеть эту ерунду?!","Где мой молоток?! Сейчас все исправлю!","Противная техника! Ненавижу!","Лучше бы пошел в программисты!"]},a=n[s.mood]||n.confident;return a[Math.floor(Math.random()*a.length)]},submitGameToServer:async()=>{const e=t();if(!q.isAuthenticated())return console.warn("User not authenticated, skipping server submission"),{success:!1,error:"Not authenticated"};try{const s={score:e.gameState.score,level:cs(e.singleMode.difficulty),timePlayed:Math.floor(e.gameState.gameTime/1e3)};console.log("Submitting game data to server:",s);const n=await q.submitScore(s);if(n.error)return console.error("Failed to submit score:",n.error),{success:!1,error:n.error};if(n.data){const a=n.data;if(i({player:{...e.player,volts:a.totalVolts,experience:a.totalExperience,level:a.newLevel}}),a.leveledUp){const{showLevelUpNotification:o}=t();o({level:a.newLevel},a.levelUpReward)}return console.log("Successfully submitted score and synced with server"),{success:!0}}return{success:!0}}catch(s){const n=s instanceof Error?s.message:"Unknown error";return console.error("Error submitting game to server:",n),{success:!1,error:n}}},syncWithServer:async()=>{if(!q.isAuthenticated())return{success:!1,error:"Not authenticated"};try{const e=await q.getUserStats();if(e.error)return{success:!1,error:e.error};if(e.data){const s=e.data;return i({player:{...t().player,volts:s.totalVolts,experience:s.totalExperience,level:s.level}}),console.log("Successfully synced with server"),{success:!0}}return{success:!0}}catch(e){const s=e instanceof Error?e.message:"Unknown error";return console.error("Error syncing with server:",s),{success:!1,error:s}}},loadStatsFromServer:async()=>{if(!q.isAuthenticated())return{success:!1,error:"Not authenticated"};try{const e=await q.getUserStats();if(e.error)return{success:!1,error:e.error};if(e.data){const s=e.data;return i({player:{...t().player,volts:s.totalVolts,experience:s.totalExperience,level:s.level}}),console.log("Successfully loaded stats from server"),{success:!0}}return{success:!0}}catch(e){const s=e instanceof Error?e.message:"Unknown error";return console.error("Error loading stats from server:",s),{success:!1,error:s}}},buyProtectionItem:(e,s)=>{const a=t().getShopItems().find(l=>l.type===e&&l.level===s);return!a||t().player.volts<a.price?!1:(i(l=>({player:{...l.player,volts:l.player.volts-a.price,protection:{...l.player.protection,[e]:{level:a.level,protection:a.protection,durability:a.durability,maxDurability:a.durability}}}})),!0)},getShopItems:()=>[{id:"gloves-1",type:"gloves",level:1,protection:10,price:50,durability:100,name:"Резиновые перчатки",description:"Базовая защита от небольших разрядов",icon:"🧤"},{id:"gloves-2",type:"gloves",level:2,protection:20,price:150,durability:200,name:"Усиленные перчатки",description:"Улучшенная изоляция для средних разрядов",icon:"🧤"},{id:"gloves-3",type:"gloves",level:3,protection:35,price:400,durability:300,name:"Диэлектрические перчатки",description:"Профессиональная защита от высокого напряжения",icon:"🧤"},{id:"boots-1",type:"boots",level:1,protection:15,price:80,durability:150,name:"Резиновые сапоги",description:"Защита ног от заземления",icon:"👢"},{id:"boots-2",type:"boots",level:2,protection:25,price:200,durability:250,name:"Диэлектрические сапоги",description:"Улучшенная изоляция от земли",icon:"👢"},{id:"boots-3",type:"boots",level:3,protection:40,price:500,durability:350,name:"Профессиональные сапоги",description:"Максимальная защита от заземления",icon:"👢"},{id:"suit-1",type:"suit",level:1,protection:20,price:200,durability:120,name:"Изолирующий костюм",description:"Защита тела от электрических разрядов",icon:"🥽"},{id:"suit-2",type:"suit",level:2,protection:35,price:500,durability:200,name:"Защитный костюм",description:"Усиленная защита всего тела",icon:"🥽"},{id:"suit-3",type:"suit",level:3,protection:50,price:1e3,durability:300,name:"Профессиональный костюм",description:"Максимальная защита для электриков",icon:"🥽"},{id:"helmet-1",type:"helmet",level:1,protection:10,price:100,durability:200,name:"Защитная каска",description:"Защита головы от ударов током",icon:"⛑️"},{id:"helmet-2",type:"helmet",level:2,protection:20,price:300,durability:300,name:"Диэлектрическая каска",description:"Улучшенная защита головы",icon:"⛑️"},{id:"helmet-3",type:"helmet",level:3,protection:30,price:600,durability:400,name:"Профессиональная каска",description:"Максимальная защита головы",icon:"⛑️"}],getTotalProtection:()=>{const e=t().player.protection;let s=0;return Object.values(e).forEach(n=>{if(n.durability>0){const a=n.durability/n.maxDurability;s+=n.protection*a}}),Math.min(s,80)},damageProtection:e=>{i(s=>{const n={...s.player.protection};return Object.keys(n).forEach(a=>{const o=n[a];o.durability>0&&Math.random()<.3&&(o.durability=Math.max(0,o.durability-Math.floor(e/4)))}),{player:{...s.player,protection:n}}})}}));function cs(i){switch(i){case"easy":return 1;case"medium":return 2;case"hard":return 3;case"extreme":return 4;default:return 1}}class ds{constructor(){B(this,"hapticFeedback",null);B(this,"isEnabled",!0);B(this,"isTelegramEnvironment",!1);this.initializeTelegramHaptics()}initializeTelegramHaptics(){var t;try{if(typeof window<"u"&&((t=window.Telegram)!=null&&t.WebApp)){this.isTelegramEnvironment=!0;const e=window.Telegram.WebApp;e.HapticFeedback?(this.hapticFeedback=e.HapticFeedback,console.log("Telegram Haptic Feedback initialized")):console.log("HapticFeedback not available in this Telegram version")}else console.log("Not in Telegram environment, haptics disabled")}catch(e){console.warn("Failed to initialize Telegram haptics:",e)}}setEnabled(t){this.isEnabled=t}isAvailable(){return(this.isTelegramEnvironment&&this.hapticFeedback!==null||typeof window<"u"&&"navigator"in window&&"vibrate"in navigator)&&this.isEnabled}light(){this.isAvailable()?this.hapticFeedback.impactOccurred("light"):this.fallbackVibration(50)}medium(){this.isAvailable()?this.hapticFeedback.impactOccurred("medium"):this.fallbackVibration(100)}heavy(){this.isAvailable()?this.hapticFeedback.impactOccurred("heavy"):this.fallbackVibration(150)}soft(){this.isAvailable()?this.hapticFeedback.impactOccurred("soft"):this.fallbackVibration(30)}rigid(){this.isAvailable()?this.hapticFeedback.impactOccurred("rigid"):this.fallbackVibration(200)}success(){this.isAvailable()?this.hapticFeedback.notificationOccurred("success"):this.customPattern([100,50,100])}error(){this.isAvailable()?this.hapticFeedback.notificationOccurred("error"):this.customPattern([200,100,200,100,200])}warning(){this.isAvailable()?this.hapticFeedback.notificationOccurred("warning"):this.customPattern([150,50,150])}selection(){this.isAvailable()?this.hapticFeedback.selectionChanged():this.fallbackVibration(25)}outletPress(){this.medium()}survivalSuccess(){this.success()}electricShock(){this.isEnabled&&(this.rigid(),setTimeout(()=>{this.isEnabled&&this.heavy()},50))}electricWarning(){this.isEnabled&&(this.light(),setTimeout(()=>{this.isEnabled&&this.light()},100))}levelUp(){this.success(),setTimeout(()=>this.medium(),150),setTimeout(()=>this.success(),300)}dangerWarning(){this.isEnabled&&(this.light(),setTimeout(()=>{this.isEnabled&&this.light()},100))}extremeDangerWarning(){this.isEnabled&&(this.light(),setTimeout(()=>{this.isEnabled&&this.medium()},150),setTimeout(()=>{this.isEnabled&&this.heavy()},300))}rewardReceived(){this.light(),setTimeout(()=>this.medium(),100)}streakAchievement(t){t>=25?(this.heavy(),setTimeout(()=>this.heavy(),200),setTimeout(()=>this.heavy(),400)):t>=10?(this.medium(),setTimeout(()=>this.medium(),150)):t>=5&&(this.light(),setTimeout(()=>this.light(),100))}itemUsed(){this.soft()}shopPurchase(){this.medium(),setTimeout(()=>this.light(),100)}gameInvitation(){this.warning(),setTimeout(()=>this.light(),500),setTimeout(()=>this.light(),1e3)}roundStart(){this.light()}gameEnd(t){t?(this.success(),setTimeout(()=>this.medium(),200),setTimeout(()=>this.success(),400)):this.error()}fallbackVibration(t){if("navigator"in window&&"vibrate"in navigator)try{navigator.vibrate(t),console.log(`🔹 Fallback vibration: ${t}ms`)}catch(e){console.warn("Vibration not supported:",e)}else console.log(`📳 Haptic feedback: ${t}ms (visual only)`),this.visualFeedback(t)}visualFeedback(t){const e=document.createElement("div");if(e.style.cssText=`
      position: fixed;
      top: 20px;
      right: 20px;
      background: #FF6B35;
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      z-index: 10000;
      pointer-events: none;
      animation: pulse 0.3s ease-in-out;
    `,e.textContent=`📳 ${t}ms`,!document.querySelector("#haptic-style")){const s=document.createElement("style");s.id="haptic-style",s.textContent=`
        @keyframes pulse {
          0% { transform: scale(0.8); opacity: 0; }
          50% { transform: scale(1.1); opacity: 1; }
          100% { transform: scale(1); opacity: 0.8; }
        }
      `,document.head.appendChild(s)}document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},Math.max(t,500))}customPattern(t){if("navigator"in window&&"vibrate"in navigator)try{navigator.vibrate(t),console.log(`🔹 Vibration pattern: [${t.join(", ")}]ms`)}catch(e){console.warn("Vibration pattern not supported:",e)}else console.log(`📳 Haptic pattern: [${t.join(", ")}]ms (visual only)`),this.visualPatternFeedback(t)}visualPatternFeedback(t){let e=0;for(let s=0;s<t.length;s+=2){const n=t[s],a=t[s+1]||0;setTimeout(()=>{this.visualFeedback(n)},e),e+=n+a}}test(){this.medium(),setTimeout(()=>this.light(),200),setTimeout(()=>this.heavy(),400)}}const A=new ds,us=({onClose:i})=>{const{player:t,singleMode:e,gameState:s}=L();return r.jsx(x.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50",onClick:i,children:r.jsxs(x.div,{initial:{opacity:0,y:20,scale:.9},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:20,scale:.9},className:"glass-effect p-6 max-w-2xl mx-auto relative max-h-[90vh] overflow-y-auto",onClick:n=>n.stopPropagation(),children:[r.jsx("button",{onClick:i,className:"absolute top-4 right-4 text-gray-400 hover:text-white transition-colors text-2xl",children:"✕"}),r.jsx("h3",{className:"text-2xl font-bold text-center mb-6 text-primary-orange",children:"📊 Система очков и уровней"}),r.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[r.jsxs("div",{className:"text-center glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-xs text-gray-400",children:"ТЕКУЩАЯ СЕРИЯ"}),r.jsx("div",{className:"text-xl font-bold text-yellow-400",children:e.streakCount})]}),r.jsxs("div",{className:"text-center glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-xs text-gray-400",children:"КОЭФФИЦИЕНТ УДАЧИ"}),r.jsxs("div",{className:`text-xl font-bold ${t.luckCoefficient>=70?"text-green-400":t.luckCoefficient>=50?"text-yellow-400":t.luckCoefficient>=30?"text-orange-400":"text-red-400"}`,children:[t.luckCoefficient,"%"]})]}),r.jsxs("div",{className:"text-center glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-xs text-gray-400",children:"ТЕКУЩИЙ СЧЕТ"}),r.jsxs("div",{className:"text-xl font-bold text-green-400",children:[s.score,"⚡"]})]}),r.jsxs("div",{className:"text-center glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-xs text-gray-400",children:"ВСЕГО ВОЛЬТ"}),r.jsxs("div",{className:"text-xl font-bold text-blue-400",children:[t.volts,"⚡"]})]})]}),r.jsxs("div",{className:"mb-6",children:[r.jsx("h4",{className:"text-lg font-bold text-accent-blue mb-3",children:"🍀 Статистика удачи"}),r.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[r.jsxs("div",{className:"glass-effect p-3 rounded-lg text-center",children:[r.jsx("div",{className:"text-xs text-gray-400",children:"УСПЕШНЫХ"}),r.jsx("div",{className:"text-lg font-bold text-green-400",children:t.successfulClicks})]}),r.jsxs("div",{className:"glass-effect p-3 rounded-lg text-center",children:[r.jsx("div",{className:"text-xs text-gray-400",children:"УДАРОВ ТОКОМ"}),r.jsx("div",{className:"text-lg font-bold text-red-400",children:t.shockedClicks})]}),r.jsxs("div",{className:"glass-effect p-3 rounded-lg text-center",children:[r.jsx("div",{className:"text-xs text-gray-400",children:"ВСЕГО КЛИКОВ"}),r.jsx("div",{className:"text-lg font-bold text-blue-400",children:t.totalClicks})]})]}),r.jsx("div",{className:"mt-3 text-center",children:r.jsx("div",{className:"text-sm text-gray-300",children:"💡 Удача рассчитывается как процент успешных нажатий"})})]}),r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{children:[r.jsx("h4",{className:"text-lg font-bold text-accent-blue mb-3",children:"📈 Система опыта и уровней"}),r.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[r.jsxs("div",{className:"glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-green-400 font-bold",children:"🟢 Безопасное нажатие:"}),r.jsx("div",{className:"text-sm text-gray-300",children:"+10 опыта"})]}),r.jsxs("div",{className:"glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-yellow-400 font-bold",children:"🟡 Рискованное (2x+):"}),r.jsx("div",{className:"text-sm text-gray-300",children:"+15 опыта"})]}),r.jsxs("div",{className:"glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-red-400 font-bold",children:"🔴 Экстремальное (3x+):"}),r.jsx("div",{className:"text-sm text-gray-300",children:"+25 опыта"})]}),r.jsxs("div",{className:"glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-orange-400 font-bold",children:"💥 Поражение током:"}),r.jsx("div",{className:"text-sm text-gray-300",children:"+5 опыта"})]})]}),r.jsxs("div",{className:"mt-3 text-center",children:[r.jsx("div",{className:"text-sm text-yellow-400 font-semibold",children:"🏆 За повышение уровня вы получаете бонусные вольты!"}),r.jsx("div",{className:"text-xs text-gray-400 mt-1",children:"Уровень 2: +50⚡ • Уровень 5: +150⚡ • Уровень 10: +500⚡"}),r.jsx("div",{className:"text-xs text-blue-300 mt-2",children:"🎨 Изображение розетки меняется каждые 5 уровней!"})]})]}),r.jsxs("div",{children:[r.jsx("h4",{className:"text-lg font-bold text-accent-blue mb-3",children:"⚡ Базовые очки за нажатие"}),r.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[r.jsxs("div",{className:"glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-green-400 font-bold",children:"🟢 Безопасное нажатие:"}),r.jsx("div",{className:"text-sm text-gray-300",children:"+10⚡ (базовые очки)"})]}),r.jsxs("div",{className:"glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-red-400 font-bold",children:"💥 Поражение током:"}),r.jsx("div",{className:"text-sm text-gray-300",children:"-8⚡ до -25⚡ (случайно)"})]})]})]}),r.jsxs("div",{children:[r.jsx("h4",{className:"text-lg font-bold text-accent-blue mb-3",children:"🎯 Множители за риск"}),r.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[r.jsxs("div",{className:"glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-green-400 font-bold",children:"🟢 Лёгкий (15% риск):"}),r.jsx("div",{className:"text-sm text-gray-300",children:"×1.0 (базовые очки)"})]}),r.jsxs("div",{className:"glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-yellow-400 font-bold",children:"🟡 Средний (25% риск):"}),r.jsx("div",{className:"text-sm text-gray-300",children:"×1.5 множитель"})]}),r.jsxs("div",{className:"glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-orange-400 font-bold",children:"🟠 Сложный (35% риск):"}),r.jsx("div",{className:"text-sm text-gray-300",children:"×2.0 множитель"})]}),r.jsxs("div",{className:"glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-red-400 font-bold",children:"🔴 Экстрим (50% риск):"}),r.jsx("div",{className:"text-sm text-gray-300",children:"×3.0 множитель"})]})]})]}),r.jsxs("div",{children:[r.jsx("h4",{className:"text-lg font-bold text-accent-blue mb-3",children:"🔥 Бонусы за серии"}),r.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[r.jsxs("div",{className:"glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-gray-400 font-bold",children:"0-4 нажатий:"}),r.jsx("div",{className:"text-sm text-gray-300",children:"×1.0 (без бонуса)"})]}),r.jsxs("div",{className:"glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-yellow-400 font-bold",children:"5+ нажатий:"}),r.jsx("div",{className:"text-sm text-gray-300",children:"×1.2 бонус"})]}),r.jsxs("div",{className:"glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-orange-400 font-bold",children:"10+ нажатий:"}),r.jsx("div",{className:"text-sm text-gray-300",children:"×1.5 бонус"})]}),r.jsxs("div",{className:"glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-red-400 font-bold",children:"25+ нажатий:"}),r.jsx("div",{className:"text-sm text-gray-300",children:"×2.0 бонус"})]}),r.jsxs("div",{className:"glass-effect p-3 rounded-lg",children:[r.jsx("div",{className:"text-purple-400 font-bold",children:"50+ нажатий:"}),r.jsx("div",{className:"text-sm text-gray-300",children:"×3.0 бонус"})]})]})]}),r.jsxs("div",{children:[r.jsx("h4",{className:"text-lg font-bold text-accent-blue mb-3",children:"🧮 Формула расчёта"}),r.jsx("div",{className:"glass-effect p-4 rounded-lg bg-gradient-to-r from-blue-500/10 to-purple-500/10",children:r.jsxs("div",{className:"text-center text-lg font-mono",children:[r.jsx("span",{className:"text-white",children:"Итоговые очки"})," =",r.jsx("span",{className:"text-green-400",children:" 10⚡"})," ×",r.jsx("span",{className:"text-orange-400",children:" Риск"})," ×",r.jsx("span",{className:"text-yellow-400",children:" Серия"})]})})]}),r.jsxs("div",{children:[r.jsx("h4",{className:"text-lg font-bold text-accent-blue mb-3",children:"💡 Примеры расчётов"}),r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{className:"bg-black/30 p-3 rounded-lg",children:[r.jsx("div",{className:"text-green-400 font-bold",children:"🟢 Безопасная игра:"}),r.jsxs("div",{className:"text-sm text-gray-300",children:["10⚡ × 1.0 (низкий риск) × 1.2 (5+ серия) = ",r.jsx("span",{className:"text-white font-bold",children:"12⚡"})]})]}),r.jsxs("div",{className:"bg-black/30 p-3 rounded-lg",children:[r.jsx("div",{className:"text-orange-400 font-bold",children:"🟠 Рискованная игра:"}),r.jsxs("div",{className:"text-sm text-gray-300",children:["10⚡ × 2.0 (высокий риск) × 1.5 (10+ серия) = ",r.jsx("span",{className:"text-white font-bold",children:"30⚡"})]})]}),r.jsxs("div",{className:"bg-black/30 p-3 rounded-lg",children:[r.jsx("div",{className:"text-red-400 font-bold",children:"🔴 Экстремальная игра:"}),r.jsxs("div",{className:"text-sm text-gray-300",children:["10⚡ × 3.0 (экстрим риск) × 2.0 (25+ серия) = ",r.jsx("span",{className:"text-white font-bold",children:"60⚡"})]})]}),r.jsxs("div",{className:"bg-black/30 p-3 rounded-lg",children:[r.jsx("div",{className:"text-red-400 font-bold",children:"💥 Поражение током:"}),r.jsxs("div",{className:"text-sm text-gray-300",children:["Случайно от 8⚡ до 25⚡ + ",r.jsx("span",{className:"text-red-400",children:"серия сбрасывается"})]})]})]})]})]}),r.jsx("div",{className:"mt-6 text-center text-xs text-gray-400",children:"💡 Совет: Балансируйте между риском и безопасностью для максимального заработка!"})]})})},hs=()=>{const{player:i,getCurrentLevelInfo:t}=L(),{currentLevel:e,progressInfo:s}=t(),n=rs(i.experience),a=X(e.level),o=s.nextLevel?X(s.nextLevel.level):null,l=o&&o!==a;return r.jsxs("div",{className:"glass-effect p-4 rounded-xl space-y-3",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex items-center space-x-3",children:[r.jsx("img",{src:X(e.level),alt:`Розетка уровня ${e.level}`,className:"w-12 h-12 rounded-lg border-2 border-primary-orange shadow-lg"}),r.jsxs("div",{children:[r.jsx("div",{className:"text-xs text-gray-400 uppercase tracking-wide",children:"Уровень"}),r.jsxs("div",{className:"flex items-baseline space-x-2",children:[r.jsx("span",{className:"text-2xl font-bold text-primary-orange",children:e.level}),r.jsx("span",{className:"text-sm text-gray-300",children:e.title})]})]})]}),r.jsxs("div",{className:"text-right",children:[r.jsx("div",{className:"text-xs text-gray-400",children:"Опыт"}),r.jsx("div",{className:"text-lg font-bold text-accent-blue",children:i.experience.toLocaleString()})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex justify-between text-xs text-gray-400",children:[r.jsx("span",{children:s.current}),r.jsx("span",{children:s.nextLevel?`${s.remaining} до ${s.nextLevel.level} уровня`:"Максимум"}),r.jsx("span",{children:s.required})]}),r.jsxs("div",{className:"relative w-full bg-gray-700 rounded-full h-2 overflow-hidden",children:[r.jsx(x.div,{className:"h-full bg-gradient-to-r from-accent-blue to-primary-orange rounded-full",initial:{width:0},animate:{width:`${n}%`},transition:{duration:.8,ease:"easeOut"}}),n>0&&r.jsx(x.div,{className:"absolute top-0 right-0 w-1 h-full bg-white opacity-80",style:{right:`${100-n}%`},animate:{opacity:[.8,.3,.8]},transition:{repeat:1/0,duration:1.5}})]})]}),r.jsx("div",{className:"text-xs text-gray-400 italic text-center",children:e.description}),s.nextLevel&&r.jsxs("div",{className:"text-center pt-2 border-t border-gray-600",children:[r.jsx("div",{className:"text-xs text-gray-500",children:"Следующий уровень"}),r.jsxs("div",{className:"text-sm",children:[r.jsx("span",{className:"text-accent-lime font-semibold",children:s.nextLevel.title}),r.jsx("span",{className:"text-gray-400",children:" • "}),r.jsxs("span",{className:"text-yellow-400",children:["+",s.nextLevel.voltsReward,"⚡"]})]}),l&&r.jsxs("div",{className:"flex items-center justify-center space-x-2 mt-2",children:[r.jsx("span",{className:"text-xs text-blue-300",children:"🎨 Новая розетка:"}),r.jsx("img",{src:o,alt:`Розетка уровня ${s.nextLevel.level}`,className:"w-6 h-6 rounded border border-blue-400 shadow-sm"})]})]})]})},ms=({isVisible:i,onClose:t})=>{const[e,s]=h.useState(!0),[n,a]=h.useState(null);h.useEffect(()=>{const c=localStorage.getItem("hapticEnabled");if(c!==null){const d=JSON.parse(c);s(d),A.setEnabled(d)}},[]);const o=()=>{const c=!e;s(c),A.setEnabled(c),localStorage.setItem("hapticEnabled",JSON.stringify(c)),c&&A.test()},l=(c,d)=>{a(c),d(),setTimeout(()=>a(null),500)};return i?r.jsx(x.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4",onClick:t,children:r.jsxs(x.div,{initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.8,opacity:0},className:"bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 max-w-sm w-full border border-primary-orange/20",onClick:c=>c.stopPropagation(),children:[r.jsxs("div",{className:"flex justify-between items-center mb-6",children:[r.jsx("h2",{className:"text-2xl font-bold text-primary-orange",children:"Вибрация"}),r.jsx("button",{onClick:t,className:"text-gray-400 hover:text-white text-2xl",children:"×"})]}),r.jsx("div",{className:"mb-6",children:r.jsxs("div",{className:"flex justify-between items-center p-4 bg-gray-800/50 rounded-xl",children:[r.jsxs("div",{children:[r.jsx("h3",{className:"text-lg font-semibold text-white",children:"Включить вибрацию"}),r.jsx("p",{className:"text-sm text-gray-400",children:A.isAvailable()?"Поддерживается вашим устройством":"Недоступно на вашем устройстве"})]}),r.jsx(x.button,{onClick:o,className:`w-12 h-6 rounded-full p-1 transition-colors ${e?"bg-primary-orange":"bg-gray-600"}`,whileTap:{scale:.95},children:r.jsx(x.div,{className:"w-4 h-4 bg-white rounded-full",animate:{x:e?24:0},transition:{type:"spring",stiffness:500,damping:30}})})]})}),e&&r.jsxs("div",{className:"space-y-3",children:[r.jsx("h3",{className:"text-lg font-semibold text-white mb-3",children:"Тест вибрации"}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("h4",{className:"text-sm font-medium text-gray-300",children:"Игровые события"}),r.jsx(x.button,{onClick:()=>l("press",()=>A.outletPress()),className:`w-full p-3 rounded-lg border transition-colors ${n==="press"?"bg-blue-500/30 border-blue-400 text-blue-200":"bg-gray-700/50 border-gray-600 text-gray-300 hover:bg-gray-600/50"}`,whileHover:{scale:1.02},whileTap:{scale:.98},children:"🔌 Нажатие на розетку"}),r.jsx(x.button,{onClick:()=>l("success",()=>A.survivalSuccess()),className:`w-full p-3 rounded-lg border transition-colors ${n==="success"?"bg-green-500/30 border-green-400 text-green-200":"bg-gray-700/50 border-gray-600 text-gray-300 hover:bg-gray-600/50"}`,whileHover:{scale:1.02},whileTap:{scale:.98},children:"✅ Успешное выживание"}),r.jsx(x.button,{onClick:()=>l("shock",()=>A.electricShock()),className:`w-full p-3 rounded-lg border transition-colors ${n==="shock"?"bg-red-500/30 border-red-400 text-red-200":"bg-gray-700/50 border-gray-600 text-gray-300 hover:bg-gray-600/50"}`,whileHover:{scale:1.02},whileTap:{scale:.98},children:"⚡ Удар током"}),r.jsx(x.button,{onClick:()=>l("levelup",()=>A.levelUp()),className:`w-full p-3 rounded-lg border transition-colors ${n==="levelup"?"bg-yellow-500/30 border-yellow-400 text-yellow-200":"bg-gray-700/50 border-gray-600 text-gray-300 hover:bg-gray-600/50"}`,whileHover:{scale:1.02},whileTap:{scale:.98},children:"🆙 Повышение уровня"})]}),r.jsxs("div",{className:"space-y-2 mt-4",children:[r.jsx("h4",{className:"text-sm font-medium text-gray-300",children:"Интенсивность"}),r.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[r.jsx(x.button,{onClick:()=>l("light",()=>A.light()),className:`p-2 rounded-lg border text-sm transition-colors ${n==="light"?"bg-gray-500/30 border-gray-400 text-gray-200":"bg-gray-700/50 border-gray-600 text-gray-300 hover:bg-gray-600/50"}`,whileHover:{scale:1.02},whileTap:{scale:.98},children:"Легкая"}),r.jsx(x.button,{onClick:()=>l("medium",()=>A.medium()),className:`p-2 rounded-lg border text-sm transition-colors ${n==="medium"?"bg-gray-500/30 border-gray-400 text-gray-200":"bg-gray-700/50 border-gray-600 text-gray-300 hover:bg-gray-600/50"}`,whileHover:{scale:1.02},whileTap:{scale:.98},children:"Средняя"}),r.jsx(x.button,{onClick:()=>l("heavy",()=>A.heavy()),className:`p-2 rounded-lg border text-sm transition-colors ${n==="heavy"?"bg-gray-500/30 border-gray-400 text-gray-200":"bg-gray-700/50 border-gray-600 text-gray-300 hover:bg-gray-600/50"}`,whileHover:{scale:1.02},whileTap:{scale:.98},children:"Сильная"}),r.jsx(x.button,{onClick:()=>l("rigid",()=>A.rigid()),className:`p-2 rounded-lg border text-sm transition-colors ${n==="rigid"?"bg-gray-500/30 border-gray-400 text-gray-200":"bg-gray-700/50 border-gray-600 text-gray-300 hover:bg-gray-600/50"}`,whileHover:{scale:1.02},whileTap:{scale:.98},children:"Резкая"})]})]})]}),r.jsx("div",{className:"mt-6 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg",children:r.jsx("p",{className:"text-xs text-blue-300 text-center",children:"💡 Вибрация доступна только в Telegram Mini App на поддерживаемых устройствах"})})]})}):null},ye={BASE_URL:"/tigerrosette/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_API_URL:"http://localhost:3001/api",VITE_APP_URL:"https://orspiritus.github.io/tigerrosette/",VITE_DEBUG_API:"true",VITE_DEBUG_MODE:"false",VITE_DEBUG_OFFLINE:"false",VITE_DEV_MODE:"true",VITE_ENABLE_HAPTICS:"true",VITE_NODE_ENV:"development",VITE_TELEGRAM_BOT_TOKEN:"7735995745:AAGpHgZamUACtEBYkYeqH0oiBHEruaRaUe4",VITE_TELEGRAM_BOT_USERNAME:"tigerrozetka_bot"},ct=h.createContext({webApp:null,user:null,isInTelegram:!1,platform:"unknown",colorScheme:"dark",token:null,isAuthenticating:!1,isAuthenticated:!1,authError:null,authenticate:async()=>{},logout:()=>{}}),Ce=()=>h.useContext(ct),fs=({children:i})=>{const[t,e]=h.useState(null),[s,n]=h.useState(null),[a,o]=h.useState(!1),[l,c]=h.useState("unknown"),[d,m]=h.useState("dark"),[p,u]=h.useState(()=>typeof sessionStorage<"u"?sessionStorage.getItem("tg_token"):null),[g,f]=h.useState(!1),[N,b]=h.useState(null),j=h.useCallback(T=>{try{L.setState(M=>({player:{...M.player,telegramId:T.id.toString(),displayName:T.username||T.first_name||"Player"}}))}catch(M){console.warn("Failed to sync telegram user to game store",M)}},[]),y=h.useCallback(async T=>{var M;if((M=T==null?void 0:T.initDataUnsafe)!=null&&M.user&&!p){f(!0),b(null);try{const E=(ye==null?void 0:ye.VITE_BACKEND_URL)||"http://localhost:3001",k={user:T.initDataUnsafe.user,auth_date:T.initDataUnsafe.auth_date,hash:T.initDataUnsafe.hash},w=await fetch(`${E}/auth/telegram`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)});if(!w.ok)throw new Error(`Auth failed: ${w.status}`);const v=await w.json();v.token&&(u(v.token),typeof sessionStorage<"u"&&sessionStorage.setItem("tg_token",v.token),j(T.initDataUnsafe.user))}catch(E){console.error("Telegram auth error",E),b(E.message||"Auth error")}finally{f(!1)}}},[p,j]),C=h.useCallback(()=>{u(null),typeof sessionStorage<"u"&&sessionStorage.removeItem("tg_token")},[]),P=h.useCallback(async()=>{t&&await y(t)},[t,y]);h.useEffect(()=>{var T,M,E;if(typeof window<"u"&&((T=window.Telegram)!=null&&T.WebApp)){const k=window.Telegram.WebApp;k.ready(),k.expand(),e(k),o(!0),c(k.platform||"unknown"),m(k.colorScheme||"dark"),(M=k.initDataUnsafe)!=null&&M.user&&(n(k.initDataUnsafe.user),j(k.initDataUnsafe.user),y(k)),k.setHeaderColor("#000000"),k.setBackgroundColor("#000000"),k.disableClosingConfirmation(),console.log("[Telegram] Initialized",{platform:k.platform,colorScheme:k.colorScheme,user:(E=k.initDataUnsafe)==null?void 0:E.user,version:k.version});return}if(typeof window<"u"&&new URLSearchParams(window.location.search).get("tg_debug")==="1"){const w={id:999999,first_name:"Debug",last_name:"User",username:"debug_player"};n(w),j(w),console.log("[Telegram] Debug mock user active")}},[y,j]);const S={webApp:t,user:s,isInTelegram:a,platform:l,colorScheme:d,token:p,isAuthenticating:g,isAuthenticated:!!p,authError:N,authenticate:P,logout:C};return r.jsx(ct.Provider,{value:S,children:i})},ps=()=>{var n;const{user:i,isInTelegram:t,platform:e,colorScheme:s}=Ce();return t?r.jsx(x.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"bg-gradient-to-r from-blue-900/20 to-purple-900/20 border border-blue-500/30 rounded-lg p-3 mb-4",children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex items-center space-x-3",children:[i!=null&&i.photo_url?r.jsx("img",{src:i.photo_url,alt:"Avatar",className:"w-8 h-8 rounded-full border border-blue-400/50"}):r.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center",children:r.jsx("span",{className:"text-white text-sm font-bold",children:((n=i==null?void 0:i.first_name)==null?void 0:n[0])||"?"})}),r.jsxs("div",{children:[r.jsxs("div",{className:"text-sm font-medium text-white",children:[i==null?void 0:i.first_name," ",i==null?void 0:i.last_name,(i==null?void 0:i.is_premium)&&r.jsx("span",{className:"ml-1 text-yellow-400",children:"⭐"})]}),r.jsxs("div",{className:"text-xs text-gray-400",children:["@",(i==null?void 0:i.username)||"no_username"," • ",e]})]})]}),r.jsx("div",{className:"text-right",children:r.jsxs("div",{className:`text-xs px-2 py-1 rounded-full border ${s==="dark"?"bg-gray-800 border-gray-600 text-gray-300":"bg-gray-200 border-gray-400 text-gray-700"}`,children:[s==="dark"?"🌙":"☀️"," ",s]})})]})}):r.jsx("div",{className:"text-xs text-gray-500 text-center p-2",children:"💻 Веб-версия (не в Telegram)"})};function Re(){const[i,t]=h.useState({data:null,loading:!1,error:null}),[e,s]=h.useState({data:null,loading:!1,error:null}),[n,a]=h.useState({data:null,loading:!1,error:null}),o=h.useCallback(async m=>{t({data:null,loading:!0,error:null});try{const p=await q.submitScore(m);return p.error?(t({data:null,loading:!1,error:p.error}),{success:!1,error:p.error}):(t({data:p.data,loading:!1,error:null}),{success:!0,data:p.data})}catch(p){const u=p instanceof Error?p.message:"Unknown error";return t({data:null,loading:!1,error:u}),{success:!1,error:u}}},[]),l=h.useCallback(async()=>{s({data:null,loading:!0,error:null});try{const m=await q.getUserStats();return m.error?(s({data:null,loading:!1,error:m.error}),{success:!1,error:m.error}):(s({data:m.data,loading:!1,error:null}),{success:!0,data:m.data})}catch(m){const p=m instanceof Error?m.message:"Unknown error";return s({data:null,loading:!1,error:p}),{success:!1,error:p}}},[]),c=h.useCallback(async(m="level",p=10)=>{a({data:null,loading:!0,error:null});try{const u=await q.getLeaderboard(m,p);return u.error?(a({data:null,loading:!1,error:u.error}),{success:!1,error:u.error}):(a({data:u.data,loading:!1,error:null}),{success:!0,data:u.data})}catch(u){const g=u instanceof Error?u.message:"Unknown error";return a({data:null,loading:!1,error:g}),{success:!1,error:g}}},[]),d=h.useCallback(async()=>{try{const m=await q.refillEnergy();return m.error?{success:!1,error:m.error}:{success:!0,data:m.data}}catch(m){return{success:!1,error:m instanceof Error?m.message:"Unknown error"}}},[]);return{submitScore:o,getUserStats:l,getLeaderboard:c,refillEnergy:d,submitState:i,statsState:e,leaderboardState:n,isAuthenticated:q.isAuthenticated()}}function xs(){const[i,t]=h.useState(navigator.onLine);return h.useState(()=>{const e=()=>t(!0),s=()=>t(!1);return window.addEventListener("online",e),window.addEventListener("offline",s),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",s)}}),{isOnline:i}}const gs=()=>{const{player:i,gameState:t,startSingleMode:e,startMultiplayerMode:s,addExperience:n,compensateExperience:a,loadStatsFromServer:o}=L(),{isAuthenticated:l}=Re(),[c,d]=h.useState(!1),[m,p]=h.useState(!1),[u,g]=h.useState(!1);h.useEffect(()=>{(async()=>{if(l&&!u){g(!0);try{const y=await o();y.success?console.log("✅ Статистика загружена с сервера"):console.warn("⚠️ Не удалось загрузить статистику с сервера:",y.error)}catch(y){console.error("❌ Ошибка при загрузке статистики:",y)}finally{g(!1)}}})()},[l,o,u]);const f=()=>{n(100)},N=()=>{const j=a();j>0?console.log(`Compensated ${j} experience points`):console.log("No experience compensation needed")},b=j=>{A.medium(),e(j)};return r.jsxs("div",{className:"min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-background-dark to-background-darker",children:[r.jsxs(x.div,{initial:{opacity:0,y:-50},animate:{opacity:1,y:0},transition:{duration:.8},className:"text-center mb-8",children:[r.jsx("h1",{className:"text-6xl font-bold text-primary-orange tiger-stripes bg-clip-text text-transparent mb-4",children:"ТИГР"}),r.jsx("h2",{className:"text-4xl font-bold text-accent-blue mb-2",children:"РОЗЕТКА"}),r.jsx("p",{className:"text-lg text-gray-300",children:"Telegram Mini App Game"})]}),r.jsx(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.2},className:"mb-6",children:r.jsx(hs,{})}),l&&u&&r.jsxs(x.div,{initial:{opacity:0},animate:{opacity:1},className:"mb-4 text-center text-blue-400 text-sm",children:[r.jsx("span",{className:"inline-block animate-spin mr-2",children:"⏳"}),"Синхронизация с сервером..."]}),!l&&r.jsx(x.div,{initial:{opacity:0},animate:{opacity:1},className:"mb-4 text-center text-yellow-400 text-sm",children:"⚠️ Игра в автономном режиме"}),r.jsx(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.25},className:"mb-4 w-full max-w-md",children:r.jsx(ps,{})}),r.jsxs(x.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{duration:.5,delay:.3},className:"glass-effect p-6 mb-8 text-center",children:[r.jsxs("div",{className:"text-sm text-gray-300 mb-2",children:["Добро пожаловать, ",i.name,"!"]}),r.jsxs("div",{className:"flex justify-center space-x-6",children:[r.jsxs("div",{children:[r.jsx("div",{className:"text-xs text-gray-400",children:"ВОЛЬТЫ"}),r.jsxs("div",{className:"text-xl font-bold text-primary-orange",children:[i.volts,"⚡"]})]}),r.jsxs("div",{children:[r.jsx("div",{className:"text-xs text-gray-400",children:"УРОВЕНЬ"}),r.jsx("div",{className:"text-xl font-bold text-accent-blue",children:i.level})]}),r.jsxs("div",{children:[r.jsx("div",{className:"text-xs text-gray-400",children:"ВСЕГО НАЖАТИЙ"}),r.jsx("div",{className:"text-xl font-bold text-accent-lime",children:i.totalClicks})]})]})]}),r.jsxs(x.div,{initial:{opacity:0,y:50},animate:{opacity:1,y:0},transition:{duration:.6,delay:.5},className:"w-full max-w-md space-y-4",children:[r.jsx("h3",{className:"text-2xl font-bold text-center text-white mb-6",children:"⚡ Одиночный режим"}),r.jsx("p",{className:"text-center text-gray-300 text-sm mb-4",children:"Выберите сложность игры против ИИ электрика"}),r.jsx(x.button,{onClick:()=>b("easy"),className:"w-full glass-effect p-4 rounded-xl hover:bg-green-500/20 transition-colors",whileHover:{scale:1.02,x:10},whileTap:{scale:.98},children:r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("div",{className:"text-left",children:[r.jsx("div",{className:"text-lg font-bold text-green-400",children:"ЛЁГКИЙ"}),r.jsx("div",{className:"text-sm text-gray-300",children:"15% шанс разряда • 2 сек предупреждение"})]}),r.jsx("div",{className:"text-2xl",children:"🟢"})]})}),r.jsx(x.button,{onClick:()=>b("medium"),className:"w-full glass-effect p-4 rounded-xl hover:bg-yellow-500/20 transition-colors",whileHover:{scale:1.02,x:10},whileTap:{scale:.98},children:r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("div",{className:"text-left",children:[r.jsx("div",{className:"text-lg font-bold text-yellow-400",children:"СРЕДНИЙ"}),r.jsx("div",{className:"text-sm text-gray-300",children:"25% шанс разряда • 1.5 сек предупреждение"})]}),r.jsx("div",{className:"text-2xl",children:"🟡"})]})}),r.jsx(x.button,{onClick:()=>b("hard"),className:"w-full glass-effect p-4 rounded-xl hover:bg-orange-500/20 transition-colors",whileHover:{scale:1.02,x:10},whileTap:{scale:.98},children:r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("div",{className:"text-left",children:[r.jsx("div",{className:"text-lg font-bold text-orange-400",children:"СЛОЖНЫЙ"}),r.jsx("div",{className:"text-sm text-gray-300",children:"35% шанс разряда • 1 сек предупреждение"})]}),r.jsx("div",{className:"text-2xl",children:"🟠"})]})}),r.jsx(x.button,{onClick:()=>b("extreme"),className:"w-full glass-effect p-4 rounded-xl hover:bg-red-500/20 transition-colors",whileHover:{scale:1.02,x:10},whileTap:{scale:.98},children:r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("div",{className:"text-left",children:[r.jsx("div",{className:"text-lg font-bold text-red-400",children:"ЭКСТРИМ"}),r.jsx("div",{className:"text-sm text-gray-300",children:"50% шанс разряда • 0.5 сек предупреждение"})]}),r.jsx("div",{className:"text-2xl",children:"🔴"})]})}),r.jsxs(x.div,{className:"w-full border-t border-white/10 pt-6 mt-6",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.7},children:[r.jsx("h4",{className:"text-xl font-bold text-center text-white mb-4",children:"🎮 Многопользовательский режим"}),r.jsx(x.button,{onClick:()=>{A.medium(),s("duel")},className:"w-full glass-effect p-4 rounded-xl hover:bg-purple-500/20 transition-colors border border-purple-400/30",whileHover:{scale:1.02,x:10},whileTap:{scale:.98},children:r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("div",{className:"text-left",children:[r.jsx("div",{className:"text-lg font-bold text-purple-400",children:"ДУЭЛЬ"}),r.jsx("div",{className:"text-sm text-gray-300",children:"Соревнование 1v1 • Real-time бой"})]}),r.jsx("div",{className:"text-2xl",children:"⚔️"})]})}),r.jsx(x.button,{onClick:()=>{A.medium(),s("tournament")},className:"w-full glass-effect p-4 rounded-xl hover:bg-blue-500/20 transition-colors border border-blue-400/30 mt-3",whileHover:{scale:1.02,x:10},whileTap:{scale:.98},children:r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("div",{className:"text-left",children:[r.jsx("div",{className:"text-lg font-bold text-blue-400",children:"ТУРНИР"}),r.jsx("div",{className:"text-sm text-gray-300",children:"До 8 игроков • Браккет система"})]}),r.jsx("div",{className:"text-2xl",children:"🏆"})]})}),r.jsx(x.button,{onClick:()=>{A.medium(),s("coop")},className:"w-full glass-effect p-4 rounded-xl hover:bg-green-500/20 transition-colors border border-green-400/30 mt-3",whileHover:{scale:1.02,x:10},whileTap:{scale:.98},children:r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("div",{className:"text-left",children:[r.jsx("div",{className:"text-lg font-bold text-green-400",children:"КООП"}),r.jsx("div",{className:"text-sm text-gray-300",children:"Командная игра • Против ИИ"})]}),r.jsx("div",{className:"text-2xl",children:"🤝"})]})})]}),r.jsx(x.button,{onClick:()=>{A.light(),d(!0)},className:"w-full glass-effect p-3 rounded-xl hover:bg-blue-500/20 transition-colors border border-blue-400/30",whileHover:{scale:1.02},whileTap:{scale:.98},children:r.jsxs("div",{className:"flex justify-center items-center space-x-2",children:[r.jsx("span",{className:"text-lg",children:"📊"}),r.jsx("span",{className:"text-lg font-semibold text-blue-400",children:"Очки и уровни"})]})}),r.jsx(x.button,{onClick:()=>{A.light(),p(!0)},className:"w-full glass-effect p-3 rounded-xl hover:bg-purple-500/20 transition-colors border border-purple-400/30",whileHover:{scale:1.02},whileTap:{scale:.98},children:r.jsxs("div",{className:"flex justify-center items-center space-x-2",children:[r.jsx("span",{className:"text-lg",children:"📳"}),r.jsx("span",{className:"text-lg font-semibold text-purple-400",children:"Вибрация"})]})})]}),c&&r.jsx(us,{onClose:()=>d(!1)}),m&&r.jsx(ms,{isVisible:m,onClose:()=>p(!1)}),r.jsxs(x.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.5,delay:1},className:"mt-8 text-center text-gray-400 text-sm space-y-2",children:[r.jsx("p",{children:"⚡ Играй осторожно! ⚡"}),r.jsx("p",{className:"mt-2",children:"v1.1.0 | Single Mode + Multiplayer Preview"}),r.jsxs("div",{className:"flex gap-2 justify-center",children:[r.jsx("button",{onClick:()=>{A.light(),f()},className:"px-3 py-1 text-xs bg-purple-600/30 hover:bg-purple-600/50 text-purple-300 rounded transition-colors",children:"🔧 +100 опыта (тест)"}),r.jsxs("button",{onClick:()=>{A.light(),N()},className:"px-3 py-1 text-xs bg-green-600/30 hover:bg-green-600/50 text-green-300 rounded transition-colors",children:["⚡ Восстановить опыт (",t.score," очков)"]})]})]})]})};class ys{constructor(){B(this,"audioContext",null);B(this,"sounds",new Map);B(this,"volume",.7);B(this,"enabled",!0);this.init()}async init(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(t){console.warn("Web Audio API not supported:",t)}}async loadSound(t,e){if(this.audioContext)try{const n=await(await fetch(e)).arrayBuffer(),a=await this.audioContext.decodeAudioData(n);this.sounds.set(t,a)}catch(s){console.warn(`Failed to load sound ${t}:`,s)}}playSound(t,e=1){if(!this.enabled||!this.audioContext)return;const s=this.sounds.get(t);if(!s)return;const n=this.audioContext.createBufferSource(),a=this.audioContext.createGain();n.buffer=s,a.gain.value=this.volume*e,n.connect(a),a.connect(this.audioContext.destination),n.start()}generateSparkSound(t){if(!this.enabled||!this.audioContext)return;const e={low:.1,medium:.2,high:.3,extreme:.5}[t],s={low:2e3,medium:3e3,high:4e3,extreme:5e3}[t],n=this.audioContext.sampleRate*e,a=this.audioContext.createBuffer(1,n,this.audioContext.sampleRate),o=a.getChannelData(0);for(let d=0;d<n;d++){const m=d/this.audioContext.sampleRate,p=Math.exp(-m*10),u=(Math.random()*2-1)*p,g=Math.sin(2*Math.PI*s*m*(1+Math.random()*.5));o[d]=u*g*.3}const l=this.audioContext.createBufferSource(),c=this.audioContext.createGain();l.buffer=a,c.gain.value=this.volume*(t==="extreme"?.8:.5),l.connect(c),c.connect(this.audioContext.destination),l.start()}generateShockSound(){if(!this.enabled||!this.audioContext)return;const e=this.audioContext.sampleRate*.8,s=this.audioContext.createBuffer(1,e,this.audioContext.sampleRate),n=s.getChannelData(0);for(let l=0;l<e;l++){const c=l/this.audioContext.sampleRate,d=Math.exp(-c*3),m=Math.sin(2*Math.PI*100*c),p=Math.sin(2*Math.PI*800*c)*.5,u=(Math.random()*2-1)*.3;n[l]=(m+p+u)*d*.6}const a=this.audioContext.createBufferSource(),o=this.audioContext.createGain();a.buffer=s,o.gain.value=this.volume,a.connect(o),o.connect(this.audioContext.destination),a.start()}generateWarningSound(){if(!this.enabled||!this.audioContext)return;const t=.3,e=this.audioContext.sampleRate*t,s=this.audioContext.createBuffer(1,e,this.audioContext.sampleRate),n=s.getChannelData(0);for(let l=0;l<e;l++){const c=l/this.audioContext.sampleRate,d=1e3+Math.sin(c*20)*200,m=Math.sin(Math.PI*c/t);n[l]=Math.sin(2*Math.PI*d*c)*m*.4}const a=this.audioContext.createBufferSource(),o=this.audioContext.createGain();a.buffer=s,o.gain.value=this.volume*.6,a.connect(o),o.connect(this.audioContext.destination),a.start()}async playTigerSound(){if(this.enabled)try{const t=new Audio("/tigerrosette/Media/sound/re_-tigra.mp3");t.volume=this.volume*.8,t.preload="auto",await t.play(),console.log("SoundManager: Tiger sound played successfully")}catch(t){console.warn("Failed to play tiger sound:",t)}}setVolume(t){this.volume=Math.max(0,Math.min(1,t))}setEnabled(t){this.enabled=t}getVolume(){return this.volume}isEnabled(){return this.enabled}}const ie=new ys,vs=({score:i,reason:t,isVisible:e,position:s,type:n,experience:a=0})=>{const o=()=>{switch(n){case"success":return i>=30?"text-yellow-300":i>=20?"text-green-300":"text-blue-300";case"shock":return"text-red-300";case"bonus":return"text-purple-300";default:return"text-white"}},l=()=>{switch(n){case"success":return i>=30?"🔥":i>=20?"⚡":"✨";case"shock":return"💥";case"bonus":return"🎉";default:return"⚡"}};return r.jsx(V,{children:e&&r.jsx(x.div,{className:`absolute pointer-events-none z-50 ${o()}`,initial:{opacity:0,scale:.5,x:s.x,y:s.y},animate:{opacity:[0,1,1,0],scale:[.5,1.2,1,.8],y:s.y-80,x:s.x+(Math.random()-.5)*40},transition:{duration:2,ease:"easeOut"},children:r.jsx("div",{className:"bg-black/80 backdrop-blur-sm rounded-lg px-3 py-2 border border-current",children:r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx("span",{className:"text-lg",children:l()}),r.jsxs("div",{children:[r.jsxs("div",{className:"font-bold text-lg",children:["+",i,"⚡"]}),a>0&&r.jsxs("div",{className:"text-xs text-blue-300",children:["+",a," опыта"]}),r.jsx("div",{className:"text-xs opacity-80",children:t})]})]})})})})},bs=({isActive:i,intensity:t="medium",onComplete:e})=>{const[s,n]=h.useState([]);h.useEffect(()=>{i?a():n([])},[i,t]);const a=()=>{const o={low:6,medium:12,high:18,extreme:25}[t],l=["#3B82F6","#EF4444","#FFFFFF","#FBBF24","#8B5CF6"],c=[];for(let d=0;d<o;d++)c.push({id:d,x:Math.random()*100,y:Math.random()*100,angle:Math.random()*360,length:20+Math.random()*60,delay:Math.random()*.3,color:l[Math.floor(Math.random()*l.length)]});n(c),setTimeout(()=>{n([]),e==null||e()},1e3)};return r.jsxs("div",{className:"absolute inset-0 pointer-events-none overflow-hidden",children:[r.jsx(V,{children:s.map(o=>r.jsxs(x.div,{className:"absolute",style:{left:`${o.x}%`,top:`${o.y}%`,transform:`rotate(${o.angle}deg)`},initial:{opacity:0,scale:0},animate:{opacity:[0,1,.7,0],scale:[0,1,.8,0],x:[0,Math.cos(o.angle*Math.PI/180)*o.length],y:[0,Math.sin(o.angle*Math.PI/180)*o.length]},transition:{duration:.6,delay:o.delay,ease:"easeOut"},children:[r.jsx("div",{className:"w-1 bg-gradient-to-r opacity-90 rounded-full shadow-lg",style:{height:`${o.length}px`,backgroundColor:o.color,boxShadow:`0 0 8px ${o.color}, 0 0 16px ${o.color}40`}}),r.jsx("div",{className:"absolute top-0 left-0 w-1 blur-sm opacity-60 rounded-full",style:{height:`${o.length}px`,backgroundColor:o.color}})]},o.id))}),r.jsx(V,{children:i&&r.jsx(x.svg,{className:"absolute inset-0 w-full h-full",initial:{opacity:0},animate:{opacity:[0,1,.8,.2,.9,0]},transition:{duration:.8,times:[0,.1,.3,.5,.7,1]},children:Array.from({length:3},(o,l)=>{const c=20+Math.random()*60,d=20+Math.random()*60,m=5+Math.floor(Math.random()*5);let p=`M ${c} ${d}`,u=c,g=d;for(let f=0;f<m;f++)u+=(Math.random()-.5)*40,g+=(Math.random()-.5)*40,p+=` L ${u} ${g}`;return r.jsx(x.path,{d:p,stroke:"#FFFFFF",strokeWidth:Math.random()*2+1,fill:"none",opacity:.8,filter:"drop-shadow(0 0 4px #3B82F6)",initial:{pathLength:0},animate:{pathLength:1},transition:{duration:.3,delay:l*.1,ease:"easeOut"}},l)})})}),r.jsx(V,{children:i&&r.jsx(x.div,{className:"absolute inset-0 bg-white mix-blend-screen",initial:{opacity:0},animate:{opacity:[0,.4,.1,.3,0]},transition:{duration:.5,times:[0,.1,.3,.6,1]}})})]})},Ke="/tigerrosette/assets/electric_shock-mF2Yhpau.mp4",ws=({isActive:i,onComplete:t})=>{const e=h.useRef(null),[s,n]=h.useState({readyState:0,networkState:0,currentTime:0,error:""}),[a,o]=h.useState(!1),[l,c]=h.useState(!1);return h.useEffect(()=>{const d=e.current;if(!d)return;console.log("SimpleVideoPlayer: Effect triggered",{isActive:i});const m=()=>{var b;const N={src:d.currentSrc||d.src,readyState:d.readyState,networkState:d.networkState,error:d.error,canPlay:d.readyState>=3,currentTime:d.currentTime};console.log("SimpleVideoPlayer: Video state",N),n({readyState:d.readyState,networkState:d.networkState,currentTime:d.currentTime,error:d.error?String((b=d.error)==null?void 0:b.code):""})},p=()=>console.log("SimpleVideoPlayer: loadstart"),u=()=>{console.log("SimpleVideoPlayer: canplay"),m()},g=N=>{console.error("SimpleVideoPlayer: Video error",N.target.error),o(!1),m()},f=()=>{console.log("SimpleVideoPlayer: play event"),o(!1)};if(d.addEventListener("loadstart",p),d.addEventListener("canplay",u),d.addEventListener("error",g),d.addEventListener("play",f),m(),i){console.log("SimpleVideoPlayer: Starting video"),d.currentTime=0,d.style.display="block",d.style.opacity="1",d.style.outline="2px solid rgba(255,0,0,0.6)",ie.playTigerSound().catch(b=>{console.warn("SimpleVideoPlayer: Failed to play tiger sound:",b)}),setTimeout(()=>{m(),c(!0),d.play().then(()=>{console.log("SimpleVideoPlayer: Video started successfully"),window.__shockVideoStarted=!0}).catch(b=>{console.error("SimpleVideoPlayer: Play error (autoplay likely blocked):",b),o(!0)})},100);const N=()=>{console.log("SimpleVideoPlayer: Video ended"),d.style.display="none",t==null||t()};return d.addEventListener("ended",N),()=>{d.removeEventListener("ended",N),d.removeEventListener("loadstart",p),d.removeEventListener("canplay",u),d.removeEventListener("error",g),d.removeEventListener("play",f)}}else d.style.display="none",d.style.opacity="0",d.style.outline="none"},[i,t]),r.jsxs(r.Fragment,{children:[r.jsx("video",{ref:e,src:Ke,className:"absolute inset-0 w-full h-full object-cover rounded-2xl",style:{display:"none",opacity:0,transition:"opacity 120ms linear"},muted:!0,playsInline:!0,autoPlay:!1,preload:"auto",poster:Ke}),i&&a&&r.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-10 bg-black/40",children:r.jsx("button",{className:"px-4 py-2 bg-red-600/80 hover:bg-red-500 text-white text-xs rounded-md shadow",onClick:()=>{const d=e.current;d&&d.play().catch(m=>console.error("Manual play failed",m))},children:"▶ Воспроизвести"})}),i&&!1]})},Ns=()=>{const{player:i}=L(),[t,e]=h.useState(X(i.level)),[s,n]=h.useState(!1);return h.useEffect(()=>{const a=X(i.level);console.log(`Player level: ${i.level}, Image path: ${a}`),a!==t&&(n(!0),setTimeout(()=>{e(a),n(!1)},300))},[i.level,t]),{currentImage:t,isAnimating:s}},js=({className:i="",onShock:t})=>{const{clickOutlet:e,singleMode:s,gameState:n,player:a,updateScore:o,triggerShock:l}=L(),{currentImage:c,isAnimating:d}=Ns(),[m,p]=h.useState([]),[u,g]=h.useState(!1),[f,N]=h.useState(1),[b,j]=h.useState(!1),[y,C]=h.useState(!1),[P,S]=h.useState({visible:!1,score:0,reason:"",type:"success"}),T=h.useCallback((w,v,_)=>{S({visible:!0,score:w,reason:v,type:_}),setTimeout(()=>{S(R=>({...R,visible:!1}))},2e3)},[]),M=h.useCallback(()=>{console.log("TigerOutlet: Shock video completed"),C(!1)},[]);h.useEffect(()=>{if(y){console.log("TigerOutlet: Video started, setting failsafe timeout");const w=setTimeout(()=>{console.log("TigerOutlet: Failsafe timeout - forcing video off"),C(!1)},1e4);return()=>clearTimeout(w)}},[y]);const E=h.useCallback(w=>{const v={low:3,medium:6,high:12,extreme:20}[w],_=Array.from({length:v},(R,D)=>({id:`spark-${Date.now()}-${D}`,x:Math.random()*200-100,y:Math.random()*200-100,intensity:w,timestamp:Date.now(),duration:300+Math.random()*200,color:w==="extreme"?"#E8FF00":w==="high"?"#00D4FF":w==="medium"?"#8A2BE2":"#FF6B35"}));p(R=>[...R,..._]),_.forEach(R=>{setTimeout(()=>{p(D=>D.filter(G=>G.id!==R.id))},R.duration)})},[]),k=h.useCallback(()=>{if(!n.isPlaying)return;if(y){console.log("TigerOutlet: Click during shock video - applying additional penalty!"),A.electricShock(),ie.generateShockSound();const v={basePoints:-20,riskMultiplier:1,streakBonus:0,timeBonus:0,totalPoints:-20,reason:"Клик во время разряда!"};o(v),T(v.totalPoints,v.reason,"shock"),E("extreme"),N(4);return}s.warningSignsActive&&(s.dangerLevel>80?A.extremeDangerWarning():s.dangerLevel>60&&A.dangerWarning()),A.outletPress(),g(!0),e();const w=s.isDischarging;if(console.log("TigerOutlet: Click handled",{isShocked:w,dangerLevel:s.dangerLevel,isDischarging:s.isDischarging,currentRisk:s.currentRisk,gameState:n.isPlaying,aiElectricianActive:s.aiElectricianActive,nextDischargeTime:s.nextDischargeTime,now:Date.now(),timeUntilDischarge:s.nextDischargeTime-Date.now(),showShockVideo:y,singleModeState:s}),w)console.log("TigerOutlet: Electric shock triggered!",{currentVideoState:y,electricShockActive:b}),j(!0),C(!0),N(3),t==null||t(),A.electricShock(),ie.generateShockSound(),l(),setTimeout(()=>{console.log("TigerOutlet: Disabling electric shock effect"),j(!1)},1e3),setTimeout(()=>{const v=window.lastPenaltyMessage;if(v)T(0,v,"shock"),window.lastPenaltyMessage=null;else{const _=Z(a.experience).level,R=_>=3?-15:5,D={low:1,medium:1.5,high:2,extreme:2.5}[s.currentRisk],G=_>=3?Math.floor(R*D):R+Math.floor(Math.random()*10),z={basePoints:R,riskMultiplier:D,streakBonus:0,timeBonus:0,totalPoints:G,reason:"Поражение током"};o(z),T(z.totalPoints,z.reason,"shock")}},100);else{const v=s.currentRisk==="extreme"?"extreme":s.currentRisk==="high"?"high":s.currentRisk==="medium"?"medium":"low";E(v),N(2),A.survivalSuccess(),ie.generateSparkSound(v);const _=5,R={low:1,medium:2,high:3.5,extreme:6}[s.currentRisk],D=s.streakCount>=50?4:s.streakCount>=25?3:s.streakCount>=10?2:s.streakCount>=5?1.5:1,G=Math.floor(_*R*D),z={basePoints:_,riskMultiplier:R,streakBonus:D,timeBonus:0,totalPoints:G,reason:`Выживание (${s.currentRisk} риск)`};o(z),T(z.totalPoints,z.reason,"success"),s.streakCount>0&&s.streakCount%5===0&&A.streakAchievement(s.streakCount)}setTimeout(()=>{g(!1),N(1)},200)},[n.isPlaying,s,e,E,o]);return r.jsxs("div",{className:`relative z-30 ${i}`,children:[y&&r.jsx(x.div,{className:"absolute inset-0 flex items-center justify-center pointer-events-none z-10",initial:{opacity:0},animate:{opacity:[0,1,0]},transition:{duration:.5,repeat:1/0},children:r.jsx("div",{className:"bg-red-600/70 text-white px-4 py-2 rounded-lg border border-red-300 font-bold text-xs md:text-sm",children:"⚡ РАЗРЯД! Штраф за клик ⚡"})}),r.jsxs(x.button,{onClick:k,disabled:!n.isPlaying,className:`relative w-64 h-64 rounded-2xl overflow-hidden bg-gray-800 ${y?"cursor-pointer animate-pulse":"cursor-pointer"}`,style:{opacity:n.isPlaying?1:.5,boxShadow:y?`0 0 ${40*f}px rgba(255, 0, 0, 0.8)`:`0 0 ${20*f}px rgba(255, 107, 53, ${.5*f})`},whileTap:{scale:.95},whileHover:{scale:1.05},animate:{scale:u?.9:y?[1,1.05,1]:1,filter:`brightness(${f}) saturate(${f})`,rotateY:d?[0,180,360]:0},transition:{rotateY:{duration:.6,ease:"easeInOut"},scale:y?{duration:.3,repeat:1/0}:{duration:.1}},children:[y?r.jsx("div",{className:"absolute inset-0 z-50 pointer-events-none",children:r.jsx(ws,{isActive:y,onComplete:M})}):r.jsx("img",{src:c,alt:"Tiger Outlet",className:"absolute inset-0 w-full h-full object-cover rounded-2xl",onError:w=>{console.error("Image failed to load:",c),console.error("Error event:",w),console.error("Current window location:",window.location.href),console.error("Trying full path:",`${window.location.origin}${c}`),w.currentTarget.style.display="none"},onLoad:()=>{console.log("Image loaded successfully:",c)}}),!y&&r.jsx("div",{className:"absolute inset-0 tiger-stripes opacity-20 mix-blend-overlay"}),!y&&r.jsx(x.div,{className:"absolute inset-0 rounded-2xl",animate:{boxShadow:s.warningSignsActive?`0 0 ${30*f}px #FF0000, inset 0 0 ${30*f}px #FF0000`:`0 0 ${15*f}px #FF6B35, inset 0 0 ${15*f}px #FF6B35`},transition:{duration:s.warningSignsActive?.1:.2}}),s.dangerLevel>50&&!y&&r.jsx(x.div,{className:"absolute -top-12 left-1/2 transform -translate-x-1/2",initial:{opacity:0,scale:0},animate:{opacity:[.7,1,.7,1],scale:[.8,1.2,.8,1.2]},transition:{duration:1,repeat:1/0,ease:"easeInOut"},children:r.jsx("div",{className:`px-2 py-1 rounded-full text-xs font-bold ${s.dangerLevel>80?"bg-red-500 text-white":s.dangerLevel>70?"bg-orange-500 text-white":"bg-yellow-500 text-black"}`,children:s.dangerLevel>80?"🔴 КРИТИЧНО":s.dangerLevel>70?"🟠 ОПАСНО":"🟡 РИСК"})}),!y&&r.jsx(bs,{isActive:b,intensity:"extreme",onComplete:()=>j(!1)})]}),r.jsx(V,{children:m.map(w=>r.jsx(x.div,{className:"absolute w-2 h-2 rounded-full pointer-events-none",style:{backgroundColor:w.color,boxShadow:`0 0 10px ${w.color}`,left:"50%",top:"50%"},initial:{x:0,y:0,scale:0,opacity:1},animate:{x:w.x,y:w.y,scale:[0,1.5,.8,0],opacity:[1,1,.5,0],rotate:[0,180,360]},transition:{duration:w.duration/1e3,ease:"easeOut"}},w.id))}),r.jsx("div",{className:"absolute -bottom-8 left-1/2 transform -translate-x-1/2",children:r.jsxs("div",{className:`px-3 py-1 rounded-full text-xs font-bold ${s.currentRisk==="extreme"?"bg-red-500 text-white":s.currentRisk==="high"?"bg-orange-500 text-white":s.currentRisk==="medium"?"bg-yellow-500 text-black":"bg-green-500 text-white"}`,children:[s.currentRisk==="extreme"?"ЭКСТРИМ":s.currentRisk==="high"?"ВЫСОКИЙ":s.currentRisk==="medium"?"СРЕДНИЙ":"НИЗКИЙ"," РИСК"]})}),r.jsx(vs,{score:P.score,reason:P.reason,isVisible:P.visible,position:{x:0,y:-32},type:P.type})]})},ks=({className:i="",disabled:t=!1})=>{const{player:e,singleMode:s,aiElectrician:n,damageAIElectrician:a,gameState:o}=L(),[l,c]=h.useState(!1),[d,m]=h.useState(0),[p,u]=h.useState(!1),g=10,f=o.isPlaying&&s.aiElectricianActive&&n.isActive&&!t&&d===0&&e.volts>=g,N=async()=>{if(!f||l)return;c(!0),u(!0),A.electricShock(),ie.generateShockSound();const b=e.volts,j=10,y=Math.floor(b/10),C=j+y;console.log("Counter attack!",{playerVoltage:b,baseDamage:j,voltageDamage:y,totalDamage:C}),a("energy",C,!0),b>=200?a("equipment",Math.random()*15+10,!0):b>=100&&Math.random()<.5&&a("equipment",Math.random()*10+5,!0);const P=L.getState();L.setState({player:{...P.player,volts:0}});const S=Math.max(3,Math.min(15,Math.floor(b/50)));m(S);const T=setInterval(()=>{m(M=>M<=1?(clearInterval(T),0):M-1)},1e3);setTimeout(()=>{u(!1),c(!1)},1e3)};return r.jsxs("div",{className:`relative ${i}`,children:[r.jsx(V,{children:p&&r.jsx(x.div,{className:"absolute inset-0 pointer-events-none z-10",initial:{scale:0,rotate:0},animate:{scale:[0,1.5,1],rotate:[0,180,360],opacity:[0,1,0]},exit:{opacity:0},transition:{duration:1},children:r.jsx("div",{className:"w-full h-full bg-yellow-400 rounded-full shadow-lg flex items-center justify-center",children:r.jsx("span",{className:"text-2xl",children:"⚡"})})})}),r.jsxs(x.button,{onClick:N,disabled:!f||l,className:`
          relative w-16 h-16 rounded-full border-2 transition-all duration-200
          ${f?"bg-gradient-to-br from-yellow-400 to-orange-500 border-yellow-300 shadow-lg hover:shadow-xl cursor-pointer":"bg-gray-600 border-gray-500 cursor-not-allowed opacity-50"}
          ${d>0?"animate-pulse":""}
        `,whileTap:f?{scale:.9}:{},whileHover:f?{scale:1.1,rotate:5}:{},style:{boxShadow:f?"0 0 20px rgba(255, 193, 7, 0.6)":"none"},children:[r.jsx("div",{className:"flex items-center justify-center w-full h-full",children:d>0?r.jsx("span",{className:"text-white font-bold text-sm",children:d}):r.jsx("span",{className:"text-2xl",children:l?"💥":e.level>=5?"⚡":"🦷"})}),f&&r.jsx("div",{className:"absolute -bottom-2 left-1/2 transform -translate-x-1/2",children:r.jsxs("div",{className:"bg-black/80 text-white text-xs px-1 py-0.5 rounded",children:[e.volts,"⚡ → 0⚡"]})})]}),!f&&!l&&r.jsx("div",{className:"absolute -top-12 left-1/2 transform -translate-x-1/2 pointer-events-none",children:r.jsx("div",{className:"bg-black/80 text-white text-xs px-2 py-1 rounded whitespace-nowrap",children:e.volts<g?`Нужно ${g-e.volts} вольт`:o.isPlaying?s.aiElectricianActive?"Контратака недоступна":"ИИ электрик неактивен":"Игра не запущена"})})]})},Ss=({className:i=""})=>{const{isAuthenticated:t}=Re(),{isOnline:e}=xs(),n=e?t?{text:"Подключено к серверу",color:"text-green-400",icon:"✅",bgColor:"bg-green-500/10"}:{text:"Автономный режим",color:"text-yellow-400",icon:"⚠️",bgColor:"bg-yellow-500/10"}:{text:"Нет подключения",color:"text-red-400",icon:"❌",bgColor:"bg-red-500/10"};return r.jsx(x.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:`glass-effect p-2 rounded-lg ${n.bgColor} ${i}`,children:r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx("span",{className:"text-sm",children:n.icon}),r.jsx("span",{className:`text-xs font-medium ${n.color}`,children:n.text})]})})},Es=({isOpen:i,onClose:t})=>{var j;const{player:e,getShopItems:s,buyProtectionItem:n,getTotalProtection:a}=L(),[o,l]=h.useState("gloves"),[c,d]=h.useState(null);h.useEffect(()=>{if(!i)return;const y=C=>{C.key==="Escape"&&t()};return window.addEventListener("keydown",y),()=>window.removeEventListener("keydown",y)},[i,t]);const m=s(),p=a(),u=[{key:"gloves",name:"Перчатки",icon:"🧤"},{key:"boots",name:"Сапоги",icon:"👢"},{key:"suit",name:"Костюм",icon:"🥽"},{key:"helmet",name:"Каска",icon:"⛑️"}],g=m.filter(y=>y.type===o),f=y=>{n(y.type,y.level)&&(d(y.id),setTimeout(()=>d(null),1e3))},N=y=>e.volts>=y,b=y=>e.protection[y.type].level>=y.level;return i?r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[999]",onClick:t,role:"button","aria-label":"Закрыть магазин",children:r.jsxs(x.div,{initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.8,opacity:0},className:"bg-gray-900 border-2 border-yellow-400 rounded-lg p-6 max-w-4xl w-full max-h-[80vh] overflow-y-auto",onClick:y=>y.stopPropagation(),children:[r.jsxs("div",{className:"flex justify-between items-center mb-6",children:[r.jsxs("div",{children:[r.jsx("h2",{className:"text-2xl font-bold text-yellow-400",children:"Магазин защиты"}),r.jsxs("p",{className:"text-gray-300",children:["Вольты: ",r.jsxs("span",{className:"text-yellow-400 font-bold",children:[e.volts,"V"]})," | Общая защита: ",r.jsxs("span",{className:"text-green-400 font-bold",children:[p.toFixed(1),"%"]})]})]}),r.jsx("button",{onClick:t,className:"text-red-400 hover:text-red-300 text-2xl font-bold",children:"✕"})]}),r.jsx("div",{className:"flex mb-6 bg-gray-800 rounded-lg p-1",children:u.map(y=>r.jsxs("button",{onClick:()=>l(y.key),className:`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all ${o===y.key?"bg-yellow-400 text-black":"text-gray-300 hover:text-white hover:bg-gray-700"}`,children:[r.jsx("span",{className:"mr-2",children:y.icon}),y.name]},y.key))}),r.jsxs("div",{className:"mb-6 p-4 bg-gray-800 rounded-lg",children:[r.jsxs("h3",{className:"text-lg font-bold text-yellow-400 mb-2",children:["Текущая экипировка: ",(j=u.find(y=>y.key===o))==null?void 0:j.name]}),r.jsxs("div",{className:"grid grid-cols-4 gap-2 text-sm",children:[r.jsx("div",{className:"text-gray-400",children:"Уровень:"}),r.jsx("div",{className:"text-white",children:e.protection[o].level||"Нет"}),r.jsx("div",{className:"text-gray-400",children:"Защита:"}),r.jsxs("div",{className:"text-green-400",children:[e.protection[o].protection,"%"]}),r.jsx("div",{className:"text-gray-400",children:"Прочность:"}),r.jsxs("div",{className:"text-blue-400",children:[e.protection[o].durability,"/",e.protection[o].maxDurability]})]})]}),r.jsx("div",{className:"grid gap-4",children:g.map(y=>{const C=b(y),P=N(y.price),S=c===y.id;return r.jsx(x.div,{className:`p-4 rounded-lg border-2 transition-all ${C?"border-green-500 bg-green-900 bg-opacity-30":P?"border-yellow-400 bg-gray-800":"border-gray-600 bg-gray-800 opacity-60"}`,whileHover:!C&&P?{scale:1.02}:{},children:r.jsxs("div",{className:"flex justify-between items-start",children:[r.jsxs("div",{className:"flex-1",children:[r.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[r.jsx("span",{className:"text-2xl",children:y.icon}),r.jsxs("div",{children:[r.jsx("h4",{className:"text-lg font-bold text-white",children:y.name}),r.jsx("p",{className:"text-gray-300 text-sm",children:y.description})]})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-400",children:"Уровень: "}),r.jsx("span",{className:"text-yellow-400 font-bold",children:y.level})]}),r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-400",children:"Защита: "}),r.jsxs("span",{className:"text-green-400 font-bold",children:[y.protection,"%"]})]}),r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-400",children:"Прочность: "}),r.jsx("span",{className:"text-blue-400 font-bold",children:y.durability})]}),r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-400",children:"Цена: "}),r.jsxs("span",{className:"text-yellow-400 font-bold",children:[y.price,"V"]})]})]})]}),r.jsx("div",{className:"ml-4",children:r.jsx(V,{children:C?r.jsx("div",{className:"px-4 py-2 bg-green-500 text-white rounded-lg font-bold",children:"Куплено"}):r.jsx(x.button,{onClick:()=>f(y),disabled:!P,className:`px-4 py-2 rounded-lg font-bold transition-all ${P?"bg-yellow-400 text-black hover:bg-yellow-300":"bg-gray-600 text-gray-400 cursor-not-allowed"}`,whileTap:P?{scale:.95}:{},animate:S?{scale:[1,1.2,1],backgroundColor:["#fbbf24","#10b981","#fbbf24"]}:{},children:P?"Купить":"Нет вольт"})})})]})},y.id)})}),r.jsx("div",{className:"mt-6 p-4 bg-blue-900 bg-opacity-30 border border-blue-400 rounded-lg",children:r.jsxs("p",{className:"text-blue-300 text-sm",children:["💡 ",r.jsx("strong",{children:"Совет:"})," Защитная экипировка изнашивается при ударах током. Более качественная экипировка служит дольше и обеспечивает лучшую защиту."]})}),r.jsx("div",{className:"mt-6 flex justify-end",children:r.jsx("button",{onClick:t,className:"px-5 py-2 rounded-md font-bold bg-gray-700 text-white hover:bg-gray-600 border border-gray-500",children:"Закрыть"})})]})}):null},_s=()=>{const{player:i,gameState:t,singleMode:e,aiElectrician:s,repairAIElectrician:n,getTotalProtection:a}=L(),[o,l]=h.useState(!1);return r.jsxs("div",{className:"fixed top-0 left-0 right-0 z-10 bg-black/20 backdrop-blur-sm border-b border-white/10 pointer-events-auto",children:[r.jsxs("div",{className:"flex justify-between items-center p-4",children:[r.jsxs("div",{className:"flex items-center space-x-4",children:[r.jsxs(x.div,{className:"glass-effect px-4 py-2",whileHover:{scale:1.05},children:[r.jsx("div",{className:"text-xs text-gray-300",children:"СЧЁТ"}),r.jsx("div",{className:"text-xl font-bold text-accent-lime",children:t.score.toLocaleString()})]}),r.jsxs(x.div,{className:"glass-effect px-4 py-2",whileHover:{scale:1.05},children:[r.jsx("div",{className:"text-xs text-gray-300",children:"ВОЛЬТЫ"}),r.jsxs("div",{className:"text-xl font-bold text-primary-orange",children:[i.volts.toLocaleString(),"⚡"]})]})]}),r.jsx("div",{className:"text-center",children:r.jsxs(x.div,{className:"glass-effect px-4 py-2",animate:{scale:e.streakCount>0?[1,1.1,1]:1,boxShadow:e.streakCount>=5?"0 0 20px #E8FF00":"0 0 10px rgba(255,255,255,0.2)"},transition:{duration:.3},children:[r.jsx("div",{className:"text-xs text-gray-300",children:"СЕРИЯ"}),r.jsx("div",{className:`text-xl font-bold ${e.streakCount>=25?"text-red-400":e.streakCount>=10?"text-orange-400":e.streakCount>=5?"text-yellow-400":"text-white"}`,children:e.streakCount})]})}),r.jsxs("div",{className:"flex items-center space-x-4",children:[r.jsxs(x.div,{className:"glass-effect px-4 py-2",whileHover:{scale:1.05},animate:{opacity:i.luckIndicatorHidden&&Date.now()<i.luckHiddenUntil?.3:1},transition:{duration:.3},children:[r.jsx("div",{className:"text-xs text-gray-300",children:"УДАЧА"}),r.jsx("div",{className:`text-sm font-bold ${i.luckIndicatorHidden&&Date.now()<i.luckHiddenUntil?"text-gray-500":i.luckCoefficient>=70?"text-green-400":i.luckCoefficient>=50?"text-yellow-400":i.luckCoefficient>=30?"text-orange-400":"text-red-400"}`,children:i.luckIndicatorHidden&&Date.now()<i.luckHiddenUntil?"???":`${i.luckCoefficient}%`})]}),r.jsxs(x.div,{className:"glass-effect px-4 py-2",whileHover:{scale:1.05},children:[r.jsx("div",{className:"text-xs text-gray-300",children:"СЛОЖНОСТЬ"}),r.jsx("div",{className:`text-sm font-bold ${e.difficulty==="extreme"?"text-red-400":e.difficulty==="hard"?"text-orange-400":e.difficulty==="medium"?"text-yellow-400":"text-green-400"}`,children:e.difficulty==="extreme"?"ЭКСТРИМ":e.difficulty==="hard"?"СЛОЖНЫЙ":e.difficulty==="medium"?"СРЕДНИЙ":"ЛЁГКИЙ"})]}),r.jsxs(x.div,{className:"glass-effect px-4 py-2",whileHover:{scale:1.05},animate:{boxShadow:e.dangerLevel>80?"0 0 20px #ff4444":e.dangerLevel>60?"0 0 15px #ff8800":e.dangerLevel>40?"0 0 10px #ffaa00":"0 0 5px rgba(255,255,255,0.2)"},children:[r.jsx("div",{className:"text-xs text-gray-300",children:"ОПАСНОСТЬ"}),r.jsxs("div",{className:`text-sm font-bold ${e.dangerLevel>80?"text-red-400":e.dangerLevel>60?"text-orange-400":e.dangerLevel>40?"text-yellow-400":"text-green-400"}`,children:[e.dangerLevel,"%"]})]}),r.jsxs(x.div,{className:"glass-effect px-4 py-2",whileHover:{scale:1.05},animate:{boxShadow:e.isDischarging?"0 0 20px #ff0000":e.warningSignsActive?"0 0 15px #ff8800":e.aiElectricianActive?"0 0 10px #00ffff":"0 0 5px rgba(255,255,255,0.2)",scale:e.isDischarging?[1,1.05,1]:1},transition:{duration:.3,repeat:e.isDischarging?1/0:0},children:[r.jsx("div",{className:"text-xs text-gray-300",children:"ИИ ЭЛЕКТРИК"}),r.jsx("div",{className:`text-sm font-bold ${e.isDischarging?"text-red-400":e.warningSignsActive?"text-orange-400":e.aiElectricianActive?"text-cyan-400":"text-gray-500"}`,children:e.isDischarging?"⚡ РАЗРЯД!":e.warningSignsActive?"⚠️ ВНИМАНИЕ!":e.aiElectricianActive?"🤖 АКТИВЕН":"😴 СПИТ"})]}),e.aiElectricianActive&&r.jsxs(x.div,{className:"glass-effect px-4 py-2 min-w-[120px]",whileHover:{scale:1.05},animate:{boxShadow:s.energy<20?"0 0 15px #ff4444":s.energy<50?"0 0 10px #ff8800":"0 0 5px rgba(255,255,255,0.2)"},children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsx("div",{className:"text-xs text-gray-300",children:"ЭТАП"}),r.jsx("div",{className:"text-sm font-bold text-cyan-300",children:e.stage||1})]}),r.jsxs("div",{className:"text-right",children:[r.jsx("div",{className:"text-xs text-gray-300",children:"ОЧКИ ИИ"}),r.jsxs("div",{className:"text-sm font-bold text-cyan-200",children:[Math.max(0,Math.floor(s.points??0))," / ",Math.max(1,Math.floor(s.maxPoints??0))]})]})]}),r.jsx("div",{className:"text-xs text-gray-300",children:"ЭНЕРГИЯ"}),r.jsxs("div",{className:`text-sm font-bold ${s.energy<20?"text-red-400":s.energy<50?"text-orange-400":"text-green-400"}`,children:[Math.round(s.energy),"%"]}),r.jsx("div",{className:"text-xs text-gray-300 mt-1",children:"УСТАЛОСТЬ"}),r.jsxs("div",{className:`text-xs font-bold ${s.fatigueLevel>=8?"text-red-400":s.fatigueLevel>=5?"text-orange-400":s.fatigueLevel>=2?"text-yellow-400":"text-green-400"}`,children:[Math.floor(s.fatigueLevel),"/10",s.fatigueLevel>=8&&" 💎",s.fatigueLevel>=5&&s.fatigueLevel<8&&" 🥇",s.fatigueLevel>=2&&s.fatigueLevel<5&&" 🥈"]})]}),r.jsxs(x.div,{className:"glass-effect px-4 py-2",whileHover:{scale:1.05},children:[r.jsx("div",{className:"text-xs text-gray-300",children:"НАЖАТИЙ"}),r.jsx("div",{className:"text-lg font-bold text-accent-blue",children:i.totalClicks})]}),r.jsx(Ss,{})]})]}),e.aiElectricianActive&&r.jsx(x.div,{className:"bg-black/40 border-t border-white/10 px-4 py-3",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.3},children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex items-center space-x-4",children:[r.jsxs("div",{className:"text-sm",children:[r.jsxs("div",{className:"text-cyan-400 font-bold",children:["⚡ ",s.name]}),r.jsx("div",{className:`text-xs ${s.mood==="confident"?"text-green-400":s.mood==="frustrated"?"text-orange-400":s.mood==="tired"?"text-yellow-400":s.mood==="broken"?"text-red-400":"text-red-600"}`,children:s.lastMessage})]}),r.jsxs("div",{className:"flex flex-col items-center",children:[r.jsx("div",{className:"text-xs text-gray-300 mb-1",children:"ЭНЕРГИЯ"}),r.jsx("div",{className:"w-20 h-2 bg-gray-700 rounded-full overflow-hidden",children:r.jsx(x.div,{className:`h-full rounded-full ${s.energy>60?"bg-green-500":s.energy>30?"bg-yellow-500":"bg-red-500"}`,initial:{width:0},animate:{width:`${s.energy}%`},transition:{duration:.5}})}),r.jsxs("div",{className:"text-xs text-white",children:[Math.round(s.energy),"%"]})]}),r.jsxs("div",{className:"flex flex-col items-center",children:[r.jsx("div",{className:"text-xs text-gray-300 mb-1",children:"НАПРЯЖЕНИЕ"}),r.jsx("div",{className:"w-20 h-2 bg-gray-700 rounded-full overflow-hidden",children:r.jsx(x.div,{className:`h-full rounded-full ${s.voltage>300?"bg-red-500":s.voltage>200?"bg-orange-500":s.voltage>100?"bg-yellow-500":"bg-blue-500"}`,initial:{width:0},animate:{width:`${s.voltage/s.maxVoltage*100}%`,boxShadow:s.voltage>=100?"0 0 10px rgba(255, 0, 0, 0.8)":"none"},transition:{duration:.5}})}),r.jsxs("div",{className:`text-xs font-bold ${s.voltage>=100?"text-red-400":"text-white"}`,children:[Math.round(s.voltage),"⚡"]})]}),r.jsxs("div",{className:"flex space-x-2",children:[r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-xs text-gray-300",children:"БАТ"}),r.jsxs("div",{className:`text-xs font-bold ${s.equipment.battery>70?"text-green-400":s.equipment.battery>30?"text-yellow-400":"text-red-400"}`,children:[Math.round(s.equipment.battery),"%"]})]}),r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-xs text-gray-300",children:"КОН"}),r.jsxs("div",{className:`text-xs font-bold ${s.equipment.capacitor>70?"text-green-400":s.equipment.capacitor>30?"text-yellow-400":"text-red-400"}`,children:[Math.round(s.equipment.capacitor),"%"]})]}),r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-xs text-gray-300",children:"ПРВ"}),r.jsxs("div",{className:`text-xs font-bold ${s.equipment.wires>70?"text-green-400":s.equipment.wires>30?"text-yellow-400":"text-red-400"}`,children:[Math.round(s.equipment.wires),"%"]})]}),r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-xs text-gray-300",children:"ГЕН"}),r.jsxs("div",{className:`text-xs font-bold ${s.equipment.generator>70?"text-green-400":s.equipment.generator>30?"text-yellow-400":"text-red-400"}`,children:[Math.round(s.equipment.generator),"%"]})]})]}),r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-xs text-gray-300",children:"ЭФФЕКТ"}),r.jsxs("div",{className:`text-sm font-bold ${s.workingEfficiency>80?"text-green-400":s.workingEfficiency>50?"text-yellow-400":"text-red-400"}`,children:[Math.round(s.workingEfficiency),"%"]})]}),r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-xs text-gray-300",children:"УСПЕХ/НЕУДАЧ"}),r.jsx("div",{className:"text-xs text-green-400",children:s.successfulDischarges}),r.jsx("div",{className:"text-xs text-red-400",children:s.failuresCount})]}),r.jsx("div",{className:"text-center",children:r.jsx("div",{className:`text-sm font-bold ${s.canWork?"text-green-400":"text-red-400"}`,children:s.canWork?"✅ РАБОТАЕТ":"❌ НЕ РАБОТАЕТ"})})]}),r.jsxs("div",{className:"flex space-x-2 mt-2",children:[r.jsx(x.button,{className:"glass-effect px-3 py-1 text-xs text-green-400 hover:text-green-300 disabled:text-gray-500 disabled:cursor-not-allowed",onClick:()=>{i.volts>=50&&(n("energy"),L.getState().updatePlayerStats({volts:i.volts-50}))},disabled:i.volts<50||s.energy>=90,whileHover:{scale:1.05},whileTap:{scale:.95},children:"⚡ Зарядить (50⚡)"}),r.jsx(x.button,{className:"glass-effect px-3 py-1 text-xs text-blue-400 hover:text-blue-300 disabled:text-gray-500 disabled:cursor-not-allowed",onClick:()=>{i.volts>=100&&(n("equipment"),L.getState().updatePlayerStats({volts:i.volts-100}))},disabled:i.volts<100||Object.values(s.equipment).every(c=>c>=95),whileHover:{scale:1.05},whileTap:{scale:.95},children:"🔧 Починить (100⚡)"})]})]})}),r.jsx(x.button,{onClick:()=>l(!0),className:"fixed bottom-20 left-4 glass-effect px-4 py-2 text-yellow-400 hover:text-yellow-300 z-40",whileHover:{scale:1.1},whileTap:{scale:.95},children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("span",{children:"🛡️"}),r.jsxs("div",{children:[r.jsx("div",{className:"text-sm font-bold",children:"ЗАЩИТА"}),r.jsxs("div",{className:"text-xs",children:[a().toFixed(1),"%"]})]})]})}),r.jsx(Es,{isOpen:o,onClose:()=>l(!1)})]})},Ts=({isActive:i,intensity:t="medium",duration:e=500,onComplete:s})=>{const n={low:5,medium:10,high:15,extreme:20}[t];return h.useEffect(()=>{if(i&&s){const a=setTimeout(s,e);return()=>clearTimeout(a)}},[i,e,s]),i?r.jsx(x.div,{className:"fixed inset-0 pointer-events-none z-50",initial:{x:0,y:0},animate:{x:[0,-n,n,-n,n,0],y:[0,n,-n,n,-n,0]},transition:{duration:e/1e3,times:[0,.1,.2,.3,.4,1],ease:"easeInOut"},children:r.jsx(x.div,{className:"absolute inset-0 bg-red-500 mix-blend-multiply",initial:{opacity:0},animate:{opacity:[0,.3,0,.2,0]},transition:{duration:e/1e3}})}):null},Ms=()=>{const{gameState:i,singleMode:t,endGame:e,player:s,submitGameToServer:n}=L(),{isAuthenticated:a}=Re(),[o,l]=h.useState(0),[c,d]=h.useState(!1),[m,p]=h.useState(!1),[u,g]=h.useState(!1),f=h.useCallback(()=>{g(!0),setTimeout(()=>{g(!1)},600)},[]);h.useEffect(()=>{if(!i.isPlaying)return;const j=setInterval(()=>{l(y=>y+1)},1e3);return()=>clearInterval(j)},[i.isPlaying]),h.useEffect(()=>{o>=600&&d(!0)},[o]);const N=async()=>{if(d(!1),l(0),a&&i.score>0){p(!0);try{const j=L.getState();j.gameState.gameTime=o*1e3;const y=await n();y.success?console.log("✅ Игра успешно сохранена на сервер"):console.warn("⚠️ Не удалось сохранить игру на сервер:",y.error)}catch(j){console.error("❌ Ошибка при сохранении игры:",j)}finally{p(!1)}}e()},b=j=>{const y=Math.floor(j/60),C=j%60;return`${y.toString().padStart(2,"0")}:${C.toString().padStart(2,"0")}`};return c?r.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-background-dark to-background-darker",children:r.jsxs(x.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},className:"glass-effect p-8 text-center max-w-md",children:[r.jsx("h2",{className:"text-3xl font-bold text-primary-orange mb-4",children:"Игра окончена!"}),r.jsxs("div",{className:"space-y-3 mb-6",children:[r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{children:"Время игры:"}),r.jsx("span",{className:"font-bold",children:b(o)})]}),r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{children:"Финальный счёт:"}),r.jsx("span",{className:"font-bold text-accent-lime",children:i.score.toLocaleString()})]}),r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{children:"Получено вольт:"}),r.jsxs("span",{className:"font-bold text-primary-orange",children:[i.score,"⚡"]})]}),r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{children:"Всего нажатий:"}),r.jsx("span",{className:"font-bold text-accent-blue",children:s.totalClicks})]}),r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{children:"Лучшая серия:"}),r.jsx("span",{className:"font-bold text-yellow-400",children:s.streak})]})]}),a&&i.score>0&&r.jsx("div",{className:"mb-4 text-center",children:m?r.jsxs("div",{className:"text-blue-400 text-sm",children:[r.jsx("span",{className:"inline-block animate-spin mr-2",children:"⏳"}),"Сохранение результатов..."]}):r.jsx("div",{className:"text-green-400 text-sm",children:"✅ Результаты будут сохранены на сервер"})}),!a&&i.score>0&&r.jsx("div",{className:"mb-4 text-center text-yellow-400 text-sm",children:"⚠️ Результаты сохраняются только локально"}),r.jsx(x.button,{onClick:N,disabled:m,className:"w-full glass-effect p-3 rounded-xl hover:bg-primary-orange/20 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",whileHover:{scale:m?1:1.05},whileTap:{scale:m?1:.95},children:r.jsx("span",{className:"font-bold",children:m?"Сохранение...":"Вернуться в меню"})})]})}):r.jsxs(r.Fragment,{children:[r.jsx(Ts,{isActive:u}),r.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-background-dark to-background-darker relative",children:[r.jsx(_s,{}),r.jsxs("div",{className:`flex flex-col items-center justify-center min-h-screen pb-8 ${t.aiElectricianActive?"pt-44 md:pt-48":"pt-24"}`,children:[r.jsx(x.div,{className:"glass-effect px-6 py-3 mb-8",animate:{scale:o%10===0&&o>0?[1,1.1,1]:1},children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-xs text-gray-300",children:"ВРЕМЯ ИГРЫ"}),r.jsx("div",{className:"text-2xl font-bold text-white font-mono",children:b(o)})]})}),r.jsxs("div",{className:"relative flex items-center justify-center space-x-8 mb-8 z-20",children:[r.jsx(ks,{className:"order-1"}),r.jsx(js,{className:"order-2",onShock:f}),r.jsx("div",{className:"w-16 h-16 order-3 opacity-0"})]}),r.jsx("div",{className:"flex space-x-4 text-center",children:r.jsxs(x.div,{className:"glass-effect px-4 py-2",whileHover:{scale:1.05},children:[r.jsx("div",{className:"text-xs text-gray-300",children:"ПОСЛЕДНИЙ РИСК"}),r.jsx("div",{className:`text-sm font-bold ${t.currentRisk==="extreme"?"text-red-400":t.currentRisk==="high"?"text-orange-400":t.currentRisk==="medium"?"text-yellow-400":"text-green-400"}`,children:t.currentRisk==="extreme"?"ЭКСТРИМ":t.currentRisk==="high"?"ВЫСОКИЙ":t.currentRisk==="medium"?"СРЕДНИЙ":"НИЗКИЙ"})]})}),r.jsx(x.button,{onClick:N,className:"mt-8 glass-effect px-6 py-3 rounded-xl hover:bg-red-500/20 transition-colors",whileHover:{scale:1.05},whileTap:{scale:.95},children:r.jsx("span",{className:"text-red-300 font-bold",children:"Завершить игру"})})]}),r.jsx("div",{className:"fixed inset-0 pointer-events-none overflow-hidden",children:r.jsx(x.div,{className:"absolute inset-0 opacity-10",animate:{backgroundPosition:["0% 0%","100% 100%"]},transition:{duration:20,repeat:1/0,ease:"linear"},style:{backgroundImage:`
              linear-gradient(0deg, transparent 24%, rgba(255, 107, 53, 0.05) 25%, rgba(255, 107, 53, 0.05) 26%, transparent 27%, transparent 74%, rgba(255, 107, 53, 0.05) 75%, rgba(255, 107, 53, 0.05) 76%, transparent 77%, transparent),
              linear-gradient(90deg, transparent 24%, rgba(255, 107, 53, 0.05) 25%, rgba(255, 107, 53, 0.05) 26%, transparent 27%, transparent 74%, rgba(255, 107, 53, 0.05) 75%, rgba(255, 107, 53, 0.05) 76%, transparent 77%, transparent)
            `,backgroundSize:"50px 50px"}})})]})]})},As=()=>{const i=()=>{A.light(),L.getState().endGame()};return r.jsxs("div",{className:"min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-background-dark to-background-darker",children:[r.jsxs(x.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.6},className:"text-center",children:[r.jsx("h1",{className:"text-4xl font-bold text-primary-orange mb-4",children:"🎮 Многопользовательский режим"}),r.jsx("p",{className:"text-xl text-gray-300 mb-8",children:"Скоро здесь будут эпические дуэли!"})]}),r.jsxs(x.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{duration:.5,delay:.2},className:"glass-effect p-8 rounded-xl text-center max-w-md",children:[r.jsx("div",{className:"text-6xl mb-4",children:"🚧"}),r.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"В разработке"}),r.jsx("p",{className:"text-gray-300 mb-6",children:"Мы работаем над захватывающими многопользовательскими режимами:"}),r.jsxs("div",{className:"space-y-3 text-left mb-6",children:[r.jsxs("div",{className:"flex items-center space-x-3",children:[r.jsx("span",{className:"text-purple-400",children:"⚔️"}),r.jsx("span",{className:"text-gray-300",children:"Дуэли 1v1 в реальном времени"})]}),r.jsxs("div",{className:"flex items-center space-x-3",children:[r.jsx("span",{className:"text-blue-400",children:"🏆"}),r.jsx("span",{className:"text-gray-300",children:"Турниры до 8 игроков"})]}),r.jsxs("div",{className:"flex items-center space-x-3",children:[r.jsx("span",{className:"text-green-400",children:"🤝"}),r.jsx("span",{className:"text-gray-300",children:"Кооперативные режимы"})]}),r.jsxs("div",{className:"flex items-center space-x-3",children:[r.jsx("span",{className:"text-yellow-400",children:"📊"}),r.jsx("span",{className:"text-gray-300",children:"Глобальные таблицы лидеров"})]})]}),r.jsx(x.button,{onClick:i,className:"w-full glass-effect p-3 rounded-xl hover:bg-orange-500/20 transition-colors border border-orange-400/30",whileHover:{scale:1.02},whileTap:{scale:.98},children:r.jsx("span",{className:"text-lg font-semibold text-orange-400",children:"← Назад в меню"})})]}),r.jsx(x.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.5,delay:.4},className:"mt-8 text-center text-gray-400 text-sm",children:r.jsx("p",{children:"🔔 Подпишитесь на уведомления, чтобы узнать о запуске первыми!"})})]})},W=Object.create(null);W.open="0";W.close="1";W.ping="2";W.pong="3";W.message="4";W.upgrade="5";W.noop="6";const oe=Object.create(null);Object.keys(W).forEach(i=>{oe[W[i]]=i});const ke={type:"error",data:"parser error"},dt=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",ut=typeof ArrayBuffer=="function",ht=i=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(i):i&&i.buffer instanceof ArrayBuffer,Ie=({type:i,data:t},e,s)=>dt&&t instanceof Blob?e?s(t):Ye(t,s):ut&&(t instanceof ArrayBuffer||ht(t))?e?s(t):Ye(new Blob([t]),s):s(W[i]+(t||"")),Ye=(i,t)=>{const e=new FileReader;return e.onload=function(){const s=e.result.split(",")[1];t("b"+(s||""))},e.readAsDataURL(i)};function Je(i){return i instanceof Uint8Array?i:i instanceof ArrayBuffer?new Uint8Array(i):new Uint8Array(i.buffer,i.byteOffset,i.byteLength)}let ve;function Cs(i,t){if(dt&&i.data instanceof Blob)return i.data.arrayBuffer().then(Je).then(t);if(ut&&(i.data instanceof ArrayBuffer||ht(i.data)))return t(Je(i.data));Ie(i,!1,e=>{ve||(ve=new TextEncoder),t(ve.encode(e))})}const Xe="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",re=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let i=0;i<Xe.length;i++)re[Xe.charCodeAt(i)]=i;const Rs=i=>{let t=i.length*.75,e=i.length,s,n=0,a,o,l,c;i[i.length-1]==="="&&(t--,i[i.length-2]==="="&&t--);const d=new ArrayBuffer(t),m=new Uint8Array(d);for(s=0;s<e;s+=4)a=re[i.charCodeAt(s)],o=re[i.charCodeAt(s+1)],l=re[i.charCodeAt(s+2)],c=re[i.charCodeAt(s+3)],m[n++]=a<<2|o>>4,m[n++]=(o&15)<<4|l>>2,m[n++]=(l&3)<<6|c&63;return d},Is=typeof ArrayBuffer=="function",Pe=(i,t)=>{if(typeof i!="string")return{type:"message",data:mt(i,t)};const e=i.charAt(0);return e==="b"?{type:"message",data:Ps(i.substring(1),t)}:oe[e]?i.length>1?{type:oe[e],data:i.substring(1)}:{type:oe[e]}:ke},Ps=(i,t)=>{if(Is){const e=Rs(i);return mt(e,t)}else return{base64:!0,data:i}},mt=(i,t)=>{switch(t){case"blob":return i instanceof Blob?i:new Blob([i]);case"arraybuffer":default:return i instanceof ArrayBuffer?i:i.buffer}},ft="",Ds=(i,t)=>{const e=i.length,s=new Array(e);let n=0;i.forEach((a,o)=>{Ie(a,!1,l=>{s[o]=l,++n===e&&t(s.join(ft))})})},Ls=(i,t)=>{const e=i.split(ft),s=[];for(let n=0;n<e.length;n++){const a=Pe(e[n],t);if(s.push(a),a.type==="error")break}return s};function Os(){return new TransformStream({transform(i,t){Cs(i,e=>{const s=e.length;let n;if(s<126)n=new Uint8Array(1),new DataView(n.buffer).setUint8(0,s);else if(s<65536){n=new Uint8Array(3);const a=new DataView(n.buffer);a.setUint8(0,126),a.setUint16(1,s)}else{n=new Uint8Array(9);const a=new DataView(n.buffer);a.setUint8(0,127),a.setBigUint64(1,BigInt(s))}i.data&&typeof i.data!="string"&&(n[0]|=128),t.enqueue(n),t.enqueue(e)})}})}let be;function ne(i){return i.reduce((t,e)=>t+e.length,0)}function ae(i,t){if(i[0].length===t)return i.shift();const e=new Uint8Array(t);let s=0;for(let n=0;n<t;n++)e[n]=i[0][s++],s===i[0].length&&(i.shift(),s=0);return i.length&&s<i[0].length&&(i[0]=i[0].slice(s)),e}function Bs(i,t){be||(be=new TextDecoder);const e=[];let s=0,n=-1,a=!1;return new TransformStream({transform(o,l){for(e.push(o);;){if(s===0){if(ne(e)<1)break;const c=ae(e,1);a=(c[0]&128)===128,n=c[0]&127,n<126?s=3:n===126?s=1:s=2}else if(s===1){if(ne(e)<2)break;const c=ae(e,2);n=new DataView(c.buffer,c.byteOffset,c.length).getUint16(0),s=3}else if(s===2){if(ne(e)<8)break;const c=ae(e,8),d=new DataView(c.buffer,c.byteOffset,c.length),m=d.getUint32(0);if(m>Math.pow(2,21)-1){l.enqueue(ke);break}n=m*Math.pow(2,32)+d.getUint32(4),s=3}else{if(ne(e)<n)break;const c=ae(e,n);l.enqueue(Pe(a?c:be.decode(c),t)),s=0}if(n===0||n>i){l.enqueue(ke);break}}}})}const pt=4;function O(i){if(i)return Fs(i)}function Fs(i){for(var t in O.prototype)i[t]=O.prototype[t];return i}O.prototype.on=O.prototype.addEventListener=function(i,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+i]=this._callbacks["$"+i]||[]).push(t),this};O.prototype.once=function(i,t){function e(){this.off(i,e),t.apply(this,arguments)}return e.fn=t,this.on(i,e),this};O.prototype.off=O.prototype.removeListener=O.prototype.removeAllListeners=O.prototype.removeEventListener=function(i,t){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var e=this._callbacks["$"+i];if(!e)return this;if(arguments.length==1)return delete this._callbacks["$"+i],this;for(var s,n=0;n<e.length;n++)if(s=e[n],s===t||s.fn===t){e.splice(n,1);break}return e.length===0&&delete this._callbacks["$"+i],this};O.prototype.emit=function(i){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),e=this._callbacks["$"+i],s=1;s<arguments.length;s++)t[s-1]=arguments[s];if(e){e=e.slice(0);for(var s=0,n=e.length;s<n;++s)e[s].apply(this,t)}return this};O.prototype.emitReserved=O.prototype.emit;O.prototype.listeners=function(i){return this._callbacks=this._callbacks||{},this._callbacks["$"+i]||[]};O.prototype.hasListeners=function(i){return!!this.listeners(i).length};const fe=typeof Promise=="function"&&typeof Promise.resolve=="function"?t=>Promise.resolve().then(t):(t,e)=>e(t,0),$=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),$s="arraybuffer";function xt(i,...t){return t.reduce((e,s)=>(i.hasOwnProperty(s)&&(e[s]=i[s]),e),{})}const Us=$.setTimeout,qs=$.clearTimeout;function pe(i,t){t.useNativeTimers?(i.setTimeoutFn=Us.bind($),i.clearTimeoutFn=qs.bind($)):(i.setTimeoutFn=$.setTimeout.bind($),i.clearTimeoutFn=$.clearTimeout.bind($))}const Vs=1.33;function Hs(i){return typeof i=="string"?Ws(i):Math.ceil((i.byteLength||i.size)*Vs)}function Ws(i){let t=0,e=0;for(let s=0,n=i.length;s<n;s++)t=i.charCodeAt(s),t<128?e+=1:t<2048?e+=2:t<55296||t>=57344?e+=3:(s++,e+=4);return e}function gt(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function zs(i){let t="";for(let e in i)i.hasOwnProperty(e)&&(t.length&&(t+="&"),t+=encodeURIComponent(e)+"="+encodeURIComponent(i[e]));return t}function Gs(i){let t={},e=i.split("&");for(let s=0,n=e.length;s<n;s++){let a=e[s].split("=");t[decodeURIComponent(a[0])]=decodeURIComponent(a[1])}return t}class Ks extends Error{constructor(t,e,s){super(t),this.description=e,this.context=s,this.type="TransportError"}}class De extends O{constructor(t){super(),this.writable=!1,pe(this,t),this.opts=t,this.query=t.query,this.socket=t.socket,this.supportsBinary=!t.forceBase64}onError(t,e,s){return super.emitReserved("error",new Ks(t,e,s)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(t){this.readyState==="open"&&this.write(t)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(t){const e=Pe(t,this.socket.binaryType);this.onPacket(e)}onPacket(t){super.emitReserved("packet",t)}onClose(t){this.readyState="closed",super.emitReserved("close",t)}pause(t){}createUri(t,e={}){return t+"://"+this._hostname()+this._port()+this.opts.path+this._query(e)}_hostname(){const t=this.opts.hostname;return t.indexOf(":")===-1?t:"["+t+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(t){const e=zs(t);return e.length?"?"+e:""}}class Ys extends De{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(t){this.readyState="pausing";const e=()=>{this.readyState="paused",t()};if(this._polling||!this.writable){let s=0;this._polling&&(s++,this.once("pollComplete",function(){--s||e()})),this.writable||(s++,this.once("drain",function(){--s||e()}))}else e()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(t){const e=s=>{if(this.readyState==="opening"&&s.type==="open"&&this.onOpen(),s.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(s)};Ls(t,this.socket.binaryType).forEach(e),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const t=()=>{this.write([{type:"close"}])};this.readyState==="open"?t():this.once("open",t)}write(t){this.writable=!1,Ds(t,e=>{this.doWrite(e,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const t=this.opts.secure?"https":"http",e=this.query||{};return this.opts.timestampRequests!==!1&&(e[this.opts.timestampParam]=gt()),!this.supportsBinary&&!e.sid&&(e.b64=1),this.createUri(t,e)}}let yt=!1;try{yt=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const Js=yt;function Xs(){}class Qs extends Ys{constructor(t){if(super(t),typeof location<"u"){const e=location.protocol==="https:";let s=location.port;s||(s=e?"443":"80"),this.xd=typeof location<"u"&&t.hostname!==location.hostname||s!==t.port}}doWrite(t,e){const s=this.request({method:"POST",data:t});s.on("success",e),s.on("error",(n,a)=>{this.onError("xhr post error",n,a)})}doPoll(){const t=this.request();t.on("data",this.onData.bind(this)),t.on("error",(e,s)=>{this.onError("xhr poll error",e,s)}),this.pollXhr=t}}class H extends O{constructor(t,e,s){super(),this.createRequest=t,pe(this,s),this._opts=s,this._method=s.method||"GET",this._uri=e,this._data=s.data!==void 0?s.data:null,this._create()}_create(){var t;const e=xt(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");e.xdomain=!!this._opts.xd;const s=this._xhr=this.createRequest(e);try{s.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){s.setDisableHeaderCheck&&s.setDisableHeaderCheck(!0);for(let n in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(n)&&s.setRequestHeader(n,this._opts.extraHeaders[n])}}catch{}if(this._method==="POST")try{s.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{s.setRequestHeader("Accept","*/*")}catch{}(t=this._opts.cookieJar)===null||t===void 0||t.addCookies(s),"withCredentials"in s&&(s.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(s.timeout=this._opts.requestTimeout),s.onreadystatechange=()=>{var n;s.readyState===3&&((n=this._opts.cookieJar)===null||n===void 0||n.parseCookies(s.getResponseHeader("set-cookie"))),s.readyState===4&&(s.status===200||s.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof s.status=="number"?s.status:0)},0))},s.send(this._data)}catch(n){this.setTimeoutFn(()=>{this._onError(n)},0);return}typeof document<"u"&&(this._index=H.requestsCount++,H.requests[this._index]=this)}_onError(t){this.emitReserved("error",t,this._xhr),this._cleanup(!0)}_cleanup(t){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=Xs,t)try{this._xhr.abort()}catch{}typeof document<"u"&&delete H.requests[this._index],this._xhr=null}}_onLoad(){const t=this._xhr.responseText;t!==null&&(this.emitReserved("data",t),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}H.requestsCount=0;H.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",Qe);else if(typeof addEventListener=="function"){const i="onpagehide"in $?"pagehide":"unload";addEventListener(i,Qe,!1)}}function Qe(){for(let i in H.requests)H.requests.hasOwnProperty(i)&&H.requests[i].abort()}const Zs=function(){const i=vt({xdomain:!1});return i&&i.responseType!==null}();class er extends Qs{constructor(t){super(t);const e=t&&t.forceBase64;this.supportsBinary=Zs&&!e}request(t={}){return Object.assign(t,{xd:this.xd},this.opts),new H(vt,this.uri(),t)}}function vt(i){const t=i.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!t||Js))return new XMLHttpRequest}catch{}if(!t)try{return new $[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const bt=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class tr extends De{get name(){return"websocket"}doOpen(){const t=this.uri(),e=this.opts.protocols,s=bt?{}:xt(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(s.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(t,e,s)}catch(n){return this.emitReserved("error",n)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=t=>this.onClose({description:"websocket connection closed",context:t}),this.ws.onmessage=t=>this.onData(t.data),this.ws.onerror=t=>this.onError("websocket error",t)}write(t){this.writable=!1;for(let e=0;e<t.length;e++){const s=t[e],n=e===t.length-1;Ie(s,this.supportsBinary,a=>{try{this.doWrite(s,a)}catch{}n&&fe(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const t=this.opts.secure?"wss":"ws",e=this.query||{};return this.opts.timestampRequests&&(e[this.opts.timestampParam]=gt()),this.supportsBinary||(e.b64=1),this.createUri(t,e)}}const we=$.WebSocket||$.MozWebSocket;class sr extends tr{createSocket(t,e,s){return bt?new we(t,e,s):e?new we(t,e):new we(t)}doWrite(t,e){this.ws.send(e)}}class rr extends De{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(t){return this.emitReserved("error",t)}this._transport.closed.then(()=>{this.onClose()}).catch(t=>{this.onError("webtransport error",t)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(t=>{const e=Bs(Number.MAX_SAFE_INTEGER,this.socket.binaryType),s=t.readable.pipeThrough(e).getReader(),n=Os();n.readable.pipeTo(t.writable),this._writer=n.writable.getWriter();const a=()=>{s.read().then(({done:l,value:c})=>{l||(this.onPacket(c),a())}).catch(l=>{})};a();const o={type:"open"};this.query.sid&&(o.data=`{"sid":"${this.query.sid}"}`),this._writer.write(o).then(()=>this.onOpen())})})}write(t){this.writable=!1;for(let e=0;e<t.length;e++){const s=t[e],n=e===t.length-1;this._writer.write(s).then(()=>{n&&fe(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var t;(t=this._transport)===null||t===void 0||t.close()}}const ir={websocket:sr,webtransport:rr,polling:er},nr=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,ar=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Se(i){if(i.length>8e3)throw"URI too long";const t=i,e=i.indexOf("["),s=i.indexOf("]");e!=-1&&s!=-1&&(i=i.substring(0,e)+i.substring(e,s).replace(/:/g,";")+i.substring(s,i.length));let n=nr.exec(i||""),a={},o=14;for(;o--;)a[ar[o]]=n[o]||"";return e!=-1&&s!=-1&&(a.source=t,a.host=a.host.substring(1,a.host.length-1).replace(/;/g,":"),a.authority=a.authority.replace("[","").replace("]","").replace(/;/g,":"),a.ipv6uri=!0),a.pathNames=or(a,a.path),a.queryKey=lr(a,a.query),a}function or(i,t){const e=/\/{2,9}/g,s=t.replace(e,"/").split("/");return(t.slice(0,1)=="/"||t.length===0)&&s.splice(0,1),t.slice(-1)=="/"&&s.splice(s.length-1,1),s}function lr(i,t){const e={};return t.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(s,n,a){n&&(e[n]=a)}),e}const Ee=typeof addEventListener=="function"&&typeof removeEventListener=="function",le=[];Ee&&addEventListener("offline",()=>{le.forEach(i=>i())},!1);class Y extends O{constructor(t,e){if(super(),this.binaryType=$s,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,t&&typeof t=="object"&&(e=t,t=null),t){const s=Se(t);e.hostname=s.host,e.secure=s.protocol==="https"||s.protocol==="wss",e.port=s.port,s.query&&(e.query=s.query)}else e.host&&(e.hostname=Se(e.host).host);pe(this,e),this.secure=e.secure!=null?e.secure:typeof location<"u"&&location.protocol==="https:",e.hostname&&!e.port&&(e.port=this.secure?"443":"80"),this.hostname=e.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=e.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},e.transports.forEach(s=>{const n=s.prototype.name;this.transports.push(n),this._transportsByName[n]=s}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},e),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=Gs(this.opts.query)),Ee&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},le.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(t){const e=Object.assign({},this.opts.query);e.EIO=pt,e.transport=t,this.id&&(e.sid=this.id);const s=Object.assign({},this.opts,{query:e,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[t]);return new this._transportsByName[t](s)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const t=this.opts.rememberUpgrade&&Y.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const e=this.createTransport(t);e.open(),this.setTransport(e)}setTransport(t){this.transport&&this.transport.removeAllListeners(),this.transport=t,t.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",e=>this._onClose("transport close",e))}onOpen(){this.readyState="open",Y.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",t),this.emitReserved("heartbeat"),t.type){case"open":this.onHandshake(JSON.parse(t.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const e=new Error("server error");e.code=t.data,this._onError(e);break;case"message":this.emitReserved("data",t.data),this.emitReserved("message",t.data);break}}onHandshake(t){this.emitReserved("handshake",t),this.id=t.sid,this.transport.query.sid=t.sid,this._pingInterval=t.pingInterval,this._pingTimeout=t.pingTimeout,this._maxPayload=t.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const t=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+t,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},t),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const t=this._getWritablePackets();this.transport.send(t),this._prevBufferLen=t.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let e=1;for(let s=0;s<this.writeBuffer.length;s++){const n=this.writeBuffer[s].data;if(n&&(e+=Hs(n)),s>0&&e>this._maxPayload)return this.writeBuffer.slice(0,s);e+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const t=Date.now()>this._pingTimeoutTime;return t&&(this._pingTimeoutTime=0,fe(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),t}write(t,e,s){return this._sendPacket("message",t,e,s),this}send(t,e,s){return this._sendPacket("message",t,e,s),this}_sendPacket(t,e,s,n){if(typeof e=="function"&&(n=e,e=void 0),typeof s=="function"&&(n=s,s=null),this.readyState==="closing"||this.readyState==="closed")return;s=s||{},s.compress=s.compress!==!1;const a={type:t,data:e,options:s};this.emitReserved("packetCreate",a),this.writeBuffer.push(a),n&&this.once("flush",n),this.flush()}close(){const t=()=>{this._onClose("forced close"),this.transport.close()},e=()=>{this.off("upgrade",e),this.off("upgradeError",e),t()},s=()=>{this.once("upgrade",e),this.once("upgradeError",e)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?s():t()}):this.upgrading?s():t()),this}_onError(t){if(Y.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",t),this._onClose("transport error",t)}_onClose(t,e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),Ee&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const s=le.indexOf(this._offlineEventListener);s!==-1&&le.splice(s,1)}this.readyState="closed",this.id=null,this.emitReserved("close",t,e),this.writeBuffer=[],this._prevBufferLen=0}}}Y.protocol=pt;class cr extends Y{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let t=0;t<this._upgrades.length;t++)this._probe(this._upgrades[t])}_probe(t){let e=this.createTransport(t),s=!1;Y.priorWebsocketSuccess=!1;const n=()=>{s||(e.send([{type:"ping",data:"probe"}]),e.once("packet",p=>{if(!s)if(p.type==="pong"&&p.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",e),!e)return;Y.priorWebsocketSuccess=e.name==="websocket",this.transport.pause(()=>{s||this.readyState!=="closed"&&(m(),this.setTransport(e),e.send([{type:"upgrade"}]),this.emitReserved("upgrade",e),e=null,this.upgrading=!1,this.flush())})}else{const u=new Error("probe error");u.transport=e.name,this.emitReserved("upgradeError",u)}}))};function a(){s||(s=!0,m(),e.close(),e=null)}const o=p=>{const u=new Error("probe error: "+p);u.transport=e.name,a(),this.emitReserved("upgradeError",u)};function l(){o("transport closed")}function c(){o("socket closed")}function d(p){e&&p.name!==e.name&&a()}const m=()=>{e.removeListener("open",n),e.removeListener("error",o),e.removeListener("close",l),this.off("close",c),this.off("upgrading",d)};e.once("open",n),e.once("error",o),e.once("close",l),this.once("close",c),this.once("upgrading",d),this._upgrades.indexOf("webtransport")!==-1&&t!=="webtransport"?this.setTimeoutFn(()=>{s||e.open()},200):e.open()}onHandshake(t){this._upgrades=this._filterUpgrades(t.upgrades),super.onHandshake(t)}_filterUpgrades(t){const e=[];for(let s=0;s<t.length;s++)~this.transports.indexOf(t[s])&&e.push(t[s]);return e}}let dr=class extends cr{constructor(t,e={}){const s=typeof t=="object"?t:e;(!s.transports||s.transports&&typeof s.transports[0]=="string")&&(s.transports=(s.transports||["polling","websocket","webtransport"]).map(n=>ir[n]).filter(n=>!!n)),super(t,s)}};function ur(i,t="",e){let s=i;e=e||typeof location<"u"&&location,i==null&&(i=e.protocol+"//"+e.host),typeof i=="string"&&(i.charAt(0)==="/"&&(i.charAt(1)==="/"?i=e.protocol+i:i=e.host+i),/^(https?|wss?):\/\//.test(i)||(typeof e<"u"?i=e.protocol+"//"+i:i="https://"+i),s=Se(i)),s.port||(/^(http|ws)$/.test(s.protocol)?s.port="80":/^(http|ws)s$/.test(s.protocol)&&(s.port="443")),s.path=s.path||"/";const a=s.host.indexOf(":")!==-1?"["+s.host+"]":s.host;return s.id=s.protocol+"://"+a+":"+s.port+t,s.href=s.protocol+"://"+a+(e&&e.port===s.port?"":":"+s.port),s}const hr=typeof ArrayBuffer=="function",mr=i=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(i):i.buffer instanceof ArrayBuffer,wt=Object.prototype.toString,fr=typeof Blob=="function"||typeof Blob<"u"&&wt.call(Blob)==="[object BlobConstructor]",pr=typeof File=="function"||typeof File<"u"&&wt.call(File)==="[object FileConstructor]";function Le(i){return hr&&(i instanceof ArrayBuffer||mr(i))||fr&&i instanceof Blob||pr&&i instanceof File}function ce(i,t){if(!i||typeof i!="object")return!1;if(Array.isArray(i)){for(let e=0,s=i.length;e<s;e++)if(ce(i[e]))return!0;return!1}if(Le(i))return!0;if(i.toJSON&&typeof i.toJSON=="function"&&arguments.length===1)return ce(i.toJSON(),!0);for(const e in i)if(Object.prototype.hasOwnProperty.call(i,e)&&ce(i[e]))return!0;return!1}function xr(i){const t=[],e=i.data,s=i;return s.data=_e(e,t),s.attachments=t.length,{packet:s,buffers:t}}function _e(i,t){if(!i)return i;if(Le(i)){const e={_placeholder:!0,num:t.length};return t.push(i),e}else if(Array.isArray(i)){const e=new Array(i.length);for(let s=0;s<i.length;s++)e[s]=_e(i[s],t);return e}else if(typeof i=="object"&&!(i instanceof Date)){const e={};for(const s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=_e(i[s],t));return e}return i}function gr(i,t){return i.data=Te(i.data,t),delete i.attachments,i}function Te(i,t){if(!i)return i;if(i&&i._placeholder===!0){if(typeof i.num=="number"&&i.num>=0&&i.num<t.length)return t[i.num];throw new Error("illegal attachments")}else if(Array.isArray(i))for(let e=0;e<i.length;e++)i[e]=Te(i[e],t);else if(typeof i=="object")for(const e in i)Object.prototype.hasOwnProperty.call(i,e)&&(i[e]=Te(i[e],t));return i}const yr=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],vr=5;var I;(function(i){i[i.CONNECT=0]="CONNECT",i[i.DISCONNECT=1]="DISCONNECT",i[i.EVENT=2]="EVENT",i[i.ACK=3]="ACK",i[i.CONNECT_ERROR=4]="CONNECT_ERROR",i[i.BINARY_EVENT=5]="BINARY_EVENT",i[i.BINARY_ACK=6]="BINARY_ACK"})(I||(I={}));class br{constructor(t){this.replacer=t}encode(t){return(t.type===I.EVENT||t.type===I.ACK)&&ce(t)?this.encodeAsBinary({type:t.type===I.EVENT?I.BINARY_EVENT:I.BINARY_ACK,nsp:t.nsp,data:t.data,id:t.id}):[this.encodeAsString(t)]}encodeAsString(t){let e=""+t.type;return(t.type===I.BINARY_EVENT||t.type===I.BINARY_ACK)&&(e+=t.attachments+"-"),t.nsp&&t.nsp!=="/"&&(e+=t.nsp+","),t.id!=null&&(e+=t.id),t.data!=null&&(e+=JSON.stringify(t.data,this.replacer)),e}encodeAsBinary(t){const e=xr(t),s=this.encodeAsString(e.packet),n=e.buffers;return n.unshift(s),n}}function Ze(i){return Object.prototype.toString.call(i)==="[object Object]"}class Oe extends O{constructor(t){super(),this.reviver=t}add(t){let e;if(typeof t=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");e=this.decodeString(t);const s=e.type===I.BINARY_EVENT;s||e.type===I.BINARY_ACK?(e.type=s?I.EVENT:I.ACK,this.reconstructor=new wr(e),e.attachments===0&&super.emitReserved("decoded",e)):super.emitReserved("decoded",e)}else if(Le(t)||t.base64)if(this.reconstructor)e=this.reconstructor.takeBinaryData(t),e&&(this.reconstructor=null,super.emitReserved("decoded",e));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+t)}decodeString(t){let e=0;const s={type:Number(t.charAt(0))};if(I[s.type]===void 0)throw new Error("unknown packet type "+s.type);if(s.type===I.BINARY_EVENT||s.type===I.BINARY_ACK){const a=e+1;for(;t.charAt(++e)!=="-"&&e!=t.length;);const o=t.substring(a,e);if(o!=Number(o)||t.charAt(e)!=="-")throw new Error("Illegal attachments");s.attachments=Number(o)}if(t.charAt(e+1)==="/"){const a=e+1;for(;++e&&!(t.charAt(e)===","||e===t.length););s.nsp=t.substring(a,e)}else s.nsp="/";const n=t.charAt(e+1);if(n!==""&&Number(n)==n){const a=e+1;for(;++e;){const o=t.charAt(e);if(o==null||Number(o)!=o){--e;break}if(e===t.length)break}s.id=Number(t.substring(a,e+1))}if(t.charAt(++e)){const a=this.tryParse(t.substr(e));if(Oe.isPayloadValid(s.type,a))s.data=a;else throw new Error("invalid payload")}return s}tryParse(t){try{return JSON.parse(t,this.reviver)}catch{return!1}}static isPayloadValid(t,e){switch(t){case I.CONNECT:return Ze(e);case I.DISCONNECT:return e===void 0;case I.CONNECT_ERROR:return typeof e=="string"||Ze(e);case I.EVENT:case I.BINARY_EVENT:return Array.isArray(e)&&(typeof e[0]=="number"||typeof e[0]=="string"&&yr.indexOf(e[0])===-1);case I.ACK:case I.BINARY_ACK:return Array.isArray(e)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class wr{constructor(t){this.packet=t,this.buffers=[],this.reconPack=t}takeBinaryData(t){if(this.buffers.push(t),this.buffers.length===this.reconPack.attachments){const e=gr(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const Nr=Object.freeze(Object.defineProperty({__proto__:null,Decoder:Oe,Encoder:br,get PacketType(){return I},protocol:vr},Symbol.toStringTag,{value:"Module"}));function U(i,t,e){return i.on(t,e),function(){i.off(t,e)}}const jr=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Nt extends O{constructor(t,e,s){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=t,this.nsp=e,s&&s.auth&&(this.auth=s.auth),this._opts=Object.assign({},s),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const t=this.io;this.subs=[U(t,"open",this.onopen.bind(this)),U(t,"packet",this.onpacket.bind(this)),U(t,"error",this.onerror.bind(this)),U(t,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...t){return t.unshift("message"),this.emit.apply(this,t),this}emit(t,...e){var s,n,a;if(jr.hasOwnProperty(t))throw new Error('"'+t.toString()+'" is a reserved event name');if(e.unshift(t),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(e),this;const o={type:I.EVENT,data:e};if(o.options={},o.options.compress=this.flags.compress!==!1,typeof e[e.length-1]=="function"){const m=this.ids++,p=e.pop();this._registerAckCallback(m,p),o.id=m}const l=(n=(s=this.io.engine)===null||s===void 0?void 0:s.transport)===null||n===void 0?void 0:n.writable,c=this.connected&&!(!((a=this.io.engine)===null||a===void 0)&&a._hasPingExpired());return this.flags.volatile&&!l||(c?(this.notifyOutgoingListeners(o),this.packet(o)):this.sendBuffer.push(o)),this.flags={},this}_registerAckCallback(t,e){var s;const n=(s=this.flags.timeout)!==null&&s!==void 0?s:this._opts.ackTimeout;if(n===void 0){this.acks[t]=e;return}const a=this.io.setTimeoutFn(()=>{delete this.acks[t];for(let l=0;l<this.sendBuffer.length;l++)this.sendBuffer[l].id===t&&this.sendBuffer.splice(l,1);e.call(this,new Error("operation has timed out"))},n),o=(...l)=>{this.io.clearTimeoutFn(a),e.apply(this,l)};o.withError=!0,this.acks[t]=o}emitWithAck(t,...e){return new Promise((s,n)=>{const a=(o,l)=>o?n(o):s(l);a.withError=!0,e.push(a),this.emit(t,...e)})}_addToQueue(t){let e;typeof t[t.length-1]=="function"&&(e=t.pop());const s={id:this._queueSeq++,tryCount:0,pending:!1,args:t,flags:Object.assign({fromQueue:!0},this.flags)};t.push((n,...a)=>s!==this._queue[0]?void 0:(n!==null?s.tryCount>this._opts.retries&&(this._queue.shift(),e&&e(n)):(this._queue.shift(),e&&e(null,...a)),s.pending=!1,this._drainQueue())),this._queue.push(s),this._drainQueue()}_drainQueue(t=!1){if(!this.connected||this._queue.length===0)return;const e=this._queue[0];e.pending&&!t||(e.pending=!0,e.tryCount++,this.flags=e.flags,this.emit.apply(this,e.args))}packet(t){t.nsp=this.nsp,this.io._packet(t)}onopen(){typeof this.auth=="function"?this.auth(t=>{this._sendConnectPacket(t)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(t){this.packet({type:I.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},t):t})}onerror(t){this.connected||this.emitReserved("connect_error",t)}onclose(t,e){this.connected=!1,delete this.id,this.emitReserved("disconnect",t,e),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(t=>{if(!this.sendBuffer.some(s=>String(s.id)===t)){const s=this.acks[t];delete this.acks[t],s.withError&&s.call(this,new Error("socket has been disconnected"))}})}onpacket(t){if(t.nsp===this.nsp)switch(t.type){case I.CONNECT:t.data&&t.data.sid?this.onconnect(t.data.sid,t.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case I.EVENT:case I.BINARY_EVENT:this.onevent(t);break;case I.ACK:case I.BINARY_ACK:this.onack(t);break;case I.DISCONNECT:this.ondisconnect();break;case I.CONNECT_ERROR:this.destroy();const s=new Error(t.data.message);s.data=t.data.data,this.emitReserved("connect_error",s);break}}onevent(t){const e=t.data||[];t.id!=null&&e.push(this.ack(t.id)),this.connected?this.emitEvent(e):this.receiveBuffer.push(Object.freeze(e))}emitEvent(t){if(this._anyListeners&&this._anyListeners.length){const e=this._anyListeners.slice();for(const s of e)s.apply(this,t)}super.emit.apply(this,t),this._pid&&t.length&&typeof t[t.length-1]=="string"&&(this._lastOffset=t[t.length-1])}ack(t){const e=this;let s=!1;return function(...n){s||(s=!0,e.packet({type:I.ACK,id:t,data:n}))}}onack(t){const e=this.acks[t.id];typeof e=="function"&&(delete this.acks[t.id],e.withError&&t.data.unshift(null),e.apply(this,t.data))}onconnect(t,e){this.id=t,this.recovered=e&&this._pid===e,this._pid=e,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(t=>this.emitEvent(t)),this.receiveBuffer=[],this.sendBuffer.forEach(t=>{this.notifyOutgoingListeners(t),this.packet(t)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(t=>t()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:I.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(t){return this.flags.compress=t,this}get volatile(){return this.flags.volatile=!0,this}timeout(t){return this.flags.timeout=t,this}onAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(t),this}prependAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(t),this}offAny(t){if(!this._anyListeners)return this;if(t){const e=this._anyListeners;for(let s=0;s<e.length;s++)if(t===e[s])return e.splice(s,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(t),this}prependAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(t),this}offAnyOutgoing(t){if(!this._anyOutgoingListeners)return this;if(t){const e=this._anyOutgoingListeners;for(let s=0;s<e.length;s++)if(t===e[s])return e.splice(s,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(t){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const e=this._anyOutgoingListeners.slice();for(const s of e)s.apply(this,t.data)}}}function te(i){i=i||{},this.ms=i.min||100,this.max=i.max||1e4,this.factor=i.factor||2,this.jitter=i.jitter>0&&i.jitter<=1?i.jitter:0,this.attempts=0}te.prototype.duration=function(){var i=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),e=Math.floor(t*this.jitter*i);i=Math.floor(t*10)&1?i+e:i-e}return Math.min(i,this.max)|0};te.prototype.reset=function(){this.attempts=0};te.prototype.setMin=function(i){this.ms=i};te.prototype.setMax=function(i){this.max=i};te.prototype.setJitter=function(i){this.jitter=i};class Me extends O{constructor(t,e){var s;super(),this.nsps={},this.subs=[],t&&typeof t=="object"&&(e=t,t=void 0),e=e||{},e.path=e.path||"/socket.io",this.opts=e,pe(this,e),this.reconnection(e.reconnection!==!1),this.reconnectionAttempts(e.reconnectionAttempts||1/0),this.reconnectionDelay(e.reconnectionDelay||1e3),this.reconnectionDelayMax(e.reconnectionDelayMax||5e3),this.randomizationFactor((s=e.randomizationFactor)!==null&&s!==void 0?s:.5),this.backoff=new te({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(e.timeout==null?2e4:e.timeout),this._readyState="closed",this.uri=t;const n=e.parser||Nr;this.encoder=new n.Encoder,this.decoder=new n.Decoder,this._autoConnect=e.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(t){return arguments.length?(this._reconnection=!!t,t||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(t){return t===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=t,this)}reconnectionDelay(t){var e;return t===void 0?this._reconnectionDelay:(this._reconnectionDelay=t,(e=this.backoff)===null||e===void 0||e.setMin(t),this)}randomizationFactor(t){var e;return t===void 0?this._randomizationFactor:(this._randomizationFactor=t,(e=this.backoff)===null||e===void 0||e.setJitter(t),this)}reconnectionDelayMax(t){var e;return t===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=t,(e=this.backoff)===null||e===void 0||e.setMax(t),this)}timeout(t){return arguments.length?(this._timeout=t,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(t){if(~this._readyState.indexOf("open"))return this;this.engine=new dr(this.uri,this.opts);const e=this.engine,s=this;this._readyState="opening",this.skipReconnect=!1;const n=U(e,"open",function(){s.onopen(),t&&t()}),a=l=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",l),t?t(l):this.maybeReconnectOnOpen()},o=U(e,"error",a);if(this._timeout!==!1){const l=this._timeout,c=this.setTimeoutFn(()=>{n(),a(new Error("timeout")),e.close()},l);this.opts.autoUnref&&c.unref(),this.subs.push(()=>{this.clearTimeoutFn(c)})}return this.subs.push(n),this.subs.push(o),this}connect(t){return this.open(t)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const t=this.engine;this.subs.push(U(t,"ping",this.onping.bind(this)),U(t,"data",this.ondata.bind(this)),U(t,"error",this.onerror.bind(this)),U(t,"close",this.onclose.bind(this)),U(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(t){try{this.decoder.add(t)}catch(e){this.onclose("parse error",e)}}ondecoded(t){fe(()=>{this.emitReserved("packet",t)},this.setTimeoutFn)}onerror(t){this.emitReserved("error",t)}socket(t,e){let s=this.nsps[t];return s?this._autoConnect&&!s.active&&s.connect():(s=new Nt(this,t,e),this.nsps[t]=s),s}_destroy(t){const e=Object.keys(this.nsps);for(const s of e)if(this.nsps[s].active)return;this._close()}_packet(t){const e=this.encoder.encode(t);for(let s=0;s<e.length;s++)this.engine.write(e[s],t.options)}cleanup(){this.subs.forEach(t=>t()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(t,e){var s;this.cleanup(),(s=this.engine)===null||s===void 0||s.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",t,e),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const t=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const e=this.backoff.duration();this._reconnecting=!0;const s=this.setTimeoutFn(()=>{t.skipReconnect||(this.emitReserved("reconnect_attempt",t.backoff.attempts),!t.skipReconnect&&t.open(n=>{n?(t._reconnecting=!1,t.reconnect(),this.emitReserved("reconnect_error",n)):t.onreconnect()}))},e);this.opts.autoUnref&&s.unref(),this.subs.push(()=>{this.clearTimeoutFn(s)})}}onreconnect(){const t=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",t)}}const se={};function de(i,t){typeof i=="object"&&(t=i,i=void 0),t=t||{};const e=ur(i,t.path||"/socket.io"),s=e.source,n=e.id,a=e.path,o=se[n]&&a in se[n].nsps,l=t.forceNew||t["force new connection"]||t.multiplex===!1||o;let c;return l?c=new Me(s,t):(se[n]||(se[n]=new Me(s,t)),c=se[n]),e.query&&!t.query&&(t.query=e.queryKey),c.socket(e.path,t)}Object.assign(de,{Manager:Me,Socket:Nt,io:de,connect:de});const Ne={BASE_URL:"/tigerrosette/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_API_URL:"http://localhost:3001/api",VITE_APP_URL:"https://orspiritus.github.io/tigerrosette/",VITE_DEBUG_API:"true",VITE_DEBUG_MODE:"false",VITE_DEBUG_OFFLINE:"false",VITE_DEV_MODE:"true",VITE_ENABLE_HAPTICS:"true",VITE_NODE_ENV:"development",VITE_TELEGRAM_BOT_TOKEN:"7735995745:AAGpHgZamUACtEBYkYeqH0oiBHEruaRaUe4",VITE_TELEGRAM_BOT_USERNAME:"tigerrozetka_bot"},kr=()=>{const{player:i}=L(),[t,e]=h.useState(!1),[s,n]=h.useState(null),[a,o]=h.useState(null),[l,c]=h.useState([]),d=h.useRef(null),m=h.useRef(null),p=h.useRef(null),u=h.useRef([]),g=h.useRef(null),f=h.useRef(0),N=h.useCallback(()=>{console.log("🔌 Подключение к серверу дуэлей...");try{const E=(Ne==null?void 0:Ne.VITE_BACKEND_URL)||"http://localhost:3001",k=de(E,{transports:["websocket"],query:{pid:i.id},timeout:2500});d.current=k,k.on("connect",()=>{e(!0),console.log("✅ Socket.IO подключено")}),k.on("connect_error",w=>{console.warn("Socket connect error, fallback to simulation",w==null?void 0:w.message),t||b()}),k.on("duel:update",w=>{c(v=>[...v,{type:"sync_state",playerId:w.player.id,data:w,timestamp:Date.now()}]),F.emit("duelState",{roomId:w.roomId,players:{[w.player.id]:{id:w.player.id,score:w.player.score,volts:w.player.volts,streak:w.player.streak}}})}),k.on("duel:state",w=>{c(_=>[..._,{type:"sync_state",playerId:i.id,data:w,timestamp:Date.now()}]);const v={};Object.values(w.players||{}).forEach(_=>{v[_.id]={id:_.id,score:_.score,volts:_.volts,streak:_.streak}}),F.emit("duelState",{roomId:w.roomId,players:v})})}catch(E){console.warn("Socket init failed, using simulation",E),b()}},[i.id,t]),b=()=>{setTimeout(()=>{e(!0),console.log("✅ Симуляция дуэлей активна"),p.current=setInterval(()=>{if(u.current.length>0){const E=u.current.shift();E&&c(k=>[...k,E])}},100)},600)},j=h.useCallback(()=>{var E;p.current&&(clearInterval(p.current),p.current=null),m.current&&(clearInterval(m.current),m.current=null),(E=d.current)==null||E.disconnect(),g.current&&(clearInterval(g.current),g.current=null),e(!1),n(null),o(null),c([]),console.log("🔌 Отключено от сервера дуэлей")},[]),y=h.useCallback(async()=>{if(!t)throw new Error("Не подключен к серверу");return console.log("🔍 Поиск дуэли..."),new Promise(E=>{setTimeout(()=>{const k={id:`duel_${Date.now()}`,players:[i.id,"bot_opponent"],status:"waiting",createdAt:Date.now()},w={id:"bot_opponent",name:`Соперник ${Math.floor(Math.random()*1e3)}`,level:Math.max(1,i.level-2+Math.floor(Math.random()*5)),volts:Math.floor(Math.random()*500)+100,isReady:!1,score:0,streak:0};n(k),o(w),console.log("✅ Дуэль найдена!",k),E(k)},2e3+Math.random()*3e3)})},[t,i.id,i.level]),C=h.useCallback(E=>{if(!t||!s){console.warn("⚠️ Не удалось отправить сообщение: нет соединения или комнаты");return}const k={...E,timestamp:Date.now()};if(console.log("📤 Отправка сообщения:",k),E.type==="player_ready"&&setTimeout(()=>{u.current.push({type:"player_ready",playerId:"bot_opponent",timestamp:Date.now()})},1e3+Math.random()*2e3),E.type==="player_action"){const w=Date.now();w-f.current>2e3&&Math.random()<.3&&(f.current=w,setTimeout(()=>{Math.random()<.25?u.current.push({type:"player_shocked",playerId:"bot_opponent",data:{damage:20+Math.random()*30},timestamp:Date.now()}):u.current.push({type:"player_action",playerId:"bot_opponent",data:{points:Math.floor(Math.random()*50)+15,volts:Math.floor(Math.random()*30)+10},timestamp:Date.now()})},800+Math.random()*1500))}},[t,s]),P=h.useCallback(()=>{C({type:"player_ready",playerId:i.id}),setTimeout(()=>{g.current=setInterval(()=>{const E=Date.now();Math.random()<.4&&(Math.random()<.25?u.current.push({type:"player_shocked",playerId:"bot_opponent",data:{damage:20+Math.random()*30},timestamp:E}):u.current.push({type:"player_action",playerId:"bot_opponent",data:{points:Math.floor(Math.random()*50)+15,volts:Math.floor(Math.random()*30)+10},timestamp:E}))},2e3+Math.random()*1500)},3e3)},[C,i.id]),S=h.useCallback((E,k)=>{C({type:"player_action",playerId:i.id,data:{points:E,volts:k}})},[C,i.id]),T=h.useCallback(E=>{C({type:"player_shocked",playerId:i.id,data:{damage:E}})},[C,i.id]),M=h.useCallback(()=>{s&&C({type:"game_end",playerId:i.id,data:{reason:"left"}}),g.current&&(clearInterval(g.current),g.current=null),n(null),o(null),c([])},[s,C,i.id]);return h.useEffect(()=>()=>{j()},[j]),{isConnected:t,currentRoom:s,opponent:a,messages:l,connect:N,disconnect:j,findDuel:y,setReady:P,sendPlayerAction:S,sendPlayerShocked:T,leaveDuel:M,setOpponent:o}},Sr=()=>{const{player:i,endGame:t}=L(),{isConnected:e,currentRoom:s,opponent:n,messages:a,connect:o,disconnect:l,findDuel:c,setReady:d,sendPlayerAction:m,sendPlayerShocked:p,leaveDuel:u,setOpponent:g}=kr(),[f,N]=h.useState({status:"connecting",timeLeft:60,winner:null,roundNumber:1,maxRounds:3}),[b,j]=h.useState({id:i.id,name:i.name,volts:i.volts,level:i.level,isReady:!1,isAlive:!0,score:0,streak:0}),[y,C]=h.useState(0),[P,S]=h.useState(0);h.useEffect(()=>(o(),()=>{l()}),[o,l]),h.useEffect(()=>{e&&f.status==="connecting"&&(N(v=>({...v,status:"searching"})),c().then(()=>{N(v=>({...v,status:"found"})),A.medium()}))},[e,f.status,c]),h.useEffect(()=>{const v=a[a.length-1];if(v)switch(v.type){case"player_ready":v.playerId!==i.id&&g(_=>_?{..._,isReady:!0}:null);break;case"player_action":if(v.playerId!==i.id&&n){const{points:_,volts:R}=v.data;g(D=>D?{...D,score:D.score+_,volts:D.volts+R,streak:D.streak+1}:null)}break;case"player_shocked":if(v.playerId!==i.id&&n){const{damage:_}=v.data;g(R=>R?{...R,volts:Math.max(0,R.volts-_),streak:0}:null)}break;case"game_start":N(_=>({..._,status:"countdown"})),C(3);break;case"game_end":N(_=>({..._,status:"finished"}));break}},[a,i.id,n,g]),h.useEffect(()=>{f.status==="found"&&b.isReady&&(n!=null&&n.isReady)&&(N(v=>({...v,status:"countdown"})),C(3))},[f.status,b.isReady,n==null?void 0:n.isReady]),h.useEffect(()=>{if(f.status==="countdown"&&y>0){const v=setTimeout(()=>{C(_=>_-1),A.light()},1e3);return()=>clearTimeout(v)}else f.status==="countdown"&&y===0&&(N(v=>({...v,status:"playing"})),S(f.timeLeft),A.heavy())},[f.status,y,f.timeLeft]),h.useEffect(()=>{if(f.status==="playing"&&P>0){const v=setTimeout(()=>{S(_=>_-1)},1e3);return()=>clearTimeout(v)}else if(f.status==="playing"&&P===0){const v=b.score>((n==null?void 0:n.score)||0)?b.id:((n==null?void 0:n.score)||0)>b.score?n==null?void 0:n.id:null;N(_=>({..._,status:"finished",winner:v}))}},[f.status,P,b.score,n==null?void 0:n.score]);const T=()=>{j(v=>({...v,isReady:!0})),d(),A.medium()},M=h.useCallback(()=>{if(f.status!=="playing")return;const v=Math.floor(Math.random()*80)+20;Math.random()<.25?(j(D=>({...D,volts:Math.max(0,D.volts-30),streak:0})),p(30),A.heavy()):(j(R=>({...R,score:R.score+v,volts:R.volts+v,streak:R.streak+1})),m(v,v),A.light())},[f.status,m,p]),E=()=>{A.light(),u(),t()},k=()=>{switch(f.status){case"connecting":return"Подключение к серверу...";case"searching":return"Поиск соперника...";case"found":return"Соперник найден!";case"ready":return"Приготовьтесь!";case"countdown":return`Начинаем через ${y}`;case"playing":return`Осталось: ${P}с`;case"finished":return f.winner?f.winner===b.id?"Победа!":"Поражение":"Ничья!";default:return""}},w=()=>e?s?"🟢 В дуэли":"🟡 Подключен":"🔴 Не подключен";return r.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-background-dark to-background-darker",children:[r.jsx("div",{className:"bg-black/40 border-b border-white/10 p-4",children:r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsx("button",{onClick:E,className:"text-gray-400 hover:text-white transition-colors",children:"← Назад"}),r.jsx("h1",{className:"text-xl font-bold text-primary-orange",children:"⚔️ ДУЭЛЬ REAL-TIME"}),r.jsx("div",{className:"text-sm text-gray-400",children:w()})]})}),r.jsxs("div",{className:"bg-black/30 p-4 text-center",children:[r.jsx(x.div,{className:"text-2xl font-bold text-white",animate:{scale:f.status==="countdown"?[1,1.2,1]:1},transition:{duration:.5,repeat:f.status==="countdown"?1/0:0},children:k()}),s&&r.jsxs("div",{className:"text-sm text-gray-400 mt-2",children:["Комната: ",s.id.slice(-8)]})]}),(f.status==="found"||f.status==="ready"||f.status==="countdown"||f.status==="playing"||f.status==="finished")&&n&&r.jsxs("div",{className:"flex justify-between items-center p-4 bg-black/20",children:[r.jsx(x.div,{className:"glass-effect p-4 rounded-xl flex-1 mr-2",animate:{borderColor:b.isReady?"#10B981":"#6B7280",boxShadow:b.streak>0?"0 0 20px #10B981":"none"},children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-lg font-bold text-green-400",children:b.name}),r.jsxs("div",{className:"text-sm text-gray-300",children:["Уровень ",b.level]}),r.jsx("div",{className:"text-2xl font-bold text-white mt-2",children:b.score}),r.jsx("div",{className:"text-xs text-gray-400",children:"Очки"}),r.jsxs("div",{className:"text-sm text-yellow-400 mt-1",children:["Серия: ",b.streak]}),r.jsxs("div",{className:"text-sm text-blue-400",children:[b.volts,"⚡"]}),b.isReady&&r.jsx("div",{className:"text-xs text-green-400 mt-1",children:"✓ Готов"})]})}),r.jsx("div",{className:"px-4",children:r.jsx("div",{className:"text-3xl font-bold text-red-400",children:"VS"})}),r.jsx(x.div,{className:"glass-effect p-4 rounded-xl flex-1 ml-2",animate:{borderColor:n.isReady?"#10B981":"#6B7280",boxShadow:n.streak>0?"0 0 20px #EF4444":"none"},children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-lg font-bold text-red-400",children:n.name}),r.jsxs("div",{className:"text-sm text-gray-300",children:["Уровень ",n.level]}),r.jsx("div",{className:"text-2xl font-bold text-white mt-2",children:n.score}),r.jsx("div",{className:"text-xs text-gray-400",children:"Очки"}),r.jsxs("div",{className:"text-sm text-yellow-400 mt-1",children:["Серия: ",n.streak]}),r.jsxs("div",{className:"text-sm text-blue-400",children:[n.volts,"⚡"]}),n.isReady&&r.jsx("div",{className:"text-xs text-green-400 mt-1",children:"✓ Готов"})]})})]}),r.jsx("div",{className:"flex-1 flex flex-col items-center justify-center p-4",children:r.jsxs(V,{mode:"wait",children:[(f.status==="connecting"||f.status==="searching")&&r.jsxs(x.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"text-center",children:[r.jsx("div",{className:"text-6xl mb-4",children:f.status==="connecting"?"�":"�🔍"}),r.jsx("div",{className:"text-xl text-gray-300 mb-4",children:f.status==="connecting"?"Подключение к серверу...":"Ищем достойного соперника..."}),r.jsx("div",{className:"animate-spin text-4xl",children:"⚡"})]},"searching"),f.status==="found"&&r.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"text-center",children:[r.jsx("div",{className:"text-6xl mb-4",children:"⚔️"}),r.jsx("div",{className:"text-xl text-white mb-6",children:"Соперник найден!"}),r.jsxs("div",{className:"text-lg text-gray-300 mb-4",children:[n==null?void 0:n.name," (Уровень ",n==null?void 0:n.level,")"]}),r.jsx(x.button,{onClick:T,disabled:b.isReady,className:`px-8 py-4 rounded-xl font-bold text-lg transition-colors ${b.isReady?"bg-green-600 text-white cursor-default":"bg-orange-600 hover:bg-orange-500 text-white"}`,whileHover:{scale:b.isReady?1:1.05},whileTap:{scale:b.isReady?1:.95},children:b.isReady?"✓ Готов! Ждем соперника...":"Готов к бою!"})]},"found"),f.status==="countdown"&&r.jsx(x.div,{initial:{opacity:0,scale:2},animate:{opacity:1,scale:1},exit:{opacity:0,scale:0},className:"text-center",children:r.jsx(x.div,{className:"text-9xl font-bold text-red-400",animate:{scale:[1,1.2,1]},transition:{duration:.5},children:y||"⚡"})},"countdown"),f.status==="playing"&&r.jsxs(x.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"w-full max-w-md",children:[r.jsx("div",{className:"w-full h-48 bg-orange-500 rounded-lg cursor-pointer flex items-center justify-center hover:bg-orange-600 transition-colors",onClick:M,children:r.jsx("span",{className:"text-white text-2xl font-bold",children:"⚡ КЛИК ⚡"})}),r.jsx("div",{className:"text-center mt-4 text-white",children:"🔥 Real-time дуэль! Кликайте быстро! 🔥"}),r.jsxs("div",{className:"text-center mt-2 text-gray-400 text-sm",children:["Время: ",P,"с | Ваш счет: ",b.score," | Соперник: ",(n==null?void 0:n.score)||0]})]},"playing"),f.status==="finished"&&r.jsxs(x.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"text-center",children:[r.jsx("div",{className:"text-6xl mb-4",children:f.winner===b.id?"🏆":f.winner===(n==null?void 0:n.id)?"💀":"🤝"}),r.jsx("div",{className:"text-3xl font-bold text-white mb-4",children:k()}),r.jsxs("div",{className:"text-lg text-gray-300 mb-6",children:["Финальный счет: ",b.score," - ",(n==null?void 0:n.score)||0]}),f.winner===b.id&&r.jsxs("div",{className:"text-green-400 text-lg mb-4",children:["+",Math.floor(b.score*.1)," опыта за победу!"]}),r.jsx(x.button,{onClick:E,className:"px-8 py-4 bg-orange-600 hover:bg-orange-500 text-white rounded-xl font-bold text-lg transition-colors",whileHover:{scale:1.05},whileTap:{scale:.95},children:"Вернуться в меню"})]},"finished")]})})]})},Er=()=>{const{player:i,goToMenu:t}=L(),{webApp:e,user:s,isInTelegram:n}=Ce(),[a,o]=h.useState([]),[l,c]=h.useState([]),[d,m]=h.useState(null),[p,u]=h.useState("idle"),[g,f]=h.useState(!1);h.useEffect(()=>{n&&e&&s?N(s.id):o([])},[n,e,s]);const N=async S=>{f(!0);try{const M=await(await fetch(`http://localhost:3001/api/duels/players/${S}`)).json();M.success?(o(M.players),console.log(`✅ Загружено ${M.players.length} реальных игроков`)):(console.error("Ошибка загрузки игроков:",M.error),o([]))}catch(T){console.error("Ошибка запроса игроков:",T),o([])}finally{f(!1)}},b=async S=>{if(!n||!e||!s){alert("Дуэли доступны только в Telegram!");return}u("sending"),A.medium();try{const M=await(await fetch("http://localhost:3001/api/duels/invite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fromUserId:s.id,toUserId:S.id,message:`${s.first_name} (Уровень ${i.level}) вызывает вас на дуэль!`})})).json();if(M.success){const E={id:M.duelId,fromUserId:s.id,toUserId:S.id,status:"pending",createdAt:Date.now(),expiresAt:Date.now()+3e5};c(k=>[...k,E]),u("sent"),e.showAlert&&e.showAlert(`Приглашение отправлено ${S.firstName}! Ожидаем ответа...`),setTimeout(()=>{u("waiting")},2e3)}else throw new Error(M.error||"Ошибка отправки приглашения")}catch(T){console.error("Ошибка отправки приглашения:",T),u("idle"),e!=null&&e.showAlert&&e.showAlert("Ошибка отправки приглашения. Попробуйте еще раз.")}},j=S=>{m(S),A.light()},y=()=>{d&&b(d)},C=()=>{A.light(),t()},P=S=>{const T=S.lastName?`${S.firstName} ${S.lastName}`:S.firstName;return S.username?`${T} (@${S.username})`:T};return r.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-background-dark to-background-darker",children:[r.jsxs("div",{className:"bg-black/40 border-b border-white/10 p-4",children:[r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsx("button",{onClick:C,className:"text-gray-400 hover:text-white transition-colors",children:"← Назад"}),r.jsx("h1",{className:"text-white text-xl font-bold",children:"⚔️ Приглашения на дуэль"}),r.jsx("div",{})]}),!n&&r.jsx("div",{className:"text-sm text-yellow-400 mt-2 text-center",children:"⚠️ Для дуэлей откройте игру в Telegram"})]}),r.jsx("div",{className:"p-4",children:n?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"text-white text-lg mb-4 font-bold",children:"👥 Игроки онлайн:"}),g?r.jsxs("div",{className:"text-center py-8",children:[r.jsx("div",{className:"animate-spin text-orange-400 text-4xl mb-4",children:"⚡"}),r.jsx("div",{className:"text-gray-400",children:"Загружаем игроков..."})]}):a.length>0?r.jsx("div",{className:"space-y-3",children:a.map(S=>r.jsx(x.div,{className:`glass-effect p-4 rounded-xl cursor-pointer transition-all ${(d==null?void 0:d.id)===S.id?"border-2 border-green-400 bg-green-400/10":"border border-white/20 hover:border-orange-400"}`,onClick:()=>j(S),whileHover:{scale:1.02},whileTap:{scale:.98},children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex items-center space-x-3",children:[r.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center text-white font-bold text-lg",children:S.firstName.charAt(0)}),r.jsxs("div",{children:[r.jsx("div",{className:"text-white font-medium",children:P(S)}),r.jsxs("div",{className:"text-gray-400 text-sm",children:["Уровень ",S.level||1," • Побед: ",S.wins||0,"/",S.totalGames||0]})]})]}),(d==null?void 0:d.id)===S.id&&r.jsx("div",{className:"text-green-400 text-2xl",children:"✓"})]})},S.id))}):r.jsxs("div",{className:"text-center text-gray-400 py-8",children:[r.jsx("div",{className:"text-4xl mb-4",children:"😔"}),r.jsx("div",{className:"text-lg mb-2",children:"Нет доступных игроков"}),r.jsx("div",{className:"text-sm",children:"Пригласите друзей подписаться на бота для дуэлей!"})]})]}):r.jsxs("div",{className:"text-center py-12",children:[r.jsx("div",{className:"text-6xl mb-4",children:"📱"}),r.jsx("div",{className:"text-xl text-white mb-4",children:"Откройте игру в Telegram"}),r.jsx("div",{className:"text-gray-400 mb-6",children:"Дуэли доступны только подписчикам бота в Telegram"}),r.jsx("a",{href:"https://orspiritus.github.io/tigerrosette/",target:"_blank",rel:"noopener noreferrer",className:"bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors",children:"🚀 Открыть в Telegram"})]})}),d&&p==="idle"&&r.jsx("div",{className:"fixed bottom-6 left-4 right-4",children:r.jsxs(x.button,{onClick:y,className:"w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-4 rounded-xl font-bold text-lg",whileHover:{scale:1.02},whileTap:{scale:.98},initial:{opacity:0,y:50},animate:{opacity:1,y:0},children:["⚔️ Отправить вызов на дуэль ",d.firstName]})}),p==="waiting"&&r.jsx("div",{className:"fixed bottom-6 left-4 right-4",children:r.jsxs("div",{className:"bg-black/60 backdrop-blur-sm rounded-xl p-4 text-center",children:[r.jsx("div",{className:"text-white text-lg mb-2",children:"⏳ Ожидаем ответа..."}),r.jsx("div",{className:"text-gray-400 text-sm",children:"Приглашение действительно 5 минут"}),r.jsx("div",{className:"mt-3",children:r.jsx("div",{className:"animate-pulse text-orange-400",children:"⚡⚔️⚡"})})]})}),l.length>0&&r.jsxs("div",{className:"p-4 mt-4",children:[r.jsx("div",{className:"text-white text-lg mb-3 font-bold",children:"📋 Активные приглашения:"}),l.map(S=>{const T=a.find(k=>k.id===S.toUserId),M=Math.max(0,S.expiresAt-Date.now()),E=Math.floor(M/6e4);return r.jsxs("div",{className:"glass-effect p-3 rounded-lg mb-2",children:[r.jsx("div",{className:"text-white",children:T?P(T):"Неизвестный пользователь"}),r.jsxs("div",{className:"text-sm text-gray-400",children:["Статус: ",S.status," • Осталось: ",E,"м"]})]},S.id)})]})]})},_r=()=>{const{player:i,startMultiplayerMode:t}=L(),{webApp:e,user:s,isInTelegram:n}=Ce(),[a,o]=h.useState([]),[l,c]=h.useState(null);h.useEffect(()=>{if(n&&e){const u=new URLSearchParams(window.location.search),g=u.get("duel")||u.get("duel_invite");console.log("🔍 URL parameters:",window.location.search),console.log("🎯 Duel ID found:",g),g&&(console.log("🎯 Found duel ID in URL, fetching duel info..."),d(g)),console.log("Слушаем приглашения на дуэли...")}},[n,e]);const d=async u=>{var g,f,N;try{console.log("🔍 Fetching duel info for ID:",u);const j=await(await fetch(`http://localhost:3001/api/duels/info/${u}`)).json();if(j.success&&j.duel){console.log("✅ Duel info received:",j.duel);const y=j.duel,C={id:u,fromUserId:y.player1_id,fromUserName:((g=y.fromUser)==null?void 0:g.firstName)||"Игрок",fromUserLevel:((f=y.fromUser)==null?void 0:f.level)||1,message:`Приглашение на дуэль от ${((N=y.fromUser)==null?void 0:N.firstName)||"игрока"}!`,receivedAt:Date.now(),expiresAt:new Date(y.expires_at).getTime()};m(C)}else{console.error("❌ Failed to fetch duel info:",j.error);const y={id:u,fromUserId:12345,fromUserName:"Игрок",fromUserLevel:1,message:"Приглашение на дуэль!",receivedAt:Date.now(),expiresAt:Date.now()+5*60*1e3};m(y)}}catch(b){console.error("❌ Error fetching duel info:",b),m({id:u,fromUserId:12345,fromUserName:"Игрок",fromUserLevel:1,message:"Приглашение на дуэль!"})}},m=u=>{var f,N,b;const g={id:u.inviteId||u.id,fromUserId:((f=u.fromUser)==null?void 0:f.id)||u.fromUserId,fromUserName:((N=u.fromUser)==null?void 0:N.name)||u.fromUserName,fromUserLevel:((b=u.fromUser)==null?void 0:b.level)||u.fromUserLevel,message:u.message,receivedAt:Date.now(),expiresAt:Date.now()+3e5};o(j=>[...j,g]),e!=null&&e.showAlert&&e.showAlert(`🎮 Новое приглашение на дуэль от ${g.fromUserName}!`),A.heavy()},p=async(u,g)=>{c(u.id),A.medium();try{if(g){if(e!=null&&e.sendData){const f={type:"duel_response",inviteId:u.id,accepted:!0,fromUserId:s==null?void 0:s.id,fromUserName:s==null?void 0:s.first_name,fromUserLevel:i.level};e.sendData(JSON.stringify(f))}e!=null&&e.showAlert&&e.showAlert(`Дуэль принята! Подготовка к бою с ${u.fromUserName}...`),o(f=>f.filter(N=>N.id!==u.id)),setTimeout(()=>{t("duel")},2e3)}else{if(e!=null&&e.sendData){const f={type:"duel_response",inviteId:u.id,accepted:!1,fromUserId:s==null?void 0:s.id};e.sendData(JSON.stringify(f))}e!=null&&e.showAlert&&e.showAlert(`Приглашение от ${u.fromUserName} отклонено.`),o(f=>f.filter(N=>N.id!==u.id))}}catch(f){console.error("Ошибка ответа на приглашение:",f)}finally{c(null)}};return h.useEffect(()=>{const u=setInterval(()=>{const g=Date.now();o(f=>f.filter(N=>N.expiresAt>g))},3e4);return()=>clearInterval(u)},[]),a.length===0?null:r.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:r.jsxs(x.div,{className:"bg-gradient-to-br from-gray-900 to-black rounded-2xl p-6 max-w-md w-full border border-orange-400/30",initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.8,opacity:0},children:[r.jsxs("div",{className:"text-center mb-6",children:[r.jsx("div",{className:"text-4xl mb-2",children:"⚔️"}),r.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:"Приглашение на дуэль!"}),r.jsxs("div",{className:"text-orange-400 text-sm",children:[a.length," активных приглашений"]})]}),a.map(u=>{const g=Math.max(0,u.expiresAt-Date.now()),f=Math.floor(g/6e4),N=Math.floor(g%6e4/1e3);return r.jsxs(x.div,{className:"bg-black/40 rounded-xl p-4 mb-4 border border-white/10",initial:{x:-20,opacity:0},animate:{x:0,opacity:1},children:[r.jsxs("div",{className:"flex items-center justify-between mb-3",children:[r.jsxs("div",{children:[r.jsx("div",{className:"text-white font-bold text-lg",children:u.fromUserName}),r.jsxs("div",{className:"text-gray-400 text-sm",children:["Уровень ",u.fromUserLevel]})]}),r.jsxs("div",{className:"text-right",children:[r.jsxs("div",{className:"text-orange-400 text-sm font-medium",children:["⏰ ",f,":",N.toString().padStart(2,"0")]}),r.jsx("div",{className:"text-gray-500 text-xs",children:"до истечения"})]})]}),r.jsxs("div",{className:"text-gray-300 text-sm mb-4 bg-black/20 rounded-lg p-3",children:["🎮 Дуэль на 60 секунд",r.jsx("br",{}),"🏆 Побеждает тот, кто наберет больше очков",r.jsx("br",{}),"⚡ Удачи и осторожности!"]}),r.jsxs("div",{className:"flex space-x-3",children:[r.jsx(x.button,{onClick:()=>p(u,!1),disabled:l===u.id,className:"flex-1 bg-gray-600 hover:bg-gray-500 text-white py-3 px-4 rounded-xl font-medium transition-colors disabled:opacity-50",whileHover:{scale:1.02},whileTap:{scale:.98},children:l===u.id?"...":"❌ Отклонить"}),r.jsx(x.button,{onClick:()=>p(u,!0),disabled:l===u.id,className:"flex-1 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-400 hover:to-emerald-400 text-white py-3 px-4 rounded-xl font-medium transition-all disabled:opacity-50",whileHover:{scale:1.02},whileTap:{scale:.98},children:l===u.id?"⏳ Принимаем...":"✅ Принять"})]})]},u.id)}),r.jsx("div",{className:"text-center text-gray-400 text-xs mt-4",children:"💡 Приглашения автоматически истекают через 5 минут"})]})})},Tr=({isVisible:i,newLevel:t,voltsReward:e,onClose:s})=>{if(h.useEffect(()=>{i&&A.levelUp()},[i]),!t||!t.level)return i&&console.warn("LevelUpNotification: newLevel is invalid",t),null;const n=X(t.level),a=X(t.level-1),o=n!==a;return r.jsx(V,{children:i&&r.jsx(x.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50",onClick:s,children:r.jsxs(x.div,{initial:{scale:.5,opacity:0,rotateY:-90},animate:{scale:1,opacity:1,rotateY:0},exit:{scale:.5,opacity:0,rotateY:90},transition:{type:"spring",stiffness:300,damping:20,duration:.6},className:"glass-effect p-8 max-w-md mx-4 text-center relative overflow-hidden",onClick:l=>l.stopPropagation(),children:[r.jsx("div",{className:"absolute inset-0 pointer-events-none",children:[...Array(20)].map((l,c)=>r.jsx(x.div,{className:"absolute w-1 h-1 bg-yellow-300 rounded-full",style:{left:`${Math.random()*100}%`,top:`${Math.random()*100}%`},animate:{opacity:[0,1,0],scale:[0,1,0]},transition:{duration:2,repeat:1/0,delay:Math.random()*2}},c))}),r.jsxs(x.div,{animate:{scale:[1,1.1,1]},transition:{duration:.6,delay:.3},children:[r.jsx("div",{className:"text-6xl mb-4",children:"🎉"}),r.jsx(x.h2,{className:"text-3xl font-bold text-primary-orange mb-2",animate:{textShadow:["0 0 10px rgba(255, 107, 53, 0.5)","0 0 20px rgba(255, 107, 53, 0.8)","0 0 10px rgba(255, 107, 53, 0.5)"]},transition:{duration:1.5,repeat:1/0},children:"НОВЫЙ УРОВЕНЬ!"}),r.jsxs("div",{className:"mb-4",children:[r.jsx("div",{className:"text-5xl font-bold text-accent-blue mb-2",children:t.level}),r.jsx("div",{className:"text-xl text-yellow-300 font-semibold mb-1",children:t.title}),r.jsx("div",{className:"text-sm text-gray-300 italic",children:t.description})]}),r.jsxs(x.div,{className:"glass-effect p-4 rounded-lg bg-gradient-to-r from-yellow-500/20 to-orange-500/20",animate:{boxShadow:["0 0 20px rgba(255, 193, 7, 0.3)","0 0 30px rgba(255, 193, 7, 0.6)","0 0 20px rgba(255, 193, 7, 0.3)"]},transition:{duration:2,repeat:1/0},children:[r.jsx("div",{className:"text-lg font-bold text-yellow-300 mb-1",children:"Награда за уровень:"}),r.jsxs("div",{className:"text-2xl font-bold text-white",children:["+",e,"⚡ Вольт"]}),o&&r.jsxs("div",{className:"mt-3 pt-3 border-t border-yellow-400/30",children:[r.jsx("div",{className:"text-sm font-bold text-blue-300 mb-2",children:"🎨 Новое изображение розетки!"}),r.jsxs("div",{className:"flex items-center justify-center space-x-4",children:[r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-xs text-gray-400",children:"Было:"}),r.jsx("img",{src:a,alt:"Предыдущая розетка",className:"w-8 h-8 rounded border border-gray-600"})]}),r.jsx("div",{className:"text-yellow-400",children:"→"}),r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-xs text-gray-400",children:"Стало:"}),r.jsx("img",{src:n,alt:"Новая розетка",className:"w-8 h-8 rounded border border-blue-400"})]})]})]})]})]}),r.jsx(x.button,{onClick:s,className:"mt-6 px-6 py-3 bg-primary-orange hover:bg-primary-orange/80 text-white font-bold rounded-lg transition-colors",whileHover:{scale:1.05},whileTap:{scale:.95},children:"Продолжить"}),r.jsx("div",{className:"absolute inset-0 pointer-events-none overflow-hidden",children:[...Array(15)].map((l,c)=>r.jsx(x.div,{className:"absolute w-2 h-2 rounded-full",style:{backgroundColor:["#FFD700","#FF6B35","#00D4FF","#E8FF00","#8A2BE2"][c%5],left:`${50+(Math.random()-.5)*60}%`,top:"20%"},animate:{y:["0vh","80vh"],x:[(Math.random()-.5)*200,(Math.random()-.5)*400],rotate:[0,360],opacity:[1,0]},transition:{duration:3,delay:Math.random()*.5,ease:"easeOut"}},`confetti-${c}`))})]})})})},Mr=()=>{const{aiElectrician:i}=L(),[t,e]=h.useState([]);return h.useEffect(()=>{if(i.lastMessage&&i.messageTime&&(i.lastMessage.includes("🧤")||i.lastMessage.includes("👢")||i.lastMessage.includes("⛑️")||i.lastMessage.includes("🥽")||i.lastMessage.includes("💰"))){const n={id:`${i.messageTime}-${Math.random()}`,message:i.lastMessage,timestamp:i.messageTime};e(a=>[...a,n]),setTimeout(()=>{e(a=>a.filter(o=>o.id!==n.id))},5e3)}},[i.lastMessage,i.messageTime]),r.jsx("div",{className:"fixed top-20 right-4 z-50 space-y-2 pointer-events-none",children:r.jsx(V,{children:t.map(s=>r.jsxs(x.div,{initial:{opacity:0,x:300,scale:.8},animate:{opacity:1,x:0,scale:1},exit:{opacity:0,x:300,scale:.8},transition:{type:"spring",stiffness:400,damping:25,duration:.5},className:"glass-effect bg-gradient-to-r from-yellow-900/30 to-orange-900/30 border border-yellow-500/50 rounded-lg p-4 max-w-xs",children:[r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx(x.div,{animate:{rotate:[0,10,-10,0],scale:[1,1.1,1]},transition:{duration:.6,repeat:2,ease:"easeInOut"},className:"text-2xl",children:"🎁"}),r.jsxs("div",{children:[r.jsx("div",{className:"text-xs text-yellow-300 font-semibold mb-1",children:"НАХОДКА!"}),r.jsx("div",{className:"text-sm text-white font-medium",children:s.message})]})]}),r.jsx(x.div,{className:"h-1 bg-yellow-500/30 rounded-full mt-3 overflow-hidden",initial:{width:"100%"},children:r.jsx(x.div,{className:"h-full bg-gradient-to-r from-yellow-400 to-orange-400",initial:{width:"100%"},animate:{width:"0%"},transition:{duration:5,ease:"linear"}})})]},s.id))})})},ue=class ue{constructor(){B(this,"device",null);B(this,"context",null);B(this,"format",null);B(this,"adapterName");B(this,"features",[]);B(this,"initialized",!1)}static get instance(){return this._instance||(this._instance=new ue),this._instance}async init(t){if(this.initialized)return{ok:!!this.device,adapterName:this.adapterName,features:this.features,device:this.device,context:this.context,format:this.format};if(!navigator.gpu)return{ok:!1,reason:"WebGPU not supported"};try{const e=await navigator.gpu.requestAdapter();if(!e)return{ok:!1,reason:"No adapter"};const s=await e.requestDevice(),n=t.getContext("webgpu");if(!n)return{ok:!1,reason:"No context"};const a=navigator.gpu.getPreferredCanvasFormat();return n.configure({device:s,format:a,alphaMode:"premultiplied"}),this.device=s,this.context=n,this.format=a,this.adapterName=e.name,this.features=Array.from(e.features||[]),this.initialized=!0,{ok:!0,adapterName:this.adapterName,features:this.features,device:s,context:n,format:a}}catch(e){return{ok:!1,reason:(e==null?void 0:e.message)||"init error"}}}getDevice(){return this.device}getContext(){return this.context}getFormat(){return this.format}getInfo(){return{adapterName:this.adapterName,features:this.features}}};B(ue,"_instance",null);let Ae=ue;class Q{constructor(t=500){B(this,"particles",[]);B(this,"max");this.max=t}spawnBurst(t,e,s=40){for(let n=0;n<s&&this.particles.length<this.max;n++){const a=Math.random()*Math.PI*2,o=30+Math.random()*70;this.particles.push({x:t,y:e,vx:Math.cos(a)*o,vy:Math.sin(a)*o,life:0,maxLife:.6+Math.random()*.8})}}update(t){for(let s=this.particles.length-1;s>=0;s--){const n=this.particles[s];if(n.life+=t,n.life>n.maxLife){this.particles.splice(s,1);continue}n.vy+=40*t,n.x+=n.vx*t,n.y+=n.vy*t}}draw2D(t){t.save();for(const e of this.particles){const s=e.life/e.maxLife,n=1-s,a=4+12*(1-s),o=t.createRadialGradient(e.x,e.y,0,e.x,e.y,a);o.addColorStop(0,`rgba(255,180,80,${n})`),o.addColorStop(1,"rgba(255,80,0,0)"),t.fillStyle=o,t.beginPath(),t.arc(e.x,e.y,a,0,Math.PI*2),t.fill()}t.restore()}}function Ar(i,t,e,s,n=90,a=4){const o=[],l=(c,d,m,p,u)=>{if(u<a){o.push({x1:c,y1:d,x2:m,y2:p});return}const g=(c+m)/2,f=(d+p)/2,N=(Math.random()-.5)*u,b=g+(p-d)*.2*(N/u),j=f-(m-c)*.2*(N/u);l(c,d,b,j,u/2),l(b,j,m,p,u/2)};return l(i,t,e,s,n),o}function Cr(i,t,e=1){i.save(),i.globalCompositeOperation="lighter",i.lineWidth=2,i.strokeStyle=`rgba(255,200,100,${e})`,i.beginPath();for(const s of t)i.lineTo(s.x1,s.y1),i.lineTo(s.x2,s.y2);i.stroke(),i.restore()}const Rr=()=>{var C,P;const i=h.useRef(null),[t,e]=h.useState({supported:!0,message:"Initializing..."}),[s,n]=h.useState(0),a=h.useRef(0),o=h.useRef(performance.now()),l=h.useRef(performance.now()),c=h.useRef(null),d=h.useRef(null),m=typeof window<"u"&&((C=window.Telegram)==null?void 0:C.WebApp),p=h.useRef(m?300:500),u=h.useRef(0),g=h.useRef(!1),f=h.useRef(null),N=h.useRef(null),b=h.useRef(null),j=h.useRef(null),y=()=>{if(!g.current||!f.current||!N.current||b.current)return;const S=f.current,T=j.current,M=S.createShaderModule({code:`struct VSOut { @builtin(position) pos: vec4f, @location(0) col: vec3f };
      @vertex fn vs(@builtin(vertex_index) i:u32) -> VSOut {
        var positions = array<vec2f,3>(vec2f(0.0,0.8), vec2f(-0.8,-0.8), vec2f(0.8,-0.8));
        var colors = array<vec3f,3>(vec3f(1,0.4,0.1), vec3f(0.1,0.6,1), vec3f(0.2,1,0.4));
        var out: VSOut; out.pos = vec4f(positions[i],0,1); out.col = colors[i]; return out; }
      @fragment fn fs(in:VSOut) -> @location(0) vec4f { return vec4f(in.col,1); }`});b.current=S.createRenderPipeline({layout:"auto",vertex:{module:M,entryPoint:"vs"},fragment:{module:M,entryPoint:"fs",targets:[{format:T}]},primitive:{topology:"triangle-list"}})};return h.useEffect(()=>{let S;const T=()=>{const M=performance.now(),E=(M-l.current)/1e3;if(l.current=M,a.current++,M-o.current>500){const w=M-o.current,v=Math.round(a.current*1e3/w);n(v),u.current+=w,u.current>2e3&&(u.current=0,v<30?p.current=Math.max(200,Math.floor(p.current*.8)):v>55&&(p.current=Math.min(2e3,Math.floor(p.current*1.15))),c.current&&(c.current.max=p.current)),a.current=0,o.current=M}if(t.supported&&g.current&&f.current&&N.current&&(y(),b.current))try{const w=f.current,v=N.current,_=w.createCommandEncoder(),R=v.getCurrentTexture().createView(),D=_.beginRenderPass({colorAttachments:[{view:R,clearValue:{r:.04,g:.04,b:.07,a:1},loadOp:"clear",storeOp:"store"}]});D.setPipeline(b.current),D.draw(3),D.end(),w.queue.submit([_.finish()])}catch(w){console.warn("WebGPU frame error",w)}const k=i.current;if(k&&!t.supported){const w=k.getContext("2d");if(w){if(c.current||(c.current=new Q(p.current)),Math.random()<.07){const v=Math.random()*k.width,_=Math.random()*k.height*.6;if(c.current.spawnBurst(v,_,20+Math.random()*20),Math.random()<.35){const R=Math.random()*k.width;d.current={segs:Ar(R,0,R+(Math.random()-.5)*140,k.height*(.4+Math.random()*.4)),t:0}}}if(c.current.update(E),w.fillStyle="#090910",w.fillRect(0,0,k.width,k.height),c.current.draw2D(w),d.current){d.current.t+=E*3.2;const v=1-d.current.t;v>0?Cr(w,d.current.segs,v):d.current=null}}}S=requestAnimationFrame(T)};return S=requestAnimationFrame(T),()=>cancelAnimationFrame(S)},[t.supported]),h.useEffect(()=>{if(!i.current)return;let S=!0;const T=i.current;(async()=>{const E=Ae.instance,k=await E.init(T);if(k.ok){S&&e({supported:!0,message:"WebGPU ready",adapterInfo:{name:k.adapterName,features:k.features}}),f.current=E.getDevice(),N.current=E.getContext(),j.current=E.getFormat(),g.current=!0;return}const w=await(async()=>{if(!("gpu"in navigator))return{supported:!1,message:"WebGPU not supported",reason:"Navigator.gpu missing (browser build / flag disabled)"};try{const v=await navigator.gpu.requestAdapter();if(!v)return{supported:!1,message:"No adapter",reason:"requestAdapter() returned null (sandbox / driver / context restrictions)"};const _=await v.requestDevice(),R=T.getContext("webgpu");if(!R)return{supported:!1,message:"No context",reason:'getContext("webgpu") failed — experimental in this WebView'};const D=navigator.gpu.getPreferredCanvasFormat();R.configure({device:_,format:D,alphaMode:"premultiplied"});const G=_.createShaderModule({code:"@vertex fn v(@builtin(vertex_index) i:u32)->@builtin(position) vec4f{var p=array<vec2f,3>(vec2f(0.0,0.6),vec2f(-0.6,-0.6),vec2f(0.6,-0.6));return vec4f(p[i],0,1);} @fragment fn f()->@location(0) vec4f{return vec4f(1,0.5,0.15,1);}"}),z=_.createRenderPipeline({layout:"auto",vertex:{module:G,entryPoint:"v"},fragment:{module:G,entryPoint:"f",targets:[{format:D}]},primitive:{topology:"triangle-list"}}),Be=()=>{const Fe=_.createCommandEncoder(),jt=R.getCurrentTexture().createView(),xe=Fe.beginRenderPass({colorAttachments:[{view:jt,clearValue:{r:.05,g:.05,b:.08,a:1},loadOp:"clear",storeOp:"store"}]});xe.setPipeline(z),xe.draw(3),xe.end(),_.queue.submit([Fe.finish()]),S&&t.supported&&requestAnimationFrame(Be)};return requestAnimationFrame(Be),{supported:!0,message:"WebGPU (triangle)"}}catch(v){return{supported:!1,message:"Inline init failed",reason:v==null?void 0:v.message}}})();S&&e(w),w.supported||m&&w.reason&&!w.reason.includes("Telegram")&&e(v=>({...v,reason:v.reason?v.reason+" (Telegram WebView: WebGPU часто отключён)":"Telegram WebView: WebGPU отключён"}))})();const M=()=>{if(!i.current)return;const E=i.current.parentElement;if(!E)return;const k=E.clientWidth,w=Math.min(300,Math.round(k*.75));i.current.width=k*window.devicePixelRatio,i.current.height=w*window.devicePixelRatio,i.current.style.width=k+"px",i.current.style.height=w+"px"};return M(),window.addEventListener("resize",M),()=>{S=!1,window.removeEventListener("resize",M)}},[]),h.useEffect(()=>{const S=F.on("levelUp",({level:w})=>{const v=i.current;v&&(c.current||(c.current=new Q(p.current)),c.current.spawnBurst(v.width*.5,v.height*.4,80+w*5))}),T=F.on("shock",({severity:w})=>{const v=i.current;if(!v)return;c.current||(c.current=new Q(p.current));const _=w==="critical"?2.2:w==="severe"?1.6:w==="moderate"?1.2:1;for(let R=0;R<5*_;R++)c.current.spawnBurst(Math.random()*v.width,Math.random()*v.height*.5,10*_)}),M=F.on("stageAdvance",({stage:w})=>{const v=i.current;v&&(c.current||(c.current=new Q(p.current)),c.current.spawnBurst(v.width*.5,v.height*.2,120+w*15))}),E=F.on("itemDrop",({level:w})=>{const v=i.current;v&&(c.current||(c.current=new Q(p.current)),c.current.spawnBurst(v.width*(.3+Math.random()*.4),v.height*.3,60+w*20))}),k=F.on("aiAttack",({voltage:w})=>{const v=i.current;v&&(c.current||(c.current=new Q(p.current)),c.current.spawnBurst(v.width*.5,v.height*.1,100+Math.min(100,Math.floor(w/5))))});return()=>{S(),T(),M(),E(),k()}},[]),r.jsxs("div",{style:{border:"1px solid #333",padding:8,borderRadius:8,background:"#111",color:"#eee",fontFamily:"monospace"},children:[r.jsxs("div",{style:{marginBottom:6,fontSize:12,display:"flex",gap:12,flexWrap:"wrap"},children:[r.jsxs("span",{children:["WebGPU: ",t.message]}),r.jsxs("span",{children:["FPS: ",s]}),((P=t.adapterInfo)==null?void 0:P.name)&&r.jsxs("span",{children:["GPU: ",t.adapterInfo.name]})]}),r.jsx("canvas",{ref:i,width:400,height:300,style:{width:"100%",display:"block",borderRadius:4}}),!t.supported&&r.jsxs("div",{style:{color:"#f66",marginTop:8,fontSize:11,lineHeight:1.4},children:[r.jsx("div",{children:r.jsx("strong",{children:"Fallback Canvas2D mode."})}),r.jsxs("div",{children:["Причина: ",t.reason||"Недоступно"]}),r.jsxs("div",{style:{opacity:.8},children:["Чтобы включить WebGPU:",r.jsxs("ul",{style:{margin:"4px 0 0 16px",padding:0},children:[r.jsx("li",{children:'Chrome / Edge 113+: chrome://flags → "Unsafe WebGPU" → Enabled'}),r.jsx("li",{children:"Обновить видеодрайверы (если adapter null)"}),r.jsx("li",{children:"Использовать обычный браузер вместо Telegram WebView"}),r.jsx("li",{children:"HTTPS origin обязателен (localhost допустим)"}),m&&r.jsx("li",{children:"В Telegram Mini App WebGPU ещё не доступен на большинстве устройств"})]})]})]})]})},Ir=he.lazy(()=>st(()=>import("./BabylonStage-DTqXF1d6.js"),__vite__mapDeps([0,1,2]))),Pr=he.lazy(()=>st(()=>import("./BabylonStageAdvanced-DCFzqzTU.js"),__vite__mapDeps([3,1,2,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96])));function Dr(){const{gameState:i,levelUpNotification:t,hideLevelUpNotification:e}=L();h.useEffect(()=>{var a,o;if(typeof window<"u"&&((a=window.Telegram)!=null&&a.WebApp)){const l=window.Telegram.WebApp;l.ready(),l.expand(),l.setHeaderColor("#FF6B35"),l.setBackgroundColor("#1A1A1A"),l.enableClosingConfirmation(),l.MainButton&&(l.MainButton.setText("🎮 Играть"),l.MainButton.color="#FF6B35",l.MainButton.textColor="#FFFFFF"),console.log("Telegram WebApp initialized:",{platform:l.platform,version:l.version,colorScheme:l.colorScheme,user:(o=l.initDataUnsafe)==null?void 0:o.user})}else console.log("Running outside Telegram environment")},[]),console.log("App rendering, mode:",i.mode);const[s,n]=h.useState("both");return r.jsx(fs,{children:r.jsxs("div",{className:"App",children:[i.mode==="menu"&&r.jsxs(r.Fragment,{children:[r.jsx(gs,{}),r.jsxs("div",{style:{margin:"8px 0",display:"flex",gap:8,flexWrap:"wrap",fontSize:12},children:[r.jsx("span",{style:{opacity:.7},children:"Render Engines:"}),["webgpu","babylon","both"].map(a=>r.jsx("button",{onClick:()=>n(a),style:{padding:"4px 10px",border:"1px solid #444",background:s===a?"#FF6B35":"#222",color:"#fff",borderRadius:4,cursor:"pointer"},children:a},a))]}),r.jsxs("div",{style:{display:"grid",gap:16,margin:"16px auto",maxWidth:860,gridTemplateColumns:"repeat(auto-fit,minmax(380px,1fr))"},children:[(s==="webgpu"||s==="both")&&r.jsx(Rr,{}),(s==="babylon"||s==="both")&&r.jsx(h.Suspense,{fallback:r.jsx("div",{style:{color:"#888",fontSize:12},children:"Loading Babylon..."}),children:r.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[r.jsx(Ir,{}),r.jsx(Pr,{})]})})]})]}),i.mode==="single"&&r.jsx(Ms,{}),i.mode==="multiplayer"&&r.jsx(As,{}),i.mode==="duel-invite"&&r.jsx(Er,{}),i.mode==="duel"&&r.jsx(Sr,{}),r.jsx(_r,{}),r.jsx(Mr,{}),t.level&&r.jsx(Tr,{isVisible:t.isVisible,newLevel:t.level,voltsReward:t.voltsReward||0,onClose:e})]})})}var et,tt;if(typeof window<"u"&&((et=window.Telegram)!=null&&et.WebApp)){const i=window.Telegram.WebApp;i.ready(),i.expand(),i.setHeaderColor("#000000"),i.setBackgroundColor("#000000"),i.BackButton.hide(),i.HapticFeedback&&i.HapticFeedback.selectionChanged(),console.log("Telegram WebApp initialized:",{version:i.version,platform:i.platform,colorScheme:i.colorScheme,user:(tt=i.initDataUnsafe)==null?void 0:tt.user})}je.createRoot(document.getElementById("root")).render(r.jsx(he.StrictMode,{children:r.jsx(Dr,{})}));export{st as _,F as e};
//# sourceMappingURL=index-rhFFGTpy.js.map
